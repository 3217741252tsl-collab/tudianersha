# 前后端连接问题修复记录

**错误时间**: 2025年12月13日 14:52  
**错误类型**: ERR_CONNECTION_REFUSED - 前后端端口不匹配  
**影响功能**: 所有前端页面的API调用

---

## ❌ 错误详情

### 浏览器控制台错误

```
Failed to load resource: net::ERR_CONNECTION_REFUSED

common.js:37  API请求错误: TypeError: Failed to fetch
    at apiRequest (common.js:15:32)
    at post (common.js:49:12)
    at handleCreatorSubmit (create-project.html:1819:41)

create-project.html:1765  错误: Error: 创建项目失败
```

### 错误原因

**根本原因**: 前后端端口配置不匹配

| 组件 | 配置的端口 | 实际端口 | 状态 |
|------|-----------|---------|------|
| **后端** | 8010 (application.yml) | 8010 | ✅ 正确 |
| **前端** | 8080 (common.js) | - | ❌ 错误 |

**连接失败流程**:
```
前端页面
  ↓ 发送请求
http://localhost:8080/api/...  ← 8080端口无服务
  ↓
❌ ERR_CONNECTION_REFUSED
```

**正确流程应该是**:
```
前端页面
  ↓ 发送请求
http://localhost:8010/api/...  ← 8010端口有后端服务
  ↓
✅ 连接成功
```

---

## ✅ 修复方案

### 修复的文件

**文件路径**: `tudianersha/src/main/resources/static/js/common.js`  
**修改位置**: 第2行

### 修改内容

**修改前**:
```javascript
// API基础配置
const API_BASE_URL = 'http://localhost:8080/api';  // ❌ 错误端口
```

**修改后**:
```javascript
// API基础配置
const API_BASE_URL = 'http://localhost:8010/api';  // ✅ 正确端口
```

---

## 🔍 验证步骤

### 步骤1: 确认后端正在运行

**检查IDEA Run窗口**:

**预期日志**:
```
[INFO] Tomcat started on port(s): 8010 (http)  ← 确认8010端口
[INFO] Started Application in X.XXX seconds
```

**如果后端未运行**:
1. 在IDEA中右键 `Application.java`
2. 选择 "Run 'Application.main()'"
3. 等待启动成功

**截图制作**:
- 截取IDEA Run窗口
- 确保包含 "Tomcat started on port(s): 8010"

---

### 步骤2: 刷新浏览器页面

**操作**:
1. 打开浏览器
2. 访问 `http://localhost:8010/create-project.html`
3. **按 Ctrl + F5 强制刷新**（清除缓存）

**为什么需要强制刷新？**
- 浏览器会缓存JavaScript文件
- 必须强制刷新才能加载修改后的 `common.js`
- 普通刷新（F5）可能还是使用旧的缓存文件

**截图制作**:
- 打开浏览器开发者工具（F12）
- 切换到"Network"标签
- 刷新页面
- 截取 `common.js` 的请求记录
- 确认状态码是 200（不是304 Not Modified）

---

### 步骤3: 测试API连接

**方法1: 浏览器直接访问健康检查接口**

**打开浏览器，访问**:
```
http://localhost:8010/api/health
```

**预期结果**:
```json
{
  "status": "UP"
}
```

**截图制作**:
- 截取浏览器显示的JSON响应
- 确认返回 `{"status":"UP"}`

---

**方法2: 控制台测试API请求**

**操作**:
1. 打开 `http://localhost:8010/create-project.html`
2. 按F12打开开发者工具
3. 切换到"Console"标签
4. 粘贴以下代码并回车:

```javascript
// 测试API连接
fetch('http://localhost:8010/api/health')
    .then(res => res.json())
    .then(data => console.log('API连接成功:', data))
    .catch(err => console.error('API连接失败:', err));
```

**预期结果**:
```
API连接成功: {status: "UP"}
```

**截图制作**:
- 截取控制台输出
- 确认显示 "API连接成功"

---

### 步骤4: 测试创建项目功能

**完整测试流程**:

1. **打开创建项目页面**
   ```
   http://localhost:8010/create-project.html
   ```

2. **填写项目信息**
   - 项目名称: 测试项目
   - 目的地: 杭州
   - 旅行天数: 3天
   - 出行日期: 2025-12-15 至 2025-12-17

3. **点击"创建项目"按钮**

4. **观察浏览器控制台（F12）**

**预期结果**:
- ✅ Network标签显示API请求成功（状态码200）
- ✅ 页面自动跳转到需求输入页面
- ❌ 无 "ERR_CONNECTION_REFUSED" 错误
- ❌ 无 "Failed to fetch" 错误

**截图制作**:
1. 打开F12开发者工具
2. 切换到"Network"标签
3. 点击"创建项目"按钮
4. 截取Network中的API请求记录
5. 确认请求URL是 `http://localhost:8010/api/...`
6. 确认状态码是 200

---

## 🎯 完整的前后端连接检查清单

### 1. 后端检查

| 检查项 | 命令/操作 | 预期结果 |
|--------|----------|---------|
| **后端是否运行** | 查看IDEA Run窗口 | 显示 "Started Application" |
| **端口是否正确** | 查看启动日志 | "Tomcat started on port(s): 8010" |
| **健康检查** | 访问 `http://localhost:8010/api/health` | 返回 `{"status":"UP"}` |

---

### 2. 前端检查

| 检查项 | 文件位置 | 正确配置 |
|--------|---------|---------|
| **API基础URL** | `static/js/common.js` 第2行 | `http://localhost:8010/api` |
| **浏览器缓存** | 按 Ctrl + F5 | 强制刷新清除缓存 |

---

### 3. 网络检查

| 检查项 | 操作 | 预期结果 |
|--------|------|---------|
| **端口占用** | `netstat -ano \| findstr "8010"` | 显示Java进程占用8010端口 |
| **防火墙** | 检查Windows防火墙 | 允许Java访问网络 |

---

## 🔧 故障排查

### 问题1: 强制刷新后仍然连接8080

**现象**: 
```
Failed to load resource: http://localhost:8080/api/...
```

**可能原因**: 浏览器缓存未清除

**解决方案**:

1. **清除浏览器缓存**
   - Chrome: `Ctrl + Shift + Delete`
   - 选择"缓存的图片和文件"
   - 点击"清除数据"

2. **硬性重载**
   - 打开开发者工具（F12）
   - 右键点击刷新按钮
   - 选择"清空缓存并硬性重新加载"

3. **验证文件已更新**
   - F12 → Network标签
   - 刷新页面
   - 找到 `common.js` 请求
   - 点击查看响应内容
   - 确认第2行是 `http://localhost:8010/api`

**截图验证**:
- 截取Network中 `common.js` 的Response内容
- 确认API_BASE_URL是8010

---

### 问题2: 访问8010仍然连接失败

**现象**:
```
ERR_CONNECTION_REFUSED on http://localhost:8010/api/...
```

**可能原因**: 后端未启动或端口被占用

**检查步骤**:

1. **确认后端进程**
   ```powershell
   # PowerShell执行
   netstat -ano | findstr "8010"
   ```

   **预期结果**:
   ```
   TCP    0.0.0.0:8010           0.0.0.0:0              LISTENING       12345
   ```

2. **如果无输出**: 后端未启动
   - 在IDEA中启动 `Application.java`

3. **如果显示其他进程**: 端口被占用
   ```powershell
   # 查看进程详情（假设PID是12345）
   tasklist | findstr "12345"
   
   # 如果不是Java进程，终止它
   taskkill /PID 12345 /F
   ```

---

### 问题3: API请求返回404

**现象**:
```
GET http://localhost:8010/api/projects 404 (Not Found)
```

**可能原因**: Controller路径配置错误

**检查步骤**:

1. **查看Controller注解**
   ```java
   @RestController
   @RequestMapping("/api/projects")  // ← 确认路径
   public class TravelProjectController {
       // ...
   }
   ```

2. **查看前端请求路径**
   ```javascript
   // common.js中的请求
   const response = await post('/projects', data);
   // 完整URL: http://localhost:8010/api/projects
   ```

3. **检查IDEA启动日志**
   ```
   [INFO] Mapped "{[/api/projects]}" onto ...
   ```

---

## 📊 配置对照表

### 完整的端口配置清单

| 配置项 | 文件路径 | 配置值 | 说明 |
|--------|---------|--------|------|
| **后端端口** | `application.yml` | `server.port: 8010` | Spring Boot监听端口 |
| **前端API地址** | `static/js/common.js` | `http://localhost:8010/api` | 前端请求后端的地址 |

### 正确的完整配置

**application.yml**:
```yaml
server:
  port: 8010  # ← 后端监听端口
```

**common.js**:
```javascript
const API_BASE_URL = 'http://localhost:8010/api';  // ← 前端请求地址
```

**两者必须一致！**

---

## 📝 最佳实践

### 开发环境配置建议

1. **统一端口配置**
   - 后端固定使用 8010
   - 前端固定请求 8010
   - 避免频繁修改

2. **环境变量管理**
   ```javascript
   // 未来可以改进为环境变量
   const API_BASE_URL = process.env.API_URL || 'http://localhost:8010/api';
   ```

3. **开发者工具常开**
   - 始终开启F12开发者工具
   - 及时发现网络错误
   - 查看详细的错误信息

---

## ✅ 验证成功标志

### 启动成功的完整流程

**1. 后端启动成功**
```
[INFO] Tomcat started on port(s): 8010 (http)
[INFO] Started Application in 5.234 seconds
```

**2. 健康检查通过**
```
访问: http://localhost:8010/api/health
返回: {"status":"UP"}
```

**3. 前端加载成功**
```
访问: http://localhost:8010/create-project.html
状态: 页面正常显示，无控制台错误
```

**4. API请求成功**
```
Network标签:
- URL: http://localhost:8010/api/projects
- Status: 200
- Response: 返回项目数据
```

**5. 功能测试通过**
```
创建项目 → 跳转到需求输入页面 → AI生成路线 → 成功
```

---

## 🎯 快速诊断命令

### Windows PowerShell一键检查脚本

```powershell
# 途点儿啥前后端连接诊断脚本

Write-Host "=== 前后端连接诊断 ===" -ForegroundColor Green

# 1. 检查8010端口
Write-Host "`n[1] 检查8010端口..." -ForegroundColor Yellow
$port = netstat -ano | findstr "8010"
if ($port) {
    Write-Host "端口8010已占用（后端应该在运行）:" -ForegroundColor Green
    Write-Host $port
} else {
    Write-Host "端口8010空闲（后端未启动）" -ForegroundColor Red
}

# 2. 测试API连接
Write-Host "`n[2] 测试API连接..." -ForegroundColor Yellow
try {
    $response = Invoke-WebRequest -Uri "http://localhost:8010/api/health" -UseBasicParsing
    Write-Host "API连接成功: $($response.Content)" -ForegroundColor Green
} catch {
    Write-Host "API连接失败: $($_.Exception.Message)" -ForegroundColor Red
}

# 3. 检查common.js配置
Write-Host "`n[3] 检查common.js配置..." -ForegroundColor Yellow
$commonJs = Get-Content "e:\tudianershatest\tudianersha\src\main\resources\static\js\common.js" -Head 3
$apiUrl = $commonJs | Select-String "API_BASE_URL"
if ($apiUrl -match "8010") {
    Write-Host "前端配置正确: $apiUrl" -ForegroundColor Green
} else {
    Write-Host "前端配置错误: $apiUrl" -ForegroundColor Red
}

Write-Host "`n=== 诊断完成 ===" -ForegroundColor Green
```

**使用方式**:
1. 复制上述代码保存为 `check-connection.ps1`
2. 在PowerShell中执行:
   ```powershell
   .\check-connection.ps1
   ```

---

## 📸 问题解决验证截图清单

### 截图1: 修复后的common.js
**内容**: 
- 文件路径: `static/js/common.js`
- 第2行: `const API_BASE_URL = 'http://localhost:8010/api';`

**制作方式**:
- 在IDEA中打开 `common.js`
- 截取前5行代码

---

### 截图2: 强制刷新后的Network
**内容**:
- F12 → Network标签
- `common.js` 请求
- Status: 200（不是304）

**制作方式**:
- 打开创建项目页面
- 按Ctrl + F5强制刷新
- 截取Network中的 `common.js` 记录

---

### 截图3: API请求成功
**内容**:
- Network标签中的API请求
- URL: `http://localhost:8010/api/projects`
- Status: 200
- Response: JSON数据

**制作方式**:
- 填写项目信息
- 点击"创建项目"
- 截取Network中的请求记录

---

## 🚀 下一步操作

### 立即执行

1. **强制刷新浏览器**
   ```
   按 Ctrl + F5（Windows）
   或 Cmd + Shift + R（Mac）
   ```

2. **测试健康检查**
   ```
   访问: http://localhost:8010/api/health
   ```

3. **测试创建项目**
   ```
   访问: http://localhost:8010/create-project.html
   填写信息 → 点击创建
   ```

**预期**: 所有功能正常，无连接错误 ✅

---

**修复完成**: ✅  
**前端端口**: 已改为8010  
**后端端口**: 保持8010  
**状态**: 前后端端口一致

**现在请强制刷新浏览器（Ctrl + F5），然后重新测试创建项目功能！**🚀
