# ç¼–è¯‘é”™è¯¯ä¿®å¤è®°å½•

**ä¿®å¤æ—¥æœŸ**: 2025å¹´12æœˆ13æ—¥  
**é”™è¯¯ç±»å‹**: æ‰¾ä¸åˆ°ç¬¦å· - æ–¹æ³•ç¼ºå¤±  
**å½±å“èŒƒå›´**: PDFå¯¼å‡ºåŠŸèƒ½

---

## âŒ é”™è¯¯è¯¦æƒ…

### é”™è¯¯ä¿¡æ¯

```
E:\tudianershatest\tudianersha\src\main\java\com\tudianersha\service\ItineraryPdfService.java:96:22
java: æ‰¾ä¸åˆ°ç¬¦å·
  ç¬¦å·:   æ–¹æ³• getBudgetsJson()
  ä½ç½®: ç±»å‹ä¸ºcom.tudianersha.entity.AiGeneratedRouteçš„å˜é‡ route
```

### é”™è¯¯åŸå› 

**v1.2ç‰ˆæœ¬é¢„ç®—åŠŸèƒ½å‡çº§**æ—¶ï¼Œ`ItineraryPdfService` ä¸­ä½¿ç”¨äº† `route.getBudgetsJson()` æ–¹æ³•ï¼Œä½† **`AiGeneratedRoute` å®ä½“ç±»ç¼ºå°‘å¯¹åº”çš„å­—æ®µå’Œgetter/setteræ–¹æ³•**ã€‚

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤çš„æ–‡ä»¶

**æ–‡ä»¶è·¯å¾„**: `tudianersha/src/main/java/com/tudianersha/entity/AiGeneratedRoute.java`

### æ·»åŠ çš„ä»£ç 

#### 1. æ·»åŠ å­—æ®µå£°æ˜ï¼ˆç¬¬52-53è¡Œï¼‰

```java
@Column(name = "budgets_json", columnDefinition = "TEXT")
private String budgetsJson; // é¢„ç®—æ•°æ®JSONï¼ˆv1.2æ–°å¢ï¼‰
```

**ä½ç½®**: åœ¨ `coverImageUrl` å­—æ®µä¹‹å

#### 2. æ·»åŠ Getteræ–¹æ³•ï¼ˆç¬¬177-179è¡Œï¼‰

```java
public String getBudgetsJson() {
    return budgetsJson;
}
```

#### 3. æ·»åŠ Setteræ–¹æ³•ï¼ˆç¬¬181-183è¡Œï¼‰

```java
public void setBudgetsJson(String budgetsJson) {
    this.budgetsJson = budgetsJson;
}
```

---

## ğŸ“Š å®Œæ•´ä¿®æ”¹åçš„ç±»ç»“æ„

### AiGeneratedRoute å®ä½“ç±»å­—æ®µæ¸…å•

| åºå· | å­—æ®µå | æ•°æ®ç±»å‹ | ç”¨é€” | ç‰ˆæœ¬ |
|------|--------|---------|------|------|
| 1 | id | Long | ä¸»é”®ID | v1.0 |
| 2 | projectId | Long | é¡¹ç›®ID | v1.0 |
| 3 | routeContent | String | è·¯çº¿å†…å®¹ | v1.0 |
| 4 | generatedTime | LocalDateTime | ç”Ÿæˆæ—¶é—´ | v1.0 |
| 5 | interestTags | String | å…´è¶£æ ‡ç­¾ | v1.0 |
| 6 | routeTitle | String | è·¯çº¿åç§° | v1.1 |
| 7 | routeTag | String | ç‰¹è‰²æ ‡ç­¾ | v1.1 |
| 8 | attractionsCount | Integer | æ™¯ç‚¹æ•°é‡ | v1.1 |
| 9 | restaurantsCount | Integer | é¤å…æ•°é‡ | v1.1 |
| 10 | transportMode | String | äº¤é€šæ–¹å¼ | v1.1 |
| 11 | totalBudget | Integer | æ€»é¢„ç®— | v1.2 |
| 12 | recommendationScore | Integer | æ¨èæŒ‡æ•° | v1.1 |
| 13 | dailyItinerary | String | æ¯æ—¥è¡Œç¨‹JSON | v1.1 |
| 14 | coverImageUrl | String | å°é¢å›¾ç‰‡URL | v1.1 |
| 15 | **budgetsJson** | **String** | **é¢„ç®—æ•°æ®JSON** | **v1.2 âœ… æ–°å¢** |

---

## ğŸ” budgetsJsonå­—æ®µè¯´æ˜

### æ•°æ®æ ¼å¼

**ç±»å‹**: JSONå­—ç¬¦ä¸²  
**å­˜å‚¨**: TEXTç±»å‹å­—æ®µ

**ç¤ºä¾‹æ•°æ®**ï¼š
```json
{
  "1-0": 0,      // ç¬¬1å¤©ç¬¬0ä¸ªæ´»åŠ¨ï¼šè¥¿æ¹–ï¼ˆå…è´¹ï¼‰
  "1-1": 40,     // ç¬¬1å¤©ç¬¬1ä¸ªæ´»åŠ¨ï¼šé›·å³°å¡”ï¼ˆé—¨ç¥¨40å…ƒï¼‰
  "1-2": 80,     // ç¬¬1å¤©ç¬¬2ä¸ªæ´»åŠ¨ï¼šå¤–å©†å®¶ï¼ˆé¤é¥®80å…ƒï¼‰
  "2-0": 100,    // ç¬¬2å¤©ç¬¬0ä¸ªæ´»åŠ¨
  "2-1": 200     // ç¬¬2å¤©ç¬¬1ä¸ªæ´»åŠ¨
}
```

### é”®å€¼è§„åˆ™

**é”®æ ¼å¼**: `"{å¤©æ•°}-{æ´»åŠ¨ç´¢å¼•}"`  
- å¤©æ•°: ä»1å¼€å§‹ï¼ˆç¬¬1å¤©ã€ç¬¬2å¤©...ï¼‰
- æ´»åŠ¨ç´¢å¼•: ä»0å¼€å§‹ï¼ˆç¬¬0ä¸ªæ´»åŠ¨ã€ç¬¬1ä¸ªæ´»åŠ¨...ï¼‰

**å€¼ç±»å‹**: Doubleï¼ˆé‡‘é¢ï¼Œå•ä½ï¼šå…ƒï¼‰

---

## ğŸ¯ ä½¿ç”¨åœºæ™¯

### 1. PDFå¯¼å‡ºåŠŸèƒ½

**æ–‡ä»¶**: `ItineraryPdfService.java`  
**ä½¿ç”¨ä½ç½®**: ç¬¬96è¡Œ

```java
// è§£æé¢„ç®—æ•°æ®
Map<String, Double> budgets = new HashMap<>();
if (route.getBudgetsJson() != null && !route.getBudgetsJson().isEmpty()) {
    try {
        budgets = gson.fromJson(
            route.getBudgetsJson(),
            new TypeToken<Map<String, Double>>(){}.getType()
        );
        System.out.println("[PDF] Loaded budgets: " + budgets.size() + " items");
    } catch (Exception e) {
        System.err.println("[PDF] Error parsing budgets: " + e.getMessage());
    }
}
```

**ä½œç”¨**: ä»æ•°æ®åº“è¯»å–é¢„ç®—JSONï¼Œè½¬æ¢ä¸ºMapå¯¹è±¡ï¼Œç”¨äºPDFä¸­å±•ç¤ºæ¯ä¸ªæ´»åŠ¨çš„é¢„ç®—é‡‘é¢ã€‚

---

### 2. åä½œç•Œé¢é¢„ç®—ä¿å­˜

**Controller**: `AiGeneratedRouteController.java`  
**æ¥å£**: `PUT /api/ai-routes/{id}`

```java
@PutMapping("/{id}")
public ResponseEntity<?> updateRoute(@PathVariable Long id, @RequestBody AiGeneratedRoute routeData) {
    // ...
    route.setBudgetsJson(routeData.getBudgetsJson()); // ä¿å­˜é¢„ç®—æ•°æ®
    // ...
}
```

**ä½œç”¨**: ç”¨æˆ·åœ¨åä½œç•Œé¢ä¿®æ”¹æ™¯ç‚¹é¢„ç®—åï¼Œé€šè¿‡æ­¤æ¥å£ä¿å­˜åˆ°æ•°æ®åº“ã€‚

---

### 3. å‰ç«¯è¯»å–é¢„ç®—æ•°æ®

**é¡µé¢**: `collaboration.html`  
**JavaScript**:

```javascript
// ä»åç«¯è·å–è·¯çº¿ä¿¡æ¯
fetch(`/api/ai-routes/${routeId}`)
    .then(res => res.json())
    .then(route => {
        // è§£æé¢„ç®—JSON
        const budgets = JSON.parse(route.budgetsJson || '{}');
        
        // æ¸²æŸ“é¢„ç®—è¾“å…¥æ¡†
        Object.keys(budgets).forEach(key => {
            const [day, index] = key.split('-');
            const budgetInput = document.querySelector(`input[data-day="${day}"][data-index="${index}"]`);
            if (budgetInput) {
                budgetInput.value = budgets[key];
            }
        });
    });
```

---

## ğŸ“¸ éªŒè¯æ­¥éª¤

### æ­¥éª¤1: æ£€æŸ¥ç¼–è¯‘é”™è¯¯æ˜¯å¦æ¶ˆå¤±

**æ“ä½œ**ï¼š
1. åœ¨IntelliJ IDEAä¸­ï¼Œç‚¹å‡»èœå• `Build` â†’ `Rebuild Project`
2. ç­‰å¾…ç¼–è¯‘å®Œæˆ
3. æŸ¥çœ‹åº•éƒ¨"Build"çª—å£

**é¢„æœŸç»“æœ**ï¼š
```
BUILD SUCCESSFUL in Xs
```

**æˆªå›¾åˆ¶ä½œ**ï¼š
- æˆªå–IDEAåº•éƒ¨"Build"çª—å£
- åº”è¯¥æ˜¾ç¤ºç»¿è‰²çš„"BUILD SUCCESSFUL"

---

### æ­¥éª¤2: å¯åŠ¨åç«¯éªŒè¯

**æ“ä½œ**ï¼š
1. å³é”®ç‚¹å‡» `Application.java`
2. é€‰æ‹© "Run 'Application.main()'"
3. è§‚å¯Ÿå¯åŠ¨æ—¥å¿—

**é¢„æœŸç»“æœ**ï¼š
```
[INFO] Started Application in X.XXX seconds
```

**æˆªå›¾åˆ¶ä½œ**ï¼š
- æˆªå–IDEAåº•éƒ¨"Run"çª—å£
- åº”è¯¥çœ‹åˆ°æˆåŠŸå¯åŠ¨çš„æ—¥å¿—

---

### æ­¥éª¤3: æ•°æ®åº“è¡¨ç»“æ„éªŒè¯

**æ“ä½œ**ï¼š
```sql
-- è¿æ¥MySQL
mysql -u root -p123456

-- æŸ¥çœ‹è¡¨ç»“æ„
USE tudianersha;
DESC ai_generated_routes;
```

**é¢„æœŸç»“æœ**ï¼š
åº”è¯¥çœ‹åˆ° `budgets_json` å­—æ®µ

| Field | Type | Null | Key | Default | Extra |
|-------|------|------|-----|---------|-------|
| ... | ... | ... | ... | ... | ... |
| budgets_json | text | YES |  | NULL |  |

**æˆªå›¾åˆ¶ä½œ**ï¼š
- æˆªå–MySQLå‘½ä»¤è¡Œè¾“å‡º
- ç¡®è®¤ `budgets_json` å­—æ®µå­˜åœ¨

---

### æ­¥éª¤4: åŠŸèƒ½æµ‹è¯•

**æµ‹è¯•åœºæ™¯1: åä½œç•Œé¢é¢„ç®—è¾“å…¥**

1. ç™»å½•ç³»ç»Ÿ
2. è¿›å…¥åä½œç•Œé¢ (`collaboration.html?projectId=XXX`)
3. ä¸ºæŸä¸ªæ™¯ç‚¹è¾“å…¥é¢„ç®—é‡‘é¢ï¼ˆå¦‚ï¼š100å…ƒï¼‰
4. ç‚¹å‡»"ä¿å­˜è·¯çº¿"
5. åˆ·æ–°é¡µé¢ï¼Œç¡®è®¤é¢„ç®—é‡‘é¢ä¿å­˜æˆåŠŸ

**é¢„æœŸç»“æœ**: é¢„ç®—é‡‘é¢æ­£ç¡®æ˜¾ç¤º

---

**æµ‹è¯•åœºæ™¯2: PDFå¯¼å‡ºåŒ…å«é¢„ç®—**

1. åœ¨åä½œç•Œé¢ç‚¹å‡»"ç”Ÿæˆè¡Œç¨‹PDF"
2. ä¸‹è½½ç”Ÿæˆçš„PDFæ–‡ä»¶
3. æ‰“å¼€PDFï¼ŒæŸ¥çœ‹æ¯æ—¥è¡Œç¨‹è¡¨æ ¼

**é¢„æœŸç»“æœ**: 
- è¡¨æ ¼åŒ…å«"é¢„ç®—"åˆ—
- æ¯ä¸ªæ´»åŠ¨çš„é¢„ç®—é‡‘é¢æ­£ç¡®æ˜¾ç¤º
- å½“æ—¥æ€»é¢„ç®—æ­£ç¡®è®¡ç®—

**æˆªå›¾åˆ¶ä½œ**ï¼š
- æˆªå–PDFä¸­çš„è¡Œç¨‹è¡¨æ ¼éƒ¨åˆ†
- ç¡®è®¤é¢„ç®—åˆ—å­˜åœ¨ä¸”æ•°æ®æ­£ç¡®

---

## ğŸ”§ æ•°æ®åº“è¿ç§»è„šæœ¬

å¦‚æœæ•°æ®åº“ä¸­ `ai_generated_routes` è¡¨ç¼ºå°‘ `budgets_json` å­—æ®µï¼Œéœ€è¦æ‰§è¡Œä»¥ä¸‹SQLï¼š

### è¿ç§»SQL

```sql
-- ä¸º ai_generated_routes è¡¨æ·»åŠ  budgets_json å­—æ®µ
USE tudianersha;

ALTER TABLE ai_generated_routes 
ADD COLUMN budgets_json TEXT COMMENT 'é¢„ç®—æ•°æ®JSONï¼ˆv1.2æ–°å¢ï¼‰';

-- éªŒè¯å­—æ®µæ·»åŠ æˆåŠŸ
DESC ai_generated_routes;
```

### æ‰§è¡Œæ­¥éª¤

1. **æ‰“å¼€MySQLå‘½ä»¤è¡Œ**
   ```powershell
   mysql -u root -p123456
   ```

2. **æ‰§è¡Œè¿ç§»è„šæœ¬**
   ```sql
   USE tudianersha;
   ALTER TABLE ai_generated_routes 
   ADD COLUMN budgets_json TEXT COMMENT 'é¢„ç®—æ•°æ®JSONï¼ˆv1.2æ–°å¢ï¼‰';
   ```

3. **éªŒè¯ç»“æœ**
   ```sql
   DESC ai_generated_routes;
   ```

**é¢„æœŸè¾“å‡º**: è¡¨ç»“æ„ä¸­åŒ…å« `budgets_json` å­—æ®µ

---

## ğŸ“ ç›¸å…³æ–‡ä»¶æ¸…å•

### ä¿®æ”¹çš„æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | ä¿®æ”¹å†…å®¹ | å½±å“ |
|---------|---------|------|
| `entity/AiGeneratedRoute.java` | æ·»åŠ budgetsJsonå­—æ®µåŠgetter/setter | âœ… ä¿®å¤ç¼–è¯‘é”™è¯¯ |

### ä¾èµ–çš„æ–‡ä»¶ï¼ˆæ— éœ€ä¿®æ”¹ï¼‰

| æ–‡ä»¶è·¯å¾„ | ç”¨é€” |
|---------|------|
| `service/ItineraryPdfService.java` | ä½¿ç”¨budgetsJsonç”ŸæˆPDF |
| `controller/AiGeneratedRouteController.java` | ä¿å­˜budgetsJsonåˆ°æ•°æ®åº“ |
| `static/collaboration.html` | å‰ç«¯é¢„ç®—è¾“å…¥ç•Œé¢ |

---

## âœ… ä¿®å¤ç¡®è®¤æ¸…å•

- [x] `AiGeneratedRoute.java` æ·»åŠ  `budgetsJson` å­—æ®µ
- [x] `AiGeneratedRoute.java` æ·»åŠ  `getBudgetsJson()` æ–¹æ³•
- [x] `AiGeneratedRoute.java` æ·»åŠ  `setBudgetsJson()` æ–¹æ³•
- [ ] é‡æ–°ç¼–è¯‘é¡¹ç›®ï¼ˆç”¨æˆ·æ‰‹åŠ¨æ‰§è¡Œï¼‰
- [ ] å¯åŠ¨åç«¯éªŒè¯ï¼ˆç”¨æˆ·æ‰‹åŠ¨æ‰§è¡Œï¼‰
- [ ] æ•°æ®åº“è¿ç§»ï¼ˆå¦‚éœ€è¦ï¼‰
- [ ] åŠŸèƒ½æµ‹è¯•ï¼ˆç”¨æˆ·æ‰‹åŠ¨æ‰§è¡Œï¼‰

---

## ğŸ“ æŠ€æœ¯è¦ç‚¹

### ä¸ºä»€ä¹ˆä½¿ç”¨TEXTç±»å‹ï¼Ÿ

**åŸå› **ï¼š
- `budgetsJson` å­˜å‚¨çš„æ˜¯JSONå­—ç¬¦ä¸²
- JSONæ•°æ®é•¿åº¦ä¸å›ºå®šï¼Œå¯èƒ½åŒ…å«å¤šå¤©å¤šä¸ªæ´»åŠ¨çš„é¢„ç®—
- TEXTç±»å‹æ”¯æŒæœ€å¤§65,535å­—èŠ‚ï¼Œè¶³å¤Ÿå­˜å‚¨å¤§é‡é¢„ç®—æ•°æ®

### ä¸ºä»€ä¹ˆä¸ç”¨å•ç‹¬çš„é¢„ç®—è¡¨ï¼Ÿ

**è®¾è®¡è€ƒé‡**ï¼š

| æ–¹æ¡ˆ | ä¼˜åŠ¿ | åŠ£åŠ¿ | é€‰æ‹© |
|------|------|------|------|
| **å•ç‹¬é¢„ç®—è¡¨** | è§„èŒƒåŒ–ï¼Œæ˜“äºæŸ¥è¯¢ç»Ÿè®¡ | å¢åŠ è¡¨å…³è”ï¼ŒæŸ¥è¯¢å¤æ‚ | âŒ |
| **JSONå­—æ®µ** | çµæ´»æ‰©å±•ï¼ŒæŸ¥è¯¢ç®€å• | ä¸ä¾¿äºSQLç»Ÿè®¡ | âœ… |

**é¡¹ç›®é€‰æ‹©**: JSONå­—æ®µ
- é¢„ç®—æ•°æ®ä¸»è¦ç”¨äº**å±•ç¤º**ï¼Œä¸éœ€è¦å¤æ‚ç»Ÿè®¡
- æ¯æ¬¡è¯»å–å®Œæ•´è·¯çº¿æ—¶ï¼Œé¢„ç®—æ•°æ®ä¸€å¹¶è·å–ï¼Œ**æ€§èƒ½æ›´å¥½**
- åŠ¨æ€æ·»åŠ /åˆ é™¤æ´»åŠ¨æ—¶ï¼Œ**JSONæ›´çµæ´»**

---

## ğŸ“Œ æ³¨æ„äº‹é¡¹

1. **JPAè‡ªåŠ¨å»ºè¡¨**
   - å¦‚æœ `application.yml` ä¸­é…ç½® `ddl-auto: update`
   - å¯åŠ¨åº”ç”¨æ—¶ä¼š**è‡ªåŠ¨æ·»åŠ ** `budgets_json` å­—æ®µ
   - æ— éœ€æ‰‹åŠ¨æ‰§è¡Œè¿ç§»SQL

2. **å·²æœ‰æ•°æ®å…¼å®¹æ€§**
   - æ–°å¢å­—æ®µå…è®¸NULLå€¼
   - ä¸å½±å“å·²æœ‰çš„è·¯çº¿æ•°æ®
   - æ—§æ•°æ®çš„ `budgetsJson` ä¸ºNULLï¼Œå‰ç«¯æ­£å¸¸å¤„ç†

3. **JSONè§£æå¼‚å¸¸å¤„ç†**
   - `ItineraryPdfService` ä¸­å·²åŒ…å«try-catch
   - å¦‚æœJSONæ ¼å¼é”™è¯¯ï¼Œä¸ä¼šå¯¼è‡´PDFç”Ÿæˆå¤±è´¥
   - ä»…æ—¥å¿—è®°å½•é”™è¯¯ä¿¡æ¯

---

## ğŸš€ ä¸‹ä¸€æ­¥æ“ä½œ

### ç«‹å³æ‰§è¡Œ

1. **é‡æ–°ç¼–è¯‘é¡¹ç›®**
   ```
   IDEAèœå•: Build â†’ Rebuild Project
   ```

2. **å¯åŠ¨åç«¯**
   ```
   å³é”® Application.java â†’ Run 'Application.main()'
   ```

3. **éªŒè¯ç¼–è¯‘æˆåŠŸ**
   - æ£€æŸ¥"Build"çª—å£æ— ERROR
   - æ£€æŸ¥"Run"çª—å£åº”ç”¨å¯åŠ¨æˆåŠŸ

### åç»­æµ‹è¯•

1. æµ‹è¯•åä½œç•Œé¢é¢„ç®—è¾“å…¥åŠŸèƒ½
2. æµ‹è¯•PDFå¯¼å‡ºåŒ…å«é¢„ç®—æ•°æ®
3. éªŒè¯å‰åç«¯æ•°æ®ä¸€è‡´æ€§

---

**ä¿®å¤å®Œæˆ**: âœ…  
**æµ‹è¯•çŠ¶æ€**: â³ å¾…ç”¨æˆ·éªŒè¯  
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¶é—´**: 2025å¹´12æœˆ13æ—¥
