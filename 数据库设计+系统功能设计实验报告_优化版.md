# 数据库设计+系统功能设计实验报告

**项目名称**: 途点儿啥 - 协作式旅行规划系统  
**开发团队**: 惠州学院23软工3班 HappCoding团队  
**技术栈**: Spring Boot + MySQL + HTML/CSS/JavaScript  
**文档版本**: v2.0  
**编写日期**: 2025年12月

---

## 目录

1. [系统概述](#1-系统概述)
2. [数据库设计](#2-数据库设计)
   - 2.1 [数据库概念设计(E-R图)](#21-数据库概念设计er图)
   - 2.2 [数据库逻辑设计](#22-数据库逻辑设计)
   - 2.3 [数据表详细设计](#23-数据表详细设计)
3. [系统功能设计](#3-系统功能设计)
   - 3.1 [系统功能模块图](#31-系统功能模块图)
   - 3.2 [核心功能模块设计](#32-核心功能模块设计)
   - 3.3 [系统接口设计](#33-系统接口设计)
4. [系统架构设计](#4-系统架构设计)
5. [附录](#5-附录)

---

## 1. 系统概述

### 1.1 项目背景

"途点儿啥"是一个基于AI技术的协作式旅行规划系统，旨在解决传统旅行规划中的痛点：
- 信息收集困难，需要浏览大量网站
- 多人协作规划效率低下
- 行程安排缺乏个性化推荐
- 预算管理和分配不透明

### 1.2 系统定位

本系统是一个面向多人协作的智能旅行规划平台，集成了以下核心能力：
- **AI智能规划**: 集成Kimi AI大模型，根据用户需求自动生成个性化旅行路线
- **实时协作**: 支持多人同时编辑、讨论和优化旅行计划
- **POI推荐**: 集成高德地图API，提供景点、餐厅等兴趣点推荐
- **预算管理**: 实时计算和跟踪旅行预算，避免超支
- **文档导出**: 一键生成PDF行程单，方便分享和打印

### 1.3 技术架构

- **后端框架**: Spring Boot 2.7.0
- **数据库**: MySQL 8.0.29
- **持久化**: Spring Data JPA + MyBatis
- **前端技术**: HTML5 + CSS3 + JavaScript (原生)
- **第三方集成**: Kimi AI、高德地图API、iText PDF

---

## 2. 数据库设计

### 2.1 数据库概念设计(E-R图)

#### 核心实体及关系

```
[用户 User] 1 ----创建----> N [旅行项目 TravelProject]
    |                              |
    |                              |
    N                             N
    |                              |
[项目参与者 ProjectParticipant] 1 ---- 属于 ---- 1 [旅行项目]
    |
    |
[需求参数 RequirementParameter] N ---- 关联 ---- 1 [旅行项目]
    |
    |
[AI生成路线 AiGeneratedRoute] N ---- 生成于 ---- 1 [旅行项目]
    |
    |
[活动安排 ActivitySchedule] N ---- 包含 ---- 1 [旅行项目]
    |
    |
[预算管理 Budget] 1 ---- 对应 ---- 1 [旅行项目]
    |
    |
[聊天消息 ChatMessage] N ---- 发送于 ---- 1 [旅行项目]
```

#### 实体属性说明

**用户实体 (User)**
- id: 用户ID (主键)
- username: 用户名 (唯一)
- email: 邮箱 (唯一)
- password: 密码 (BCrypt加密)

**旅行项目实体 (TravelProject)**
- id: 项目ID (主键)
- projectName: 项目名称
- destination: 目的地
- days: 旅行天数
- creatorId: 创建者ID (外键)
- status: 项目状态 (草稿/规划中/已归档)
- startDate: 开始日期
- endDate: 结束日期
- totalBudget: 总预算
- currentRouteId: 当前选择的路线ID

**项目参与者实体 (ProjectParticipant)**
- id: 参与者ID (主键)
- projectId: 项目ID (外键)
- userId: 用户ID (外键)
- role: 角色 (创建者/编辑者/查看者)
- joinTime: 加入时间

**AI生成路线实体 (AiGeneratedRoute)**
- id: 路线ID (主键)
- projectId: 项目ID (外键)
- routeTitle: 路线标题
- routeContent: 路线内容 (TEXT)
- dailyItinerary: 每日行程 (JSON)
- budgetsJson: 预算数据 (JSON)
- interestTags: 兴趣标签
- attractionsCount: 景点数量
- restaurantsCount: 餐厅数量
- totalBudget: 总预算
- recommendationScore: 推荐指数

### 2.2 数据库逻辑设计

#### 数据库命名规范

1. **数据库名称**: tudianersha
2. **表名命名**: 小写+下划线分隔 (如: travel_projects)
3. **字段命名**: 小写+下划线分隔 (如: project_name)
4. **主键命名**: id (BIGINT AUTO_INCREMENT)
5. **外键命名**: {关联表名}_id (如: creator_id)

#### 关系模式

**R1: 用户表 (users)**
```
users(id, username, email, password)
主键: id
唯一约束: username, email
```

**R2: 旅行项目表 (travel_projects)**
```
travel_projects(id, project_name, destination, days, creator_id, status, 
                created_time, updated_time, current_route_id, start_date, 
                end_date, total_budget)
主键: id
外键: creator_id → users(id)
索引: creator_id
```

**R3: 项目参与者表 (project_participants)**
```
project_participants(id, project_id, user_id, role, join_time)
主键: id
外键: project_id → travel_projects(id), user_id → users(id)
索引: project_id, user_id
联合唯一约束: (project_id, user_id)
```

**R4: 旅行参与者表 (travel_participants)**
```
travel_participants(id, project_id, user_id, permission)
主键: id
外键: project_id → travel_projects(id), user_id → users(id)
索引: project_id, user_id
```

**R5: 需求参数表 (requirement_parameters)**
```
requirement_parameters(id, project_id, user_id, interest_tags, 
                       daily_budget_allocation, wishlist, dislike_list, 
                       budget_breakdown)
主键: id
外键: project_id → travel_projects(id), user_id → users(id)
索引: project_id, user_id
```

**R6: AI生成路线表 (ai_generated_routes)**
```
ai_generated_routes(id, project_id, route_content, generated_time, 
                    interest_tags, route_title, route_tag, attractions_count, 
                    restaurants_count, transport_mode, total_budget, 
                    recommendation_score, daily_itinerary, cover_image_url, 
                    budgets_json)
主键: id
外键: project_id → travel_projects(id)
索引: project_id
```

**R7: 总体路线表 (overall_routes)**
```
overall_routes(id, project_id, route_details, created_time)
主键: id
外键: project_id → travel_projects(id)
索引: project_id
```

**R8: 活动安排表 (activity_schedules)**
```
activity_schedules(id, project_id, activity_name, activity_time, 
                   location, budget, day_number)
主键: id
外键: project_id → travel_projects(id)
索引: project_id, day_number
```

**R9: 预算表 (budgets)**
```
budgets(id, project_id, total_budget, used_budget, remaining_budget)
主键: id
外键: project_id → travel_projects(id)
索引: project_id
```

**R10: 聊天消息表 (chat_messages)**
```
chat_messages(id, project_id, user_id, username, message, created_time)
主键: id
外键: project_id → travel_projects(id), user_id → users(id)
索引: project_id, created_time
```

**R11: 旅行会话表 (travel_sessions)**
```
travel_sessions(id, project_id, user_id, message, message_time, 
                mentioned_user_id)
主键: id
外键: project_id → travel_projects(id), user_id → users(id)
索引: project_id
```

**R12: 共享文档表 (shared_documents)**
```
shared_documents(id, project_id, document_url, format, generated_time, 
                 share_link, creator_id)
主键: id
外键: project_id → travel_projects(id), creator_id → users(id)
索引: project_id
```

### 2.3 数据表详细设计

#### 表1: users (用户表)

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 约束 | 说明 |
|--------|---------|------|---------|--------|------|------|
| id | BIGINT | - | NOT NULL | AUTO_INCREMENT | PRIMARY KEY | 用户ID |
| username | VARCHAR | 50 | NOT NULL | - | UNIQUE | 用户名 |
| email | VARCHAR | 100 | NOT NULL | - | UNIQUE | 邮箱 |
| password | VARCHAR | 100 | NOT NULL | - | - | 密码(BCrypt加密) |

**建表SQL:**
```sql
CREATE TABLE users (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '用户ID',
    username VARCHAR(50) NOT NULL UNIQUE COMMENT '用户名',
    email VARCHAR(100) NOT NULL UNIQUE COMMENT '邮箱',
    password VARCHAR(100) NOT NULL COMMENT '密码(BCrypt加密)',
    INDEX idx_username (username),
    INDEX idx_email (email)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户表';
```

#### 表2: travel_projects (旅行项目表)

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 约束 | 说明 |
|--------|---------|------|---------|--------|------|------|
| id | BIGINT | - | NOT NULL | AUTO_INCREMENT | PRIMARY KEY | 项目ID |
| project_name | VARCHAR | 100 | NOT NULL | - | - | 项目名称 |
| destination | VARCHAR | 100 | NOT NULL | - | - | 目的地 |
| days | INT | - | NOT NULL | - | - | 旅行天数 |
| creator_id | BIGINT | - | NOT NULL | - | FOREIGN KEY | 创建者ID |
| status | VARCHAR | 20 | NOT NULL | 'planning' | - | 项目状态 |
| created_time | DATETIME | - | NOT NULL | - | - | 创建时间 |
| updated_time | DATETIME | - | NOT NULL | - | - | 更新时间 |
| current_route_id | BIGINT | - | NULL | NULL | - | 当前路线ID |
| start_date | DATE | - | NULL | NULL | - | 开始日期 |
| end_date | DATE | - | NULL | NULL | - | 结束日期 |
| total_budget | DECIMAL | 10,2 | NULL | NULL | - | 总预算 |

**建表SQL:**
```sql
CREATE TABLE travel_projects (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '项目ID',
    project_name VARCHAR(100) NOT NULL COMMENT '项目名称',
    destination VARCHAR(100) NOT NULL COMMENT '目的地',
    days INT NOT NULL COMMENT '旅行天数',
    creator_id BIGINT NOT NULL COMMENT '创建者ID',
    status VARCHAR(20) NOT NULL DEFAULT 'planning' COMMENT '项目状态:草稿/规划中/已归档',
    created_time DATETIME NOT NULL COMMENT '创建时间',
    updated_time DATETIME NOT NULL COMMENT '更新时间',
    current_route_id BIGINT COMMENT '当前选择的路线ID',
    start_date DATE COMMENT '开始日期',
    end_date DATE COMMENT '结束日期',
    total_budget DECIMAL(10,2) COMMENT '总预算',
    INDEX idx_creator (creator_id),
    INDEX idx_status (status),
    FOREIGN KEY (creator_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='旅行项目表';
```

#### 表3: project_participants (项目参与者表)

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 约束 | 说明 |
|--------|---------|------|---------|--------|------|------|
| id | BIGINT | - | NOT NULL | AUTO_INCREMENT | PRIMARY KEY | 参与者ID |
| project_id | BIGINT | - | NOT NULL | - | FOREIGN KEY | 项目ID |
| user_id | BIGINT | - | NOT NULL | - | FOREIGN KEY | 用户ID |
| role | VARCHAR | 20 | NOT NULL | - | - | 角色:创建者/编辑者/查看者 |
| join_time | DATETIME | - | NOT NULL | - | - | 加入时间 |

**建表SQL:**
```sql
CREATE TABLE project_participants (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '参与者ID',
    project_id BIGINT NOT NULL COMMENT '项目ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    role VARCHAR(20) NOT NULL COMMENT '角色:创建者/编辑者/查看者',
    join_time DATETIME NOT NULL COMMENT '加入时间',
    INDEX idx_project (project_id),
    INDEX idx_user (user_id),
    UNIQUE KEY uk_project_user (project_id, user_id),
    FOREIGN KEY (project_id) REFERENCES travel_projects(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='项目参与者表';
```

#### 表4: travel_participants (旅行参与者表)

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 约束 | 说明 |
|--------|---------|------|---------|--------|------|------|
| id | BIGINT | - | NOT NULL | AUTO_INCREMENT | PRIMARY KEY | 参与者ID |
| project_id | BIGINT | - | NOT NULL | - | FOREIGN KEY | 项目ID |
| user_id | BIGINT | - | NOT NULL | - | FOREIGN KEY | 用户ID |
| permission | VARCHAR | 20 | NOT NULL | - | - | 权限:创建者/编辑者/查看者 |

**建表SQL:**
```sql
CREATE TABLE travel_participants (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '参与者ID',
    project_id BIGINT NOT NULL COMMENT '项目ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    permission VARCHAR(20) NOT NULL COMMENT '权限:创建者/编辑者/查看者',
    INDEX idx_project (project_id),
    INDEX idx_user (user_id),
    FOREIGN KEY (project_id) REFERENCES travel_projects(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='旅行参与者表';
```

#### 表5: requirement_parameters (需求参数表)

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 约束 | 说明 |
|--------|---------|------|---------|--------|------|------|
| id | BIGINT | - | NOT NULL | AUTO_INCREMENT | PRIMARY KEY | 参数ID |
| project_id | BIGINT | - | NOT NULL | - | FOREIGN KEY | 项目ID |
| user_id | BIGINT | - | NOT NULL | - | FOREIGN KEY | 用户ID |
| interest_tags | VARCHAR | 200 | NULL | NULL | - | 兴趣标签(逗号分隔) |
| daily_budget_allocation | DECIMAL | 10,2 | NULL | NULL | - | 每日预算分配 |
| wishlist | TEXT | - | NULL | NULL | - | 期望列表 |
| dislike_list | TEXT | - | NULL | NULL | - | 不喜欢列表 |
| budget_breakdown | TEXT | - | NULL | NULL | - | 预算明细(JSON) |

**建表SQL:**
```sql
CREATE TABLE requirement_parameters (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '参数ID',
    project_id BIGINT NOT NULL COMMENT '项目ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    interest_tags VARCHAR(200) COMMENT '兴趣标签(逗号分隔)',
    daily_budget_allocation DECIMAL(10,2) COMMENT '每日预算分配',
    wishlist TEXT COMMENT '期望列表',
    dislike_list TEXT COMMENT '不喜欢列表',
    budget_breakdown TEXT COMMENT '预算明细(JSON)',
    INDEX idx_project (project_id),
    INDEX idx_user (user_id),
    FOREIGN KEY (project_id) REFERENCES travel_projects(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='需求参数表';
```

#### 表6: ai_generated_routes (AI生成路线表)

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 约束 | 说明 |
|--------|---------|------|---------|--------|------|------|
| id | BIGINT | - | NOT NULL | AUTO_INCREMENT | PRIMARY KEY | 路线ID |
| project_id | BIGINT | - | NOT NULL | - | FOREIGN KEY | 项目ID |
| route_content | TEXT | - | NULL | NULL | - | 路线内容 |
| generated_time | DATETIME | - | NOT NULL | - | - | 生成时间 |
| interest_tags | VARCHAR | 200 | NULL | NULL | - | 兴趣标签 |
| route_title | VARCHAR | 100 | NULL | NULL | - | 路线名称 |
| route_tag | VARCHAR | 50 | NULL | NULL | - | 特色标签 |
| attractions_count | INT | - | NULL | NULL | - | 景点数量 |
| restaurants_count | INT | - | NULL | NULL | - | 餐厅数量 |
| transport_mode | VARCHAR | 50 | NULL | NULL | - | 交通方式 |
| total_budget | INT | - | NULL | NULL | - | 总预算 |
| recommendation_score | INT | - | NULL | NULL | - | 推荐指数(1-5星) |
| daily_itinerary | TEXT | - | NULL | NULL | - | 每日行程(JSON) |
| cover_image_url | TEXT | - | NULL | NULL | - | 封面图片URL |
| budgets_json | TEXT | - | NULL | NULL | - | 预算数据(JSON) |

**建表SQL:**
```sql
CREATE TABLE ai_generated_routes (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '路线ID',
    project_id BIGINT NOT NULL COMMENT '项目ID',
    route_content TEXT COMMENT '路线内容',
    generated_time DATETIME NOT NULL COMMENT '生成时间',
    interest_tags VARCHAR(200) COMMENT '兴趣标签',
    route_title VARCHAR(100) COMMENT '路线名称',
    route_tag VARCHAR(50) COMMENT '特色标签',
    attractions_count INT COMMENT '景点数量',
    restaurants_count INT COMMENT '餐厅数量',
    transport_mode VARCHAR(50) COMMENT '交通方式',
    total_budget INT COMMENT '总预算',
    recommendation_score INT COMMENT '推荐指数(1-5星)',
    daily_itinerary TEXT COMMENT '每日行程(JSON)',
    cover_image_url TEXT COMMENT '封面图片URL',
    budgets_json TEXT COMMENT '预算数据(JSON)',
    INDEX idx_project (project_id),
    FOREIGN KEY (project_id) REFERENCES travel_projects(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='AI生成路线表';
```

**budgets_json字段JSON格式示例:**
```json
{
  "1-0": 100.00,
  "1-1": 200.00,
  "1-2": 150.00,
  "2-0": 180.00
}
```
其中键为"天数-活动索引"，值为该活动的预算金额。

**daily_itinerary字段JSON格式示例:**
```json
[
  {
    "day": 1,
    "activities": [
      {
        "time": "09:00",
        "activity": "西湖-断桥残雪",
        "location": "西湖风景区",
        "description": "欣赏湖光山色"
      }
    ]
  }
]
```

#### 表7: overall_routes (总体路线表)

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 约束 | 说明 |
|--------|---------|------|---------|--------|------|------|
| id | BIGINT | - | NOT NULL | AUTO_INCREMENT | PRIMARY KEY | 路线ID |
| project_id | BIGINT | - | NOT NULL | - | FOREIGN KEY | 项目ID |
| route_details | TEXT | - | NULL | NULL | - | 路线详情 |
| created_time | DATETIME | - | NOT NULL | - | - | 创建时间 |

**建表SQL:**
```sql
CREATE TABLE overall_routes (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '路线ID',
    project_id BIGINT NOT NULL COMMENT '项目ID',
    route_details TEXT COMMENT '路线详情',
    created_time DATETIME NOT NULL COMMENT '创建时间',
    INDEX idx_project (project_id),
    FOREIGN KEY (project_id) REFERENCES travel_projects(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='总体路线表';
```

#### 表8: activity_schedules (活动安排表)

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 约束 | 说明 |
|--------|---------|------|---------|--------|------|------|
| id | BIGINT | - | NOT NULL | AUTO_INCREMENT | PRIMARY KEY | 活动ID |
| project_id | BIGINT | - | NOT NULL | - | FOREIGN KEY | 项目ID |
| activity_name | VARCHAR | 100 | NOT NULL | - | - | 活动名称 |
| activity_time | DATETIME | - | NULL | NULL | - | 活动时间 |
| location | VARCHAR | 100 | NULL | NULL | - | 活动地点 |
| budget | DECIMAL | 10,2 | NULL | NULL | - | 活动预算 |
| day_number | INT | - | NULL | NULL | - | 第几天 |

**建表SQL:**
```sql
CREATE TABLE activity_schedules (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '活动ID',
    project_id BIGINT NOT NULL COMMENT '项目ID',
    activity_name VARCHAR(100) NOT NULL COMMENT '活动名称',
    activity_time DATETIME COMMENT '活动时间',
    location VARCHAR(100) COMMENT '活动地点',
    budget DECIMAL(10,2) COMMENT '活动预算',
    day_number INT COMMENT '第几天',
    INDEX idx_project (project_id),
    INDEX idx_day (day_number),
    FOREIGN KEY (project_id) REFERENCES travel_projects(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='活动安排表';
```

#### 表9: budgets (预算表)

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 约束 | 说明 |
|--------|---------|------|---------|--------|------|------|
| id | BIGINT | - | NOT NULL | AUTO_INCREMENT | PRIMARY KEY | 预算ID |
| project_id | BIGINT | - | NOT NULL | - | FOREIGN KEY | 项目ID |
| total_budget | DECIMAL | 10,2 | NOT NULL | - | - | 总预算 |
| used_budget | DECIMAL | 10,2 | NOT NULL | - | - | 已用预算 |
| remaining_budget | DECIMAL | 10,2 | NOT NULL | - | - | 剩余预算 |

**建表SQL:**
```sql
CREATE TABLE budgets (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '预算ID',
    project_id BIGINT NOT NULL COMMENT '项目ID',
    total_budget DECIMAL(10,2) NOT NULL COMMENT '总预算',
    used_budget DECIMAL(10,2) NOT NULL COMMENT '已用预算',
    remaining_budget DECIMAL(10,2) NOT NULL COMMENT '剩余预算',
    INDEX idx_project (project_id),
    FOREIGN KEY (project_id) REFERENCES travel_projects(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='预算表';
```

#### 表10: chat_messages (聊天消息表)

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 约束 | 说明 |
|--------|---------|------|---------|--------|------|------|
| id | BIGINT | - | NOT NULL | AUTO_INCREMENT | PRIMARY KEY | 消息ID |
| project_id | BIGINT | - | NOT NULL | - | FOREIGN KEY | 项目ID |
| user_id | BIGINT | - | NOT NULL | - | FOREIGN KEY | 用户ID |
| username | VARCHAR | 50 | NOT NULL | - | - | 用户名 |
| message | TEXT | - | NOT NULL | - | - | 消息内容 |
| created_time | DATETIME | - | NOT NULL | - | - | 创建时间 |

**建表SQL:**
```sql
CREATE TABLE chat_messages (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '消息ID',
    project_id BIGINT NOT NULL COMMENT '项目ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    username VARCHAR(50) NOT NULL COMMENT '用户名',
    message TEXT NOT NULL COMMENT '消息内容',
    created_time DATETIME NOT NULL COMMENT '创建时间',
    INDEX idx_project (project_id),
    INDEX idx_created (created_time),
    FOREIGN KEY (project_id) REFERENCES travel_projects(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='聊天消息表';
```

#### 表11: travel_sessions (旅行会话表)

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 约束 | 说明 |
|--------|---------|------|---------|--------|------|------|
| id | BIGINT | - | NOT NULL | AUTO_INCREMENT | PRIMARY KEY | 会话ID |
| project_id | BIGINT | - | NOT NULL | - | FOREIGN KEY | 项目ID |
| user_id | BIGINT | - | NOT NULL | - | FOREIGN KEY | 用户ID |
| message | TEXT | - | NULL | NULL | - | 消息内容 |
| message_time | DATETIME | - | NOT NULL | - | - | 消息时间 |
| mentioned_user_id | BIGINT | - | NULL | NULL | - | @提及的用户ID |

**建表SQL:**
```sql
CREATE TABLE travel_sessions (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '会话ID',
    project_id BIGINT NOT NULL COMMENT '项目ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    message TEXT COMMENT '消息内容',
    message_time DATETIME NOT NULL COMMENT '消息时间',
    mentioned_user_id BIGINT COMMENT '@提及的用户ID',
    INDEX idx_project (project_id),
    FOREIGN KEY (project_id) REFERENCES travel_projects(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='旅行会话表';
```

#### 表12: shared_documents (共享文档表)

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 约束 | 说明 |
|--------|---------|------|---------|--------|------|------|
| id | BIGINT | - | NOT NULL | AUTO_INCREMENT | PRIMARY KEY | 文档ID |
| project_id | BIGINT | - | NOT NULL | - | FOREIGN KEY | 项目ID |
| document_url | VARCHAR | 255 | NOT NULL | - | - | 文档URL |
| format | VARCHAR | 20 | NOT NULL | - | - | 文档格式(PDF/Word) |
| generated_time | DATETIME | - | NOT NULL | - | - | 生成时间 |
| share_link | VARCHAR | 255 | NULL | NULL | - | 分享链接 |
| creator_id | BIGINT | - | NOT NULL | - | FOREIGN KEY | 创建者ID |

**建表SQL:**
```sql
CREATE TABLE shared_documents (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '文档ID',
    project_id BIGINT NOT NULL COMMENT '项目ID',
    document_url VARCHAR(255) NOT NULL COMMENT '文档URL',
    format VARCHAR(20) NOT NULL COMMENT '文档格式(PDF/Word)',
    generated_time DATETIME NOT NULL COMMENT '生成时间',
    share_link VARCHAR(255) COMMENT '分享链接',
    creator_id BIGINT NOT NULL COMMENT '创建者ID',
    INDEX idx_project (project_id),
    FOREIGN KEY (project_id) REFERENCES travel_projects(id) ON DELETE CASCADE,
    FOREIGN KEY (creator_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='共享文档表';
```

---

## 3. 系统功能设计

### 3.1 系统功能模块图

```
途点儿啥系统
├── 用户管理模块
│   ├── 用户注册
│   ├── 用户登录
│   ├── 密码加密存储(BCrypt)
│   └── 邮箱验证码发送
│
├── 项目管理模块
│   ├── 创建旅行项目
│   ├── 项目列表查看
│   ├── 项目详情管理
│   ├── 项目状态更新
│   └── 项目删除
│
├── 协作需求收集模块
│   ├── 需求参数填写
│   ├── 兴趣标签选择
│   ├── 预算分配设置
│   ├── 期望/不喜欢列表
│   └── 参与者状态跟踪
│
├── AI路线生成模块
│   ├── Kimi AI集成
│   ├── 路线智能生成
│   ├── 多方案推荐
│   ├── 路线选择确认
│   └── 路线详情展示
│
├── 协作优化模块
│   ├── 实时聊天功能
│   ├── 景点添加/删除
│   ├── 预算实时计算
│   ├── 高德地图POI推荐
│   └── 权限管理(创建者/编辑者/查看者)
│
├── 文档导出模块
│   ├── PDF行程单生成
│   ├── 预算明细导出
│   └── 分享链接生成
│
└── 数据统计模块
    ├── 项目数量统计
    ├── 参与者统计
    └── 预算使用统计
```

### 3.2 核心功能模块设计

#### 3.2.1 用户管理模块

**功能描述**: 负责用户的注册、登录、认证和信息管理

**主要功能点**:
1. 用户注册
   - 用户名唯一性验证
   - 邮箱格式验证和唯一性检查
   - 邮箱验证码发送(Spring Mail + QQ邮箱SMTP)
   - 密码BCrypt加密存储

2. 用户登录
   - 用户名/邮箱登录
   - 密码验证
   - Session会话管理
   - 登录状态保持

3. 用户信息管理
   - 查看用户信息
   - 修改用户信息

**技术实现**:
- Controller: `UserController.java`
- Service: `UserService.java`, `EmailService.java`
- Repository: `UserRepository.java`
- Entity: `User.java`

**核心API接口**:
```
POST   /api/users/register          # 用户注册
POST   /api/users/login             # 用户登录
POST   /api/users/send-code         # 发送验证码
GET    /api/users/{id}              # 获取用户信息
PUT    /api/users/{id}              # 更新用户信息
GET    /api/users/email/{email}     # 根据邮箱查询用户
```

**业务流程**:
```
用户注册流程:
1. 用户填写注册信息(用户名、邮箱、密码)
2. 系统发送验证码到邮箱
3. 用户输入验证码
4. 系统验证验证码
5. 密码BCrypt加密
6. 保存用户信息到数据库
7. 返回注册成功

用户登录流程:
1. 用户输入用户名/邮箱和密码
2. 系统根据用户名/邮箱查询用户
3. BCrypt验证密码
4. 创建Session会话
5. 返回用户信息
```

#### 3.2.2 项目管理模块

**功能描述**: 负责旅行项目的创建、查询、更新和删除

**主要功能点**:
1. 创建旅行项目
   - 填写项目基本信息(名称、目的地、天数、日期)
   - 自动设置创建者
   - 初始化项目状态为"草稿"

2. 项目列表查看
   - 我创建的项目
   - 我编辑的项目
   - 我查看的项目
   - 根据状态筛选

3. 项目详情管理
   - 查看项目详细信息
   - 更新项目信息
   - 选择当前路线

4. 项目状态管理
   - 草稿
   - 规划中
   - 已归档

**技术实现**:
- Controller: `TravelProjectController.java`
- Service: `TravelProjectService.java`
- Repository: `TravelProjectRepository.java`
- Entity: `TravelProject.java`

**核心API接口**:
```
POST   /api/travel-projects          # 创建项目
GET    /api/travel-projects          # 获取项目列表
GET    /api/travel-projects/{id}     # 获取项目详情
PUT    /api/travel-projects/{id}     # 更新项目
DELETE /api/travel-projects/{id}     # 删除项目
GET    /api/travel-projects/creator/{creatorId}  # 根据创建者查询
GET    /api/travel-projects/status/{status}      # 根据状态查询
```

**业务流程**:
```
创建项目流程:
1. 用户填写项目信息
2. 系统生成项目ID
3. 设置创建者ID
4. 初始化状态为"草稿"
5. 保存项目到数据库
6. 创建项目参与者记录(角色:创建者)
7. 返回项目ID
```

#### 3.2.3 协作需求收集模块

**功能描述**: 收集所有参与者的旅行需求,为AI生成路线提供依据

**主要功能点**:
1. 需求参数填写
   - 兴趣标签选择(美食、文化、自然等)
   - 每日预算分配
   - 期望去的地方列表
   - 不喜欢的地方列表
   - 预算明细(交通、住宿、餐饮、门票、其他)

2. 参与者邀请
   - 生成邀请链接
   - 邀请链接分享
   - 参与者加入项目

3. 参与者状态跟踪
   - 待填写
   - 填写中
   - 已完成
   - 实时更新参与者列表

**技术实现**:
- Controller: `RequirementParameterController.java`, `ProjectParticipantController.java`
- Service: `RequirementParameterService.java`, `ProjectParticipantService.java`
- Repository: `RequirementParameterRepository.java`, `ProjectParticipantRepository.java`
- Entity: `RequirementParameter.java`, `ProjectParticipant.java`

**核心API接口**:
```
POST   /api/requirement-parameters                    # 创建需求参数
GET    /api/requirement-parameters/project/{projectId} # 获取项目需求列表
GET    /api/project-participants/project/{projectId}  # 获取参与者列表
POST   /api/project-participants                      # 添加参与者
PUT    /api/project-participants/{id}                 # 更新参与者状态
```

**业务流程**:
```
需求收集流程:
1. 创建者创建项目
2. 系统生成邀请链接
3. 创建者分享链接给参与者
4. 参与者打开链接,加入项目
5. 参与者填写需求参数
6. 系统保存需求数据
7. 更新参与者状态为"已完成"
8. 创建者查看所有参与者填写进度
9. 所有人完成后,开始AI生成路线
```

#### 3.2.4 AI路线生成模块

**功能描述**: 集成Kimi AI大模型,根据所有参与者需求自动生成个性化旅行路线

**主要功能点**:
1. AI路线生成
   - 整合所有参与者需求
   - 调用Kimi AI API
   - 生成3个不同风格的路线方案
   - 包含每日详细行程

2. 路线展示
   - 路线卡片展示(标题、标签、推荐指数)
   - 景点数量、餐厅数量统计
   - 预算预览
   - 封面图片展示

3. 路线选择
   - 对比多个方案
   - 选择确认当前方案
   - 进入协作优化阶段

**技术实现**:
- Controller: `AiGeneratedRouteController.java`
- Service: `KimiAIService.java`, `AiGeneratedRouteService.java`
- Repository: `AiGeneratedRouteRepository.java`
- Entity: `AiGeneratedRoute.java`

**核心API接口**:
```
POST   /api/ai-routes/generate                  # 生成AI路线
GET    /api/ai-routes/project/{projectId}       # 获取项目路线列表
GET    /api/ai-routes/{routeId}                 # 获取路线详情
PUT    /api/ai-routes/{routeId}                 # 更新路线
DELETE /api/ai-routes/{routeId}                 # 删除路线
```

**业务流程**:
```
AI路线生成流程:
1. 创建者点击"生成AI路线"
2. 系统收集所有参与者需求参数
3. 构造Prompt提示词
4. 调用Kimi AI API (moonshot-v1-8k)
5. 解析AI返回的JSON数据
6. 保存3个路线方案到数据库
7. 返回路线列表
8. 前端展示路线卡片
9. 用户选择路线
10. 进入协作优化界面
```

**Kimi AI集成配置**:
```yaml
kimi:
  api:
    key: sk-bCclui8VTON2LeiUgmNSUwPiC6FxmyIwpkXvidii4m4NQoTI
    url: https://api.moonshot.cn/v1/chat/completions
    model: moonshot-v1-8k
```

#### 3.2.5 协作优化模块

**功能描述**: 支持多人实时协作优化旅行路线,包括聊天、景点编辑、预算管理

**主要功能点**:
1. 实时聊天功能
   - 发送消息
   - 接收新消息(轮询)
   - 消息历史记录
   - 消息时间戳显示

2. 景点管理
   - 添加景点(手动/POI推荐)
   - 删除景点
   - 编辑景点信息
   - 景点排序

3. 预算管理
   - 每个景点/活动设置预算
   - 实时计算总预算
   - 超预算提示
   - 预算分配可视化

4. 高德地图POI推荐
   - 搜索附近景点
   - 分类筛选(景点/餐厅/酒店)
   - 一键添加到行程

5. 权限管理
   - 创建者:完全权限
   - 编辑者:编辑行程和预算
   - 查看者:仅查看

**技术实现**:
- Controller: `ChatMessageController.java`, `AiGeneratedRouteController.java`, `AmapTestController.java`
- Service: `ChatMessageService.java`, `AmapPoiService.java`
- Repository: `ChatMessageRepository.java`
- Entity: `ChatMessage.java`

**核心API接口**:
```
# 聊天功能
GET    /api/chat-messages/project/{projectId}     # 获取消息列表
POST   /api/chat-messages                         # 发送消息
GET    /api/chat-messages/project/{projectId}/new # 获取新消息

# 路线优化
PUT    /api/ai-routes/{routeId}                   # 更新路线(添加/删除景点)
GET    /api/ai-routes/{routeId}                   # 获取最新路线数据

# 高德地图POI
GET    /api/amap-test/poi/nearby                  # 搜索附近POI
```

**业务流程**:
```
协作优化流程:
1. 用户进入协作界面
2. 加载聊天历史和路线数据
3. 用户在聊天窗口讨论
4. 编辑者修改行程(添加/删除景点)
5. 实时更新预算计算
6. 显示超预算提示(如有)
7. 保存修改到数据库
8. 其他用户刷新看到最新数据
9. 重复步骤3-8直到满意
10. 导出PDF行程单
```

**权限控制**:
```
创建者权限:
- 修改行程
- 删除景点
- 管理成员权限
- 导出文档
- 归档项目

编辑者权限:
- 修改行程
- 添加/删除景点
- 修改预算
- 发送消息

查看者权限:
- 查看行程
- 发送消息
```

#### 3.2.6 文档导出模块

**功能描述**: 生成PDF格式的旅行行程单,包含完整行程和预算信息

**主要功能点**:
1. PDF生成
   - 项目基本信息
   - 每日行程详情
   - 景点/活动列表
   - 预算明细表
   - 协作成员信息

2. 文档分享
   - 生成分享链接
   - 下载PDF文件

**技术实现**:
- Controller: `PdfExportController.java`
- Service: `PdfExportService.java`
- Library: iText 7.2.5

**核心API接口**:
```
GET    /api/pdf/export/{projectId}    # 导出PDF
```

**PDF文档结构**:
```
途点儿啥 - 旅行行程单
==================
项目名称: 杭州3日游
目的地: 杭州
旅行天数: 3天
日期: 2025-12-15 至 2025-12-17
总预算: 2500元

第1天 - 西湖风光游
------------------
09:00 - 西湖-断桥残雪
       地点: 西湖风景区
       预算: 0元
       
11:00 - 雷峰塔
       地点: 南山路
       预算: 40元
       
12:30 - 外婆家(午餐)
       地点: 湖滨银泰
       预算: 80元

...

预算明细
--------
| 类别   | 预算 |
|--------|------|
| 交通   | 500  |
| 住宿   | 800  |
| 餐饮   | 600  |
| 门票   | 400  |
| 其他   | 200  |
| 总计   | 2500 |

参与成员
--------
- 张三 (创建者)
- 李四 (编辑者)
- 王五 (查看者)

生成时间: 2025-12-11 17:30:00
```

### 3.3 系统接口设计

#### 3.3.1 RESTful API设计规范

**URL设计原则**:
1. 使用名词表示资源 (如: /users, /projects)
2. 使用HTTP方法表示操作 (GET/POST/PUT/DELETE)
3. 使用路径参数传递ID (如: /users/{id})
4. 使用查询参数传递筛选条件 (如: ?status=active)

**HTTP方法语义**:
- GET: 查询资源
- POST: 创建资源
- PUT: 完整更新资源
- PATCH: 部分更新资源
- DELETE: 删除资源

**响应状态码**:
- 200 OK: 请求成功
- 201 Created: 创建成功
- 204 No Content: 删除成功
- 400 Bad Request: 请求参数错误
- 404 Not Found: 资源不存在
- 500 Internal Server Error: 服务器错误

#### 3.3.2 核心API接口汇总

**用户管理接口**
```
POST   /api/users/register              # 用户注册
POST   /api/users/login                 # 用户登录
POST   /api/users/send-code             # 发送验证码
GET    /api/users/{id}                  # 获取用户信息
PUT    /api/users/{id}                  # 更新用户信息
GET    /api/users/email/{email}         # 根据邮箱查询
```

**项目管理接口**
```
POST   /api/travel-projects             # 创建项目
GET    /api/travel-projects             # 获取项目列表
GET    /api/travel-projects/{id}        # 获取项目详情
PUT    /api/travel-projects/{id}        # 更新项目
DELETE /api/travel-projects/{id}        # 删除项目
GET    /api/travel-projects/creator/{creatorId}  # 根据创建者查询
GET    /api/travel-projects/status/{status}      # 根据状态查询
```

**参与者管理接口**
```
GET    /api/project-participants                      # 获取所有参与者
GET    /api/project-participants/{id}                 # 获取参与者详情
POST   /api/project-participants                      # 添加参与者
PUT    /api/project-participants/{id}                 # 更新参与者
DELETE /api/project-participants/{id}                 # 删除参与者
GET    /api/project-participants/project/{projectId}  # 根据项目查询
GET    /api/project-participants/user/{userId}        # 根据用户查询
```

**需求参数接口**
```
GET    /api/requirement-parameters                      # 获取所有需求
GET    /api/requirement-parameters/{id}                 # 获取需求详情
POST   /api/requirement-parameters                      # 创建需求
PUT    /api/requirement-parameters/{id}                 # 更新需求
DELETE /api/requirement-parameters/{id}                 # 删除需求
GET    /api/requirement-parameters/project/{projectId}  # 根据项目查询
```

**AI路线接口**
```
POST   /api/ai-routes/generate             # 生成AI路线
GET    /api/ai-routes                      # 获取所有路线
GET    /api/ai-routes/{routeId}            # 获取路线详情
PUT    /api/ai-routes/{routeId}            # 更新路线
DELETE /api/ai-routes/{routeId}            # 删除路线
GET    /api/ai-routes/project/{projectId}  # 根据项目查询
```

**聊天消息接口**
```
GET    /api/chat-messages/project/{projectId}           # 获取消息列表
POST   /api/chat-messages                               # 发送消息
DELETE /api/chat-messages/{id}                          # 删除消息
GET    /api/chat-messages/project/{projectId}/new       # 获取新消息
```

**预算管理接口**
```
GET    /api/budgets                        # 获取所有预算
GET    /api/budgets/{id}                   # 获取预算详情
POST   /api/budgets                        # 创建预算
PUT    /api/budgets/{id}                   # 更新预算
DELETE /api/budgets/{id}                   # 删除预算
GET    /api/budgets/project/{projectId}    # 根据项目查询
```

**文档导出接口**
```
GET    /api/pdf/export/{projectId}         # 导出PDF
```

**高德地图接口**
```
GET    /api/amap-test/poi/nearby           # 搜索附近POI
```

**邮件发送接口**
```
POST   /api/email/send-code                # 发送验证码
```

#### 3.3.3 接口请求/响应示例

**示例1: 用户注册**

请求:
```http
POST /api/users/register HTTP/1.1
Content-Type: application/json

{
  "username": "zhangsan",
  "email": "zhangsan@example.com",
  "password": "123456",
  "verificationCode": "123456"
}
```

响应:
```http
HTTP/1.1 201 Created
Content-Type: application/json

{
  "id": 1,
  "username": "zhangsan",
  "email": "zhangsan@example.com"
}
```

**示例2: 创建项目**

请求:
```http
POST /api/travel-projects HTTP/1.1
Content-Type: application/json

{
  "projectName": "杭州3日游",
  "destination": "杭州",
  "days": 3,
  "creatorId": 1,
  "status": "草稿",
  "startDate": "2025-12-15",
  "endDate": "2025-12-17",
  "totalBudget": 2500.00
}
```

响应:
```http
HTTP/1.1 201 Created
Content-Type: application/json

{
  "id": 10,
  "projectName": "杭州3日游",
  "destination": "杭州",
  "days": 3,
  "creatorId": 1,
  "status": "草稿",
  "createdTime": "2025-12-11T17:30:00",
  "updatedTime": "2025-12-11T17:30:00",
  "startDate": "2025-12-15",
  "endDate": "2025-12-17",
  "totalBudget": 2500.00
}
```

**示例3: 获取项目路线列表**

请求:
```http
GET /api/ai-routes/project/10 HTTP/1.1
```

响应:
```http
HTTP/1.1 200 OK
Content-Type: application/json

[
  {
    "id": 1,
    "projectId": 10,
    "routeTitle": "杭州文化深度游",
    "routeTag": "文化",
    "attractionsCount": 8,
    "restaurantsCount": 6,
    "transportMode": "地铁+步行",
    "totalBudget": 2300,
    "recommendationScore": 5,
    "coverImageUrl": "https://example.com/cover1.jpg",
    "dailyItinerary": "[...]",
    "budgetsJson": "{...}"
  },
  {
    "id": 2,
    "projectId": 10,
    "routeTitle": "杭州美食探索之旅",
    "routeTag": "美食",
    "attractionsCount": 5,
    "restaurantsCount": 12,
    "totalBudget": 2800,
    "recommendationScore": 4
  }
]
```

**示例4: 发送聊天消息**

请求:
```http
POST /api/chat-messages HTTP/1.1
Content-Type: application/json

{
  "projectId": 10,
  "userId": 1,
  "username": "张三",
  "message": "我觉得第一天可以加上灵隐寺"
}
```

响应:
```http
HTTP/1.1 201 Created
Content-Type: application/json

{
  "id": 25,
  "projectId": 10,
  "userId": 1,
  "username": "张三",
  "message": "我觉得第一天可以加上灵隐寺",
  "createdTime": "2025-12-11T18:00:00"
}
```

---

## 4. 系统架构设计

### 4.1 技术架构图

```
┌─────────────────────────────────────────────────────────┐
│                    前端层 (Presentation Layer)            │
│         HTML5 + CSS3 + JavaScript (原生)                 │
│  login.html | index.html | create-project.html ...      │
└─────────────────┬───────────────────────────────────────┘
                  │ HTTP/REST API
┌─────────────────┴───────────────────────────────────────┐
│              控制层 (Controller Layer)                    │
│    UserController | ProjectController | AIRouteController│
└─────────────────┬───────────────────────────────────────┘
                  │
┌─────────────────┴───────────────────────────────────────┐
│              业务逻辑层 (Service Layer)                   │
│    UserService | ProjectService | KimiAIService ...     │
└─────────────────┬───────────────────────────────────────┘
                  │
┌─────────────────┴───────────────────────────────────────┐
│            数据访问层 (Repository Layer)                  │
│    JPA Repository + MyBatis Mapper                       │
└─────────────────┬───────────────────────────────────────┘
                  │
┌─────────────────┴───────────────────────────────────────┐
│                  数据层 (Data Layer)                      │
│             MySQL 8.0.29 Database                        │
│    users | travel_projects | ai_generated_routes ...    │
└─────────────────────────────────────────────────────────┘

            第三方服务集成
┌──────────────┬──────────────┬──────────────┐
│  Kimi AI API │ 高德地图 API  │ Spring Mail  │
│  (moonshot)  │   (Amap)     │  (QQ SMTP)   │
└──────────────┴──────────────┴──────────────┘
```

### 4.2 系统部署架构

```
┌──────────────────────────────────────┐
│          客户端浏览器                  │
│    (Chrome/Firefox/Safari/Edge)      │
└─────────────┬────────────────────────┘
              │ HTTPS
┌─────────────┴────────────────────────┐
│        Nginx反向代理服务器             │
│      (端口: 80/443)                   │
└─────────────┬────────────────────────┘
              │
┌─────────────┴────────────────────────┐
��      Spring Boot应用服务器            │
│      (端口: 8010)                     │
│  - Tomcat内嵌容器                     │
│  - Spring MVC                        │
│  - Spring Data JPA                   │
│  - MyBatis                           │
└─────────────┬────────────────────────┘
              │ JDBC
┌─────────────┴────────────────────────┐
│         MySQL数据库服务器             │
│         (端口: 3306)                 │
│    tudianersha数据库                 │
└──────────────────────────────────────┘
```

### 4.3 MVC三层架构设计

**Controller层 (控制层)**:
- 职责: 接收HTTP请求,调用Service层,返回响应
- 注解: @RestController, @RequestMapping
- 示例: UserController, TravelProjectController

**Service层 (业务逻辑层)**:
- 职责: 处理业务逻辑,事务管理
- 注解: @Service, @Transactional
- 示例: UserService, KimiAIService

**Repository层 (数据访问层)**:
- 职责: 数据库CRUD操作
- 技术: Spring Data JPA + MyBatis
- 示例: UserRepository, TravelProjectRepository

**Entity层 (实体层)**:
- 职责: 数据库表映射
- 注解: @Entity, @Table, @Column
- 示例: User, TravelProject

### 4.4 数据流程图

```
用户请求 → Controller → Service → Repository → Database
                ↓
            Validation
                ↓
           Business Logic
                ↓
         Transaction Management
                ↓
            返回响应
```

### 4.5 安全架构设计

**密码安全**:
- 使用BCrypt算法加密存储
- 密码强度验证
- 防止SQL注入

**Session管理**:
- 使用Spring Session
- Session超时设置
- 登录状态验证

**跨域配置**:
- CORS配置允许前端访问
- 限制允许的域名和方法

**API安全**:
- API Key管理(Kimi AI, 高德地图)
- 请求频率限制
- 异常处理和日志记录

---

## 5. 附录

### 5.1 完整建表SQL脚本

```sql
-- 创建数据库
CREATE DATABASE IF NOT EXISTS tudianersha 
  DEFAULT CHARACTER SET utf8mb4 
  DEFAULT COLLATE utf8mb4_unicode_ci;

USE tudianersha;

-- 1. 用户表
CREATE TABLE users (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '用户ID',
    username VARCHAR(50) NOT NULL UNIQUE COMMENT '用户名',
    email VARCHAR(100) NOT NULL UNIQUE COMMENT '邮箱',
    password VARCHAR(100) NOT NULL COMMENT '密码(BCrypt加密)',
    INDEX idx_username (username),
    INDEX idx_email (email)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户表';

-- 2. 旅行项目表
CREATE TABLE travel_projects (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '项目ID',
    project_name VARCHAR(100) NOT NULL COMMENT '项目名称',
    destination VARCHAR(100) NOT NULL COMMENT '目的地',
    days INT NOT NULL COMMENT '旅行天数',
    creator_id BIGINT NOT NULL COMMENT '创建者ID',
    status VARCHAR(20) NOT NULL DEFAULT 'planning' COMMENT '项目状态:草稿/规划中/已归档',
    created_time DATETIME NOT NULL COMMENT '创建时间',
    updated_time DATETIME NOT NULL COMMENT '更新时间',
    current_route_id BIGINT COMMENT '当前选择的路线ID',
    start_date DATE COMMENT '开始日期',
    end_date DATE COMMENT '结束日期',
    total_budget DECIMAL(10,2) COMMENT '总预算',
    INDEX idx_creator (creator_id),
    INDEX idx_status (status),
    FOREIGN KEY (creator_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='旅行项目表';

-- 3. 项目参与者表
CREATE TABLE project_participants (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '参与者ID',
    project_id BIGINT NOT NULL COMMENT '项目ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    role VARCHAR(20) NOT NULL COMMENT '角色:创建者/编辑者/查看者',
    join_time DATETIME NOT NULL COMMENT '加入时间',
    INDEX idx_project (project_id),
    INDEX idx_user (user_id),
    UNIQUE KEY uk_project_user (project_id, user_id),
    FOREIGN KEY (project_id) REFERENCES travel_projects(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='项目参与者表';

-- 4. 旅行参与者表
CREATE TABLE travel_participants (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '参与者ID',
    project_id BIGINT NOT NULL COMMENT '项目ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    permission VARCHAR(20) NOT NULL COMMENT '权限:创建者/编辑者/查看者',
    INDEX idx_project (project_id),
    INDEX idx_user (user_id),
    FOREIGN KEY (project_id) REFERENCES travel_projects(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='旅行参与者表';

-- 5. 需求参数表
CREATE TABLE requirement_parameters (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '参数ID',
    project_id BIGINT NOT NULL COMMENT '项目ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    interest_tags VARCHAR(200) COMMENT '兴趣标签(逗号分隔)',
    daily_budget_allocation DECIMAL(10,2) COMMENT '每日预算分配',
    wishlist TEXT COMMENT '期望列表',
    dislike_list TEXT COMMENT '不喜欢列表',
    budget_breakdown TEXT COMMENT '预算明细(JSON)',
    INDEX idx_project (project_id),
    INDEX idx_user (user_id),
    FOREIGN KEY (project_id) REFERENCES travel_projects(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='需求参数表';

-- 6. AI生成路线表
CREATE TABLE ai_generated_routes (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '路线ID',
    project_id BIGINT NOT NULL COMMENT '项目ID',
    route_content TEXT COMMENT '路线内容',
    generated_time DATETIME NOT NULL COMMENT '生成时间',
    interest_tags VARCHAR(200) COMMENT '兴趣标签',
    route_title VARCHAR(100) COMMENT '路线名称',
    route_tag VARCHAR(50) COMMENT '特色标签',
    attractions_count INT COMMENT '景点数量',
    restaurants_count INT COMMENT '餐厅数量',
    transport_mode VARCHAR(50) COMMENT '交通方式',
    total_budget INT COMMENT '总预算',
    recommendation_score INT COMMENT '推荐指数(1-5星)',
    daily_itinerary TEXT COMMENT '每日行程(JSON)',
    cover_image_url TEXT COMMENT '封面图片URL',
    budgets_json TEXT COMMENT '预算数据(JSON)',
    INDEX idx_project (project_id),
    FOREIGN KEY (project_id) REFERENCES travel_projects(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='AI生成路线表';

-- 7. 总体路线表
CREATE TABLE overall_routes (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '路线ID',
    project_id BIGINT NOT NULL COMMENT '项目ID',
    route_details TEXT COMMENT '路线详情',
    created_time DATETIME NOT NULL COMMENT '创建时间',
    INDEX idx_project (project_id),
    FOREIGN KEY (project_id) REFERENCES travel_projects(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='总体路线表';

-- 8. 活动安排表
CREATE TABLE activity_schedules (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '活动ID',
    project_id BIGINT NOT NULL COMMENT '项目ID',
    activity_name VARCHAR(100) NOT NULL COMMENT '活动名称',
    activity_time DATETIME COMMENT '活动时间',
    location VARCHAR(100) COMMENT '活动地点',
    budget DECIMAL(10,2) COMMENT '活动预算',
    day_number INT COMMENT '第几天',
    INDEX idx_project (project_id),
    INDEX idx_day (day_number),
    FOREIGN KEY (project_id) REFERENCES travel_projects(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='活动安排表';

-- 9. 预算表
CREATE TABLE budgets (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '预算ID',
    project_id BIGINT NOT NULL COMMENT '项目ID',
    total_budget DECIMAL(10,2) NOT NULL COMMENT '总预算',
    used_budget DECIMAL(10,2) NOT NULL COMMENT '已用预算',
    remaining_budget DECIMAL(10,2) NOT NULL COMMENT '剩余预算',
    INDEX idx_project (project_id),
    FOREIGN KEY (project_id) REFERENCES travel_projects(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='预算表';

-- 10. 聊天消息表
CREATE TABLE chat_messages (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '消息ID',
    project_id BIGINT NOT NULL COMMENT '项目ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    username VARCHAR(50) NOT NULL COMMENT '用户名',
    message TEXT NOT NULL COMMENT '消息内容',
    created_time DATETIME NOT NULL COMMENT '创建时间',
    INDEX idx_project (project_id),
    INDEX idx_created (created_time),
    FOREIGN KEY (project_id) REFERENCES travel_projects(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='聊天消息表';

-- 11. 旅行会话表
CREATE TABLE travel_sessions (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '会话ID',
    project_id BIGINT NOT NULL COMMENT '项目ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    message TEXT COMMENT '消息内容',
    message_time DATETIME NOT NULL COMMENT '消息时间',
    mentioned_user_id BIGINT COMMENT '@提及的用户ID',
    INDEX idx_project (project_id),
    FOREIGN KEY (project_id) REFERENCES travel_projects(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='旅行会话表';

-- 12. 共享文档表
CREATE TABLE shared_documents (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '文档ID',
    project_id BIGINT NOT NULL COMMENT '项目ID',
    document_url VARCHAR(255) NOT NULL COMMENT '文档URL',
    format VARCHAR(20) NOT NULL COMMENT '文档格式(PDF/Word)',
    generated_time DATETIME NOT NULL COMMENT '生成时间',
    share_link VARCHAR(255) COMMENT '分享链接',
    creator_id BIGINT NOT NULL COMMENT '创建者ID',
    INDEX idx_project (project_id),
    FOREIGN KEY (project_id) REFERENCES travel_projects(id) ON DELETE CASCADE,
    FOREIGN KEY (creator_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='共享文档表';
```

### 5.2 系统配置文件

**application.yml配置**:
```yaml
server:
  port: 8010

spring:
  datasource:
    url: jdbc:mysql://localhost:3306/tudianersha?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=GMT%2B8
    username: root
    password: 123456
    driver-class-name: com.mysql.cj.jdbc.Driver
  
  jpa:
    hibernate:
      ddl-auto: update
    show-sql: true
    database-platform: org.hibernate.dialect.MySQL8Dialect

  # Mail Configuration
  mail:
    host: smtp.qq.com
    port: 587
    username: 2230845112@qq.com
    password: snqivklkwjeieabj
    properties:
      mail:
        smtp:
          auth: true
          starttls:
            enable: true
            required: true

mybatis:
  mapper-locations: classpath:mapper/*.xml
  type-aliases-package: com.tudianersha.entity

logging:
  level:
    com.tudianersha: debug

# Kimi AI Configuration
kimi:
  api:
    key: sk-bCclui8VTON2LeiUgmNSUwPiC6FxmyIwpkXvidii4m4NQoTI
    url: https://api.moonshot.cn/v1/chat/completions
    model: moonshot-v1-8k

# Amap API Configuration
amap:
  api:
    key: 4290f3a6e308a95a70bc29f5577a6a21
```

### 5.3 项目文件结构

```
tudianersha/
├── src/main/java/com/tudianersha/
│   ├── Application.java                 # 主启动类
│   ├── config/                          # 配置类
│   │   ├── DatabaseConfig.java          # 数据库配置
│   │   └── WebConfig.java              # Web配置(CORS)
│   ├── controller/                      # 控制器层(18个)
│   │   ├── UserController.java          # 用户管理
│   │   ├── TravelProjectController.java # 项目管理
│   │   ├── AiGeneratedRouteController.java # AI路线
│   │   ├── ChatMessageController.java   # 聊天功能
│   │   ├── BudgetController.java        # 预算管理
│   │   ├── PdfExportController.java     # PDF导出
│   │   └── ...                         # 其他控制器
│   ├── entity/                          # 实体类(12个)
│   │   ├── User.java                    # 用户实体
│   │   ├── TravelProject.java           # 项目实体
│   │   ├── AiGeneratedRoute.java        # AI路线实体
│   │   └── ...                         # 其他实体
│   ├── repository/                      # 数据访问层(JPA)
│   │   ├── UserRepository.java
│   │   ├── TravelProjectRepository.java
│   │   └── ...
│   ├── service/                         # 业务逻辑层
│   │   ├── UserService.java
│   │   ├── KimiAIService.java          # Kimi AI服务
│   │   ├── AmapPoiService.java         # 高德地图服务
│   │   ├── EmailService.java           # 邮件服务
│   │   ├── PdfExportService.java       # PDF导出服务
│   │   └── ...
│   └── util/                            # 工具类
├── src/main/resources/
│   ├── static/                          # 静态资源
│   │   ├── css/common.css              # 样式文件
│   │   ├── js/common.js                # 公共JS
│   │   ├── login.html                  # 登录页面
│   │   ├── register.html               # 注册页面
│   │   ├── index.html                  # 主页
│   │   ├── create-project.html         # 创建项目
│   │   ├── collaboration.html          # 协作界面
│   │   ├── participants-status.html    # 参与者状态
│   │   └── route-selection.html        # 路线选择
│   ├── mapper/                          # MyBatis Mapper XML
│   ├── application.yml                  # 应用配置
│   ├── schema.sql                       # 数据库表结构
│   └── data.sql                         # 初始数据
├── pom.xml                              # Maven配置
└── README.md                            # 项目说明
```

### 5.4 技术栈清单

**后端技术**:
- Spring Boot 2.7.0 - 核心应用框架
- Spring Data JPA - ORM持久化
- MyBatis 2.2.2 - SQL映射框架
- Spring Security Crypto - 密码加密
- Spring Mail - 邮件服务
- MySQL Connector 8.0.29 - 数据库驱动
- Hibernate - JPA实现

**前端技术**:
- HTML5 - 页面结构
- CSS3 - 样式设计
- JavaScript (ES6+) - 交互逻辑
- Fetch API - 异步请求
- LocalStorage - 本地存储

**第三方集成**:
- Kimi AI (moonshot-v1-8k) - AI路线生成
- 高德地图API - POI推荐
- iText 7.2.5 - PDF生成
- OkHttp 4.10.0 - HTTP客户端
- Gson 2.9.0 - JSON处理

**开发工具**:
- IntelliJ IDEA - IDE
- Maven - 项目管理
- Git - 版本控制
- Navicat - 数据库管理

### 5.5 系统特色功能

1. **AI智能规划**: 首个集成Kimi AI大模型的旅行规划系统，自动生成个性化路线
2. **实时协作**: 支持多人同时编辑，类似Google Docs的协作体验
3. **POI智能推荐**: 集成高德地图API，根据位置推荐周边景点
4. **预算智能管理**: 实时计算预算，超支自动提示
5. **权限精细控制**: 创建者、编辑者、查看者三级权限管理
6. **一键PDF导出**: 完整行程单一键生成，方便分享和打印
7. **邮箱验证注册**: 使用QQ邮箱SMTP发送验证码，保证用户真实性
8. **双持久化方案**: JPA + MyBatis互补，灵活应对不同场景

### 5.6 系统优势分析

**对比传统旅行规划方式**:

| 对比项 | 传统方式 | 途点儿啥系统 |
|--------|---------|-------------|
| 信息收集 | 需要浏览多个网站 | AI自动推荐，一站式解决 |
| 多人协作 | 微信/QQ讨论，效率低 | 实时协作界面，所见即所得 |
| 行程规划 | 手工整理Excel | AI智能生成3种方案选择 |
| 预算管理 | 手动记账，容易超支 | 实时计算，超支自动提醒 |
| 文档分享 | Word/PDF手动编辑 | 一键生成专业PDF行程单 |
| 景点推荐 | 依赖攻略，不够个性化 | 基于需求AI推荐+地图POI |

**技术优势**:
1. 前后端分离架构，易于维护和扩展
2. RESTful API设计，接口规范统一
3. 双持久化方案，性能和灵活性兼顾
4. 第三方API集成，功能强大
5. 模块化设计，代码复用性高

---

## 总结

本设计文档详细描述了"途点儿啥"协作式旅行规划系统的数据库设计和系统功能设计。

**数据库设计亮点**:
- 12张核心数据表，完整覆盖业务需求
- 规范的命名和约束设计
- 合理的外键关系和索引优化
- 支持JSON字段存储复杂数据

**系统功能亮点**:
- 6大核心功能模块，功能完整
- 50+个RESTful API接口
- AI智能路线生成
- 实时协作优化
- PDF文档导出

**技术实现亮点**:
- Spring Boot现代化开发框架
- 前后端分离架构
- 第三方API深度集成
- 安全性和性能兼顾

系统已完成开发并上线运行，为用户提供了智能、高效、协作的旅行规划体验。

---

**编写人**: HappCoding团队  
**审核人**: 指导老师  
**完成日期**: 2025年12月11日  
**文档版本**: v2.0