<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‚ä¸æˆå‘˜çŠ¶æ€ - é€”ç‚¹å„¿å•¥</title>
    <link rel="stylesheet" href="/css/common.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .status-container {
            max-width: 900px;
            margin: 40px auto;
            padding: 0 24px;
        }
        
        .status-card {
            background: white;
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .status-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f3f4f6;
        }
        
        .status-title {
            font-size: 24px;
            font-weight: 700;
            color: #111827;
        }
        
        .status-section {
            margin-bottom: 32px;
        }
        
        .section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #374151;
        }
        
        .section-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
        }
        
        .badge-pending {
            background: #fef3c7;
            color: #d97706;
        }
        
        .badge-completed {
            background: #d1fae5;
            color: #059669;
        }
        
        .participant-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .participant-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: #f9fafb;
            border-radius: 12px;
            border: 2px solid #e5e7eb;
            transition: all 0.2s;
        }
        
        .participant-item:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }
        
        .participant-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            font-weight: 700;
            flex-shrink: 0;
        }
        
        .participant-info {
            flex: 1;
        }
        
        .participant-name {
            font-size: 16px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 4px;
        }
        
        .participant-email {
            font-size: 13px;
            color: #6b7280;
        }
        
        .participant-status {
            padding: 6px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
        }
        
        .status-pending {
            background: #fef3c7;
            color: #d97706;
        }
        
        .status-completed {
            background: #d1fae5;
            color: #059669;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #9ca3af;
        }
        
        .action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 32px;
        }
        
        .btn {
            flex: 1;
            padding: 14px 24px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
        }
        
        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }
        
        .btn-secondary:hover {
            background: #e5e7eb;
        }
    </style>
</head>
<body class="bg-gray-50">
    <nav class="navbar">
        <div class="container">
            <a href="/index.html" class="navbar-brand" style="display: flex; align-items: center; gap: 8px; text-decoration: none;">
                <div style="background: #3b82f6; width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white">
                        <path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/>
                    </svg>
                </div>
                <div>
                    <div style="font-size: 1.5rem; font-weight: 700; color: #3b82f6; line-height: 1.2;">é€”ç‚¹å„¿å•¥</div>
                    <div style="font-size: 0.75rem; color: #6b7280;">è®©æ—…é€”ä¸ç³Šæ¶‚</div>
                </div>
            </a>
            <div class="navbar-menu">
                <a href="/index.html">è¿”å›é¦–é¡µ</a>
                <a href="#" onclick="auth.logout(); return false;">é€€å‡ºç™»å½•</a>
            </div>
        </div>
    </nav>
    
    <div class="status-container">
        <div class="status-card">
            <div class="status-header">
                <div>
                    <div class="status-title" id="projectTitle">é¡¹ç›®å‚ä¸æˆå‘˜</div>
                    <p style="font-size: 14px; color: #6b7280; margin-top: 8px;">æŸ¥çœ‹æ‰€æœ‰å‚ä¸è€…çš„å¡«å†™çŠ¶æ€</p>
                </div>
                <button onclick="window.history.back()" class="btn-secondary" style="padding: 10px 20px;">
                    â† è¿”å›
                </button>
            </div>
            
            <!-- æ­£åœ¨å¡«å†™ -->
            <div class="status-section">
                <div class="section-header">
                    <span style="font-size: 24px;">â³</span>
                    <span class="section-title">æ­£åœ¨å¡«å†™</span>
                    <span class="section-badge badge-pending" id="pendingCount">0 äºº</span>
                </div>
                <div class="participant-list" id="pendingList">
                    <div class="empty-state">æš‚æ— æ­£åœ¨å¡«å†™çš„æˆå‘˜</div>
                </div>
            </div>
            
            <!-- å·²å®Œæˆå¡«å†™ -->
            <div class="status-section">
                <div class="section-header">
                    <span style="font-size: 24px;">âœ…</span>
                    <span class="section-title">å·²å®Œæˆå¡«å†™</span>
                    <span class="section-badge badge-completed" id="completedCount">0 äºº</span>
                </div>
                <div class="participant-list" id="completedList">
                    <div class="empty-state">æš‚æ— å·²å®Œæˆçš„æˆå‘˜</div>
                </div>
            </div>
            
            <!-- æ“ä½œæŒ‰é’® -->
            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="copyInviteLink()">
                    ğŸ“‹ å¤åˆ¶é‚€è¯·é“¾æ¥
                </button>
                <button class="btn btn-primary" id="generateRouteBtn" onclick="generateAIRoute()">
                    ğŸ¤– ç”ŸæˆAIè·¯çº¿æ–¹æ¡ˆ
                </button>
            </div>
        </div>
    </div>
    
    <script src="/js/common.js"></script>
    <script>
        auth.checkAuth();
        
        const currentUser = auth.getUser();
        const projectId = getQueryParam('id');
        
        let participants = [];
        let projectData = null;
        
        // Load project and participants data
        async function loadData() {
            try {
                // Load project info
                const projectResponse = await fetch(`/api/travel-projects/${projectId}`);
                if (projectResponse.ok) {
                    projectData = await projectResponse.json();
                    document.getElementById('projectTitle').textContent = `${projectData.projectName} - å‚ä¸æˆå‘˜`;
                }
                
                // Load participants
                const participantsResponse = await fetch(`/api/project-participants/project/${projectId}`);
                if (participantsResponse.ok) {
                    const allParticipants = await participantsResponse.json();
                    
                    // è¿‡æ»¤æ‰åˆ›å»ºè€…ï¼Œåªæ˜¾ç¤ºå‚ä¸è€…
                    participants = allParticipants.filter(p => 
                        p.role !== 'åˆ›å»ºè€…' && p.userId !== projectData.creatorId
                    );
                    
                    // Load user details and requirement status for each participant
                    for (let participant of participants) {
                        try {
                            // Get user info
                            const userResponse = await fetch(`/api/users/${participant.userId}`);
                            if (userResponse.ok) {
                                const apiResult = await userResponse.json();
                                // åç«¯è¿”å›çš„æ˜¯ ApiResponse æ ¼å¼: {success: true, data: {...}}
                                participant.userInfo = apiResult.data || apiResult;
                            }
                            
                            // Check if user has submitted requirements
                            const reqResponse = await fetch(`/api/requirement-parameters/project/${projectId}/all`);
                            if (reqResponse.ok) {
                                const requirements = await reqResponse.json();
                                const userReq = requirements.find(r => r.userId === participant.userId);
                                participant.hasSubmitted = !!userReq;
                            } else {
                                participant.hasSubmitted = false;
                            }
                        } catch (err) {
                            console.error('Error loading participant details:', err);
                            participant.hasSubmitted = false;
                        }
                    }
                    
                    renderParticipants();
                }
            } catch (error) {
                console.error('Error loading data:', error);
                showError('åŠ è½½æ•°æ®å¤±è´¥');
            }
        }
        
        // Render participants
        function renderParticipants() {
            const pending = participants.filter(p => !p.hasSubmitted);
            const completed = participants.filter(p => p.hasSubmitted);
            
            // Update counts
            document.getElementById('pendingCount').textContent = `${pending.length} äºº`;
            document.getElementById('completedCount').textContent = `${completed.length} äºº`;
            
            // Render pending list
            const pendingList = document.getElementById('pendingList');
            if (pending.length === 0) {
                pendingList.innerHTML = '<div class="empty-state">æš‚æ— æ­£åœ¨å¡«å†™çš„å‚ä¸è€…</div>';
            } else {
                pendingList.innerHTML = pending.map(p => renderParticipantItem(p)).join('');
            }
            
            // Render completed list
            const completedList = document.getElementById('completedList');
            if (completed.length === 0) {
                completedList.innerHTML = '<div class="empty-state">æš‚æ— å·²å®Œæˆçš„å‚ä¸è€…</div>';
            } else {
                completedList.innerHTML = completed.map(p => renderParticipantItem(p)).join('');
            }
            
            // å¦‚æœæ²¡æœ‰ä»»ä½•å‚ä¸è€…ï¼Œæ˜¾ç¤ºæç¤º
            if (participants.length === 0) {
                pendingList.innerHTML = '<div class="empty-state">è¿˜æ²¡æœ‰å‚ä¸è€…åŠ å…¥ï¼Œè¯·å¤åˆ¶é‚€è¯·é“¾æ¥åˆ†äº«ç»™å…¶ä»–äººğŸ‘‡</div>';
            }
        }
        
        // Render participant item
        function renderParticipantItem(participant) {
            const username = participant.userInfo?.username || `ç”¨æˆ·${participant.userId}`;
            const email = participant.userInfo?.email || '';
            const initial = username.charAt(0).toUpperCase();
            const statusClass = participant.hasSubmitted ? 'status-completed' : 'status-pending';
            const statusText = participant.hasSubmitted ? 'å·²å®Œæˆ' : 'å¡«å†™ä¸­';
            
            return `
                <div class="participant-item">
                    <div class="participant-avatar">${initial}</div>
                    <div class="participant-info">
                        <div class="participant-name">${username}</div>
                        <div class="participant-email">${email}</div>
                    </div>
                    <div class="participant-status ${statusClass}">${statusText}</div>
                </div>
            `;
        }
        
        // Copy invite link
        function copyInviteLink() {
            const token = Math.random().toString(36).substring(2, 15);
            // é‚€è¯·å‚ä¸è€…å¡«å†™éœ€æ±‚çš„é“¾æ¥
            const shareUrl = `${window.location.origin}/create-project.html?projectId=${projectId}&token=${token}`;
            
            const tempInput = document.createElement('input');
            tempInput.value = shareUrl;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
            
            showSuccess('é‚€è¯·é“¾æ¥å·²å¤åˆ¶ï¼å‚ä¸è€…å¯å¡«å†™è‡ªå·±çš„åå¥½');
        }
        
        // Generate AI route and navigate to route selection
        async function generateAIRoute() {
            const completed = participants.filter(p => p.hasSubmitted);
                        
            // æ£€æŸ¥æ˜¯å¦æœ‰å‚ä¸è€…å®Œæˆå¡«å†™
            if (completed.length === 0 && participants.length > 0) {
                showError('è¯·ç­‰å¾…è‡³å°‘ä¸€ä½å‚ä¸è€…å®Œæˆå¡«å†™åå†ç”Ÿæˆè·¯çº¿');
                return;
            }
                        
            const btn = document.getElementById('generateRouteBtn');
            btn.disabled = true;
            btn.textContent = 'ğŸ”„ æ­£åœ¨ç”ŸæˆAIè·¯çº¿...';
            btn.style.opacity = '0.6';
                        
            try {
                // è°ƒç”¨AIç”Ÿæˆè·¯çº¿çš„API
                const response = await fetch(`/api/ai-generated-routes/generate/${projectId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                            
                const result = await response.json();
                            
                if (result.success) {
                    showSuccess('è·¯çº¿ç”ŸæˆæˆåŠŸï¼æ­£åœ¨è·³è½¬åˆ°é€‰æ‹©ç•Œé¢...');
                                
                    // è·³è½¬åˆ°è·¯çº¿é€‰æ‹©ç•Œé¢
                    setTimeout(() => {
                        navigate(`/route-selection.html?id=${projectId}`);
                    }, 1000);
                } else {
                    throw new Error(result.message || 'AIè·¯çº¿ç”Ÿæˆå¤±è´¥');
                }
                            
            } catch (error) {
                console.error('Error generating AI route:', error);
                showError(error.message || 'AIè·¯çº¿ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
                            
                btn.disabled = false;
                btn.textContent = 'ğŸ¤– ç”ŸæˆAIè·¯çº¿æ–¹æ¡ˆ';
                btn.style.opacity = '1';
            }
        }
        
        // Initialize
        loadData();
        
        // Auto refresh every 5 seconds
        setInterval(loadData, 5000);
    </script>
</body>
</html>
