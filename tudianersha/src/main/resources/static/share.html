<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†äº«è¡Œç¨‹ - é€”ç‚¹å„¿å•¥æ—…è¡Œè§„åˆ’å¹³å°</title>
    <link rel="stylesheet" href="/css/common.css">
    <style>
        .share-container {
            max-width: 800px;
            margin: 40px auto;
        }
        
        .preview-panel {
            background: white;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 20px;
        }
        
        .preview-header {
            text-align: center;
            padding-bottom: 20px;
            border-bottom: 2px solid #667eea;
            margin-bottom: 30px;
        }
        
        .preview-title {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .preview-info {
            color: #666;
            font-size: 16px;
        }
        
        .preview-section {
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            padding-left: 10px;
            border-left: 4px solid #667eea;
        }
        
        .day-preview {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .activity-preview {
            padding: 10px;
            border-left: 3px solid #667eea;
            margin-bottom: 10px;
            background: white;
        }
        
        .share-options {
            background: white;
            border-radius: 10px;
            padding: 25px;
        }
        
        .share-link {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .share-link input {
            flex: 1;
            padding: 12px;
            border: 2px solid #667eea;
            border-radius: 5px;
            background: #f8f9fa;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <a href="/index.html" class="navbar-brand" style="display: flex; align-items: center; gap: 8px; text-decoration: none;">
                <div style="background: #3b82f6; width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white">
                        <path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/>
                    </svg>
                </div>
                <div>
                    <div style="font-size: 1.5rem; font-weight: 700; color: #3b82f6; line-height: 1.2;">é€”ç‚¹å„¿å•¥</div>
                    <div style="font-size: 0.75rem; color: #6b7280;">è®©æ—…é€”ä¸ç³Šæ¶‚</div>
                </div>
            </a>
            <div class="navbar-menu">
                <a href="#" onclick="history.back(); return false;">è¿”å›</a>
                <a href="/index.html">è¿”å›é¦–é¡µ</a>
                <a href="#" onclick="auth.logout(); return false;">é€€å‡ºç™»å½•</a>
            </div>
        </div>
    </nav>
    
    <div class="share-container">
        <h2 style="margin-bottom: 20px;">åˆ†äº«è¡Œç¨‹</h2>
        
        <div class="preview-panel" id="pdfPreview">
            <div class="preview-header">
                <div class="preview-title" id="projectTitle">è¡Œç¨‹åç§°</div>
                <div class="preview-info" id="projectInfo"></div>
            </div>
            
            <div class="preview-section">
                <div class="section-title">ğŸ“… è¡Œç¨‹å®‰æ’</div>
                <div id="activitiesPreview"></div>
            </div>
            
            <div class="preview-section">
                <div class="section-title">ğŸ’° é¢„ç®—æ˜ç»†</div>
                <div id="budgetPreview"></div>
            </div>
        </div>
        
        <div class="share-options">
            <h3>åˆ†äº«é€‰é¡¹</h3>
            
            <div style="margin: 20px 0;">
                <button class="btn btn-primary" onclick="generatePDF()">
                    ğŸ“„ ç”ŸæˆPDFæ–‡æ¡£
                </button>
                <button class="btn btn-success" onclick="generateShareLink()" style="margin-left: 10px;">
                    ğŸ”— ç”Ÿæˆåˆ†äº«é“¾æ¥
                </button>
            </div>
            
            <div id="shareLinkContainer" class="hidden">
                <label class="form-label">åˆ†äº«é“¾æ¥</label>
                <div class="share-link">
                    <input type="text" id="shareLink" readonly>
                    <button class="btn btn-primary" onclick="copyShareLink()">å¤åˆ¶é“¾æ¥</button>
                </div>
                <small style="color: #999; display: block; margin-top: 10px;">
                    é“¾æ¥æœ‰æ•ˆæœŸï¼š30å¤©
                </small>
            </div>
            
            <div id="pdfLinkContainer" class="hidden" style="margin-top: 20px;">
                <label class="form-label">PDFä¸‹è½½</label>
                <div class="share-link">
                    <input type="text" id="pdfLink" readonly>
                    <button class="btn btn-success" onclick="downloadPDF()">ä¸‹è½½PDF</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="/js/common.js"></script>
    <script>
        auth.checkAuth();
        const currentUser = auth.getUser();
        const projectId = getQueryParam('id');
        
        let project = null;
        let activities = [];
        let budget = null;
        
        if (!projectId) {
            showError('é¡¹ç›®IDä¸å­˜åœ¨');
            setTimeout(() => navigate('/index.html'), 2000);
        }
        
        // åŠ è½½é¡¹ç›®æ•°æ®
        async function loadProject() {
            try {
                const projectResult = await get(`/travel-projects/${projectId}`);
                if (projectResult.success) {
                    project = projectResult.data;
                    document.getElementById('projectTitle').textContent = project.projectName;
                    document.getElementById('projectInfo').textContent = 
                        `${project.destination} Â· ${project.days}å¤©`;
                }
                
                const activitiesResult = await get(`/activity-schedules/project/${projectId}/ordered`);
                if (activitiesResult.success) {
                    activities = activitiesResult.data;
                }
                
                const budgetResult = await get(`/budgets/project/${projectId}`);
                if (budgetResult.success) {
                    budget = budgetResult.data;
                }
                
                renderPreview();
            } catch (error) {
                console.error('åŠ è½½é¡¹ç›®é”™è¯¯:', error);
                showError('åŠ è½½å¤±è´¥');
            }
        }
        
        // æ¸²æŸ“é¢„è§ˆ
        function renderPreview() {
            // æ¸²æŸ“æ´»åŠ¨
            const dayGroups = {};
            activities.forEach(activity => {
                const day = activity.dayNumber || 1;
                if (!dayGroups[day]) dayGroups[day] = [];
                dayGroups[day].push(activity);
            });
            
            document.getElementById('activitiesPreview').innerHTML = 
                Object.keys(dayGroups).sort((a, b) => a - b).map(day => `
                    <div class="day-preview">
                        <strong style="font-size: 18px; color: #667eea;">ç¬¬${day}å¤©</strong>
                        <div style="margin-top: 15px;">
                            ${dayGroups[day].map(activity => `
                                <div class="activity-preview">
                                    <div style="font-weight: bold;">${activity.activityName}</div>
                                    ${activity.location ? `<div style="color: #666; font-size: 14px;">ğŸ“ ${activity.location}</div>` : ''}
                                    ${activity.budget ? `<div style="color: #28a745; font-size: 14px;">ğŸ’° ${formatMoney(activity.budget)}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('') || '<p style="color: #999;">æš‚æ— æ´»åŠ¨å®‰æ’</p>';
            
            // æ¸²æŸ“é¢„ç®—
            if (budget) {
                document.getElementById('budgetPreview').innerHTML = `
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; text-align: center;">
                            <div>
                                <div style="color: #666; margin-bottom: 5px;">æ€»é¢„ç®—</div>
                                <div style="font-size: 24px; font-weight: bold; color: #667eea;">
                                    ${formatMoney(budget.totalBudget)}
                                </div>
                            </div>
                            <div>
                                <div style="color: #666; margin-bottom: 5px;">å·²ä½¿ç”¨</div>
                                <div style="font-size: 24px; font-weight: bold; color: #dc3545;">
                                    ${formatMoney(budget.usedBudget)}
                                </div>
                            </div>
                            <div>
                                <div style="color: #666; margin-bottom: 5px;">å‰©ä½™</div>
                                <div style="font-size: 24px; font-weight: bold; color: #28a745;">
                                    ${formatMoney(budget.remainingBudget)}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                document.getElementById('budgetPreview').innerHTML = 
                    '<p style="color: #999;">æš‚æ— é¢„ç®—ä¿¡æ¯</p>';
            }
        }
        
        // ç”ŸæˆPDF
        async function generatePDF() {
            try {
                // æ¨¡æ‹Ÿç”ŸæˆPDFï¼ˆå®é™…åº”è¯¥è°ƒç”¨åç«¯PDFç”ŸæˆæœåŠ¡ï¼‰
                const pdfUrl = `${window.location.origin}/pdfs/${projectId}_${Date.now()}.pdf`;
                
                // ä¿å­˜åˆ†äº«æ–‡æ¡£è®°å½•
                await post('/shared-documents', {
                    projectId,
                    documentUrl: pdfUrl,
                    format: 'PDF',
                    generatedTime: new Date().toISOString(),
                    shareLink: pdfUrl,
                    creatorId: currentUser.id
                });
                
                document.getElementById('pdfLink').value = pdfUrl;
                document.getElementById('pdfLinkContainer').classList.remove('hidden');
                
                showSuccess('PDFç”ŸæˆæˆåŠŸï¼');
            } catch (error) {
                console.error('ç”ŸæˆPDFé”™è¯¯:', error);
                showError('ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }
        
        // ç”Ÿæˆåˆ†äº«é“¾æ¥
        async function generateShareLink() {
            try {
                const shareLink = `${window.location.origin}/view-project.html?id=${projectId}&token=${Date.now()}`;
                
                // ä¿å­˜åˆ†äº«æ–‡æ¡£è®°å½•
                await post('/shared-documents', {
                    projectId,
                    format: 'LINK',
                    generatedTime: new Date().toISOString(),
                    shareLink,
                    creatorId: currentUser.id
                });
                
                document.getElementById('shareLink').value = shareLink;
                document.getElementById('shareLinkContainer').classList.remove('hidden');
                
                showSuccess('åˆ†äº«é“¾æ¥ç”ŸæˆæˆåŠŸï¼');
            } catch (error) {
                console.error('ç”Ÿæˆåˆ†äº«é“¾æ¥é”™è¯¯:', error);
                showError('ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }
        
        // å¤åˆ¶åˆ†äº«é“¾æ¥
        function copyShareLink() {
            const input = document.getElementById('shareLink');
            input.select();
            document.execCommand('copy');
            showSuccess('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
        }
        
        // ä¸‹è½½PDF
        function downloadPDF() {
            const pdfUrl = document.getElementById('pdfLink').value;
            showSuccess('PDFä¸‹è½½åŠŸèƒ½éœ€è¦åç«¯æ”¯æŒï¼Œç›®å‰ä»…æ¨¡æ‹Ÿç”Ÿæˆé“¾æ¥');
            // å®é™…åº”è¯¥ï¼šwindow.open(pdfUrl, '_blank');
        }
        
        // é¡µé¢åŠ è½½æ—¶åŠ è½½é¡¹ç›®
        loadProject();
    </script>
</body>
</html>