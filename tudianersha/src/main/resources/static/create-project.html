<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ›å»ºè¡Œç¨‹ - é€”ç‚¹å„¿å•¥æ—…è¡Œè§„åˆ’å¹³å°</title>
    <link rel="stylesheet" href="/css/common.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- é«˜å¾·åœ°å›¾API - å®‰å…¨å¯†é’¥å¿…é¡»åœ¨åŠ è½½APIä¹‹å‰è®¾ç½® -->
    <script>
        window._AMapSecurityConfig = {
            securityJsCode: '07ec5b4c0314b96e44928e25dede60f7'
        };
    </script>
    <script src="https://webapi.amap.com/maps?v=2.0&key=bf0e97cd7a4c3c6aaa8ecf3dd7485381&plugin=AMap.AutoComplete,AMap.PlaceSearch"></script>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            background: #f9fafb;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        
        .main-container {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 24px;
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 24px;
        }
        
        .left-section {
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .right-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .section-title {
            font-size: 28px;
            font-weight: 700;
            color: #111827;
            margin-bottom: 12px;
        }
        
        .section-subtitle {
            font-size: 20px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 8px;
        }
        
        .section-desc {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 24px;
        }
        
        .interest-card {
            background: #f8f9ff;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 32px;
        }
        
        .interest-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .interest-card-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
            font-weight: 600;
        }
        
        .icon-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
        }
        
        .icon-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 16px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .icon-item:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }
        
        .icon-item.selected {
            border-color: #667eea;
            background: #eef2ff;
        }
        
        .icon-item-icon {
            font-size: 32px;
        }
        
        .icon-item-label {
            font-size: 14px;
            color: #374151;
            font-weight: 500;
        }
        
        .location-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 32px;
        }
        
        .location-item {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .location-item:hover {
            border-color: #667eea;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        
        .location-item.selected {
            border-color: #667eea;
            background: #f8f9ff;
        }
        
        .location-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }
        
        .location-number {
            width: 28px;
            height: 28px;
            background: #667eea;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            flex-shrink: 0;
        }
        
        .location-title {
            font-size: 16px;
            font-weight: 600;
            color: #111827;
        }
        
        .location-meta {
            font-size: 13px;
            color: #6b7280;
        }
        
        .location-desc {
            font-size: 14px;
            color: #6b7280;
            line-height: 1.6;
            padding-left: 40px;
        }
        
        .budget-summary {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .budget-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .budget-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: #f9fafb;
            border-radius: 8px;
            margin-bottom: 12px;
        }
        
        .budget-item-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .budget-item-info {
            flex: 1;
            margin-left: 12px;
        }
        
        .budget-item-name {
            font-size: 14px;
            font-weight: 600;
            color: #111827;
        }
        
        .budget-item-desc {
            font-size: 12px;
            color: #6b7280;
        }
        
        .budget-item-price {
            font-size: 18px;
            font-weight: 700;
            display: flex;
            align-items: baseline;
            gap: 4px;
        }
        
        .budget-item-price.editable {
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 6px;
            transition: all 0.2s;
        }
        
        .budget-item-price.editable:hover {
            background: #f3f4f6;
        }
        
        .budget-item-price.blue {
            color: #3b82f6;
        }
        
        .budget-item-price.green {
            color: #10b981;
        }
        
        .budget-total {
            background: #ecfdf5;
            border: 2px solid #10b981;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            margin-top: 20px;
        }
        
        .budget-total-label {
            font-size: 14px;
            color: #059669;
            margin-bottom: 4px;
        }
        
        .budget-total-amount {
            font-size: 32px;
            font-weight: 700;
            color: #10b981;
        }
        
        .budget-total-unit {
            font-size: 16px;
            font-weight: 400;
        }
        
        .edit-link {
            color: #667eea;
            font-size: 14px;
            text-decoration: none;
            cursor: pointer;
        }
        
        .edit-link:hover {
            text-decoration: underline;
        }
        
        .checkbox-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 16px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
        }
        
        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-top: 2px;
        }
        
        .checkbox-content {
            flex: 1;
        }
        
        .checkbox-title {
            font-size: 14px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 4px;
        }
        
        .checkbox-desc {
            font-size: 13px;
            color: #6b7280;
            line-height: 1.5;
        }
        
        .form-actions {
            display: flex;
            gap: 12px;
            margin-top: 32px;
        }
        
        .btn-lg {
            padding: 14px 28px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }
        
        .btn-secondary:hover {
            background: #e5e7eb;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
            flex: 1;
        }
        
        .btn-primary:hover {
            background: #5568d3;
        }
        
        .btn-add-location {
            width: 100%;
            padding: 12px;
            margin-top: 16px;
            background: white;
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            color: #6b7280;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-add-location:hover {
            border-color: #667eea;
            color: #667eea;
            background: #f8f9ff;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <a href="/index.html" class="navbar-brand" style="display: flex; align-items: center; gap: 8px; text-decoration: none;">
                <div style="background: #3b82f6; width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white">
                        <path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/>
                    </svg>
                </div>
                <div>
                    <div style="font-size: 1.5rem; font-weight: 700; color: #3b82f6; line-height: 1.2;">é€”ç‚¹å„¿å•¥</div>
                    <div style="font-size: 0.75rem; color: #6b7280;">è®©æ—…é€”ä¸ç³Šæ¶‚</div>
                </div>
            </a>
            <div class="navbar-menu">
                <a href="/index.html">è¿”å›é¦–é¡µ</a>
                <a href="#" onclick="auth.logout(); return false;">é€€å‡ºç™»å½•</a>
            </div>
        </div>
    </nav>
    
    <div class="main-container">
        <!-- Left Section -->
        <div class="left-section">
            <h1 class="section-title">å®Œå–„æ‚¨çš„æ—…è¡Œåå¥½</h1>
            
            <form id="createProjectForm">
                <!-- Basic Info (Hidden but required) -->
                <input type="hidden" name="projectName" id="projectName" value="">
                <input type="hidden" name="destination" id="destination" value="">
                <input type="hidden" name="days" id="days" value="7">
                
                <!-- æ—…è¡ŒåŸºæœ¬ä¿¡æ¯ -->
                <div class="interest-card" style="margin-bottom: 24px;">
                    <div class="interest-card-header">
                        <div class="interest-card-title">
                            <span style="color: #667eea;">âœ“</span>
                            <span>æ—…è¡ŒåŸºæœ¬ä¿¡æ¯</span>
                            <span style="font-size: 13px; color: #9ca3af; font-weight: 400;">è¯·å¡«å†™æ—…è¡Œçš„ç›®çš„åœ°å’Œæ—¶é—´</span>
                        </div>
                    </div>
                    
                    <div style="display: grid; gap: 16px;">
                        <!-- ç›®çš„åœ° -->
                        <div style="position: relative;">
                            <label style="display: block; font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px;">
                                ğŸ“ ç›®çš„åœ° <span style="color: #ef4444; font-weight: 700;">*</span>
                            </label>
                            <input type="text" id="destinationInput" placeholder="å¿…å¡«ï¼šè¯·ä»åˆ—è¡¨é€‰æ‹©åŸå¸‚" 
                                   autocomplete="off"
                                   style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px; transition: all 0.2s;"
                                   onfocus="this.style.borderColor='#667eea'"
                                   onblur="setTimeout(() => { this.style.borderColor='#e5e7eb'; }, 200)" />
                            <!-- åŸå¸‚æç¤ºä¸‹æ‹‰åˆ—è¡¨ -->
                            <div id="citySuggestions" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 2px solid #667eea; border-top: none; border-radius: 0 0 10px 10px; max-height: 300px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                                <!-- åŠ¨æ€ç”Ÿæˆæç¤ºé¡¹ -->
                            </div>
                        </div>
                        
                        <!-- å¼€å§‹æ—¶é—´å’Œç»“æŸæ—¶é—´ -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <label style="display: block; font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px;">
                                    ğŸ“… å¼€å§‹æ—¶é—´ <span style="color: #ef4444; font-weight: 700;">*</span>
                                </label>
                                <input type="date" id="startDateInput" 
                                       style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px; transition: all 0.2s;"
                                       onfocus="this.style.borderColor='#667eea'"
                                       onblur="this.style.borderColor='#e5e7eb'" />
                            </div>
                            
                            <div>
                                <label style="display: block; font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px;">
                                    ğŸ“… ç»“æŸæ—¶é—´ <span style="color: #ef4444; font-weight: 700;">*</span>
                                </label>
                                <input type="date" id="endDateInput" 
                                       style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px; transition: all 0.2s;"
                                       onfocus="this.style.borderColor='#667eea'"
                                       onblur="this.style.borderColor='#e5e7eb'" />
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Interest Preferences -->
                <div class="interest-card">
                    <div class="interest-card-header">
                        <div class="interest-card-title">
                            <span style="color: #667eea;">âœ“</span>
                            <span>å…´è¶£åå¥½</span>
                            <span style="font-size: 13px; color: #9ca3af; font-weight: 400;">è¯·é€‰æ‹©2-7é¡¹æ‚¨æ„Ÿå…´è¶£çš„ç±»å‹</span>
                        </div>
                        <a class="edit-link">å·²é€‰æ‹© 0/5</a>
                    </div>
                    
                    <div class="icon-grid">
                        <div class="icon-item" data-interest="ç¾é£Ÿ">
                            <div class="icon-item-icon">ğŸ”</div>
                            <div class="icon-item-label">ç¾é£Ÿ</div>
                        </div>
                        <div class="icon-item" data-interest="è‡ªç„¶é£å…‰">
                            <div class="icon-item-icon">â›°ï¸</div>
                            <div class="icon-item-label">è‡ªç„¶é£å…‰</div>
                        </div>
                        <div class="icon-item" data-interest="å†å²å¤è¿¹">
                            <div class="icon-item-icon">ğŸ›ï¸</div>
                            <div class="icon-item-label">å†å²å¤è¿¹</div>
                        </div>
                        <div class="icon-item" data-interest="è´­ç‰©">
                            <div class="icon-item-icon">ğŸ›ï¸</div>
                            <div class="icon-item-label">è´­ç‰©</div>
                        </div>
                        <div class="icon-item" data-interest="æ‘„å½±">
                            <div class="icon-item-icon">ğŸ“·</div>
                            <div class="icon-item-label">æ‘„å½±</div>
                        </div>
                        <div class="icon-item" data-interest="æˆ·å¤–æ¢é™©">
                            <div class="icon-item-icon">ğŸ“–</div>
                            <div class="icon-item-label">æˆ·å¤–æ¢é™©</div>
                        </div>
                        <div class="icon-item" data-interest="æ‹ç…§æ‰“å¡">
                            <div class="icon-item-icon">ğŸ“¸</div>
                            <div class="icon-item-label">æ‹ç…§æ‰“å¡</div>
                        </div>
                        <div class="icon-item" data-interest="ä¼‘é—²æ”¾æ¾">
                            <div class="icon-item-icon">ğŸ˜Š</div>
                            <div class="icon-item-label">ä¼‘é—²æ”¾æ¾</div>
                        </div>
                    </div>
                </div>
                
                <!-- æƒ³å»çš„æ™¯ç‚¹ -->
                <div>
                    <div class="section-subtitle">ğŸ—ºï¸ æƒ³å»çš„æ™¯ç‚¹</div>
                    <div class="section-desc">è¯·è¾“å…¥æ‚¨æœŸå¾…æ¸¸ç©çš„æ™¯ç‚¹</div>
                    
                    <div class="location-list" id="likeLocationsList">
                        <div class="location-item" data-location="like-1">
                            <div class="location-header">
                                <div class="location-number" style="background: #10b981;">1</div>
                                <div style="flex: 1;">
                                    <div class="location-title">æƒ³å»çš„æ™¯ç‚¹</div>
                                    <div style="position: relative;">
                                        <input type="text" class="location-input like-poi-input" id="like-location-1" placeholder="è¾“å…¥æ™¯ç‚¹åç§°" autocomplete="off" 
                                               style="width: 100%; padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px; margin-top: 4px;"
                                               onfocus="this.style.borderColor='#10b981'"
                                               onblur="setTimeout(() => { this.style.borderColor='#e5e7eb'; }, 200)" />
                                        <!-- æ™¯ç‚¹æç¤ºä¸‹æ‹‰åˆ—è¡¨ -->
                                        <div class="poi-suggestions" id="poi-suggestions-like-1" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 2px solid #10b981; border-top: none; border-radius: 0 0 10px 10px; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="location-desc">ä¾‹å¦‚:æ•…å®«åšç‰©é¦†ã€å½“åœ°ç¾é£Ÿè¡—ã€ç½‘çº¢æ‰“å¡åœ°ç­‰</div>
                        </div>
                        
                        <div class="location-item" data-location="like-2">
                            <div class="location-header">
                                <div class="location-number" style="background: #10b981;">2</div>
                                <div style="flex: 1;">
                                    <div class="location-title">æƒ³å»çš„æ™¯ç‚¹</div>
                                    <div style="position: relative;">
                                        <input type="text" class="location-input like-poi-input" id="like-location-2" placeholder="è¾“å…¥æ™¯ç‚¹åç§°" autocomplete="off" 
                                               style="width: 100%; padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px; margin-top: 4px;"
                                               onfocus="this.style.borderColor='#10b981'"
                                               onblur="setTimeout(() => { this.style.borderColor='#e5e7eb'; }, 200)" />
                                        <!-- æ™¯ç‚¹æç¤ºä¸‹æ‹‰åˆ—è¡¨ -->
                                        <div class="poi-suggestions" id="poi-suggestions-like-2" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 2px solid #10b981; border-top: none; border-radius: 0 0 10px 10px; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="location-desc">ä¾‹å¦‚ï¼šå½“åœ°ç‰¹è‰²å°åƒè¡—ã€å†å²æ–‡åŒ–è¡—åŒºç­‰</div>
                        </div>
                        
                        <div class="location-item" data-location="like-3">
                            <div class="location-header">
                                <div class="location-number" style="background: #10b981;">3</div>
                                <div style="flex: 1;">
                                    <div class="location-title">æƒ³å»çš„æ™¯ç‚¹</div>
                                    <div style="position: relative;">
                                        <input type="text" class="location-input like-poi-input" id="like-location-3" placeholder="è¾“å…¥æ™¯ç‚¹åç§°" autocomplete="off" 
                                               style="width: 100%; padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px; margin-top: 4px;"
                                               onfocus="this.style.borderColor='#10b981'"
                                               onblur="setTimeout(() => { this.style.borderColor='#e5e7eb'; }, 200)" />
                                        <!-- æ™¯ç‚¹æç¤ºä¸‹æ‹‰åˆ—è¡¨ -->
                                        <div class="poi-suggestions" id="poi-suggestions-like-3" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 2px solid #10b981; border-top: none; border-radius: 0 0 10px 10px; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="location-desc">ä¾‹å¦‚ï¼šå•†åœˆã€ç‰¹è‰²å°é•‡æˆ–å¿…å»æ™¯åŒºç­‰</div>
                        </div>
                    </div>
                    
                    <button type="button" class="btn-add-location" id="addLikeLocation">
                        + æ·»åŠ æ›´å¤šæƒ³å»çš„æ™¯ç‚¹
                    </button>
                </div>
                
                <!-- ä¸å–œæ¬¢çš„æ™¯ç‚¹ -->
                <div style="margin-top: 32px;">
                    <div class="section-subtitle">ğŸš« ä¸å–œæ¬¢çš„æ™¯ç‚¹</div>
                    <div class="section-desc">è¯·è¾“å…¥æ‚¨ä¸æƒ³å»çš„æ™¯ç‚¹ç±»å‹æˆ–åœ°ç‚¹</div>
                    
                    <div class="location-list" id="dislikeLocationsList">
                        <div class="location-item" data-location="dislike-1" style="border-color: #fee2e2;">
                            <div class="location-header">
                                <div class="location-number" style="background: #ef4444;">1</div>
                                <div style="flex: 1;">
                                    <div class="location-title">ä¸å–œæ¬¢çš„æ™¯ç‚¹</div>
                                    <div style="position: relative;">
                                        <input type="text" class="location-input dislike-poi-input" id="dislike-location-1" placeholder="è¾“å…¥æ™¯ç‚¹åç§°" autocomplete="off" 
                                               style="width: 100%; padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px; margin-top: 4px;"
                                               onfocus="this.style.borderColor='#ef4444'"
                                               onblur="setTimeout(() => { this.style.borderColor='#e5e7eb'; }, 200)" />
                                        <!-- æ™¯ç‚¹æç¤ºä¸‹æ‹‰åˆ—è¡¨ -->
                                        <div class="poi-suggestions" id="poi-suggestions-dislike-1" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 2px solid #ef4444; border-top: none; border-radius: 0 0 10px 10px; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="location-desc">ä¾‹å¦‚ï¼šæ¸¸ä¹åœºã€äººå¤šæ‹¥æŒ¤çš„æ™¯ç‚¹ã€å•†ä¸šåŒ–ä¸¥é‡çš„æ™¯åŒºç­‰</div>
                        </div>
                        
                        <div class="location-item" data-location="dislike-2" style="border-color: #fee2e2;">
                            <div class="location-header">
                                <div class="location-number" style="background: #ef4444;">2</div>
                                <div style="flex: 1;">
                                    <div class="location-title">ä¸å–œæ¬¢çš„æ™¯ç‚¹</div>
                                    <div style="position: relative;">
                                        <input type="text" class="location-input dislike-poi-input" id="dislike-location-2" placeholder="è¾“å…¥æ™¯ç‚¹åç§°" autocomplete="off" 
                                               style="width: 100%; padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px; margin-top: 4px;"
                                               onfocus="this.style.borderColor='#ef4444'"
                                               onblur="setTimeout(() => { this.style.borderColor='#e5e7eb'; }, 200)" />
                                        <!-- æ™¯ç‚¹æç¤ºä¸‹æ‹‰åˆ—è¡¨ -->
                                        <div class="poi-suggestions" id="poi-suggestions-dislike-2" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 2px solid #ef4444; border-top: none; border-radius: 0 0 10px 10px; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="location-desc">ä¾‹å¦‚ï¼šåŠ¨ç‰©å›­ã€æ°´ä¸Šé¡¹ç›®ã€éœ€è¦é•¿æ—¶é—´æ’é˜Ÿçš„æ™¯ç‚¹ç­‰</div>
                        </div>
                        
                        <div class="location-item" data-location="dislike-3" style="border-color: #fee2e2;">
                            <div class="location-header">
                                <div class="location-number" style="background: #ef4444;">3</div>
                                <div style="flex: 1;">
                                    <div class="location-title">ä¸å–œæ¬¢çš„æ™¯ç‚¹</div>
                                    <div style="position: relative;">
                                        <input type="text" class="location-input dislike-poi-input" id="dislike-location-3" placeholder="è¾“å…¥æ™¯ç‚¹åç§°" autocomplete="off" 
                                               style="width: 100%; padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px; margin-top: 4px;"
                                               onfocus="this.style.borderColor='#ef4444'"
                                               onblur="setTimeout(() => { this.style.borderColor='#e5e7eb'; }, 200)" />
                                        <!-- æ™¯ç‚¹æç¤ºä¸‹æ‹‰åˆ—è¡¨ -->
                                        <div class="poi-suggestions" id="poi-suggestions-dislike-3" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 2px solid #ef4444; border-top: none; border-radius: 0 0 10px 10px; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="location-desc">ä¾‹å¦‚ï¼šéœ€è¦é—¨ç¥¨ã€ç¦»å¸‚åŒºè¾ƒè¿œã€ç¯å¢ƒå˜—æ‚çš„åœ°æ–¹ç­‰</div>
                        </div>
                    </div>
                    
                    <button type="button" class="btn-add-location" id="addDislikeLocation">
                        + æ·»åŠ æ›´å¤šä¸å–œæ¬¢çš„æ™¯ç‚¹
                    </button>
                </div>
                
                <!-- Action Buttons -->
                <div class="form-actions">
                    <button type="button" class="btn-lg btn-secondary" onclick="navigate('/index.html')">å–æ¶ˆ</button>
                    <button type="submit" class="btn-lg btn-primary">æäº¤å¹¶ç”ŸæˆAIæ–¹æ¡ˆ</button>
                </div>
            </form>
        </div>
        
        <!-- Right Section - Budget Summary -->
        <div class="right-section">
            <!-- Share Collaboration Link (hidden until project created) -->
            <div class="budget-summary" id="shareLinkSection" style="margin-bottom: 20px; display: none;">
                <div class="budget-header" style="margin-bottom: 16px;">
                    <span style="font-size: 20px;">ğŸ”—</span>
                    <span style="font-size: 16px; font-weight: 600;">åˆ†äº«åä½œé“¾æ¥</span>
                </div>
                <p style="font-size: 13px; color: #6b7280; margin-bottom: 16px;">é‚€è¯·å…¶ä»–äººä¸€èµ·å¡«å†™æ—…è¡Œåå¥½</p>
                
                <div style="background: #f3f4f6; border-radius: 8px; padding: 12px; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                    <input type="text" id="shareLink" readonly value="" style="flex: 1; background: transparent; border: none; font-size: 13px; color: #374151; outline: none;" />
                </div>
                
                <div style="display: flex; gap: 8px;">
                    <button type="button" id="copyLinkBtn" class="btn-lg" style="flex: 1; padding: 10px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
                        ğŸ“‹ å¤åˆ¶é“¾æ¥
                    </button>
                    <button type="button" id="viewParticipantsBtn" class="btn-lg" style="flex: 1; padding: 10px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
                        ğŸ‘¥ æŸ¥çœ‹æˆå‘˜
                    </button>
                </div>
                
                <div id="participantCount" style="margin-top: 12px; font-size: 13px; color: #6b7280; text-align: center;">
                    å·²é‚€è¯· <span id="invitedCount">0</span> äºº
                </div>
            </div>
            
            <div class="budget-summary">
                <div class="budget-header">
                    <span style="font-size: 20px;">ğŸ’¡</span>
                    <span style="font-size: 16px; font-weight: 600;">åˆ›å»ºè€…è®¾ç½®çš„æ¯æ—¥é¢„ç®—</span>
                    <button type="button" id="addBudgetItemBtn" class="edit-link" style="display: none; margin-left: auto; padding: 4px 12px; background: #10b981; color: white; border-radius: 6px; border: none; cursor: pointer;">â• æ·»åŠ é¢„ç®—é¡¹</button>
                </div>
                <p style="font-size: 13px; color: #6b7280; margin-bottom: 20px;">ä»¥ä¸‹æ˜¯åŸºæœ¬é¡¹ç›®ç»„æˆéƒ¨åˆ†é¡¹ç›®é‡ï¼Œå»ºè®®ä»…ä¾›å‚è€ƒ</p>
                
                <div id="budgetItemsList">
                    <!-- é¢„ç®—é¡¹å°†åŠ¨æ€ç”Ÿæˆ -->
                </div>
                
                <div class="budget-total">
                    <div class="budget-total-label">æ¯æ—¥æ€»é¢„ç®—</div>
                    <div class="budget-total-amount">
                        <span style="font-size: 20px;">Â¥</span>
                        <span id="dailyTotal">650</span>
                        <span class="budget-total-unit">/å¤©</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="/js/common.js"></script>
    <script>
        // Check authentication
        auth.checkAuth();
        
        const currentUser = auth.getUser();
        const selectedInterests = [];
        let likeLocationCount = 3;
        let dislikeLocationCount = 3;
        const likeLocations = {};
        const dislikeLocations = {};
        
        // Initialize default locations
        for (let i = 1; i <= 3; i++) {
            likeLocations[`like-${i}`] = '';
            dislikeLocations[`dislike-${i}`] = '';
        }
        
        // Budget data - ä½¿ç”¨æ•°ç»„å­˜å‚¨ï¼Œæ”¯æŒåŠ¨æ€æ·»åŠ /åˆ é™¤
        let budgetItems = [
            { id: 'attraction', name: 'æ™¯ç‚¹é—¨ç¥¨', desc: 'æ¯æ—¥7å¼ é—¨ç¥¨', icon: 'ğŸš‡', color: '#dbeafe', amount: 150 },
            { id: 'lunch', name: 'åˆé¤', desc: 'æ¯æ—¥åˆé¤é¢„ç®—', icon: 'ğŸš—', color: '#fef3c7', amount: 80 },
            { id: 'dinner', name: 'æ™šé¤', desc: 'æ¯æ—¥æ™šé¤é¢„ç®—', icon: 'ğŸ½ï¸', color: '#e5e7eb', amount: 120 },
            { id: 'accommodation', name: 'ä½å®¿', desc: 'æ¯æ—¥ä½å®¿é¢„ç®—', icon: 'ğŸ ', color: '#dbeafe', amount: 300 }
        ];
        
        let budgetItemIdCounter = 5; // ç”¨äºç”Ÿæˆæ–°çš„é¢„ç®—é¡¹ID
        
        let isCreator = true; // åœ¨åˆ›å»ºé¡µé¢ï¼Œå½“å‰ç”¨æˆ·å°±æ˜¯åˆ›å»ºè€…
        let currentProjectId = null; // å½“å‰é¡¹ç›®IDï¼ˆç”¨äºåˆ†äº«é“¾æ¥ï¼‰
        
        // é«˜å¾·åœ°å›¾åŸå¸‚æœç´¢åŠŸèƒ½
        let autoComplete = null;
        let searchTimeout = null;
        
        // åˆå§‹åŒ–é«˜å¾·åœ°å›¾è‡ªåŠ¨å®Œæˆ
        function initAmapAutoComplete() {
            if (typeof AMap === 'undefined') {
                console.error('é«˜å¾·åœ°å›¾APIæœªåŠ è½½');
                return;
            }
            
            autoComplete = new AMap.AutoComplete({
                city: 'å…¨å›½', // åŸå¸‚ï¼Œé»˜è®¤å…¨å›½
                citylimit: false // æ˜¯å¦é™åˆ¶åœ¨è®¾å®šåŸå¸‚å†…æœç´¢
            });
            
            console.log('é«˜å¾·åœ°å›¾è‡ªåŠ¨å®Œæˆåˆå§‹åŒ–æˆåŠŸ');
        }
        
        // åŸå¸‚æœç´¢å‡½æ•°
        function searchCity(keyword) {
            if (!keyword || keyword.trim() === '') {
                hideCitySuggestions();
                return;
            }
            
            if (!autoComplete) {
                console.log('åˆå§‹åŒ–AutoComplete...');
                initAmapAutoComplete();
            }
            
            if (!autoComplete) {
                console.error('AutoCompleteåˆå§‹åŒ–å¤±è´¥');
                return;
            }
            
            console.log('æœç´¢å…³é”®è¯:', keyword);
            
            // ä½¿ç”¨é˜²æŠ–
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                autoComplete.search(keyword, function(status, result) {
                    console.log('æœç´¢çŠ¶æ€:', status);
                    console.log('æœç´¢ç»“æœ:', result);
                    
                    if (status === 'complete' && result.tips && result.tips.length > 0) {
                        console.log('æ‰¾åˆ°', result.tips.length, 'ä¸ªç»“æœ');
                        showCitySuggestions(result.tips);
                    } else if (status === 'error') {
                        console.error('æœç´¢é”™è¯¯:', result);
                        hideCitySuggestions();
                    } else if (status === 'no_data') {
                        console.log('æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„åŸå¸‚');
                        hideCitySuggestions();
                    } else {
                        console.log('æœªçŸ¥çŠ¶æ€:', status);
                        hideCitySuggestions();
                    }
                });
            }, 300); // 300msé˜²æŠ–
        }
        
        // æ˜¾ç¤ºåŸå¸‚æç¤º
        function showCitySuggestions(tips) {
            const container = document.getElementById('citySuggestions');
            console.log('æ˜¾ç¤ºæç¤ºï¼Œå®¹å™¨:', container);
            
            if (!container) {
                console.error('æ‰¾ä¸åˆ°citySuggestionså®¹å™¨');
                return;
            }
            
            // è¿‡æ»¤å‡ºæœ‰æ•ˆçš„ç»“æœ
            const validTips = tips.filter(tip => {
                return tip.name && (tip.district || tip.adcode);
            });
            
            console.log('è¿‡æ»¤åçš„ç»“æœ:', validTips.length, 'ä¸ª');
            
            if (validTips.length === 0) {
                console.log('æ²¡æœ‰æœ‰æ•ˆçš„ç»“æœ');
                hideCitySuggestions();
                return;
            }
            
            container.innerHTML = validTips.slice(0, 10).map(tip => {
                const name = tip.name;
                const district = tip.district || '';
                const address = tip.address || '';
                const location = district || address || 'ä¸­å›½';
                
                // æå–åŸå¸‚åï¼šä¼˜å…ˆä»districtæå–
                let cityName = extractCityName(name, district);
                
                return `
                    <div class="city-suggestion-item" 
                         style="padding: 12px 16px; cursor: pointer; border-bottom: 1px solid #f3f4f6; transition: background 0.2s;"
                         onmouseover="this.style.background='#f3f4f6'"
                         onmouseout="this.style.background='white'"
                         onclick="selectCity('${cityName.replace(/'/g, "\\'")}')">
                        <div style="font-weight: 600; color: #374151; margin-bottom: 4px;">
                            ğŸ“ ${name}
                        </div>
                        <div style="font-size: 12px; color: #6b7280;">
                            ${location} â†’ å°†é€‰æ‹©: <span style="color: #3b82f6; font-weight: 600;">${cityName}</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.style.display = 'block';
            console.log('æç¤ºåˆ—è¡¨å·²æ˜¾ç¤º');
        }
        
        // ä»åç§°å’ŒåŒºå¿ä¿¡æ¯ä¸­æå–åŸå¸‚å
        function extractCityName(name, district) {
            // ç‰¹æ®ŠåŸå¸‚åˆ—è¡¨ï¼ˆç›´è¾–å¸‚ã€ç‰¹åˆ«è¡Œæ”¿åŒºï¼‰
            const specialCities = ['åŒ—äº¬', 'ä¸Šæµ·', 'å¤©æ´¥', 'é‡åº†', 'é¦™æ¸¯', 'æ¾³é—¨'];
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯ç›´è¾–å¸‚
            for (const city of specialCities) {
                if (name.includes(city) || district.includes(city)) {
                    return city + 'å¸‚';
                }
            }
            
            // å¦‚æœnameæœ¬èº«å°±æ˜¯"XXå¸‚"æ ¼å¼ï¼Œç›´æ¥è¿”å›
            if (name.endsWith('å¸‚') && !name.includes('åŒº') && !name.includes('å¿')) {
                return name;
            }
            
            // ä»districtä¸­æå–åŸå¸‚åï¼ˆæ ¼å¼é€šå¸¸æ˜¯"XXçœXXå¸‚XXåŒº"ï¼‰
            if (district) {
                // å°è¯•åŒ¹é…"XXå¸‚"çš„æ¨¡å¼
                const cityMatch = district.match(/([\u4e00-\u9fa5]+å¸‚)/g);
                if (cityMatch && cityMatch.length > 0) {
                    return cityMatch[0];
                }
                
                // å¦‚æœæ²¡æœ‰åŒ¹é…åˆ°å¸‚ï¼Œå°è¯•æå–çœä»½åçš„å†…å®¹
                const afterProvince = district.replace(/^[\u4e00-\u9fa5]+çœ/, '');
                if (afterProvince && afterProvince !== district) {
                    const cityInAfter = afterProvince.match(/^([\u4e00-\u9fa5]+?)(?:å¸‚|åŒº|å¿|$)/);
                    if (cityInAfter) {
                        return cityInAfter[1] + 'å¸‚';
                    }
                }
            }
            
            // ä»nameä¸­æå–
            if (name.includes('å¸‚')) {
                const cityMatch = name.match(/([\u4e00-\u9fa5]+å¸‚)/);
                if (cityMatch) {
                    return cityMatch[1];
                }
            }
            
            // å…œåº•ï¼šè¿”å›nameæœ¬èº«ï¼ˆå»æ‰å¯èƒ½çš„åŒºå¿åç¼€ï¼‰
            return name.replace(/åŒº$|å¿$/, '') + (name.endsWith('å¸‚') ? '' : 'å¸‚');
        }
        
        // éšè—åŸå¸‚æç¤º
        function hideCitySuggestions() {
            const container = document.getElementById('citySuggestions');
            container.style.display = 'none';
        }
        
        // é€‰æ‹©åŸå¸‚
        function selectCity(cityName) {
            const input = document.getElementById('destinationInput');
            input.value = cityName;
            // æ ‡è®°ä¸ºå·²é€‰æ‹©ï¼Œæ–‡å­—å˜è“
            input.style.color = '#3b82f6';
            input.style.fontWeight = '600';
            input.setAttribute('data-selected', 'true');
            hideCitySuggestions();
            
            // æ£€æŸ¥è¡¨å•éªŒè¯çŠ¶æ€
            checkFormValidity();
        }
        
        // ====== POI(æ™¯ç‚¹)æœç´¢åŠŸèƒ½ ======
        let placeSearch = null;
        let poiSearchTimeout = null;
        
        // ä»å®Œæ•´åœ°å€ä¸­æå–åŸå¸‚åç”¨äºPOIæœç´¢
        function extractCityForSearch(fullLocation) {
            if (!fullLocation) return 'å…¨å›½';
            
            console.log('[extractCityForSearch] è¾“å…¥:', fullLocation);
            
            // ç‰¹æ®ŠåŸå¸‚ï¼ˆç›´è¾–å¸‚ï¼‰
            const specialCities = ['åŒ—äº¬', 'ä¸Šæµ·', 'å¤©æ´¥', 'é‡åº†'];
            for (const city of specialCities) {
                if (fullLocation.includes(city)) {
                    console.log('[extractCityForSearch] åŒ¹é…ç›´è¾–å¸‚:', city);
                    return city;
                }
            }
            
            // å…ˆå»æ‰çœä»½å‰ç¼€ï¼Œç„¶åæå–åŸå¸‚
            let cleanLocation = fullLocation.replace(/^[\u4e00-\u9fa5]+çœ/, '');
            console.log('[extractCityForSearch] å»æ‰çœä»½å:', cleanLocation);
            
            // åŒ¹é…åŸå¸‚åï¼ˆå¦‚"ä¸œèå¸‚"ã€"å¹¿å·å¸‚"ï¼‰
            const cityMatch = cleanLocation.match(/^([\u4e00-\u9fa5]+å¸‚)/);
            if (cityMatch) {
                // è¿”å›çº¯åŸå¸‚åï¼ˆä¸å¸¦"å¸‚"åç¼€ï¼Œé«˜å¾·APIæ›´å®¹æ˜“è¯†åˆ«ï¼‰
                const cityName = cityMatch[1].replace(/å¸‚$/, '');
                console.log('[extractCityForSearch] æå–åŸå¸‚:', cityName);
                return cityName;
            }
            
            // å¦‚æœæ²¡æœ‰åŒ¹é…åˆ°ï¼Œè¿”å›å»æ‰çœåçš„å†…å®¹
            const result = cleanLocation.replace(/å¸‚$/, '') || fullLocation;
            console.log('[extractCityForSearch] æœ€ç»ˆç»“æœ:', result);
            return result;
        }
        
        // åˆå§‹åŒ–POIæœç´¢
        function initPoiSearch() {
            if (typeof AMap === 'undefined') {
                console.error('é«˜å¾·åœ°å›¾APIæœªåŠ è½½');
                return;
            }
            
            // è·å–ç›®çš„åœ°åŸå¸‚
            const destinationInput = document.getElementById('destinationInput');
            const fullLocation = destinationInput ? destinationInput.value.trim() : '';
            // ä»å®Œæ•´åœ°å€ä¸­æå–åŸå¸‚å
            const city = extractCityForSearch(fullLocation);
            
            // ä½¿ç”¨PlaceSearchæœç´¢POI
            placeSearch = new AMap.PlaceSearch({
                city: city,
                citylimit: false, // ä¸é™åˆ¶åœ¨åŸå¸‚å†…æœç´¢ï¼Œä½†ä¼˜å…ˆæ˜¾ç¤ºè¯¥åŸå¸‚ç»“æœ
                pageSize: 20,
                type: '' // æœç´¢æ‰€æœ‰ç±»å‹POI
            });
            
            console.log('POIæœç´¢åˆå§‹åŒ–æˆåŠŸï¼ŒåŸå¸‚:', city);
        }
        
        // POIæœç´¢å‡½æ•°
        function searchPoi(keyword, inputId, suggestionsId) {
            if (!keyword || keyword.trim() === '') {
                hidePoiSuggestions(suggestionsId);
                return;
            }
            
            // è·å–ç›®çš„åœ°åŸå¸‚
            const destinationInput = document.getElementById('destinationInput');
            const fullLocation = destinationInput ? destinationInput.value.trim() : '';
            
            if (!fullLocation) {
                console.log('è¯·å…ˆé€‰æ‹©ç›®çš„åœ°');
                hidePoiSuggestions(suggestionsId);
                return;
            }
            
            // ä»å®Œæ•´åœ°å€ä¸­æå–åŸå¸‚å
            const city = extractCityForSearch(fullLocation);
            
            if (!placeSearch) {
                initPoiSearch();
            }
            
            // æ›´æ–°æœç´¢åŸå¸‚
            placeSearch.setCity(city);
            
            console.log('æœç´¢POI:', keyword, 'åœ¨åŸå¸‚:', city);
            
            // ä½¿ç”¨é˜²æŠ–
            clearTimeout(poiSearchTimeout);
            poiSearchTimeout = setTimeout(() => {
                console.log('[POIæœç´¢] å¼€å§‹æœç´¢:', keyword, 'åŸå¸‚è®¾ç½®:', city);
                
                // é‡æ–°åˆå§‹åŒ–placeSearchä»¥ç¡®ä¿åŸå¸‚è®¾ç½®ç”Ÿæ•ˆ
                placeSearch = new AMap.PlaceSearch({
                    city: city,
                    citylimit: true, // é™åˆ¶åœ¨è¯¥åŸå¸‚æœç´¢
                    pageSize: 20,
                    type: '' // æœç´¢æ‰€æœ‰ç±»å‹POI
                });
                
                placeSearch.search(keyword, function(status, result) {
                    console.log('[POIæœç´¢] çŠ¶æ€:', status);
                    console.log('[POIæœç´¢] ç»“æœ:', result);
                    
                    if (status === 'complete' && result.poiList && result.poiList.pois && result.poiList.pois.length > 0) {
                        showPoiSuggestions(result.poiList.pois, suggestionsId, inputId);
                    } else if (status === 'no_data') {
                        console.log('æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æ™¯ç‚¹');
                        hidePoiSuggestions(suggestionsId);
                    } else {
                        hidePoiSuggestions(suggestionsId);
                    }
                });
            }, 300);
        }
        
        // æ˜¾ç¤ºPOIæç¤º
        function showPoiSuggestions(pois, suggestionsId, inputId) {
            const container = document.getElementById(suggestionsId);
            
            if (!container) {
                console.error('æ‰¾ä¸åˆ°æç¤ºå®¹å™¨:', suggestionsId);
                return;
            }
            
            console.log('æ˜¾ç¤ºPOIæç¤ºï¼Œæ•°é‡:', pois.length);
            
            if (pois.length === 0) {
                hidePoiSuggestions(suggestionsId);
                return;
            }
            
            container.innerHTML = pois.slice(0, 8).map(poi => {
                const name = poi.name || '';
                const address = poi.address || '';
                const district = poi.adname || poi.cityname || '';
                const typeName = poi.type ? poi.type.split(';')[0] : '';
                const location = address || district || '';
                // è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦é˜²æ­¢onclické”™è¯¯
                const safeName = name.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                
                return `
                    <div class="poi-suggestion-item" 
                         style="padding: 10px 14px; cursor: pointer; border-bottom: 1px solid #f3f4f6; transition: background 0.2s;"
                         onmouseover="this.style.background='#f3f4f6'"
                         onmouseout="this.style.background='white'"
                         onclick="selectPoi('${safeName}', '${inputId}')">
                        <div style="font-weight: 600; color: #374151; font-size: 13px; margin-bottom: 2px;">
                            ğŸ›ï¸ ${name}
                        </div>
                        <div style="font-size: 11px; color: #6b7280;">
                            ${location}${typeName ? ' Â· ' + typeName : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            container.style.display = 'block';
            console.log('POIæç¤ºåˆ—è¡¨å·²æ˜¾ç¤º');
        }
        
        // éšè—POIæç¤º
        function hidePoiSuggestions(suggestionsId) {
            const container = document.getElementById(suggestionsId);
            if (container) {
                container.style.display = 'none';
            }
        }
        
        // é€‰æ‹©POI
        function selectPoi(poiName, inputId) {
            const input = document.getElementById(inputId);
            if (input) {
                input.value = poiName;
                // æ ‡è®°ä¸ºå·²é€‰æ‹©ï¼Œæ–‡å­—å˜è“
                input.style.color = '#3b82f6';
                input.style.fontWeight = '600';
                input.setAttribute('data-selected', 'true');
            }
            // éšè—æ‰€æœ‰æç¤º
            document.querySelectorAll('.poi-suggestions').forEach(el => el.style.display = 'none');
            
            // æ£€æŸ¥è¡¨å•éªŒè¯çŠ¶æ€
            checkFormValidity();
        }
        
        // æ£€æŸ¥è¡¨å•å¿…å¡«é¡¹æ˜¯å¦å®Œæˆ
        function checkFormValidity() {
            let allFilled = true;
            
            // å¦‚æœæ˜¯åˆ›å»ºè€…ï¼Œæ£€æŸ¥å¿…å¡«é¡¹ï¼šç›®çš„åœ°ã€å¼€å§‹æ—¶é—´ã€ç»“æŸæ—¶é—´
            if (isCreator) {
                const destinationInput = document.getElementById('destinationInput');
                const startDateInput = document.getElementById('startDateInput');
                const endDateInput = document.getElementById('endDateInput');
                
                // æ£€æŸ¥æ‰€æœ‰å¿…å¡«é¡¹æ˜¯å¦å®Œæˆ
                const destinationFilled = destinationInput && destinationInput.getAttribute('data-selected') === 'true';
                const startDateFilled = startDateInput && startDateInput.value.trim() !== '';
                const endDateFilled = endDateInput && endDateInput.value.trim() !== '';
                
                allFilled = destinationFilled && startDateFilled && endDateFilled;
            }
            // åä½œè€…ä¸éœ€è¦æ£€æŸ¥è¿™ä¸‰ä¸ªå­—æ®µï¼Œå› ä¸ºæ˜¯åˆ›å»ºè€…å†³å®šçš„
            
            // è·å–æäº¤æŒ‰é’®
            const submitBtn = document.querySelector('button[type="submit"]');
            if (submitBtn) {
                if (allFilled) {
                    submitBtn.disabled = false;
                    submitBtn.style.opacity = '1';
                    submitBtn.style.cursor = 'pointer';
                } else {
                    submitBtn.disabled = true;
                    submitBtn.style.opacity = '0.5';
                    submitBtn.style.cursor = 'not-allowed';
                }
            }
            
            return allFilled;
        }
        
        // ç›‘å¬ç›®çš„åœ°è¾“å…¥æ¡†
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== é¡µé¢åŠ è½½å®Œæˆ ===');
            console.log('AMapæ˜¯å¦å­˜åœ¨:', typeof AMap !== 'undefined');
            console.log('å®‰å…¨é…ç½®:', window._AMapSecurityConfig);
            
            const destinationInput = document.getElementById('destinationInput');
            const suggestionsContainer = document.getElementById('citySuggestions');
            
            console.log('ç›®çš„åœ°è¾“å…¥æ¡†:', destinationInput);
            console.log('æç¤ºå®¹å™¨:', suggestionsContainer);
            
            if (destinationInput) {
                destinationInput.addEventListener('input', function(e) {
                    console.log('è¾“å…¥äº‹ä»¶è§¦å‘:', e.target.value);
                    
                    // å¦‚æœç”¨æˆ·æ‰‹åŠ¨ä¿®æ”¹äº†å†…å®¹ï¼Œæ¸…é™¤é€‰ä¸­æ ‡è®°
                    if (e.target.getAttribute('data-selected') === 'true') {
                        e.target.removeAttribute('data-selected');
                        e.target.style.color = '';
                        e.target.style.fontWeight = '';
                        checkFormValidity();
                    }
                    
                    searchCity(e.target.value);
                });
                
                // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­æç¤º
                document.addEventListener('click', function(e) {
                    if (!destinationInput.contains(e.target) && 
                        suggestionsContainer && !suggestionsContainer.contains(e.target)) {
                        hideCitySuggestions();
                    }
                });
            } else {
                console.error('æ‰¾ä¸åˆ°destinationInputå…ƒç´ ');
            }
            
            // åˆå§‹åŒ–é«˜å¾·åœ°å›¾
            console.log('å¼€å§‹åˆå§‹åŒ–é«˜å¾·åœ°å›¾...');
            initAmapAutoComplete();
            
            // åˆå§‹åŒ–POIæœç´¢
            initPoiSearch();
            
            // ä¸ºæ‰€æœ‰â€œæƒ³å»çš„æ™¯ç‚¹â€è¾“å…¥æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬
            document.querySelectorAll('.like-poi-input').forEach((input, index) => {
                const inputId = input.id;
                const suggestionsId = `poi-suggestions-like-${index + 1}`;
                
                console.log('ç»‘å®šæƒ³å»çš„æ™¯ç‚¹è¾“å…¥æ¡†:', inputId);
                
                input.addEventListener('input', function(e) {
                    console.log('æƒ³å»çš„æ™¯ç‚¹è¾“å…¥:', e.target.value);
                    
                    // å¦‚æœç”¨æˆ·æ‰‹åŠ¨ä¿®æ”¹äº†å†…å®¹ï¼Œæ¸…é™¤é€‰ä¸­æ ‡è®°
                    if (e.target.getAttribute('data-selected') === 'true') {
                        e.target.removeAttribute('data-selected');
                        e.target.style.color = '';
                        e.target.style.fontWeight = '';
                        checkFormValidity();
                    }
                    
                    searchPoi(e.target.value, inputId, suggestionsId);
                });
            });
            
            // ä¸ºæ‰€æœ‰â€œä¸å–œæ¬¢çš„æ™¯ç‚¹â€è¾“å…¥æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬
            document.querySelectorAll('.dislike-poi-input').forEach((input, index) => {
                const inputId = input.id;
                const suggestionsId = `poi-suggestions-dislike-${index + 1}`;
                
                console.log('ç»‘å®šä¸å–œæ¬¢çš„æ™¯ç‚¹è¾“å…¥æ¡†:', inputId);
                
                input.addEventListener('input', function(e) {
                    console.log('ä¸å–œæ¬¢çš„æ™¯ç‚¹è¾“å…¥:', e.target.value);
                    searchPoi(e.target.value, inputId, suggestionsId);
                });
            });
            
            // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­æ‰€æœ‰POIæç¤º
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.location-input') && !e.target.closest('.poi-suggestions')) {
                    document.querySelectorAll('.poi-suggestions').forEach(el => el.style.display = 'none');
                }
            });
            
            // ä¸ºæ—¥æœŸè¾“å…¥æ¡†æ·»åŠ changeäº‹ä»¶ç›‘å¬
            const startDateInput = document.getElementById('startDateInput');
            const endDateInput = document.getElementById('endDateInput');
            
            if (startDateInput) {
                startDateInput.addEventListener('change', function() {
                    checkFormValidity();
                });
            }
            
            if (endDateInput) {
                endDateInput.addEventListener('change', function() {
                    checkFormValidity();
                });
            }
            
            // åˆå§‹åŒ–è¡¨å•éªŒè¯çŠ¶æ€ï¼ˆç¦ç”¨æäº¤æŒ‰é’®ï¼‰
            checkFormValidity();
        });
        
        // Check if this is a shared link access
        const urlParams = new URLSearchParams(window.location.search);
        const sharedProjectId = urlParams.get('projectId');
        const inviteToken = urlParams.get('token');
        
        if (sharedProjectId && inviteToken) {
            // This is a shared link access
            isCreator = false;
            currentProjectId = sharedProjectId;
            // Load project data for non-creators
            loadSharedProjectData(sharedProjectId, inviteToken);
        }
        
        // Load shared project data
        async function loadSharedProjectData(projectId, token) {
            try {
                // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç»æäº¤è¿‡éœ€æ±‚
                const checkResponse = await fetch(`/api/requirement-parameters/project/${projectId}/all`);
                if (checkResponse.ok) {
                    const allRequirements = await checkResponse.json();
                    const userRequirement = allRequirements.find(r => r.userId === currentUser.id);
                    
                    if (userRequirement) {
                        // ç”¨æˆ·å·²ç»æäº¤è¿‡
                        alert('æ‚¨å·²ç»å¡«å†™è¿‡éœ€æ±‚ï¼Œè¯·ç­‰å¾…åˆ›å»ºè€…å¼€å§‹åä½œ');
                        setTimeout(() => {
                            navigate('/index.html');
                        }, 1500);
                        return;
                    }
                }
                
                // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç»åœ¨å‚ä¸è€…åˆ—è¡¨ä¸­
                const participantsResponse = await fetch(`/api/project-participants/project/${projectId}`);
                let isAlreadyParticipant = false;
                if (participantsResponse.ok) {
                    const participants = await participantsResponse.json();
                    isAlreadyParticipant = participants.some(p => p.userId === currentUser.id);
                }
                
                // å¦‚æœä¸æ˜¯å‚ä¸è€…ï¼Œè‡ªåŠ¨æ·»åŠ åˆ°å‚ä¸è€…åˆ—è¡¨ï¼ˆçŠ¶æ€ï¼šå¡«å†™ä¸­ï¼‰
                if (!isAlreadyParticipant) {
                    const now = new Date().toISOString();
                    try {
                        await fetch('/api/project-participants', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                projectId: parseInt(projectId),
                                userId: currentUser.id,
                                role: 'å‚ä¸è€…',
                                joinTime: now
                            })
                        });
                        console.log('å·²æ·»åŠ åˆ°å‚ä¸è€…åˆ—è¡¨');
                    } catch (err) {
                        console.error('Error adding participant:', err);
                    }
                }
                
                const response = await fetch(`/api/travel-projects/${projectId}`);
                if (response.ok) {
                    const project = await response.json();
                    document.querySelector('.section-title').textContent = `å‚ä¸é¡¹ç›®ï¼š${project.projectName}`;
                    document.getElementById('projectName').value = project.projectName;
                    document.getElementById('destination').value = project.destination;
                    document.getElementById('days').value = project.days;
                    
                    // å¡«å……æ—…è¡ŒåŸºæœ¬ä¿¡æ¯å­—æ®µ
                    if (project.destination) {
                        const destInput = document.getElementById('destinationInput');
                        destInput.value = project.destination;
                        destInput.readOnly = true;  // åä½œè€…åªè¯»
                        destInput.style.backgroundColor = '#f3f4f6';
                        destInput.style.cursor = 'not-allowed';
                    }
                    if (project.startDate) {
                        const startInput = document.getElementById('startDateInput');
                        startInput.value = project.startDate;
                        startInput.readOnly = true;  // åä½œè€…åªè¯»
                        startInput.style.backgroundColor = '#f3f4f6';
                        startInput.style.cursor = 'not-allowed';
                    }
                    if (project.endDate) {
                        const endInput = document.getElementById('endDateInput');
                        endInput.value = project.endDate;
                        endInput.readOnly = true;  // åä½œè€…åªè¯»
                        endInput.style.backgroundColor = '#f3f4f6';
                        endInput.style.cursor = 'not-allowed';
                    }
                    
                    // å°è¯•åŠ è½½ç”¨æˆ·çš„è‰ç¨¿ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    await loadDraftData(projectId);
                    
                    // Update button text
                    document.querySelector('button[type="submit"]').textContent = 'æäº¤æˆ‘çš„åå¥½';
                }
            } catch (error) {
                console.error('Error loading shared project:', error);
            }
        }
        
        // æ¸²æŸ“é¢„ç®—é¡¹åˆ—è¡¨
        function renderBudgetItems() {
            const container = document.getElementById('budgetItemsList');
            container.innerHTML = budgetItems.map(item => `
                <div class="budget-item" data-budget-id="${item.id}">
                    <div style="display: flex; align-items: center; flex: 1;">
                        <div class="budget-item-icon" style="background: ${item.color};">
                            ${item.icon}
                        </div>
                        <div class="budget-item-info">
                            <div class="budget-item-name">${item.name}</div>
                            <div class="budget-item-desc">${item.desc}</div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div class="budget-item-price blue ${isCreator ? 'editable' : ''}" data-amount="${item.amount}">
                            <span style="font-size: 14px;">ï¿¥</span>
                            <span class="amount-value">${item.amount}</span>
                            <span style="font-size: 14px; color: #6b7280;">/å¤©</span>
                        </div>
                        ${isCreator ? `<button type="button" class="delete-budget-btn" data-budget-id="${item.id}" style="background: #ef4444; color: white; border: none; border-radius: 6px; padding: 6px 10px; cursor: pointer; font-size: 12px;">âœ–</button>` : ''}
                    </div>
                </div>
            `).join('');
            
            // ä¸ºç¼–è¾‘æŒ‰é’®æ·»åŠ äº‹ä»¶
            if (isCreator) {
                document.querySelectorAll('.budget-item-price.editable').forEach(priceEl => {
                    priceEl.addEventListener('click', function() {
                        const budgetId = this.closest('.budget-item').getAttribute('data-budget-id');
                        const item = budgetItems.find(b => b.id === budgetId);
                        if (!item) return;
                        
                        const newAmount = prompt(`è¯·è¾“å…¥${item.name}çš„æ¯æ—¥é¢„ç®—ï¼ˆå…ƒï¼‰ï¼š`, item.amount);
                        if (newAmount !== null && !isNaN(newAmount) && parseFloat(newAmount) >= 0) {
                            item.amount = parseFloat(newAmount);
                            renderBudgetItems();
                            updateTotalBudget();
                            saveDraft();
                        }
                    });
                });
                
                // ä¸ºåˆ é™¤æŒ‰é’®æ·»åŠ äº‹ä»¶
                document.querySelectorAll('.delete-budget-btn').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const budgetId = this.getAttribute('data-budget-id');
                        const item = budgetItems.find(b => b.id === budgetId);
                        if (!item) return;
                        
                        if (confirm(`ç¡®å®šè¦åˆ é™¤ã€Œ${item.name}ã€é¢„ç®—é¡¹å—ï¼Ÿ`)) {
                            budgetItems = budgetItems.filter(b => b.id !== budgetId);
                            renderBudgetItems();
                            updateTotalBudget();
                            saveDraft();
                        }
                    });
                });
            }
        }
        
        // æ·»åŠ æ–°çš„é¢„ç®—é¡¹
        function addNewBudgetItem() {
            const name = prompt('è¯·è¾“å…¥é¢„ç®—é¡¹åç§°ï¼ˆä¾‹å¦‚ï¼šäº¤é€šã€è´­ç‰©ã€å¨±ä¹ï¼‰ï¼š');
            if (!name || name.trim() === '') return;
            
            const desc = prompt('è¯·è¾“å…¥æè¿°ï¼ˆå¯é€‰ï¼‰ï¼š') || 'æ¯æ—¥é¢„ç®—';
            const amount = prompt('è¯·è¾“å…¥æ¯æ—¥é¢„ç®—é‡‘é¢ï¼ˆå…ƒï¼‰ï¼š', '100');
            
            if (amount === null || isNaN(amount) || parseFloat(amount) < 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é‡‘é¢');
                return;
            }
            
            // é€‰æ‹©å›¾æ ‡
            const icons = ['ğŸšŒ', 'ğŸš', 'ğŸš•', 'ğŸ‰', 'ğŸ®', 'ğŸ¥', 'ğŸ“·', 'ğŸ›ï¸', 'â˜•', 'ğŸ«'];
            const colors = ['#dbeafe', '#fef3c7', '#e5e7eb', '#fce7f3', '#ddd6fe', '#d1fae5'];
            
            const newItem = {
                id: `custom_${budgetItemIdCounter++}`,
                name: name.trim(),
                desc: desc.trim(),
                icon: icons[Math.floor(Math.random() * icons.length)],
                color: colors[Math.floor(Math.random() * colors.length)],
                amount: parseFloat(amount)
            };
            
            budgetItems.push(newItem);
            renderBudgetItems();
            updateTotalBudget();
            saveDraft();
        }
        
        // æ›´æ–°æ€»é¢„ç®—
        function updateTotalBudget() {
            const total = budgetItems.reduce((sum, item) => sum + item.amount, 0);
            document.getElementById('dailyTotal').textContent = total;
        }
        function setupTripInfoPermissions() {
            const destinationInput = document.getElementById('destinationInput');
            const startDateInput = document.getElementById('startDateInput');
            const endDateInput = document.getElementById('endDateInput');
            
            if (!isCreator) {
                // éåˆ›å»ºè€…ï¼šç¦ç”¨è¿™äº›å­—æ®µ
                destinationInput.disabled = true;
                startDateInput.disabled = true;
                endDateInput.disabled = true;
                
                // æ·»åŠ ç¦ç”¨æ ·å¼
                destinationInput.style.backgroundColor = '#f9fafb';
                destinationInput.style.cursor = 'not-allowed';
                startDateInput.style.backgroundColor = '#f9fafb';
                startDateInput.style.cursor = 'not-allowed';
                endDateInput.style.backgroundColor = '#f9fafb';
                endDateInput.style.cursor = 'not-allowed';
            }
        }
        
        // ä¿å­˜è‰ç¨¿åˆ° localStorage
        function saveDraft() {
            if (isCreator || !currentProjectId) return;
            
            const draftKey = `draft_${currentProjectId}_${currentUser.id}`;
            const draftData = {
                selectedInterests: selectedInterests,
                likeLocations: likeLocations,
                dislikeLocations: dislikeLocations,
                budgetData: budgetItems,
                timestamp: new Date().toISOString()
            };
            
            localStorage.setItem(draftKey, JSON.stringify(draftData));
            console.log('è‰ç¨¿å·²ä¿å­˜');
        }
        
        // åŠ è½½è‰ç¨¿
        async function loadDraftData(projectId) {
            const draftKey = `draft_${projectId}_${currentUser.id}`;
            const draftJson = localStorage.getItem(draftKey);
            
            if (!draftJson) return;
            
            try {
                const draft = JSON.parse(draftJson);
                
                // æ¢å¤å…´è¶£é€‰æ‹©
                if (draft.selectedInterests && Array.isArray(draft.selectedInterests)) {
                    draft.selectedInterests.forEach(interest => {
                        selectedInterests.push(interest);
                        const item = document.querySelector(`[data-interest="${interest}"]`);
                        if (item) item.classList.add('selected');
                    });
                    updateInterestCount();
                }
                
                // æ¢å¤å–œæ¬¢çš„æ™¯ç‚¹
                if (draft.likeLocations) {
                    Object.assign(likeLocations, draft.likeLocations);
                    Object.keys(draft.likeLocations).forEach(key => {
                        const item = document.querySelector(`[data-location="${key}"]`);
                        if (item && draft.likeLocations[key]) {
                            const titleEl = item.querySelector('.location-title');
                            if (titleEl) titleEl.textContent = draft.likeLocations[key];
                        }
                    });
                }
                
                // æ¢å¤ä¸å–œæ¬¢çš„æ™¯ç‚¹
                if (draft.dislikeLocations) {
                    Object.assign(dislikeLocations, draft.dislikeLocations);
                    Object.keys(draft.dislikeLocations).forEach(key => {
                        const item = document.querySelector(`[data-location="${key}"]`);
                        if (item && draft.dislikeLocations[key]) {
                            const titleEl = item.querySelector('.location-title');
                            if (titleEl) titleEl.textContent = draft.dislikeLocations[key];
                        }
                    });
                }
                
                // æ¢å¤é¢„ç®—
                if (draft.budgetData) {
                    budgetItems = draft.budgetData;
                    renderBudgetItems();
                    updateTotalBudget();
                }
                
                console.log('è‰ç¨¿å·²åŠ è½½');
            } catch (error) {
                console.error('Error loading draft:', error);
            }
        }
        
        // æ¸…é™¤è‰ç¨¿
        function clearDraft() {
            if (!currentProjectId) return;
            const draftKey = `draft_${currentProjectId}_${currentUser.id}`;
            localStorage.removeItem(draftKey);
            console.log('è‰ç¨¿å·²æ¸…é™¤');
        }
        
        // Enable budget editing for creator
        // Enable budget editing for creator
        function enableBudgetEditing() {
            if (!isCreator) return;
            
            // æ˜¾ç¤ºæ·»åŠ æŒ‰é’®
            document.getElementById('addBudgetItemBtn').style.display = 'block';
            
            // æ¸²æŸ“é¢„ç®—é¡¹
            renderBudgetItems();
            updateTotalBudget();
        }
        
        // ä¸ºæ·»åŠ é¢„ç®—é¡¹æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬
        document.addEventListener('DOMContentLoaded', function() {
            const addBtn = document.getElementById('addBudgetItemBtn');
            if (addBtn) {
                addBtn.addEventListener('click', addNewBudgetItem);
            }
        });
        
        // Handle interest icon selection
        document.querySelectorAll('.icon-item').forEach(item => {
            item.addEventListener('click', function() {
                const interest = this.getAttribute('data-interest');
                
                if (this.classList.contains('selected')) {
                    this.classList.remove('selected');
                    const index = selectedInterests.indexOf(interest);
                    if (index > -1) {
                        selectedInterests.splice(index, 1);
                    }
                } else {
                    if (selectedInterests.length < 5) {
                        this.classList.add('selected');
                        selectedInterests.push(interest);
                    } else {
                        alert('æœ€å¤šåªèƒ½é€‰æ‹©5ä¸ªå…´è¶£æ ‡ç­¾');
                        return;
                    }
                }
                
                // Update counter
                document.querySelector('.interest-card-header .edit-link').textContent = `å·²é€‰æ‹© ${selectedInterests.length}/5`;
                
                // è‡ªåŠ¨ä¿å­˜è‰ç¨¿
                saveDraft();
            });
        });
        
        // Handle location item clicks - REMOVED, now using input fields
        // Location items no longer use prompt(), they have input fields inside
        
        // Initialize existing location items - NO LONGER NEEDED
        // document.querySelectorAll('.location-item').forEach(item => {
        //     attachLocationClickHandler(item);
        // });
        
        // Add new like location
        document.getElementById('addLikeLocation').addEventListener('click', function() {
            likeLocationCount++;
            const locationId = `like-${likeLocationCount}`;
            const inputId = `like-location-${likeLocationCount}`;
            const suggestionsId = `poi-suggestions-like-${likeLocationCount}`;
            likeLocations[locationId] = '';
            
            const locationItem = document.createElement('div');
            locationItem.className = 'location-item';
            locationItem.setAttribute('data-location', locationId);
            locationItem.innerHTML = `
                <div class="location-header">
                    <div class="location-number" style="background: #10b981;">${likeLocationCount}</div>
                    <div style="flex: 1;">
                        <div class="location-title">æƒ³å»çš„æ™¯ç‚¹</div>
                        <div style="position: relative;">
                            <input type="text" class="location-input like-poi-input" id="${inputId}" placeholder="è¾“å…¥æ™¯ç‚¹åç§°" autocomplete="off" 
                                   style="width: 100%; padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px; margin-top: 4px;"
                                   onfocus="this.style.borderColor='#10b981'"
                                   onblur="setTimeout(() => { this.style.borderColor='#e5e7eb'; }, 200)" />
                            <div class="poi-suggestions" id="${suggestionsId}" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 2px solid #10b981; border-top: none; border-radius: 0 0 10px 10px; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="location-desc">è¯·è¾“å…¥æ‚¨æƒ³å»çš„æ™¯ç‚¹åç§°</div>
            `;
            
            document.getElementById('likeLocationsList').appendChild(locationItem);
            
            // ä¸ºæ–°æ·»åŠ çš„è¾“å…¥æ¡†ç»‘å®šäº‹ä»¶
            const newInput = document.getElementById(inputId);
            newInput.addEventListener('input', function(e) {
                // å¦‚æœç”¨æˆ·æ‰‹åŠ¨ä¿®æ”¹äº†å†…å®¹ï¼Œæ¸…é™¤é€‰ä¸­æ ‡è®°
                if (e.target.getAttribute('data-selected') === 'true') {
                    e.target.removeAttribute('data-selected');
                    e.target.style.color = '';
                    e.target.style.fontWeight = '';
                    checkFormValidity();
                }
                
                searchPoi(e.target.value, inputId, suggestionsId);
            });
        });
        
        // Add new dislike location
        document.getElementById('addDislikeLocation').addEventListener('click', function() {
            dislikeLocationCount++;
            const locationId = `dislike-${dislikeLocationCount}`;
            const inputId = `dislike-location-${dislikeLocationCount}`;
            const suggestionsId = `poi-suggestions-dislike-${dislikeLocationCount}`;
            dislikeLocations[locationId] = '';
            
            const locationItem = document.createElement('div');
            locationItem.className = 'location-item';
            locationItem.setAttribute('data-location', locationId);
            locationItem.style.borderColor = '#fee2e2';
            locationItem.innerHTML = `
                <div class="location-header">
                    <div class="location-number" style="background: #ef4444;">${dislikeLocationCount}</div>
                    <div style="flex: 1;">
                        <div class="location-title">ä¸å–œæ¬¢çš„æ™¯ç‚¹</div>
                        <div style="position: relative;">
                            <input type="text" class="location-input dislike-poi-input" id="${inputId}" placeholder="è¾“å…¥æ™¯ç‚¹åç§°" autocomplete="off" 
                                   style="width: 100%; padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px; margin-top: 4px;"
                                   onfocus="this.style.borderColor='#ef4444'"
                                   onblur="setTimeout(() => { this.style.borderColor='#e5e7eb'; }, 200)" />
                            <div class="poi-suggestions" id="${suggestionsId}" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 2px solid #ef4444; border-top: none; border-radius: 0 0 10px 10px; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="location-desc">è¯·è¾“å…¥æ‚¨ä¸å–œæ¬¢çš„æ™¯ç‚¹åç§°</div>
            `;
            
            document.getElementById('dislikeLocationsList').appendChild(locationItem);
            
            // ä¸ºæ–°æ·»åŠ çš„è¾“å…¥æ¡†ç»‘å®šäº‹ä»¶
            const newInput = document.getElementById(inputId);
            newInput.addEventListener('input', function(e) {
                // å¦‚æœç”¨æˆ·æ‰‹åŠ¨ä¿®æ”¹äº†å†…å®¹ï¼Œæ¸…é™¤é€‰ä¸­æ ‡è®°
                if (e.target.getAttribute('data-selected') === 'true') {
                    e.target.removeAttribute('data-selected');
                    e.target.style.color = '';
                    e.target.style.fontWeight = '';
                    checkFormValidity();
                }
                
                searchPoi(e.target.value, inputId, suggestionsId);
            });
        });
        
        // Form submission
        document.getElementById('createProjectForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Validate interests
            if (selectedInterests.length < 2) {
                alert('è¯·è‡³å°‘é€‰æ‹©2ä¸ªå…´è¶£æ ‡ç­¾');
                return;
            }
            
            // Get location wishlist and dislike list from input fields
            const likeInputs = document.querySelectorAll('.like-poi-input');
            const dislikeInputs = document.querySelectorAll('.dislike-poi-input');
            
            const wishlist = Array.from(likeInputs)
                .map(input => input.value.trim())
                .filter(val => val !== '')
                .join(', ');
            
            const dislikeList = Array.from(dislikeInputs)
                .map(input => input.value.trim())
                .filter(val => val !== '')
                .join(', ');
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const loading = showLoading(submitBtn);
            
            try {
                if (isCreator) {
                    // Creator: Create new project
                    await handleCreatorSubmit(wishlist, dislikeList, loading);
                } else {
                    // Non-creator: Submit preferences for existing project
                    await handleParticipantSubmit(wishlist, dislikeList, loading);
                }
            } catch (error) {
                console.error('é”™è¯¯:', error);
                showError('æäº¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                loading.hide();
            }
        });
        
        // Handle creator submission
        async function handleCreatorSubmit(wishlist, dislikeList, loading) {
            // ä»æ–°çš„è¾“å…¥æ¡†è·å–å€¼
            let projectName = document.getElementById('projectName').value;
            let destination = document.getElementById('destinationInput').value.trim();
            const startDate = document.getElementById('startDateInput').value;
            const endDate = document.getElementById('endDateInput').value;
            
            // éªŒè¯å¿…å¡«å­—æ®µ
            if (!projectName) {
                projectName = prompt('è¯·è¾“å…¥è¡Œç¨‹åç§°ï¼š', `${selectedInterests[0]}ä¹‹æ—…`);
                if (!projectName) {
                    alert('è¯·è¾“å…¥è¡Œç¨‹åç§°');
                    loading.hide();
                    return;
                }
            }
            
            if (!destination) {
                alert('è¯·è¾“å…¥ç›®çš„åœ°');
                loading.hide();
                return;
            }
            
            if (!startDate || !endDate) {
                alert('è¯·é€‰æ‹©å¼€å§‹æ—¶é—´å’Œç»“æŸæ—¶é—´');
                loading.hide();
                return;
            }
            
            // éªŒè¯æ—¥æœŸé€»è¾‘
            const start = new Date(startDate);
            const end = new Date(endDate);
            if (end < start) {
                alert('ç»“æŸæ—¶é—´ä¸èƒ½æ—©äºå¼€å§‹æ—¶é—´');
                loading.hide();
                return;
            }
            
            // è®¡ç®—å¤©æ•°
            const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
            
            // Calculate total budget before creating project
            const dailyBudget = budgetItems.reduce((sum, item) => sum + item.amount, 0);
            const totalBudget = dailyBudget * days;
            
            // Create travel project
            const now = new Date().toISOString();
            const projectResult = await post('/travel-projects', {
                projectName,
                destination,
                days,
                creatorId: currentUser.id,
                status: 'è‰ç¨¿',
                createdTime: now,
                updatedTime: now,
                startDate: startDate,  // æ·»åŠ å¼€å§‹æ—¥æœŸ
                endDate: endDate,      // æ·»åŠ ç»“æŸæ—¥æœŸ
                totalBudget: totalBudget  // æ·»åŠ æ€»é¢„ç®—
            });
            
            // åç«¯ç›´æ¥è¿”å›é¡¹ç›®å¯¹è±¡ï¼Œä¸éœ€è¦æ£€æŸ¥ success å­—æ®µ
            if (!projectResult || !projectResult.id) {
                throw new Error('åˆ›å»ºé¡¹ç›®å¤±è´¥');
            }
            
            const projectId = projectResult.id;
            currentProjectId = projectId;
            
            // Generate and display share link
            generateShareLink(projectId);
            
            // Save budget to budgets table (for backward compatibility)
            await post('/budgets', {
                projectId,
                totalBudget,
                usedBudget: 0,
                remainingBudget: totalBudget
            });
            
            // Save requirement parameters with budget breakdown
            await post('/requirement-parameters', {
                projectId,
                userId: currentUser.id,
                interestTags: selectedInterests.join(','),
                wishlist,
                dailyBudgetAllocation: dailyBudget,
                dislikeList: dislikeList,
                budgetBreakdown: JSON.stringify(budgetItems)
            });
            
            // Create participant record
            await post('/travel-participants', {
                projectId,
                userId: currentUser.id,
                permission: 'åˆ›å»ºè€…'
            });
            
            // Add project participant
            await post('/project-participants', {
                projectId,
                userId: currentUser.id,
                role: 'åˆ›å»ºè€…',
                joinTime: now
            });
            
            // Generate AI route
            await post('/ai-generated-routes', {
                projectId,
                routeContent: JSON.stringify({
                    title: `${destination}${days}æ—¥æ¸¸æ¨èè·¯çº¿`,
                    description: 'æ ¹æ®æ‚¨çš„éœ€æ±‚ä¸ºæ‚¨ç”Ÿæˆçš„æ—…è¡Œè·¯çº¿',
                    highlights: selectedInterests,
                    wishlist: wishlist,
                    dislikeList: dislikeList,
                    dailyBudget: budgetItems
                }),
                generatedTime: now,
                interestTags: selectedInterests.join(',')
            });
            
            loading.hide();
            showSuccess('åˆ›å»ºæˆåŠŸï¼æ­£åœ¨è·³è½¬...');
            
            // åˆ›å»ºè€…ç›´æ¥è·³è½¬åˆ°æŸ¥çœ‹æˆå‘˜é¡µé¢
            setTimeout(() => {
                navigate(`/participants-status.html?id=${projectId}`);
            }, 1500);
        }
        
        // Handle participant submission
        async function handleParticipantSubmit(wishlist, dislikeList, loading) {
            const now = new Date().toISOString();
            
            // Calculate daily budget
            const dailyBudget = budgetItems.reduce((sum, item) => sum + item.amount, 0);
            
            // Save participant's requirement parameters
            await post('/requirement-parameters', {
                projectId: currentProjectId,
                userId: currentUser.id,
                interestTags: selectedInterests.join(','),
                wishlist,
                dailyBudgetAllocation: dailyBudget,
                dislikeList: dislikeList,
                budgetBreakdown: JSON.stringify(budgetItems)
            });
            
            // ç”¨æˆ·åœ¨è¿›å…¥é¡µé¢æ—¶å·²ç»è¢«æ·»åŠ åˆ° project-participantsï¼Œä¸éœ€è¦é‡å¤æ·»åŠ 
            // åªéœ€è¦æ·»åŠ åˆ° travel-participants
            
            // Add as travel participant
            await post('/travel-participants', {
                projectId: currentProjectId,
                userId: currentUser.id,
                permission: 'æˆå‘˜'
            });
            
            loading.hide();
            showSuccess('æäº¤æˆåŠŸï¼ç­‰å¾…åˆ›å»ºè€…å¼€å¯åä½œ...');
            
            // æ¸…é™¤è‰ç¨¿
            clearDraft();
            
            // Redirect to home page
            setTimeout(() => {
                navigate('/index.html');
            }, 2000);
        }
        
        // Generate share link
        function generateShareLink(projectId) {
            const token = Math.random().toString(36).substring(2, 15);
            const shareUrl = `${window.location.origin}/create-project.html?projectId=${projectId}&token=${token}`;
            document.getElementById('shareLink').value = shareUrl;
            
            // Show the share link section
            document.getElementById('shareLinkSection').style.display = 'block';
        }
        
        // Copy share link
        document.getElementById('copyLinkBtn').addEventListener('click', function() {
            const shareLinkInput = document.getElementById('shareLink');
            shareLinkInput.select();
            document.execCommand('copy');
            
            // Visual feedback
            this.textContent = 'âœ… å·²å¤åˆ¶';
            setTimeout(() => {
                this.textContent = 'ğŸ“‹ å¤åˆ¶é“¾æ¥';
            }, 2000);
        });
        
        // View participants
        document.getElementById('viewParticipantsBtn').addEventListener('click', function() {
            if (currentProjectId) {
                navigate(`/participants-status.html?id=${currentProjectId}`);
            }
        });
        
        // Initialize budget editing
        enableBudgetEditing();
        
        // åˆå§‹åŒ–æ—…è¡Œä¿¡æ¯å­—æ®µæƒé™
        setupTripInfoPermissions();
    </script>
</body>
</html>