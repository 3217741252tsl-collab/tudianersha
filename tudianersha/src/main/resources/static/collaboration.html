<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>协作编辑 - 途点儿啥</title>
  <!-- Version: 2024-12-17-v24-nearby-poi-location -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
  <!-- 高德地图JS API -->
  <script type="text/javascript">
    window._AMapSecurityConfig = {
      securityJsCode: '07ec5b4c0314b96e44928e25dede60f7'
    }
  </script>
  <script type="text/javascript" src="https://webapi.amap.com/maps?v=2.0&key=bf0e97cd7a4c3c6aaa8ecf3dd7485381&plugin=AMap.Driving,AMap.Walking,AMap.Transfer,AMap.Polyline"></script>
  <style>
    .timeline-item { position: relative; padding-left: 30px; }
    .timeline-item::before { content: ''; position: absolute; left: 8px; top: 30px; width: 2px; height: calc(100% - 20px); background: #e5e7eb; }
    .timeline-dot { position: absolute; left: 0; top: 8px; width: 18px; height: 18px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .flow-node { width: 80px; height: 80px; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; font-weight: bold; position: relative; }
    .flow-line { height: 2px; flex: 1; margin: 0 -10px; background: linear-gradient(to right, transparent 0%, #3b82f6 20%, #3b82f6 80%, transparent 100%); background-size: 10px 2px; }
    .flow-line-dashed { background: repeating-linear-gradient(to right, #3b82f6 0px, #3b82f6 10px, transparent 10px, transparent 20px); }
    
    /* 拖拽样式 */
    .attraction-card { cursor: grab; transition: transform 0.2s, box-shadow 0.2s; }
    .attraction-card:active { cursor: grabbing; }
    .attraction-card.dragging { opacity: 0.5; transform: scale(0.95); }
    .attraction-card.drag-over { border: 2px dashed #3b82f6; background-color: #eff6ff; }
    .attraction-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .drag-placeholder { border: 2px dashed #9ca3af; background-color: #f3f4f6; border-radius: 0.5rem; min-height: 120px; }
    
    /* Chat Styles */
    .chat-messages {
      height: 300px;
      overflow-y: auto;
      scroll-behavior: smooth;
    }
    .chat-messages::-webkit-scrollbar {
      width: 6px;
    }
    .chat-messages::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 3px;
    }
    .chat-messages::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 3px;
    }
    .chat-messages::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }
    
    /* 浮动聊天窗口样式 */
    .chat-window {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 400px;
      max-height: 600px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
      display: flex;
      flex-direction: column;
      z-index: 1000;
      transition: all 0.3s ease;
    }
    
    .chat-window.minimized {
      max-height: 48px;
    }
    
    .chat-window.hidden {
      display: none;
    }
    
    .chat-window.dragging {
      opacity: 0.8;
      cursor: move;
    }
    
    .chat-window-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 12px 16px;
      border-radius: 12px 12px 0 0;
      cursor: move;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .chat-window-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 28px;
      height: 28px;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }
    
    .chat-window-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    
    .chat-window-body {
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      overflow: hidden;
    }
    
    .chat-window.minimized .chat-window-body {
      display: none;
    }
    .mention {
      color: #3b82f6;
      background-color: #dbeafe;
      padding: 1px 4px;
      border-radius: 3px;
      font-weight: 600;
    }
    .mention-dropdown {
      position: absolute;
      bottom: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      max-height: 200px;
      overflow-y: auto;
      display: none;
      z-index: 1000;
    }
    .mention-dropdown.active {
      display: block;
    }
    .mention-item {
      padding: 8px 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .mention-item:hover {
      background-color: #f3f4f6;
    }
    .mention-item.selected {
      background-color: #dbeafe;
    }
    
    /* 刷新按钮旋转动画 */
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
  </style>
  <!-- 景点名称提取工具 -->
  <script src="/js/attraction-name-extractor.js"></script>
  <!-- 协作界面数据适配器 -->
  <script src="/js/collaboration-data-adapter.js"></script>
</head>
<body class="bg-gray-50">
  <!-- 顶部导航 -->
  <header class="bg-white shadow-sm">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex items-center gap-4">
        <button onclick="window.history.back()" class="text-gray-600 hover:text-gray-900">
          <iconify-icon icon="mdi:arrow-left" width="24"></iconify-icon>
        </button>
        <h1 class="text-xl font-bold" id="projectName">国庆七日游</h1>
        <span id="projectStatusBadge" class="bg-blue-500 text-white text-xs px-3 py-1 rounded-full cursor-pointer hover:bg-blue-600 transition-colors" onclick="handleStatusClick()" title="点击归档项目">协作中</span>
      </div>
      <div class="flex items-center gap-3">
        <div class="flex -space-x-2" id="participantAvatars">
          <!-- 动态加载参与者头像 -->
        </div>
        <button id="permissionManageBtn" class="bg-purple-500 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-purple-600" style="display: none;" onclick="openPermissionModal()">
          <iconify-icon icon="mdi:account-cog"></iconify-icon>
          <span>权限管理</span>
        </button>
        <button class="bg-blue-500 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-blue-600" onclick="copyInviteLink()">
          <iconify-icon icon="mdi:share"></iconify-icon>
          <span>邀请</span>
        </button>
        <button onclick="openChatWindow()" class="bg-gradient-to-r from-purple-500 to-purple-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:shadow-lg transition-all" title="打开群聊讨论">
          <iconify-icon icon="mdi:chat" width="20"></iconify-icon>
          <span>群聊</span>
        </button>
        <button id="refreshBtn" class="bg-green-500 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-green-600" onclick="manualRefresh()" title="刷新最新数据">
          <iconify-icon icon="mdi:refresh"></iconify-icon>
        </button>
        <button onclick="window.location.href='/index.html'" class="text-gray-600 hover:text-gray-900">
          <iconify-icon icon="mdi:close" width="24"></iconify-icon>
        </button>
      </div>
    </div>
  </header>

  <!-- 主内容区 -->
  <div class="container mx-auto px-4 py-6">
    <div class="grid grid-cols-12 gap-4">
      <!-- 左侧：景点列表 (3列) -->
      <div class="col-span-3 bg-white rounded-lg shadow p-4">
        <div class="flex items-center justify-between mb-4">
          <h3 class="font-bold text-lg flex items-center gap-2">
            <iconify-icon icon="mdi:map-marker-multiple" class="text-blue-500"></iconify-icon>
            景点列表
          </h3>
        </div>
        
        <!-- 日期选择器 -->
        <div class="mb-4">
          <label class="text-sm text-gray-600 mb-2 block">选择日期</label>
          <select id="daySelector" class="w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="loadDayAttractions()">
            <!-- 动态生成天数选项 -->
          </select>
        </div>
        
        <!-- 景点列表 -->
        <div class="space-y-2 max-h-[calc(100vh-450px)] overflow-y-auto" id="attractionsList">
          <div class="text-center text-gray-400 py-8">
            <iconify-icon icon="mdi:map-search" width="48"></iconify-icon>
            <p class="mt-2 text-sm">加载中...</p>
          </div>
        </div>
        
        <!-- 路线地图 -->
        <div class="mt-4 border-t pt-4">
          <h4 class="font-bold text-sm flex items-center gap-2 mb-2">
            <iconify-icon icon="mdi:map" class="text-green-500"></iconify-icon>
            路线地图
          </h4>
          <div id="routeMapContainer" class="w-full h-64 rounded-lg overflow-hidden bg-gray-100 flex items-center justify-center">
            <div class="text-center text-gray-400">
              <iconify-icon icon="mdi:map-outline" width="32"></iconify-icon>
              <p class="text-xs mt-1">加载地图中...</p>
            </div>
          </div>
        </div>
      </div>

      <!-- 中间：路线总览 (5列) -->
      <div class="col-span-5">
        <div class="bg-white rounded-lg shadow p-4 mb-4">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-bold text-lg flex items-center gap-2">
              <iconify-icon icon="mdi:timeline-text" class="text-purple-500"></iconify-icon>
              路线总览
            </h3>
            <div class="flex items-center gap-3">
              <span class="text-xs text-gray-500" id="currentDayLabel">第1天</span>
              <button id="addActivityBtn" onclick="openAddActivityModal()" 
                      class="hidden bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded-lg text-sm flex items-center gap-1">
                <iconify-icon icon="mdi:plus" width="16"></iconify-icon>
                新增活动
              </button>
            </div>
          </div>
          
          <!-- 当日行程卡片 (横向4列网格) -->
          <div class="grid grid-cols-4 gap-3" id="dayOverviewGrid">
            <!-- 动态加载行程卡片 -->
            <div class="text-center text-gray-400 col-span-4 py-8">
              <iconify-icon icon="mdi:calendar-blank" width="48"></iconify-icon>
              <p class="mt-2 text-sm">请选择日期查看行程</p>
            </div>
          </div>
          
          <!-- 预算统计区域 -->
          <div id="budgetSummary" class="mt-4 p-4 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg border border-blue-200 hidden">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <div class="bg-white p-2 rounded-full">
                  <iconify-icon icon="mdi:cash-multiple" class="text-blue-600" width="24"></iconify-icon>
                </div>
                <div>
                  <h4 class="font-bold text-gray-800 text-sm">当日预算总计</h4>
                  <p class="text-xs text-gray-600 mt-0.5">已填写项目的预算总和</p>
                </div>
              </div>
              <div class="text-right">
                <div class="flex items-baseline gap-2">
                  <span class="text-2xl font-bold text-gray-800" id="totalBudget">0</span>
                  <span class="text-sm text-gray-600">元</span>
                </div>
                <div class="text-xs mt-1" id="budgetStatus">
                  <span class="text-gray-500">计划预算：</span>
                  <span class="font-semibold" id="plannedBudget">0</span>元
                </div>
                <div id="hotelCostDisplay" class="hidden text-xs mt-1">
                  <span class="text-purple-500">含酒店：</span>
                  <span class="font-semibold text-purple-600" id="hotelCostAmount">0</span>元/晚
                </div>
                <div id="transportCostDisplay" class="hidden text-xs mt-1">
                  <span class="text-blue-500">含交通：</span>
                  <span class="font-semibold text-blue-600" id="transportCostAmount">0</span>元
                </div>
              </div>
            </div>
            <div class="mt-2 text-center">
              <div id="budgetWarning" class="hidden px-3 py-1.5 rounded-lg text-xs font-medium">
                <!-- 预算超支或剩余提示 -->
              </div>
            </div>
          </div>
          
          <!-- 任务分工区域 -->
          <div id="taskSection" class="mt-4 p-4 bg-white rounded-lg border border-gray-200 shadow-sm">
            <div class="flex items-center justify-between mb-3">
              <div class="flex items-center gap-2">
                <iconify-icon icon="mdi:clipboard-check-outline" class="text-purple-600" width="20"></iconify-icon>
                <h4 class="font-bold text-gray-800 text-sm">任务分工</h4>
              </div>
              <button id="addTaskBtn" onclick="openAddTaskModal()" class="hidden px-3 py-1 bg-purple-500 text-white text-xs rounded-lg hover:bg-purple-600 flex items-center gap-1">
                <iconify-icon icon="mdi:plus" width="14"></iconify-icon>
                <span>新建任务</span>
              </button>
            </div>
            <div id="taskList" class="space-y-2">
              <div class="text-center text-gray-400 text-sm py-4">
                <iconify-icon icon="mdi:clipboard-text-outline" width="32" class="mb-2"></iconify-icon>
                <p>暂无任务</p>
              </div>
            </div>
          </div>
          
          <!-- 酒店信息区域 -->
          <div id="hotelSection" class="mt-4 p-4 bg-white rounded-lg border border-gray-200 shadow-sm">
            <div class="flex items-center justify-between mb-3">
              <div class="flex items-center gap-2">
                <iconify-icon icon="mdi:hotel" class="text-purple-600" width="20"></iconify-icon>
                <h4 class="font-bold text-gray-800 text-sm">酒店信息</h4>
              </div>
              <button id="setHotelBtn" onclick="openSetHotelModal(1)" class="hidden px-3 py-1 bg-purple-500 text-white text-xs rounded-lg hover:bg-purple-600 flex items-center gap-1">
                <iconify-icon icon="mdi:plus" width="14"></iconify-icon>
                <span>设置酒店</span>
              </button>
            </div>
            <div id="hotelList" class="space-y-2">
              <div class="text-center text-gray-400 text-sm py-4">
                <iconify-icon icon="mdi:hotel" width="32" class="mb-2"></iconify-icon>
                <p>暂未设置酒店</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 右侧：景点介绍 (4列) -->
      <div class="col-span-4">
        <div class="bg-white rounded-lg shadow p-4" id="attractionDetailPanel">
          <!-- 默认空状态 -->
          <div class="h-[calc(100vh-200px)] flex flex-col items-center justify-center text-gray-400" id="emptyState">
            <iconify-icon icon="mdi:information-outline" width="64" class="mb-4"></iconify-icon>
            <p class="text-lg">点击景点查看介绍</p>
          </div>
          
          <!-- 景点介绍内容 -->
          <div class="hidden" id="attractionDetail">
            <!-- 景点标题 -->
            <div class="mb-4 pb-4 border-b">
              <h2 class="text-xl font-bold text-gray-800 mb-2" id="attractionName">景点名称</h2>
              <div class="flex items-center gap-4 text-sm text-gray-600">
                <div class="flex items-center gap-1">
                  <iconify-icon icon="mdi:map-marker"></iconify-icon>
                  <span id="attractionAddress" class="text-xs">地址加载中...</span>
                </div>
              </div>
            </div>
            
            <!-- 景点图片 -->
            <div class="mb-4">
              <div class="relative rounded-lg overflow-hidden bg-gray-100" style="height: 200px;">
                <img id="attractionImage" src="" alt="景点图片" 
                     class="w-full h-full object-cover hidden"
                     onerror="this.classList.add('hidden'); document.getElementById('attractionImagePlaceholder').classList.remove('hidden');">
                <div id="attractionImagePlaceholder" class="w-full h-full flex flex-col items-center justify-center text-gray-400">
                  <iconify-icon icon="mdi:image-outline" width="48"></iconify-icon>
                  <span class="text-sm mt-2">图片加载中...</span>
                </div>
              </div>
            </div>
            
            <!-- AI 介绍 -->
            <div class="border-t pt-4">
              <div class="flex items-center gap-2 mb-3">
                <div class="w-6 h-6 bg-purple-500 rounded-full flex items-center justify-center">
                  <iconify-icon icon="mdi:robot" class="text-white" width="14"></iconify-icon>
                </div>
                <h3 class="text-sm font-bold">AI 智能介绍</h3>
                <span class="text-xs text-gray-500">by Kimi</span>
              </div>
              <div class="prose prose-sm max-w-none">
                <div id="aiIntroduction" class="text-gray-700 text-sm leading-relaxed max-h-[calc(100vh-600px)] overflow-y-auto">
                  <div class="flex items-center justify-center py-8">
                    <iconify-icon icon="mdi:loading" class="text-blue-500 animate-spin" width="24"></iconify-icon>
                    <span class="ml-2 text-gray-500 text-xs">AI 正在生成介绍...</span>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- 附近景点推荐 -->
            <div class="border-t pt-4 mt-4" id="nearbyAttractionsSection">
              <div class="flex items-center gap-2 mb-3">
                <div class="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center">
                  <iconify-icon icon="mdi:map-marker-radius" class="text-white" width="14"></iconify-icon>
                </div>
                <h3 class="text-sm font-bold">附近景点推荐</h3>
                <span class="text-xs text-gray-500">周边可以顺便游览</span>
              </div>
              <div id="nearbyAttractions" class="space-y-2">
                <div class="flex items-center justify-center py-4 text-gray-400 text-xs">
                  <iconify-icon icon="mdi:loading" class="animate-spin mr-2" width="16"></iconify-icon>
                  加载中...
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 浮动聊天窗口 -->
    <div id="chatWindow" class="chat-window">
      <div class="chat-window-header" id="chatWindowHeader">
        <div class="flex items-center gap-2 flex-1">
          <iconify-icon icon="mdi:chat" width="18"></iconify-icon>
          <h4 class="font-bold text-sm">群聊讨论</h4>
          <span class="text-xs text-gray-500 font-normal">(@提及成员)</span>
        </div>
        <div class="flex items-center gap-1">
          <button onclick="toggleChatWindow()" class="chat-window-btn" title="最小化">
            <iconify-icon icon="mdi:window-minimize" width="16"></iconify-icon>
          </button>
          <button onclick="closeChatWindow()" class="chat-window-btn" title="关闭">
            <iconify-icon icon="mdi:close" width="16"></iconify-icon>
          </button>
        </div>
      </div>
      <div class="chat-window-body" id="chatWindowBody">
        <div class="chat-messages space-y-2 mb-3 p-3 bg-gray-50 rounded-lg" id="chatMessages">
          <!-- 聊天消息 -->
        </div>
        <div class="relative">
          <div class="mention-dropdown" id="mentionDropdown">
            <!-- @mention suggestions -->
          </div>
          <!-- 引用预览区 -->
          <div id="replyPreview" class="hidden mb-2 p-2 bg-gray-100 rounded-lg border-l-4 border-blue-500">
            <div class="flex justify-between items-start">
              <div class="flex-1 min-w-0">
                <div class="text-xs text-blue-600 font-bold" id="replyToUser"></div>
                <div class="text-sm text-gray-600 truncate" id="replyToContent"></div>
              </div>
              <button onclick="cancelReply()" class="text-gray-400 hover:text-gray-600 ml-2">
                <iconify-icon icon="mdi:close" width="16"></iconify-icon>
              </button>
            </div>
          </div>
          <div class="flex gap-2">
            <input type="text" id="chatInput" placeholder="输入消息... (输入@提及其他用户)" class="flex-1 border rounded-lg px-4 py-2 text-sm" />
            <button onclick="openVoteModal()" class="bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600" title="发起投票">
              <iconify-icon icon="mdi:poll"></iconify-icon>
            </button>
            <button onclick="sendMessage()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
              <iconify-icon icon="mdi:send"></iconify-icon>
            </button>
          </div>
        </div>
      </div>
    </div>
    </div>
  </div>

  <!-- 投票弹窗 -->
  <div id="voteModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4">
      <div class="bg-gradient-to-r from-orange-500 to-yellow-500 px-6 py-4 flex justify-between items-center">
        <h2 class="text-xl font-bold text-white flex items-center gap-2">
          <iconify-icon icon="mdi:poll" width="24"></iconify-icon>
          发起投票
        </h2>
        <button onclick="closeVoteModal()" class="text-white hover:text-gray-200">
          <iconify-icon icon="mdi:close" width="24"></iconify-icon>
        </button>
      </div>
      <div class="p-6">
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">投票标题 <span class="text-red-500">*</span></label>
            <input type="text" id="voteTitle" placeholder="例如：明天去哪个景点？" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-orange-500">
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">投票选项 <span class="text-red-500">*</span></label>
            <div id="voteOptions" class="space-y-2">
              <input type="text" class="vote-option w-full border rounded-lg px-3 py-2" placeholder="选项1">
              <input type="text" class="vote-option w-full border rounded-lg px-3 py-2" placeholder="选项2">
            </div>
            <button onclick="addVoteOption()" class="mt-2 text-sm text-orange-500 hover:text-orange-600 flex items-center gap-1">
              <iconify-icon icon="mdi:plus"></iconify-icon>添加选项
            </button>
          </div>
        </div>
      </div>
      <div class="bg-gray-50 px-6 py-4 flex justify-end gap-3">
        <button onclick="closeVoteModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">取消</button>
        <button onclick="createVote()" class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600">发起投票</button>
      </div>
    </div>
  </div>

  <!-- 右下角悬浮按钮：导出PDF（只在项目归档后显示） -->
  <div id="pdfExportButton" class="fixed bottom-8 right-8 z-50" style="display: none;">
    <button onclick="exportPdf(event)" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-full shadow-lg flex items-center gap-2 transition-all duration-300 hover:shadow-xl hover:scale-105">
      <iconify-icon icon="mdi:file-pdf-box" width="24"></iconify-icon>
      <span class="font-medium">导出PDF</span>
    </button>
  </div>

  <!-- 权限管理弹窗 -->
  <div id="permissionModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl mx-4 max-h-[80vh] overflow-hidden">
      <div class="bg-gradient-to-r from-purple-500 to-blue-500 px-6 py-4 flex justify-between items-center">
        <h2 class="text-xl font-bold text-white flex items-center gap-2">
          <iconify-icon icon="mdi:account-cog" width="24"></iconify-icon>
          权限管理
        </h2>
        <button onclick="closePermissionModal()" class="text-white hover:text-gray-200">
          <iconify-icon icon="mdi:close" width="24"></iconify-icon>
        </button>
      </div>
      <div class="p-6 overflow-y-auto" style="max-height: calc(80vh - 140px);">
        <div class="mb-4 text-sm text-gray-600">
          <p>⚠️ 权限说明：</p>
          <ul class="list-disc list-inside ml-2 mt-2 space-y-1">
            <li><strong>编辑者</strong>：可以查看和编辑项目内容</li>
            <li><strong>查看者</strong>：只能查看项目内容，不能编辑</li>
          </ul>
        </div>
        <div id="participantList" class="space-y-3">
          <!-- 参与者列表将动态生成 -->
        </div>
      </div>
      <div class="bg-gray-50 px-6 py-4 flex justify-end gap-3">
        <button onclick="closePermissionModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">取消</button>
        <button onclick="savePermissions()" class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600">保存修改</button>
      </div>
    </div>
  </div>

  <!-- 新增/编辑活动弹窗 -->
  <div id="activityModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4">
      <div class="bg-gradient-to-r from-green-500 to-blue-500 px-6 py-4 flex justify-between items-center">
        <h2 class="text-xl font-bold text-white flex items-center gap-2">
          <iconify-icon icon="mdi:calendar-plus" width="24"></iconify-icon>
          新增活动
        </h2>
        <button onclick="closeActivityModal()" class="text-white hover:text-gray-200">
          <iconify-icon icon="mdi:close" width="24"></iconify-icon>
        </button>
      </div>
      <div class="p-6">
        <div class="space-y-4">
          <!-- 活动类型 - 简化为只有景点 -->
          <div class="hidden">
            <select id="activityType" class="w-full border rounded-lg px-3 py-2">
              <option value="attraction" selected>景点游览</option>
            </select>
          </div>
          
          <!-- 景点名称 -->
          <div class="relative">
            <label class="block text-sm font-semibold text-gray-700 mb-2">景点名称 <span class="text-red-500">*</span></label>
            <input type="text" id="activityName" placeholder="请输入景点名称，如：西湖" 
                   oninput="handleActivityNameInput()"
                   class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500">
            <input type="hidden" id="selectedPoiLocation" value="">
            <input type="hidden" id="selectedPoiId" value="">
            <p class="text-xs text-gray-500 mt-1">请从下方列表中选择景点，确保高德能识别位置</p>
            <!-- 自动补全下拉列表 -->
            <div id="activitySuggestions" class="hidden absolute z-10 w-full bg-white border border-gray-300 rounded-lg shadow-lg mt-1 max-h-60 overflow-y-auto">
              <!-- 动态生成建议列表 -->
            </div>
          </div>
          
          <!-- 详细描述 -->
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">详细描述</label>
            <textarea id="activityDescription" rows="3" placeholder="选填：开放时间、门票等信息" 
                      class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500"></textarea>
          </div>
        </div>
      </div>
      <div class="bg-gray-50 px-6 py-4 flex justify-end gap-3">
        <button onclick="closeActivityModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">取消</button>
        <button onclick="saveActivity()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">保存</button>
      </div>
    </div>
  </div>

  <script src="/js/common.js"></script>
  <script>
    // URL参数获取函数
    function getQueryParam(param) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
    }
    
    if (!auth.isLoggedIn()) {
      window.location.href = '/login.html';
      throw new Error('Not logged in');
    }

    const currentUser = auth.getUser();
    const projectId = getQueryParam('id');
    const inviteToken = getQueryParam('invite');
    
    // 全局变量
    let canEdit = false; // 当前用户是否有编辑权限（创建者或编辑者）
        let isProjectCreator = false; // 当前用户是否是创建者
        let isCreator = false; // 全局isCreator用于任务分工
        let projectStatus = '协作中'; // 项目状态
    let currentRouteData = null; // 当前路线数据
    let currentProjectInfo = null; // 当前项目信息缓存
    let currentDayAttractions = []; // 当前天数的景点列表
    let destinationCity = ''; // 项目目的地城市
    let activitySuggestionsData = []; // 活动名称自动补全数据
    let dailyItinerary = []; // 每日行程数据
    let autoRefreshInterval = null; // 自动刷新定时器
    let projectRequirements = []; // 所有用户的需求参数
    let activityBudgets = {}; // 每个活动的预算 { 'day-index': budget }
    
    // 地图相关变量
    let routeMap = null; // 高德地图实例
    let routeMarkers = []; // 地图标记点
    let routePolylines = []; // 路线折线
    let dailyBudgetPlan = 0; // 创建者设定的每日预算
    let isEditingBudget = false; // 标记用户是否正在编辑预算
    let projectHotels = []; // 项目酒店数据
    let hotelSearchTimeout = null; // 酒店搜索防抖
    
    // 检查projectId是否存在
    if (!projectId) {
      console.error('No project ID found in URL');
      alert('错误：未找到项目ID');
      window.location.href = '/index.html';
    }
    
    console.log('Collaboration page initialized with projectId:', projectId);
    console.log('Current user:', currentUser);
    console.log('Invite token:', inviteToken);
    
    // 加载项目信息
    async function loadProjectInfo() {
      if (!projectId) return;
      
      try {
        const response = await fetch(`/api/travel-projects/${projectId}`);
        if (response.ok) {
          const projectResult = await response.json();
          const project = projectResult.success && projectResult.data ? projectResult.data : projectResult;
          // 更新项目名称
          document.getElementById('projectName').textContent = project.projectName;
          
          // 保存目的地城市（用于景点自动补全）
          destinationCity = project.destination || '';
          console.log('[loadProjectInfo] Initial destination:', destinationCity);
          
          // 如果目的地不是标准城市名，尝试获取真实城市名
          if (destinationCity) {
            console.log('[loadProjectInfo] Calling getCityNameFromDestination...');
            await getCityNameFromDestination(destinationCity);
            console.log('[loadProjectInfo] After getCityNameFromDestination, city is now:', destinationCity);
          }
          
          // 检查当前用户是否为创建者
          const creatorCheck = project.creatorId === currentUser.id;
          isProjectCreator = creatorCheck; // 设置全局变量
          isCreator = creatorCheck; // 同步设置 isCreator
          
          // 获取项目状态并更新显示
          projectStatus = project.status || '协作中';
          updateStatusBadge();
          
          // 如果项目已归档，禁止任何编辑
          if (projectStatus === '已归档') {
            canEdit = false;
            return; // 直接返回，不再检查权限
          }
          
          if (isCreator) {
            // 创建者显示权限管理按钮
            document.getElementById('permissionManageBtn').style.display = 'flex';
            canEdit = true;
          } else {
            // 非创建者需要检查是否为编辑者
            await checkEditPermission();
          }
          
          // 根据权限显示/隐藏新增按钮
          if (canEdit) {
            document.getElementById('addActivityBtn').classList.remove('hidden');
            document.getElementById('addActivityBtn').style.display = 'flex';
          }
        }
      } catch (error) {
        console.error('Error loading project info:', error);
      }
    }
    
    // 检查编辑权限
    async function checkEditPermission() {
      try {
        const response = await fetch(`/api/project-participants/project/${projectId}`);
        if (response.ok) {
          const participants = await response.json();
          const currentParticipant = participants.find(p => p.userId === currentUser.id);
          // 检查 role 字段，不是 permission
          if (currentParticipant && currentParticipant.role === '编辑者') {
            canEdit = true;
            console.log('[Permission] 用户具有编辑权限');
          } else {
            console.log('[Permission] 用户没有编辑权限, role:', currentParticipant?.role);
          }
        }
      } catch (error) {
        console.error('Error checking permission:', error);
      }
    }
    
    // 加载项目的所有需求参数
    async function loadProjectRequirements() {
      try {
        const response = await fetch(`/api/requirement-parameters/project/${projectId}/all`);
        if (response.ok) {
          projectRequirements = await response.json();
          console.log('[Requirements] Loaded', projectRequirements.length, 'user requirements');
          
          // 为每个需求加载用户信息
          for (let req of projectRequirements) {
            try {
              const userResponse = await fetch(`/api/users/${req.userId}`);
              if (userResponse.ok) {
                const apiResult = await userResponse.json();
                req.userInfo = apiResult.data || apiResult;
              }
            } catch (err) {
              console.error('Error loading user info:', err);
            }
          }
        }
      } catch (error) {
        console.error('Error loading requirements:', error);
      }
    }
    
    // 从目的地获取城市名称（使用后端Geocoding API）
    async function getCityNameFromDestination(destination) {
      console.log('[getCityName] Starting resolution for:', destination);
      
      // 如果已经是城市格式（以"市"结尾），直接使用
      if (destination.endsWith('市')) {
        console.log('[getCityName] Destination is already a city:', destination);
        destinationCity = destination;
        return destination;
      }
      
      try {
        // 使用后端代理接口
        const url = `/api/amap-test/geocode?address=${encodeURIComponent(destination)}`;
        console.log('[getCityName] Calling backend Geocoding API:', url);
        
        const response = await fetch(url);
        console.log('[getCityName] Response status:', response.status);
        
        if (response.ok) {
          const data = await response.json();
          console.log('[getCityName] API response:', data);
          
          if (data.success && data.city) {
            console.log('[getCityName] Resolved city name:', data.city, 'from destination:', destination);
            destinationCity = data.city;
            return data.city;
          } else {
            console.warn('[getCityName] Invalid response:', data);
          }
        } else {
          console.error('[getCityName] API call failed with status:', response.status);
        }
        
        console.warn('[getCityName] Failed to resolve city name, using original destination:', destination);
        // 备用方案：尝试从地址中提取城市名
        const cityMatch = destination.match(/([\u4e00-\u9fa5]+市)/); // 匹配 "XX市"
        if (cityMatch) {
          const extractedCity = cityMatch[1];
          console.log('[getCityName] Extracted city from pattern:', extractedCity);
          destinationCity = extractedCity;
          return extractedCity;
        }
        destinationCity = destination;
        return destination;
      } catch (error) {
        console.error('Error resolving city name:', error);
        return destination;
      }
    }
    
    // 如果是通过邀请链接进入，自动添加用户到项目
    async function handleInviteLink() {
      if (!inviteToken || !projectId) return;
      
      try {
        // 检查用户是否已经是参与者
        const checkResponse = await fetch(`/api/project-participants/project/${projectId}`);
        if (checkResponse.ok) {
          const participants = await checkResponse.json();
          const alreadyParticipant = participants.some(p => p.userId === currentUser.id);
          
          if (!alreadyParticipant) {
            // 添加用户到项目参与者
            const addResponse = await fetch('/api/project-participants', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                projectId: parseInt(projectId),
                userId: currentUser.id,
                role: '参与者',
                joinTime: new Date().toISOString()
              })
            });
            
            if (addResponse.ok) {
              console.log('成功加入项目');
              // 重新加载参与者列表
              await loadProjectParticipants();
            }
          }
        }
      } catch (error) {
        console.error('Error handling invite link:', error);
      }
    }
    
    // 全局变量已在上方声明
    
    // 加载选中路线的天数选项
    async function loadDayOptions() {
      console.log('Loading day options for project:', projectId);
      try {
        const projectResponse = await fetch(`/api/travel-projects/${projectId}`);
        if (!projectResponse.ok) {
          console.error('Failed to load project:', projectResponse.status);
          showNoRouteMessage();
          return;
        }
        
        const projectResult = await projectResponse.json();
        const project = projectResult.success && projectResult.data ? projectResult.data : projectResult;
        console.log('Project loaded:', project);
        currentProjectInfo = project; // 缓存项目信息
        const currentRouteId = project.currentRouteId;
        
        if (!currentRouteId) {
          console.warn('No route selected for this project');
          showNoRouteMessage();
          return;
        }
        
        console.log('Loading route:', currentRouteId);
        const routeResponse = await fetch(`/api/ai-generated-routes/${currentRouteId}`);
        if (!routeResponse.ok) {
          console.error('Failed to load route:', routeResponse.status);
          showNoRouteMessage();
          return;
        }
        
        const route = await routeResponse.json();
        console.log('Route loaded:', route);
        currentRouteData = route;
        
        // 解析行程数据
        if (route.dailyItinerary) {
          const dailyItinerary = JSON.parse(route.dailyItinerary);
          console.log('Daily itinerary parsed:', dailyItinerary);
          const daySelector = document.getElementById('daySelector');
          
          // 获取项目开始日期
          const startDate = new Date(project.startDate);
          
          daySelector.innerHTML = dailyItinerary.map((day, index) => {
            const dayNumber = day.day || (index + 1);
            // 计算当前天的具体日期
            const currentDate = new Date(startDate);
            currentDate.setDate(startDate.getDate() + index);
            
            // 格式化日期：月月日日
            const month = currentDate.getMonth() + 1;
            const date = currentDate.getDate();
            const dateStr = `${month}月${date}日`;
            
            return `<option value="${dayNumber}">${dateStr}（第${dayNumber}天）</option>`;
          }).join('');
          
          // 注意：不在这里调用loadDayAttractions，等酒店加载完后统一刷新
          // loadDayAttractions();
        } else {
          console.warn('Route has no daily itinerary');
          showNoRouteMessage();
        }
      } catch (error) {
        console.error('Error loading day options:', error);
        showNoRouteMessage();
      }
    }
    
    // 显示无路线提示
    function showNoRouteMessage() {
      console.log('Showing no route message...');
      const attractionsList = document.getElementById('attractionsList');
      if (!attractionsList) {
        console.error('attractionsList element not found!');
        return;
      }
      attractionsList.innerHTML = `
        <div class="text-center text-gray-500 py-8">
          <iconify-icon icon="mdi:map-marker-off-outline" width="64" class="text-gray-300 mb-4"></iconify-icon>
          <p class="text-lg font-semibold mb-2">暂未选择路线方案</p>
          <p class="text-sm mb-4">请先前往路线选择页面选择一个AI生成的方案</p>
          <a href="/route-selection.html?id=${projectId}" class="inline-block bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg transition-colors">
            <iconify-icon icon="mdi:map-search" class="mr-2"></iconify-icon>
            前往选择路线
          </a>
        </div>
      `;
      console.log('No route message displayed');
    }
    
    // 加载指定天数的景点
    async function loadDayAttractions() {
      const selectedDay = parseInt(document.getElementById('daySelector').value);
      
      if (!currentRouteData || !currentRouteData.dailyItinerary) {
        document.getElementById('attractionsList').innerHTML = `
          <div class="text-center text-gray-400 py-8">
            <iconify-icon icon="mdi:alert-circle" width="48"></iconify-icon>
            <p class="mt-2 text-sm">暂无行程数据</p>
          </div>
        `;
        return;
      }
      
      try {
        // 获取项目信息以计算具体日期
        const projectResponse = await fetch(`/api/travel-projects/${projectId}`);
        const projectResult = await projectResponse.json();
        const project = projectResult.success && projectResult.data ? projectResult.data : projectResult;
        const startDate = new Date(project.startDate);
        
        const dailyItinerary = JSON.parse(currentRouteData.dailyItinerary);
        const dayData = dailyItinerary.find(d => (d.day || dailyItinerary.indexOf(d) + 1) === selectedDay);
        
        if (!dayData || !dayData.activities) {
          document.getElementById('attractionsList').innerHTML = `
            <div class="text-center text-gray-400 py-8">
              <p class="text-sm">当天暂无景点</p>
            </div>
          `;
          return;
        }
        
        // 提取景点（过滤掉餐饮）
        const attractions = [];
        dayData.activities.forEach((activity, index) => {
          // 使用适配器解析activity
          const parsed = parseActivity(activity);
          const activityText = parsed.text;
          const timeRange = parsed.timeRange;
          const content = parsed.content;
          const poiInfo = parsed.poiInfo;
          
          // 只保留景点相关的（包含"景点”关键词或时间在非用餐时段）
          if (content.includes('景点：') || 
              content.includes('上午：') || 
              content.includes('下午：') || 
              content.includes('晚上：') ||
              (!content.includes('早餐') && !content.includes('午餐') && !content.includes('晚餐'))) {
            
            // 优先使用poiInfo中的名称，否则提取景点名称
            const attractionName = poiInfo && poiInfo.name ? poiInfo.name : extractAttractionName(content);
            if (attractionName) {
              attractions.push({
                index: index,
                name: attractionName,
                time: timeRange,
                fullActivity: activityText,
                rawContent: content,
                poiInfo: poiInfo // 保存POI信息
              });
            }
          }
        });
        
        currentDayAttractions = attractions;
        renderAttractionsList(attractions);
        
        // 更新当前天数标签（显示具体日期）
        const currentDate = new Date(startDate);
        currentDate.setDate(startDate.getDate() + (selectedDay - 1));
        const month = currentDate.getMonth() + 1;
        const date = currentDate.getDate();
        const dateStr = `${month}月${date}日`;
        document.getElementById('currentDayLabel').textContent = `${dateStr}（第${selectedDay}天）`;
        
        // 渲染路线总览（显示所有活动）
        console.log('[loadDayAttractions] 准备调用renderDayOverview, dayData.activities:', dayData.activities);
        renderDayOverview(dayData.activities, selectedDay);
        
      } catch (error) {
        console.error('Error loading day attractions:', error);
      }
    }
    
    // 提取景点名称
    function extractAttractionName(content) {
      // 移除时间段
      content = content.replace(/^\d{2}:\d{2}-\d{2}:\d{2}\s*/, '');
      
      // 移除前缀
      content = content.replace(/^[早午晚]餐[:：\s]*/, '');
      content = content.replace(/^[上下]午[:：\s]*/, '');
      content = content.replace(/^晚上[:：\s]*/, '');
      content = content.replace(/^景点[:：\s]*/, '');
      
      // 提取【】中的内容
      const bracketMatch = content.match(/【([^】]+)】/);
      if (bracketMatch) {
        return bracketMatch[1].trim();
      }
      
      // 提取第一个逗号或句号之前的内容
      const parts = content.split(/[,，。：:]/);
      if (parts.length > 0) {
        const name = parts[0].trim();
        // 移除“参观”、“游览”等动词
        return name.replace(/^(参观|游览|前往|打卡)/, '').trim();
      }
      
      return content.substring(0, 20).trim();
    }
    
    // 获取想去该景点的用户列表
    function getUsersWhoWantAttraction(attractionName) {
      const users = [];
      
      for (let req of projectRequirements) {
        if (req.wishlist && req.userInfo) {
          // wishlist 可能是逗号分隔的景点列表
          const wishlistItems = req.wishlist.split(/[,，]/).map(item => item.trim());
          
          // 检查景点名称是否在wishlist中（模糊匹配）
          const matched = wishlistItems.some(item => {
            // 去掉空格和特殊字符后比较
            const cleanItem = item.replace(/[\s【】]/g, '');
            const cleanAttraction = attractionName.replace(/[\s【】]/g, '');
            return cleanItem.includes(cleanAttraction) || cleanAttraction.includes(cleanItem);
          });
          
          if (matched) {
            users.push(req.userInfo.username);
          }
        }
      }
      
      return users;
    }
    
    // 渲染景点列表
    function renderAttractionsList(attractions) {
      const listContainer = document.getElementById('attractionsList');
      
      if (attractions.length === 0) {
        listContainer.innerHTML = `
          <div class="text-center text-gray-400 py-8">
            <iconify-icon icon="mdi:map-marker-off" width="48"></iconify-icon>
            <p class="mt-2 text-sm">当天没有景点安排</p>
          </div>
        `;
        return;
      }
      
      listContainer.innerHTML = attractions.map((attr, index) => {
        // 获取想去该景点的用户
        const interestedUsers = getUsersWhoWantAttraction(attr.name);
        const userText = interestedUsers.length > 0 
          ? `<span class="text-xs text-blue-600 mt-1 block">${interestedUsers.join('、')}想去</span>` 
          : '';
        
        return `
          <div class="p-3 border rounded-lg hover:bg-blue-50 hover:border-blue-300 transition-all attraction-item cursor-pointer" 
               onclick="showAttractionDetail(${index})"
               data-index="${index}">
            <div class="flex items-start gap-3">
              <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0">
                <iconify-icon icon="mdi:map-marker" class="text-blue-600" width="20"></iconify-icon>
              </div>
              <div class="flex-1 min-w-0">
                <h4 class="font-semibold text-gray-800 truncate">${attr.name}</h4>
                ${userText}
              </div>
              <iconify-icon icon="mdi:chevron-right" class="text-gray-400" width="20"></iconify-icon>
            </div>
          </div>
        `;
      }).join('');
    }
    
    // ========== 路线地图功能 ==========
    // 初始化地图
    function initRouteMap() {
      if (routeMap) return; // 已初始化
      try {
        routeMap = new AMap.Map('routeMapContainer', {
          zoom: 12,
          viewMode: '2D'
        });
        console.log('[RouteMap] 地图初始化成功');
      } catch (e) {
        console.error('[RouteMap] 地图初始化失败:', e);
      }
    }
    
    // 清除地图上的路线和标记
    function clearRouteMap() {
      if (!routeMap) return;
      routeMarkers.forEach(m => routeMap.remove(m));
      routePolylines.forEach(p => routeMap.remove(p));
      routeMarkers = [];
      routePolylines = [];
    }
    
    // 根据当天行程更新地图路线
    async function updateRouteMap(activities) {
      if (!routeMap) {
        initRouteMap();
        await new Promise(r => setTimeout(r, 500));
      }
      clearRouteMap();
      
      if (!activities || activities.length === 0) {
        routeMap.setCenter([113.746262, 23.046237]);
        return;
      }
      
      const points = [];
      let transports = [];
      
      // 获取交通信息
      try {
        const dailyData = JSON.parse(currentRouteData.dailyItinerary);
        const selectedDay = parseInt(document.getElementById('daySelector').value) || 1;
        const dayData = dailyData.find(d => (d.day || dailyData.indexOf(d) + 1) === selectedDay);
        if (dayData && dayData.transports) {
          transports = dayData.transports;
          // 添加出发地
          const depTransport = transports.find(t => t.isDeparture || t.fromIndex === -1);
          if (depTransport && depTransport.fromLocation) {
            const loc = depTransport.fromLocation.split(',');
            if (loc.length === 2) {
              points.push({
                name: depTransport.fromName || '出发地',
                lng: parseFloat(loc[0]),
                lat: parseFloat(loc[1]),
                isDeparture: true
              });
            }
          }
        }
      } catch (e) {
        console.log('[RouteMap] 获取交通信息失败:', e);
      }
      
      // 提取景点位置
      activities.forEach((act, idx) => {
        if (act.poiInfo && act.poiInfo.location) {
          const loc = act.poiInfo.location.split(',');
          if (loc.length === 2) {
            points.push({
              name: act.poiInfo.name || act.name || '景点',
              lng: parseFloat(loc[0]),
              lat: parseFloat(loc[1]),
              index: idx
            });
          }
        }
      });
      
      if (points.length === 0) return;
      
      // 添加标记点
      points.forEach((pt, i) => {
        const bgColor = pt.isDeparture ? '#9333ea' : '#8b5cf6';
        const marker = new AMap.Marker({
          position: [pt.lng, pt.lat],
          title: pt.name,
          label: {
            content: `<div style="background:${bgColor};color:white;padding:2px 6px;border-radius:10px;font-size:12px;white-space:nowrap;">${i + 1}. ${pt.name}</div>`,
            direction: 'top'
          }
        });
        routeMap.add(marker);
        routeMarkers.push(marker);
      });
      
      // 初始调整视野（只在开始时调整一次）
      routeMap.setFitView(routeMarkers, false, [50, 50, 50, 50]);
      
      // 根据交通卡信息绘制实际路线（使用高德路径规划）
      for (let i = 0; i < points.length - 1; i++) {
        const from = points[i];
        const to = points[i + 1];
        
        // 查找对应的交通信息
        let transport = null;
        if (from.isDeparture) {
          transport = transports.find(t => t.isDeparture || t.fromIndex === -1);
        } else {
          transport = transports.find(t => {
            if (t.isDeparture) return false;
            const cleanFrom = (t.fromName || '').replace(/[\s\-]/g, '');
            const cleanPt = from.name.replace(/[\s\-]/g, '');
            return cleanFrom.includes(cleanPt) || cleanPt.includes(cleanFrom) || t.fromIndex === from.index;
          });
        }
        
        // 使用高德路径规划绘制真实路线
        drawRealRoute(from, to, transport);
      }
      
      console.log('[RouteMap] 路线更新完成, 点数:', points.length);
    }
    
    // 使用高德路径规划绘制真实路线
    function drawRealRoute(from, to, transport) {
      // 确定交通方式
      let mode = 'transit'; // 默认公交
      if (transport && transport.steps) {
        const hasSubway = transport.steps.some(s => s.type === 'subway');
        if (hasSubway) mode = 'transit';
      } else if (transport && transport.method) {
        if (transport.method.includes('步行')) mode = 'walking';
        else if (transport.method.includes('驾车') || transport.method.includes('打车')) mode = 'driving';
      }
      
      const origin = new AMap.LngLat(from.lng, from.lat);
      const destination = new AMap.LngLat(to.lng, to.lat);
      
      if (mode === 'transit') {
        // 公交/地铁路线
        const transfer = new AMap.Transfer({
          map: routeMap,
          city: destinationCity || '东莞',
          policy: AMap.TransferPolicy.LEAST_TIME,
          hideMarkers: true,
          isOutline: false
        });
        transfer.search(origin, destination, function(status, result) {
          if (status === 'complete' && result.plans && result.plans.length > 0) {
            // 获取第一个方案的路径
            const plan = result.plans[0];
            const path = [];
            plan.segments.forEach(seg => {
              if (seg.transit && seg.transit.path) {
                path.push(...seg.transit.path);
              } else if (seg.walking && seg.walking.path) {
                path.push(...seg.walking.path);
              }
            });
            if (path.length > 0) {
              // 确定颜色
              let color = '#22c55e'; // 默认绿色公交
              const hasSubway = plan.segments.some(s => s.transit && s.transit.classextension && s.transit.classextension.includes('地铁'));
              if (hasSubway) color = '#3b82f6'; // 蓝色地铁
              
              const polyline = new AMap.Polyline({
                path: path,
                strokeColor: color,
                strokeWeight: 6,
                strokeOpacity: 0.8,
                lineJoin: 'round'
              });
              routeMap.add(polyline);
              routePolylines.push(polyline);
            }
          } else {
            // 回退到直线
            drawFallbackLine(from, to, '#8b5cf6');
          }
        });
        transfer.clear(); // 清除默认渲染
      } else if (mode === 'walking') {
        // 步行路线
        const walking = new AMap.Walking({
          map: routeMap,
          hideMarkers: true
        });
        walking.search(origin, destination, function(status, result) {
          if (status === 'complete' && result.routes && result.routes.length > 0) {
            const path = result.routes[0].steps.reduce((arr, step) => arr.concat(step.path), []);
            const polyline = new AMap.Polyline({
              path: path,
              strokeColor: '#f59e0b',
              strokeWeight: 5,
              strokeOpacity: 0.8,
              strokeStyle: 'dashed'
            });
            routeMap.add(polyline);
            routePolylines.push(polyline);
          } else {
            drawFallbackLine(from, to, '#f59e0b');
          }
        });
        walking.clear();
      } else {
        // 驾车路线
        const driving = new AMap.Driving({
          map: routeMap,
          hideMarkers: true
        });
        driving.search(origin, destination, function(status, result) {
          if (status === 'complete' && result.routes && result.routes.length > 0) {
            const path = result.routes[0].steps.reduce((arr, step) => arr.concat(step.path), []);
            const polyline = new AMap.Polyline({
              path: path,
              strokeColor: '#9333ea',
              strokeWeight: 5,
              strokeOpacity: 0.8
            });
            routeMap.add(polyline);
            routePolylines.push(polyline);
          } else {
            drawFallbackLine(from, to, '#9333ea');
          }
        });
        driving.clear();
      }
    }
    
    // 回退直线
    function drawFallbackLine(from, to, color) {
      const polyline = new AMap.Polyline({
        path: [[from.lng, from.lat], [to.lng, to.lat]],
        strokeColor: color,
        strokeWeight: 4,
        strokeOpacity: 0.6,
        strokeStyle: 'dashed'
      });
      routeMap.add(polyline);
      routePolylines.push(polyline);
    }
    
    // 获取交通方式对应的图标
    function getTransportIcon(method) {
      if (!method) return 'bus';
      if (method.includes('地铁') || method.includes('轨道')) return 'subway';
      if (method.includes('公交') || method.includes('巴士')) return 'bus';
      if (method.includes('步行')) return 'walk';
      if (method.includes('驾车') || method.includes('打车')) return 'car';
      return 'bus';
    }
    
    // 全局标志，避免重复绑定事件
    let mapEventBound = false;
    
    // 在地图上显示选中的景点
    let selectedMarker = null; // 选中的景点标记
    
    console.log('[脚本加载] showAttractionOnMap 函数已定义');
    
    // ========== 浮动聊天窗口功能 ==========
    let chatWindowDragging = false;
    let chatWindowOffset = { x: 0, y: 0 };
    
    // 初始化聊天窗口
    function initChatWindow() {
      const chatWindow = document.getElementById('chatWindow');
      const chatHeader = document.getElementById('chatWindowHeader');
      
      // 从 localStorage 恢复窗口位置
      const savedPosition = localStorage.getItem('chatWindowPosition');
      if (savedPosition) {
        const pos = JSON.parse(savedPosition);
        chatWindow.style.bottom = pos.bottom + 'px';
        chatWindow.style.right = pos.right + 'px';
      }
      
      // 恢复窗口状态
      const savedState = localStorage.getItem('chatWindowState');
      if (savedState === 'minimized') {
        chatWindow.classList.add('minimized');
      } else if (savedState === 'hidden') {
        chatWindow.classList.add('hidden');
      }
      
      // 拖动功能
      chatHeader.addEventListener('mousedown', function(e) {
        // 如果点击的是按钮，不启动拖动
        if (e.target.closest('button')) return;
        
        chatWindowDragging = true;
        chatWindow.classList.add('dragging');
        
        const rect = chatWindow.getBoundingClientRect();
        chatWindowOffset.x = e.clientX - rect.left;
        chatWindowOffset.y = e.clientY - rect.top;
        
        e.preventDefault();
      });
      
      document.addEventListener('mousemove', function(e) {
        if (!chatWindowDragging) return;
        
        // 计算新位置
        let newLeft = e.clientX - chatWindowOffset.x;
        let newTop = e.clientY - chatWindowOffset.y;
        
        // 边界检测
        const windowWidth = window.innerWidth;
        const windowHeight = window.innerHeight;
        const chatWidth = chatWindow.offsetWidth;
        const chatHeight = chatWindow.offsetHeight;
        
        if (newLeft < 0) newLeft = 0;
        if (newTop < 0) newTop = 0;
        if (newLeft + chatWidth > windowWidth) newLeft = windowWidth - chatWidth;
        if (newTop + chatHeight > windowHeight) newTop = windowHeight - chatHeight;
        
        // 使用 left/top 而不是 bottom/right
        chatWindow.style.left = newLeft + 'px';
        chatWindow.style.top = newTop + 'px';
        chatWindow.style.right = 'auto';
        chatWindow.style.bottom = 'auto';
      });
      
      document.addEventListener('mouseup', function() {
        if (chatWindowDragging) {
          chatWindowDragging = false;
          chatWindow.classList.remove('dragging');
          
          // 保存位置
          const rect = chatWindow.getBoundingClientRect();
          localStorage.setItem('chatWindowPosition', JSON.stringify({
            bottom: window.innerHeight - rect.bottom,
            right: window.innerWidth - rect.right
          }));
        }
      });
    }
    
    // 切换窗口最小化
    function toggleChatWindow() {
      const chatWindow = document.getElementById('chatWindow');
      chatWindow.classList.toggle('minimized');
      
      const state = chatWindow.classList.contains('minimized') ? 'minimized' : 'normal';
      localStorage.setItem('chatWindowState', state);
    }
    
    // 关闭窗口
    function closeChatWindow() {
      const chatWindow = document.getElementById('chatWindow');
      chatWindow.classList.add('hidden');
      localStorage.setItem('chatWindowState', 'hidden');
    }
    
    // 打开窗口
    function openChatWindow() {
      const chatWindow = document.getElementById('chatWindow');
      chatWindow.classList.remove('hidden', 'minimized');
      localStorage.setItem('chatWindowState', 'normal');
    }
    
    function showAttractionOnMap(location, name, index) {
      console.log(`[showAttractionOnMap] 调用: location=${location}, name=${name}, index=${index}`);
      
      if (!location) {
        console.warn('[showAttractionOnMap] location为空，退出');
        return;
      }
      
      // 如果地图未初始化，先初始化
      if (!routeMap) {
        initRouteMap();
        setTimeout(() => showAttractionOnMap(location, name, index), 500);
        return;
      }
      
      const loc = location.split(',');
      if (loc.length !== 2) return;
      
      const lng = parseFloat(loc[0]);
      const lat = parseFloat(loc[1]);
      
      // 清除地图上所有标记和路线（只显示当前景点）
      clearRouteMap();
      if (selectedMarker) {
        routeMap.remove(selectedMarker);
      }
      
      // 创建高亮标记
      selectedMarker = new AMap.Marker({
        position: [lng, lat],
        title: name,
        icon: new AMap.Icon({
          size: new AMap.Size(40, 50),
          image: 'https://webapi.amap.com/theme/v1.3/markers/n/mark_r.png',
          imageSize: new AMap.Size(40, 50)
        }),
        label: {
          content: `<div style="background:#ef4444;color:white;padding:6px 12px;border-radius:12px;font-size:14px;font-weight:600;white-space:nowrap;box-shadow:0 2px 8px rgba(0,0,0,0.2);">${name}</div>`,
          direction: 'top',
          offset: new AMap.Pixel(0, -5)
        },
        zIndex: 1000
      });
      
      routeMap.add(selectedMarker);
      
      // 居中地图到该点，并设置适当缩放等级
      routeMap.setZoomAndCenter(16, [lng, lat]);
      
      // 高亮对应的景点卡片
      document.querySelectorAll('.attraction-card').forEach(card => {
        card.classList.remove('ring-2', 'ring-red-500', 'shadow-lg');
      });
      const clickedCard = document.querySelector(`.attraction-card[data-activity-index="${index}"]`);
      if (clickedCard) {
        clickedCard.classList.add('ring-2', 'ring-red-500', 'shadow-lg');
      }
      
      console.log(`[地图] 定位到景点: ${name}, 坐标: [${lng}, ${lat}]`);
    }
    
    // 渲染路线总览（横向4列网格，带交通信息）
    function renderDayOverview(activities, selectedDay) {
      console.log('[renderDayOverview] 调用，activities:', activities, 'selectedDay:', selectedDay);
      const gridContainer = document.getElementById('dayOverviewGrid');
      
      if (!gridContainer) {
        console.error('[renderDayOverview] 找不到dayOverviewGrid元素!');
        return;
      }
      
      if (!activities || activities.length === 0) {
        console.log('[renderDayOverview] 没有activities数据');
        gridContainer.innerHTML = `
          <div class="text-center text-gray-400 col-span-4 py-8">
            <iconify-icon icon="mdi:calendar-blank" width="48"></iconify-icon>
            <p class="mt-2 text-sm">当天暂无行程</p>
          </div>
        `;
        return;
      }
      
      console.log('[renderDayOverview] 开始渲染', activities.length, '个活动');
      
      try {
      
      // 获取当天的交通信息
      const dailyItinerary = JSON.parse(currentRouteData.dailyItinerary);
      const dayData = dailyItinerary.find(d => (d.day || dailyItinerary.indexOf(d) + 1) === selectedDay);
      const transports = dayData && dayData.transports ? dayData.transports : [];
      
      console.log('[renderDayOverview] 交通信息:');
      transports.forEach((t, i) => {
        console.log(`  [${i}] from: ${t.fromName}, to: ${t.toName}, isDeparture: ${t.isDeparture}, isFromPrevHotel: ${t.isFromPrevHotel}`);
      });
      
      // 检查出发地交通的目的地
      const depTransportCheck = transports.find(t => t.fromIndex === -1 || t.isDeparture);
      if (depTransportCheck) {
        console.log('[renderDayOverview] 出发地交通目的地:', depTransportCheck.toName);
      }
      
      // 解析每个活动
      const parsedActivities = activities.map((activity, index) => {
        // 使用适配器解析activity
        const parsed = parseActivity(activity);
        console.log('[Activity Card] parsed:', JSON.stringify({text: parsed.text, duration: parsed.duration, ticket: parsed.ticket}));
        const activityText = parsed.text;
        let timeRange = '';
        let content = parsed.content;
        const poiInfo = parsed.poiInfo;
        let activityType = 'attraction';
        let icon = 'mdi:map-marker';
        let bgColor = 'bg-blue-100';
        let textColor = 'text-blue-600';
        
        // 所有活动都是景点类型
        
        // 提取名称（优先使用poiInfo.name）
        let displayName = '';
        if (poiInfo && poiInfo.name) {
          displayName = poiInfo.name;
        } else {
          displayName = content;
          displayName = displayName.replace(/^景点[::：]/, '');
          displayName = displayName.replace(/^[上下]午[::：]/, '');
          displayName = displayName.replace(/^晚上[::：]/, '');
          displayName = displayName.replace(/^[早午晚]餐[::：]/, '');
          
          // 提取【】中的内容
          const bracketMatch = displayName.match(/【([^】]+)】/);
          if (bracketMatch) {
            displayName = bracketMatch[1];
          } else {
            // 只取第一个逗号前的内容
            displayName = displayName.split(/[,，。]/)[ 0];
          }
        }
        
        return {
          time: timeRange,
          name: displayName.substring(0, 12).trim(),
          fullContent: content,
          type: activityType,
          icon,
          bgColor,
          textColor,
          // 修复：始终使用当前循环的index，而不是activity对象中的index（那个可能过时）
          originalIndex: index,
          duration: parsed.duration || null,  // 游玩时间
          ticket: parsed.ticket || 0          // 门票价格
        };
      });
      
      // 渲染卡片（包含交通信息）
      let html = '';
      
      // 检查是否有出发地交通信息（第一天从出发地，第二天及以后从前一天酒店）
      const departureTransport = transports.find(t => t.fromIndex === -1 || t.isDeparture);
      if (departureTransport) {
        // 获取出发时间
        const departureTime = (currentProjectInfo && currentProjectInfo.departureTime) || '08:00';
        
        // 渲染出发地卡片（包含出发时间）
        html += `
          <div class="bg-purple-100 border-2 border-purple-300 rounded-lg p-3 relative">
            <div class="flex flex-col h-full">
              <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                  <div class="w-8 h-8 rounded-full bg-purple-200 flex items-center justify-center">
                    <iconify-icon icon="mdi:map-marker" class="text-purple-600" width="18"></iconify-icon>
                  </div>
                  <span class="text-sm font-medium text-purple-600">出发地</span>
                </div>
                <span class="text-xs text-purple-500 font-medium"><iconify-icon icon="mdi:clock-outline" class="mr-1"></iconify-icon>${departureTime} 出发</span>
              </div>
              <p class="text-sm font-semibold text-gray-800">${departureTransport.fromName || '出发地'}</p>
            </div>
          </div>
        `;
        
        // 渲染出发地到第一个景点的交通信息
        const transportCard = renderTransportCard(departureTransport);
        html += `<div class="relative">
          ${transportCard}
        </div>`;
      }
      
      // 用于跟踪已渲染的交通卡片，防止重复
      const renderedTransportKeys = new Set();
      
      parsedActivities.forEach((activity, index) => {
        // 获取想去该景点的用户（只对景点类型显示）
        let userWantText = '';
        if (activity.type === 'attraction') {
          const interestedUsers = getUsersWhoWantAttraction(activity.name);
          if (interestedUsers.length > 0) {
            userWantText = `<p class="text-xs text-blue-600 mt-1">${interestedUsers.join('、')}想去</p>`;
          }
        }
        
        // 获取预算值
        const budgetKey = `${selectedDay}-${index}`;
        const budgetValue = activityBudgets[budgetKey] || '';
        
        // 获取位置信息
        const locationStr = (activity.poiInfo && activity.poiInfo.location) ? activity.poiInfo.location : '';
        const nameStr = activity.name.replace(/"/g, '&quot;');
        
        // 活动卡片（可拖拽）
        html += `
          <div class="attraction-card bg-white border rounded-lg p-3 hover:shadow-md transition-shadow relative group cursor-pointer"
               draggable="${canEdit}"
               data-activity-index="${index}"
               data-location="${locationStr}"
               data-name="${nameStr}"
               ondragstart="handleDragStart(event, ${index})"
               ondragend="handleDragEnd(event)"
               ondragover="handleDragOver(event)"
               ondragleave="handleDragLeave(event)"
               ondrop="handleDrop(event, ${index})">
            ${canEdit ? `
              <button onclick="event.stopPropagation(); deleteAttraction(${activity.originalIndex})" 
                      class="absolute -top-2 -right-2 bg-red-500 hover:bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity shadow-lg" 
                      title="删除活动">
                <iconify-icon icon="mdi:close" width="14"></iconify-icon>
              </button>
            ` : ''}
            <div class="flex flex-col h-full">
              <div class="flex items-center gap-2 mb-2">
                <div class="w-8 h-8 ${activity.bgColor} rounded-full flex items-center justify-center flex-shrink-0">
                  <iconify-icon icon="${activity.icon}" class="${activity.textColor}" width="16"></iconify-icon>
                </div>
              </div>
              <h5 class="text-sm font-medium text-gray-800 line-clamp-2 flex-1">${activity.name}</h5>
              ${activity.type === 'attraction' ? `
                <div class="flex items-center gap-2 text-xs text-gray-500 mt-1">
                  ${activity.duration ? `<span class="flex items-center gap-1"><iconify-icon icon="mdi:clock-outline" width="12"></iconify-icon>${activity.duration}</span>` : ''}
                  ${activity.ticket !== undefined && activity.ticket !== null ? (activity.ticket > 0 ? `<span class="flex items-center gap-1"><iconify-icon icon="mdi:ticket-outline" width="12"></iconify-icon>¥${activity.ticket}</span>` : '<span class="text-green-600">免费</span>') : ''}
                </div>
              ` : ''}
              ${userWantText}
              
              <!-- 预算输入框 -->
              <div class="mt-2 pt-2 border-t border-gray-100">
                <div class="flex items-center gap-1">
                  <iconify-icon icon="mdi:cash" class="text-gray-400" width="14"></iconify-icon>
                  <input type="number" 
                         placeholder="预算" 
                         value="${budgetValue}"
                         ${canEdit ? '' : 'disabled'}
                         onfocus="isEditingBudget = true"
                         onblur="isEditingBudget = false"
                         onchange="updateActivityBudget('${budgetKey}', this.value)"
                         class="w-full text-xs px-2 py-1 border rounded focus:ring-1 focus:ring-blue-500 ${canEdit ? '' : 'bg-gray-50 cursor-not-allowed'}"
                         min="0"
                         step="0.01" />
                  <span class="text-xs text-gray-500">元</span>
                </div>
              </div>
            </div>
          </div>
        `;
        
        // 查找当前景点到下一个景点的交通信息（交通显示在当前景点之后）
        // 优先使用名称匹配，其次使用索引匹配
        // 排除酒店交通卡（在后面单独渲染）
        const transport = transports.find(t => {
          if (t.isDeparture) return false;
          if (t.isHotelTransport || (t.toName && t.toName.includes('(酒店)'))) return false;
          
          // 名称匹配（去除空格和特殊字符后比较）
          if (t.fromName && activity.name) {
            const cleanTransportName = t.fromName.replace(/[\s\-]/g, '');
            const cleanActivityName = activity.name.replace(/[\s\-]/g, '');
            
            if (cleanTransportName === cleanActivityName || 
                cleanTransportName.includes(cleanActivityName) || 
                cleanActivityName.includes(cleanTransportName)) {
              return true;
            }
          }
          
          // 索引匹配作为后备
          return t.fromIndex === activity.originalIndex;
        });
        
        if (transport) {
          // 生成交通卡片的唯一标识（使用起点和终点名称）
          const transportKey = `${transport.fromName || ''}-${transport.toName || ''}`;
          
          // 检查是否已经渲染过
          if (renderedTransportKeys.has(transportKey)) {
            console.log(`[renderDayOverview] 跳过重复交通: ${transportKey}`);
          } else {
            renderedTransportKeys.add(transportKey);
            console.log(`[renderDayOverview] 找到交通: ${activity.name} (idx=${activity.originalIndex}) -> ${transport.toName}`);
            // 渲染交通信息卡片
            html += renderTransportCard(transport);
          }
        } else {
          console.log(`[renderDayOverview] 未找到交通: ${activity.name} (originalIndex=${activity.originalIndex})`);
        }
      });
      
      // 添加当天酒店卡片
      const dayHotel = projectHotels.find(h => h.dayIndex === selectedDay);
      if (dayHotel) {
        // 显示最后景点到酒店的交通卡（和其他交通卡样式一致）
        const hotelTransport = transports.find(t => t.toName && t.toName.includes('(酒店)'));
        if (hotelTransport) {
          // 使用通用的交通卡片渲染函数
          html += renderTransportCard(hotelTransport);
        }
        
        // 再添加酒店卡片
        html += `
          <div class="bg-purple-50 border-2 border-purple-300 rounded-lg p-3 flex flex-col cursor-pointer hover:shadow-md transition-shadow"
            onclick="showHotelInfo(${selectedDay}, ${dayHotel.id})">
            <div class="flex items-center gap-2 mb-2">
              <div class="w-8 h-8 bg-purple-500 rounded-full flex items-center justify-center">
                <iconify-icon icon="mdi:hotel" class="text-white" width="18"></iconify-icon>
              </div>
              <div class="flex-1 min-w-0">
                <div class="font-bold text-sm text-purple-800 truncate">当晚住宿</div>
              </div>
            </div>
            <div class="text-sm font-medium text-gray-800 truncate">${dayHotel.hotelName}</div>
            <div class="text-xs text-gray-500 truncate mt-1">${dayHotel.hotelAddress || ''}</div>
            <div class="text-sm font-bold text-purple-600 mt-2">¥${dayHotel.pricePerNight}/晚</div>
          </div>
        `;
      }
      
      gridContainer.innerHTML = html;
      
      // 只绑定一次事件，使用事件委托
      if (!mapEventBound) {
        console.log('[地图] 绑定景点点击事件');
        
        // 使用 mouseup 事件，在拖拽结束后触发
        document.getElementById('dayOverviewGrid').addEventListener('mouseup', function(e) {
          // 如果正在拖拽，忽略
          if (isDragging) {
            console.log('[地图] 正在拖拽，忽略点击');
            return;
          }
          
          const card = e.target.closest('.attraction-card');
          if (!card) return;
          
          console.log('[地图] 卡片被点击', e.target);
          
          // 如果点击的是删除按钮或输入框，不触发地图定位
          if (e.target.closest('button') || e.target.tagName === 'INPUT') {
            console.log('[地图] 点击了按钮或输入框，忽略');
            return;
          }
          
          const location = card.getAttribute('data-location');
          const name = card.getAttribute('data-name');
          const index = parseInt(card.getAttribute('data-activity-index'));
          
          console.log(`[地图] 点击景点: ${name}, location: ${location}, index: ${index}`);
          
          if (location) {
            showAttractionOnMap(location, name, index);
          } else {
            console.warn('[地图] 该景点没有位置信息');
          }
        }, true); // 使用捕获阶段，优先级更高
        
        mapEventBound = true;
      }
      
      const attractionCards = document.querySelectorAll('.attraction-card');
      console.log(`[地图] 找到 ${attractionCards.length} 个景点卡片`);
      
      // 更新预算统计
      updateBudgetSummary(selectedDay);
      
      // 不自动显示路线，由用户点击景点时才显示
      // updateRouteMap(activities);
      
      // 初始化地图（不显示内容）
      if (!routeMap) {
        initRouteMap();
      } else {
        clearRouteMap();
        if (selectedMarker) {
          routeMap.remove(selectedMarker);
          selectedMarker = null;
        }
      }
      
      console.log('[renderDayOverview] 渲染完成');
      
      } catch (error) {
        console.error('[renderDayOverview] 渲染出错:', error);
        gridContainer.innerHTML = `
          <div class="text-center text-red-400 col-span-4 py-8">
            <iconify-icon icon="mdi:alert-circle" width="48"></iconify-icon>
            <p class="mt-2 text-sm">渲染出错：${error.message}</p>
          </div>
        `;
      }
    }
    
    // 渲染交通信息卡片（极简版，点击弹窗显示详情）
    function renderTransportCard(transport) {
      // 过滤极短距离的交通（<100米）
      if (transport.distance && transport.distance < 100) {
        return '';
      }
      
      // 确定主要交通方式
      let mainMethod = '公交';
      let mainIcon = 'mdi:bus';
      let mainColor = 'text-green-600';
      let bgColor = 'bg-green-50';
      let borderColor = 'border-green-200';
      
      if (transport.steps && transport.steps.length > 0) {
        const transitSteps = transport.steps.filter(s => s.type !== 'walk');
        if (transitSteps.length > 0) {
          const firstType = transitSteps[0].type;
          if (firstType === 'subway') {
            mainMethod = '地铁';
            mainIcon = 'mdi:subway-variant';
            mainColor = 'text-blue-600';
            bgColor = 'bg-blue-50';
            borderColor = 'border-blue-200';
          } else {
            mainMethod = '公交';
            mainIcon = 'mdi:bus';
            mainColor = 'text-green-600';
            bgColor = 'bg-green-50';
            borderColor = 'border-green-200';
          }
        } else {
          mainMethod = '步行';
          mainIcon = 'mdi:walk';
          mainColor = 'text-emerald-600';
          bgColor = 'bg-emerald-50';
          borderColor = 'border-emerald-200';
        }
      } else {
        const method = transport.method || '';
        if (method.includes('步行')) {
          mainMethod = '步行';
          mainIcon = 'mdi:walk';
          mainColor = 'text-emerald-600';
          bgColor = 'bg-emerald-50';
          borderColor = 'border-emerald-200';
        } else if (method.includes('地铁')) {
          mainMethod = '地铁';
          mainIcon = 'mdi:subway-variant';
          mainColor = 'text-blue-600';
          bgColor = 'bg-blue-50';
          borderColor = 'border-blue-200';
        } else if (method.includes('驾车') || method.includes('打车')) {
          mainMethod = '打车';
          mainIcon = 'mdi:car';
          mainColor = 'text-purple-600';
          bgColor = 'bg-purple-50';
          borderColor = 'border-purple-200';
        }
      }
      
      // 警告样式
      if (transport.distanceTooFar) {
        bgColor = 'bg-red-50';
        borderColor = 'border-red-300';
      }
      
      // 将transport数据序列化传递给弹窗
      const transportData = encodeURIComponent(JSON.stringify(transport));
      
      return `
        <div class="${bgColor} ${borderColor} border rounded-lg px-3 py-2 my-1 cursor-pointer hover:shadow-md transition-shadow flex items-center justify-center gap-2"
             onclick="showTransportModal('${transportData}')">
          <iconify-icon icon="${mainIcon}" class="${mainColor}" width="20"></iconify-icon>
          <span class="text-sm font-medium ${mainColor}">${mainMethod}</span>
          <span class="text-xs text-gray-400">${transport.durationText || ''}</span>
        </div>
      `;
    }
    
    // 显示交通详情弹窗
    function showTransportModal(transportDataEncoded) {
      const transport = JSON.parse(decodeURIComponent(transportDataEncoded));
      console.log('[Transport Modal] 接收到的数据:', transport);
      
      // 计算显示值
      let distanceDisplay = '-';
      if (transport.distanceText) {
        distanceDisplay = transport.distanceText;
      } else if (transport.distance) {
        distanceDisplay = transport.distance > 1000 ? (transport.distance/1000).toFixed(1) + 'km' : transport.distance + 'm';
      }
      
      let durationDisplay = '-';
      if (transport.durationText) {
        durationDisplay = transport.durationText;
      } else if (transport.duration) {
        durationDisplay = Math.ceil(transport.duration/60) + '分钟';
      }
      
      let costDisplay = transport.costText || '免费';
      
      // 生成详细步骤HTML
      let stepsHtml = '';
      if (transport.steps && transport.steps.length > 0) {
        const filteredSteps = transport.steps.filter(step => {
          if (step.type === 'walk' && step.distance && step.distance < 50) return false;
          return true;
        });
        
        stepsHtml = filteredSteps.map(step => {
          let icon, color;
          if (step.type === 'walk') {
            icon = 'mdi:walk';
            color = 'text-emerald-600';
          } else if (step.type === 'subway') {
            icon = 'mdi:subway-variant';
            color = 'text-blue-600';
          } else {
            icon = 'mdi:bus';
            color = 'text-green-600';
          }
          
          const descLines = (step.description || '').split('\n');
          let mainDesc = descLines[0];
          const subDesc = descLines.length > 1 ? descLines.slice(1).join('<br>') : '';
                    
          // 将"终点"或"目标景点"替换为实际名称
          if (transport.toName) {
            const actualName = transport.toName.replace('(酒店)', '');
            mainDesc = mainDesc.replace(/目标景点/g, actualName);
            mainDesc = mainDesc.replace(/终点/g, actualName);
          }
          
          return `
            <div class="flex items-start gap-3 py-2 border-b border-gray-100 last:border-0">
              <iconify-icon icon="${icon}" class="${color} flex-shrink-0 mt-1" width="20"></iconify-icon>
              <div class="flex-1">
                <div class="${color} font-medium">${mainDesc}</div>
                ${subDesc ? `<div class="text-xs text-gray-500 mt-1">${subDesc}</div>` : ''}
              </div>
            </div>
          `;
        }).join('');
      }
      
      // 创建弹窗
      const modalHtml = `
        <div id="transportModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="closeTransportModal(event)">
          <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4 max-h-[80vh] overflow-hidden" onclick="event.stopPropagation()">
            <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white px-4 py-3 flex items-center justify-between">
              <h3 class="font-bold text-lg">交通详情</h3>
              <button onclick="closeTransportModal()" class="hover:bg-white/20 rounded-full p-1">
                <iconify-icon icon="mdi:close" width="24"></iconify-icon>
              </button>
            </div>
            <div class="p-4">
              <!-- 概览信息 -->
              <div class="flex items-center justify-around bg-gray-50 rounded-lg p-3 mb-4">
                <div class="text-center">
                  <iconify-icon icon="mdi:map-marker-distance" class="text-gray-500" width="24"></iconify-icon>
                  <div class="text-sm font-medium mt-1">${distanceDisplay}</div>
                  <div class="text-xs text-gray-400">距离</div>
                </div>
                <div class="text-center">
                  <iconify-icon icon="mdi:clock-outline" class="text-gray-500" width="24"></iconify-icon>
                  <div class="text-sm font-medium mt-1">${durationDisplay}</div>
                  <div class="text-xs text-gray-400">时长</div>
                </div>
                <div class="text-center">
                  <iconify-icon icon="mdi:cash" class="text-blue-600" width="24"></iconify-icon>
                  <div class="text-sm font-medium mt-1 text-blue-600">${costDisplay}</div>
                  <div class="text-xs text-gray-400">费用</div>
                </div>
              </div>
              
              <!-- 详细步骤 -->
              ${stepsHtml ? `
                <div class="border-t pt-3">
                  <h4 class="text-sm font-medium text-gray-700 mb-2">详细路线</h4>
                  <div class="max-h-60 overflow-y-auto">
                    ${stepsHtml}
                  </div>
                </div>
              ` : ''}
              
              ${transport.warning ? `
                <div class="mt-3 bg-red-50 text-red-600 text-sm px-3 py-2 rounded-lg flex items-center gap-2">
                  <iconify-icon icon="mdi:alert" width="16"></iconify-icon>
                  ${transport.warning}
                </div>
              ` : ''}
            </div>
          </div>
        </div>
      `;
      
      // 移除旧弹窗（如果存在）
      const oldModal = document.getElementById('transportModal');
      if (oldModal) oldModal.remove();
      
      // 添加新弹窗
      document.body.insertAdjacentHTML('beforeend', modalHtml);
    }
    
    // 关闭交通详情弹窗
    function closeTransportModal(event) {
      if (event && event.target.id !== 'transportModal') return;
      const modal = document.getElementById('transportModal');
      if (modal) modal.remove();
    }
    
    // 更新活动预算
    function updateActivityBudget(budgetKey, value) {
      const budget = parseFloat(value) || 0;
      activityBudgets[budgetKey] = budget;
      
      // 保存预算到后端
      saveBudgetToBackend();
      
      // 更新统计
      const selectedDay = parseInt(document.getElementById('daySelector').value);
      updateBudgetSummary(selectedDay);
    }
    
    // 保存预算到后端
    async function saveBudgetToBackend() {
      try {
        const response = await fetch(`/api/ai-generated-routes/${currentRouteData.id}/budgets`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(activityBudgets)
        });
        
        if (response.ok) {
          console.log('[Budget] Saved successfully');
        }
      } catch (error) {
        console.error('[Budget] Error saving:', error);
      }
    }
    
    // 加载预算数据
    async function loadBudgets() {
      try {
        // 检查路线数据是否存在
        if (!currentRouteData || !currentRouteData.id) {
          console.log('[Budget] No route data available, skipping budget load');
          activityBudgets = {};
          return;
        }
        
        const response = await fetch(`/api/ai-generated-routes/${currentRouteData.id}/budgets`);
        if (response.ok) {
          const budgets = await response.json();
          activityBudgets = budgets || {};
          console.log('[Budget] Loaded:', activityBudgets);
          
          // 刷新预算显示（只在用户不在编辑时）
          if (!isEditingBudget) {
            updateBudgetInputs();
          }
        }
      } catch (error) {
        console.error('[Budget] Error loading:', error);
        activityBudgets = {};
      }
    }
    
    // 更新预算统计
    function updateBudgetSummary(selectedDay) {
      // 计算当天的活动预算
      let activityTotal = 0;
      Object.keys(activityBudgets).forEach(key => {
        const [day, index] = key.split('-');
        if (parseInt(day) === selectedDay) {
          activityTotal += parseFloat(activityBudgets[key]) || 0;
        }
      });
      
      // 获取当天的酒店预算
      let hotelCost = 0;
      const dayHotel = projectHotels.find(h => h.dayIndex === selectedDay);
      if (dayHotel && dayHotel.pricePerNight) {
        hotelCost = parseFloat(dayHotel.pricePerNight) || 0;
      }
      
      // 计算当天的交通费用
      let transportCost = 0;
      if (currentRouteData && currentRouteData.dailyItinerary) {
        try {
          const itinerary = JSON.parse(currentRouteData.dailyItinerary);
          const dayData = itinerary.find(d => (d.day || itinerary.indexOf(d) + 1) === selectedDay);
          if (dayData && dayData.transports) {
            dayData.transports.forEach(t => {
              if (t.cost) {
                transportCost += parseFloat(t.cost) || 0;
              }
            });
          }
        } catch (e) {
          console.error('[Budget] 计算交通费用失败:', e);
        }
      }
      
      // 总预算 = 活动预算 + 酒店预算 + 交通费用
      const total = activityTotal + hotelCost + transportCost;
      
      // 显示预算区域
      const summaryEl = document.getElementById('budgetSummary');
      if (total > 0 || canEdit) {
        summaryEl.classList.remove('hidden');
      } else {
        summaryEl.classList.add('hidden');
        return;
      }
      
      // 更新总预算
      document.getElementById('totalBudget').textContent = total.toFixed(2);
      document.getElementById('plannedBudget').textContent = dailyBudgetPlan.toFixed(2);
      
      // 显示酒店费用
      const hotelCostDisplay = document.getElementById('hotelCostDisplay');
      const hotelCostAmount = document.getElementById('hotelCostAmount');
      if (hotelCost > 0) {
        hotelCostAmount.textContent = hotelCost.toFixed(2);
        hotelCostDisplay.classList.remove('hidden');
      } else {
        hotelCostDisplay.classList.add('hidden');
      }
      
      // 显示交通费用
      const transportCostDisplay = document.getElementById('transportCostDisplay');
      const transportCostAmount = document.getElementById('transportCostAmount');
      if (transportCost > 0) {
        transportCostAmount.textContent = transportCost.toFixed(2);
        transportCostDisplay.classList.remove('hidden');
      } else {
        transportCostDisplay.classList.add('hidden');
      }
      
      // 显示预算对比
      const warningEl = document.getElementById('budgetWarning');
      const diff = dailyBudgetPlan - total;
      
      if (dailyBudgetPlan > 0) {
        if (diff < 0) {
          // 预算超支
          warningEl.className = 'px-3 py-1.5 rounded-lg text-xs font-medium bg-red-100 text-red-700 flex items-center justify-center gap-1';
          warningEl.innerHTML = `
            <iconify-icon icon="mdi:alert-circle" width="14"></iconify-icon>
            <span>预算超支 ${Math.abs(diff).toFixed(2)} 元，请注意控制开支</span>
          `;
          warningEl.classList.remove('hidden');
        } else if (diff > 0) {
          // 预算剩余
          warningEl.className = 'px-3 py-1.5 rounded-lg text-xs font-medium bg-green-100 text-green-700 flex items-center justify-center gap-1';
          warningEl.innerHTML = `
            <iconify-icon icon="mdi:check-circle" width="14"></iconify-icon>
            <span>预算剩余 ${diff.toFixed(2)} 元，还可以安排其他活动</span>
          `;
          warningEl.classList.remove('hidden');
        } else {
          // 预算正好
          warningEl.className = 'px-3 py-1.5 rounded-lg text-xs font-medium bg-blue-100 text-blue-700 flex items-center justify-center gap-1';
          warningEl.innerHTML = `
            <iconify-icon icon="mdi:information" width="14"></iconify-icon>
            <span>预算使用合理，正好符合计划</span>
          `;
          warningEl.classList.remove('hidden');
        }
      } else {
        warningEl.classList.add('hidden');
      }
    }
    
    // 更新预算输入框的值（用于同步其他用户的修改）
    function updateBudgetInputs() {
      const selectedDay = parseInt(document.getElementById('daySelector').value);
      
      // 遍历所有预算输入框并更新其值
      document.querySelectorAll('input[type="number"][onchange^="updateActivityBudget"]').forEach(input => {
        // 跳过正在获得焦点的输入框
        if (document.activeElement === input) {
          return;
        }
        
        // 从 onchange 属性中提取 budgetKey
        const onchangeAttr = input.getAttribute('onchange');
        const keyMatch = onchangeAttr.match(/updateActivityBudget\('([^']+)'/);
        if (keyMatch) {
          const budgetKey = keyMatch[1];
          const budgetValue = activityBudgets[budgetKey] || '';
          if (input.value !== budgetValue.toString()) {
            input.value = budgetValue;
            console.log(`[Budget] Updated input ${budgetKey} to ${budgetValue}`);
          }
        }
      });
      
      // 更新预算统计
      updateBudgetSummary(selectedDay);
    }
    async function showAttractionDetail(index) {
      const attraction = currentDayAttractions[index];
      if (!attraction) return;
      
      console.log('[景点详情] 点击景点:', attraction.name, 'index:', index);
      
      // 在地图上显示该景点
      if (attraction.poiInfo && attraction.poiInfo.location) {
        showAttractionOnMap(attraction.poiInfo.location, attraction.name, index);
      } else {
        console.warn('[景点详情] 该景点没有位置信息:', attraction);
      }
      
      // 隐藏空状态，显示详情
      document.getElementById('emptyState').classList.add('hidden');
      document.getElementById('attractionDetail').classList.remove('hidden');
      
      // 高亮当前选中的景点
      document.querySelectorAll('.attraction-item').forEach(item => {
        item.classList.remove('bg-blue-50', 'border-blue-300');
      });
      document.querySelector(`.attraction-item[data-index="${index}"]`)?.classList.add('bg-blue-50', 'border-blue-300');
      
      // 设置基本信息
      document.getElementById('attractionName').textContent = attraction.name;
      
      // 重置图片状态
      const imgElement = document.getElementById('attractionImage');
      const placeholderElement = document.getElementById('attractionImagePlaceholder');
      imgElement.classList.add('hidden');
      imgElement.src = '';
      placeholderElement.classList.remove('hidden');
      placeholderElement.innerHTML = '<iconify-icon icon="mdi:loading" class="animate-spin" width="48"></iconify-icon><span class="text-sm mt-2">图片加载中...</span>';
      
      // 重置加载状态
      document.getElementById('attractionAddress').textContent = '加载中...';
      document.getElementById('aiIntroduction').innerHTML = `
        <div class="flex items-center justify-center py-8">
          <iconify-icon icon="mdi:loading" class="text-blue-500 animate-spin" width="32"></iconify-icon>
          <span class="ml-2 text-gray-500">AI 正在查找该景点的门票与开放时间信息...</span>
        </div>
      `;
      
      // 获取高德景点信息（图片 + 基本信息）
      await loadAmapInfo(attraction);
      
      // 生成AI介绍
      await generateAIIntroduction(attraction);
      
      // 加载附近景点推荐
      await loadNearbyAttractions(attraction);
    }
    
    // 加载高德景点信息（优先使用已有poiInfo）
    async function loadAmapInfo(attraction) {
      try {
        const imgElement = document.getElementById('attractionImage');
        const placeholderElement = document.getElementById('attractionImagePlaceholder');
        
        // 如果attraction已经有poiInfo，直接使用
        if (attraction.poiInfo && Object.keys(attraction.poiInfo).length > 0) {
          const data = attraction.poiInfo;
          console.log('[loadAmapInfo] Using cached poiInfo:', JSON.stringify(data, null, 2));
          
          // 使用已缓存的POI信息 - 地址
          if (data.address) {
            document.getElementById('attractionAddress').textContent = data.address;
          } else {
            document.getElementById('attractionAddress').textContent = '地址信息暂无';
          }
          
          // 设置景点图片
          if (data.photos && data.photos.length > 0) {
            const photoUrl = data.photos[0].url;
            if (photoUrl) {
              imgElement.src = photoUrl;
              imgElement.onload = () => {
                imgElement.classList.remove('hidden');
                placeholderElement.classList.add('hidden');
              };
              imgElement.onerror = () => {
                imgElement.classList.add('hidden');
                placeholderElement.classList.remove('hidden');
                placeholderElement.innerHTML = '<iconify-icon icon="mdi:image-off-outline" width="48"></iconify-icon><span class="text-sm mt-2">图片加载失败</span>';
              };
            } else {
              placeholderElement.innerHTML = '<iconify-icon icon="mdi:image-off-outline" width="48"></iconify-icon><span class="text-sm mt-2">暂无图片</span>';
            }
          } else {
            placeholderElement.innerHTML = '<iconify-icon icon="mdi:image-off-outline" width="48"></iconify-icon><span class="text-sm mt-2">暂无图片</span>';
          }
          
          return;
        }
        
        // 没有缓存，调用API获取
        const projectResponse = await fetch(`/api/travel-projects/${projectId}`);
        const projectResult = await projectResponse.json();
        
        // 处理后端返回的数据格式
        const project = projectResult.success && projectResult.data ? projectResult.data : projectResult;
        const city = project.destination;
        
        console.log('Loading Amap info for:', attraction.name, 'in', city);
        
        const url = `/api/amap-test/poi-detail?keyword=${encodeURIComponent(attraction.name)}&city=${encodeURIComponent(city)}`;
        console.log('Request URL:', url);
        
        const response = await fetch(url);
        console.log('Response status:', response.status, 'OK:', response.ok);
        
        if (!response.ok) {
          console.warn('Amap API response not OK:', response.status);
          throw new Error('Failed to fetch');
        }
        
        const data = await response.json();
        console.log('Amap API returned:', JSON.stringify(data, null, 2));
        
        // 优先使用高德返回的地址
        if (data && data.address) {
          document.getElementById('attractionAddress').textContent = data.address;
        } else if (data && data.name) {
          document.getElementById('attractionAddress').textContent = '地址信息暂无';
        } else {
          document.getElementById('attractionAddress').textContent = '未找到景点';
        }
        
        // 设置景点图片
        if (data && data.photos && data.photos.length > 0) {
          const photoUrl = data.photos[0].url;
          if (photoUrl) {
            imgElement.src = photoUrl;
            imgElement.onload = () => {
              imgElement.classList.remove('hidden');
              placeholderElement.classList.add('hidden');
            };
            imgElement.onerror = () => {
              imgElement.classList.add('hidden');
              placeholderElement.classList.remove('hidden');
              placeholderElement.innerHTML = '<iconify-icon icon="mdi:image-off-outline" width="48"></iconify-icon><span class="text-sm mt-2">图片加载失败</span>';
            };
          } else {
            placeholderElement.innerHTML = '<iconify-icon icon="mdi:image-off-outline" width="48"></iconify-icon><span class="text-sm mt-2">暂无图片</span>';
          }
        } else {
          placeholderElement.innerHTML = '<iconify-icon icon="mdi:image-off-outline" width="48"></iconify-icon><span class="text-sm mt-2">暂无图片</span>';
        }
        
      } catch (error) {
        console.error('Error loading Amap info:', error);
        document.getElementById('attractionAddress').textContent = '暂无定位信息';
        document.getElementById('attractionImagePlaceholder').innerHTML = '<iconify-icon icon="mdi:image-off-outline" width="48"></iconify-icon><span class="text-sm mt-2">图片加载失败</span>';
      }
    }
    
    // 生成AI介绍
    async function generateAIIntroduction(attraction) {
      try {
        const projectResponse = await fetch(`/api/travel-projects/${projectId}`);
        const projectResult = await projectResponse.json();
        const project = projectResult.success && projectResult.data ? projectResult.data : projectResult;
        const city = project.destination;
        
        const response = await fetch(`/api/amap-test/attraction-intro?name=${encodeURIComponent(attraction.name)}&city=${encodeURIComponent(city)}`);
        if (!response.ok) throw new Error('Failed to fetch');
        
        const data = await response.json();
        
        if (data.success && data.introduction) {
          // 格式化介绍文本为段落
          const paragraphs = data.introduction.split('\n').filter(p => p.trim().length > 0);
          const formattedIntro = paragraphs.map(p => `<p class="mb-3">${p.trim()}</p>`).join('');
          document.getElementById('aiIntroduction').innerHTML = formattedIntro;
        } else {
          // 使用默认介绍
          const introduction = `
            <p class="mb-3">${attraction.name}是一处具有重要历史和文化意义的景点。这里不仅风景优美，而且蕴含着丰富的历史故事和文化底蕴。</p>
            <p class="mb-3">景点周边配套设施完善，交通便利，是游客必打卡的热门地点之一。建议您提前了解相关历史背景，这样能更好地欣赏和理解景点的内涵。</p>
            <p>游览过程中请注意保护文物，不要在文物古迹上刻画或涂写。同时建议携带相机，记录下美好的旅行回忆。</p>
          `;
          document.getElementById('aiIntroduction').innerHTML = introduction;
        }
      } catch (error) {
        console.error('Error generating AI introduction:', error);
        // 使用默认介绍
        const introduction = `
          <p class="mb-3">${attraction.name}是一处具有重要历史和文化意义的景点。这里不仅风景优美，而且蕴含着丰富的历史故事和文化底蕴。</p>
          <p class="mb-3">景点周边配套设施完善，交通便利，是游客必打卡的热门地点之一。建议您提前了解相关历史背景，这样能更好地欣赏和理解景点的内涵。</p>
          <p>游览过程中请注意保护文物，不要在文物古迹上刻画或涂写。同时建议携带相机，记录下美好的旅行回忆。</p>
        `;
        document.getElementById('aiIntroduction').innerHTML = introduction;
      }
    }
    
    // 加载附近景点推荐
    async function loadNearbyAttractions(attraction) {
      const container = document.getElementById('nearbyAttractions');
      container.innerHTML = `
        <div class="flex items-center justify-center py-4 text-gray-400 text-xs">
          <iconify-icon icon="mdi:loading" class="animate-spin mr-2" width="16"></iconify-icon>
          加载中...
        </div>
      `;
      
      try {
        const projectResponse = await fetch(`/api/travel-projects/${projectId}`);
        const projectResult = await projectResponse.json();
        const project = projectResult.success && projectResult.data ? projectResult.data : projectResult;
        const city = project.destination;
        
        // 调用高德API搜索附近景点
        const response = await fetch(`/api/amap-test/nearby-attractions?name=${encodeURIComponent(attraction.name)}&city=${encodeURIComponent(city)}`);
        if (!response.ok) {
          throw new Error('Failed to fetch nearby attractions');
        }
        
        const data = await response.json();
        
        if (data.success && data.attractions && data.attractions.length > 0) {
          // 显示附近景点（最多5个）
          const nearbyList = data.attractions.slice(0, 5).map(poi => {
            // 将POI信息编码以便传递
            const poiData = encodeURIComponent(JSON.stringify({
              name: poi.name,
              location: poi.location,
              address: poi.address
            }));
            return `
            <div class="bg-gray-50 p-2 rounded-lg hover:bg-gray-100 transition-colors cursor-pointer" onclick="addAttractionFromRecommendation('${poiData}')">
              <div class="flex items-start gap-2">
                <iconify-icon icon="mdi:map-marker" class="text-green-600 mt-0.5" width="16"></iconify-icon>
                <div class="flex-1 min-w-0">
                  <h5 class="text-xs font-semibold text-gray-800 truncate">${poi.name}</h5>
                  <p class="text-xs text-gray-500 mt-0.5 line-clamp-1">${poi.address || '地址未知'}</p>
                  ${poi.distance ? `<p class="text-xs text-blue-600 mt-0.5">距离约 ${poi.distance}米</p>` : ''}
                </div>
                ${canEdit ? `
                  <iconify-icon icon="mdi:plus-circle" class="text-green-600 flex-shrink-0" width="16" title="添加到行程"></iconify-icon>
                ` : ''}
              </div>
            </div>
          `;
          }).join('');
          
          container.innerHTML = nearbyList;
        } else {
          container.innerHTML = `
            <div class="text-center py-4 text-gray-400 text-xs">
              <iconify-icon icon="mdi:map-marker-off" width="20" class="mb-1"></iconify-icon>
              <p>暂无附近景点推荐</p>
            </div>
          `;
        }
      } catch (error) {
        console.error('Error loading nearby attractions:', error);
        container.innerHTML = `
          <div class="text-center py-4 text-gray-400 text-xs">
            <iconify-icon icon="mdi:alert-circle" width="20" class="mb-1"></iconify-icon>
            <p>加载失败，请稍后重试</p>
          </div>
        `;
      }
    }
    
    // 从推荐中添加景点到行程（携带高德位置信息）
    function addAttractionFromRecommendation(poiDataEncoded) {
      if (!canEdit) {
        alert('您没有编辑权限');
        return;
      }
      
      try {
        // 解析POI数据
        const poiData = JSON.parse(decodeURIComponent(poiDataEncoded));
        console.log('[addAttractionFromRecommendation] POI数据:', poiData);
        
        // 打开新增活动弹窗并预填景点名称
        openAddActivityModal();
        document.getElementById('activityName').value = poiData.name;
        document.getElementById('activityType').value = 'attraction';
        
        // 保存位置信息以便保存时使用
        if (poiData.location) {
          window.pendingPoiLocation = poiData.location;
          console.log('[addAttractionFromRecommendation] 已保存位置:', poiData.location);
        }
      } catch (e) {
        console.error('[addAttractionFromRecommendation] 解析失败:', e);
        // 兑容旧版本，直接使用名称
        openAddActivityModal();
        document.getElementById('activityName').value = poiDataEncoded;
        document.getElementById('activityType').value = 'attraction';
      }
    }

    // 项目参与者列表
    let projectParticipants = [];
    let lastMessageId = 0; // 记录最后一条消息的ID
    
    // 加载项目参与者
    async function loadProjectParticipants() {
      if (!projectId) return;
      try {
        const response = await fetch(`/api/project-participants/project/${projectId}`);
        if (response.ok) {
          projectParticipants = await response.json();
          // 获取用户详细信息
          for (let participant of projectParticipants) {
            try {
              const userResponse = await fetch(`/api/users/${participant.userId}`);
              if (userResponse.ok) {
                const apiResult = await userResponse.json();
                // 后端返回的是 ApiResponse 格式: {success: true, data: {...}}
                participant.userInfo = apiResult.data || apiResult;
              }
            } catch (err) {
              console.error('Error loading user info:', err);
            }
          }
          // 渲染参与者头像
          renderParticipantAvatars();
        }
      } catch (error) {
        console.error('Error loading project participants:', error);
      }
    }
    
    // 渲染参与者头像
    function renderParticipantAvatars() {
      const container = document.getElementById('participantAvatars');
      const colors = ['#667eea', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'];
      
      const maxDisplay = 5; // 最多显示5个头像
      const displayParticipants = projectParticipants.slice(0, maxDisplay);
      const remaining = projectParticipants.length - maxDisplay;
      
      container.innerHTML = displayParticipants.map((p, idx) => {
        const username = p.userInfo?.username || `用户${p.userId}`;
        const initial = username.charAt(0).toUpperCase();
        const color = colors[idx % colors.length];
        const isCurrentUser = p.userId === currentUser.id;
        
        return `
          <div class="w-8 h-8 rounded-full border-2 border-white flex items-center justify-center text-white text-xs font-bold ${isCurrentUser ? 'ring-2 ring-blue-400' : ''}" 
               style="background: ${color};" 
               title="${username}${isCurrentUser ? ' (你)' : ''}">
            ${initial}
          </div>
        `;
      }).join('');
      
      // 如果还有更多参与者，显示+N
      if (remaining > 0) {
        container.innerHTML += `
          <div class="w-8 h-8 rounded-full bg-gray-400 border-2 border-white flex items-center justify-center text-white text-xs font-bold" 
               title="还有${remaining}位参与者">
            +${remaining}
          </div>
        `;
      }
    }
    
    // 打开权限管理弹窗
    function openPermissionModal() {
      const modal = document.getElementById('permissionModal');
      modal.classList.remove('hidden');
      renderParticipantList();
    }
    
    // 关闭权限管理弹窗
    function closePermissionModal() {
      const modal = document.getElementById('permissionModal');
      modal.classList.add('hidden');
    }
    
    // 渲染参与者列表（权限管理）
    function renderParticipantList() {
      const container = document.getElementById('participantList');
      const colors = ['#667eea', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'];
      
      // 过滤掉创建者，只显示其他参与者
      const editableParticipants = projectParticipants.filter(p => p.role !== '创建者');
      
      if (editableParticipants.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-8">暂无其他参与者</p>';
        return;
      }
      
      container.innerHTML = editableParticipants.map((p, idx) => {
        const username = p.userInfo?.username || `用户${p.userId}`;
        const initial = username.charAt(0).toUpperCase();
        const color = colors[idx % colors.length];
        const currentRole = p.role || '查看者';
        
        return `
          <div class="bg-gray-50 rounded-lg p-4 flex items-center justify-between hover:bg-gray-100 transition-colors">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 rounded-full flex items-center justify-center text-white text-lg font-bold" 
                   style="background: ${color};">
                ${initial}
              </div>
              <div>
                <div class="font-semibold text-gray-800">${username}</div>
                <div class="text-sm text-gray-500">ID: ${p.userId}</div>
              </div>
            </div>
            <div class="flex items-center gap-3">
              <select class="permission-select px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" 
                      data-participant-id="${p.id}" data-user-id="${p.userId}">
                <option value="编辑者" ${currentRole === '编辑者' ? 'selected' : ''}>📝 编辑者</option>
                <option value="查看者" ${currentRole === '查看者' || currentRole === '参与者' ? 'selected' : ''}>👁️ 查看者</option>
              </select>
              <button onclick="kickParticipant(${p.id}, '${username}')" 
                      class="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 text-sm flex items-center gap-1" title="踢出项目">
                <iconify-icon icon="mdi:account-remove"></iconify-icon>
                <span>踢出</span>
              </button>
            </div>
          </div>
        `;
      }).join('');
    }
    
    // 保存权限修改
    async function savePermissions() {
      const selects = document.querySelectorAll('.permission-select');
      const updates = [];
      
      for (let select of selects) {
        const participantId = select.getAttribute('data-participant-id');
        const newRole = select.value;
        
        updates.push({
          participantId: parseInt(participantId),
          role: newRole
        });
      }
      
      try {
        // 逐个更新权限
        for (let update of updates) {
          const response = await fetch(`/api/project-participants/${update.participantId}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              role: update.role
            })
          });
          
          if (!response.ok) {
            throw new Error('更新权限失败');
          }
        }
        
        alert('✅ 权限修改成功！');
        closePermissionModal();
        
        // 重新加载参与者列表
        await loadProjectParticipants();
        
        // 重新检查当前用户的编辑权限（如果不是创建者）
        const projectResult = await fetch(`/api/travel-projects/${projectId}`).then(r => r.json());
        const project = projectResult.success && projectResult.data ? projectResult.data : projectResult;
        isCreator = project.creatorId === currentUser.id;
        
        if (!isCreator) {
          // 重置 canEdit 标志
          canEdit = false;
          await checkEditPermission();
          
          // 根据最新权限更新 UI
          const addActivityBtn = document.getElementById('addActivityBtn');
          if (canEdit) {
            addActivityBtn.classList.remove('hidden');
            addActivityBtn.style.display = 'flex';
          } else {
            addActivityBtn.classList.add('hidden');
            addActivityBtn.style.display = 'none';
          }
          
          // 重新渲染当前天数的活动（以更新编辑/删除按钮）
          if (dailyItinerary && dailyItinerary.length > 0) {
            const selectedDay = parseInt(document.getElementById('daySelector').value);
            const dayData = dailyItinerary.find(d => (d.day || dailyItinerary.indexOf(d) + 1) === selectedDay);
            if (dayData && dayData.activities) {
              renderDayOverview(dayData.activities, selectedDay);
            }
          }
          
          // 如果获得了编辑权限，提示用户
          if (canEdit) {
            alert('🎉 你现在已获得编辑权限，可以修改行程了！');
          }
        }
        
      } catch (error) {
        console.error('Error saving permissions:', error);
        alert('❌ 权限修改失败，请重试');
      }
    }
    
    // 踢出参与者
    async function kickParticipant(participantId, username) {
      if (!confirm(`确定要将「${username}」踢出项目吗？\n\n该用户将无法再访问此项目。`)) {
        return;
      }
      
      try {
        const response = await fetch(`/api/project-participants/${participantId}`, {
          method: 'DELETE'
        });
        
        if (response.ok) {
          alert(`✅ 已将「${username}」踢出项目`);
          // 重新加载参与者列表
          await loadProjectParticipants();
          renderParticipantList();
        } else {
          throw new Error('删除失败');
        }
      } catch (error) {
        console.error('Error kicking participant:', error);
        alert('❌ 操作失败，请重试');
      }
    }
    
    // 更新状态徽章显示
    function updateStatusBadge() {
      const badge = document.getElementById('projectStatusBadge');
      if (!badge) return;
      
      badge.textContent = projectStatus;
      
      if (projectStatus === '已归档') {
        badge.className = 'bg-gray-500 text-white text-xs px-3 py-1 rounded-full';
        badge.title = '项目已归档，无法编辑';
        badge.style.cursor = 'default';
        badge.onclick = null;
        // 禁用编辑
        canEdit = false;
        disableAllEditing();
        // 显示PDF导出按钮
        const pdfBtn = document.getElementById('pdfExportButton');
        if (pdfBtn) {
          pdfBtn.style.display = 'block';
        }
      } else {
        badge.className = 'bg-blue-500 text-white text-xs px-3 py-1 rounded-full cursor-pointer hover:bg-blue-600 transition-colors';
        badge.title = isProjectCreator ? '点击归档项目' : '项目状态';
        badge.style.cursor = isProjectCreator ? 'pointer' : 'default';
        badge.onclick = isProjectCreator ? handleStatusClick : null;
        // 隐藏PDF导出按钮
        const pdfBtn = document.getElementById('pdfExportButton');
        if (pdfBtn) {
          pdfBtn.style.display = 'none';
        }
      }
    }
    
    // 禁用所有编辑功能
    function disableAllEditing() {
      // 隐藏新增按钮
      const addActivityBtn = document.getElementById('addActivityBtn');
      if (addActivityBtn) {
        addActivityBtn.classList.add('hidden');
        addActivityBtn.style.display = 'none';
      }
      
      // 隐藏任务添加按钮
      const addTaskBtn = document.getElementById('addTaskBtn');
      if (addTaskBtn) {
        addTaskBtn.classList.add('hidden');
        addTaskBtn.style.display = 'none';
      }
      
      // 隐藏所有编辑/删除按钮
      document.querySelectorAll('.edit-btn, .delete-btn').forEach(btn => {
        btn.style.display = 'none';
      });
      
      // 禁用预算输入框
      document.querySelectorAll('.budget-input').forEach(input => {
        input.disabled = true;
      });
      
      // 隐藏聊天输入框
      const chatInputContainer = document.querySelector('.bg-white.border-t.p-4');
      if (chatInputContainer) {
        chatInputContainer.style.display = 'none';
      }
      
      // 显示聊天已关闭提示
      const chatMessages = document.getElementById('chatMessages');
      if (chatMessages && chatMessages.parentElement) {
        const notice = document.createElement('div');
        notice.className = 'bg-gray-100 text-gray-500 text-center py-3 text-sm';
        notice.textContent = '项目已归档，聊天功能已关闭';
        chatMessages.parentElement.appendChild(notice);
      }
    }
    
    // 处理状态点击
    function handleStatusClick() {
      if (!isProjectCreator) {
        alert('只有创建者可以归档项目');
        return;
      }
      
      if (projectStatus === '已归档') {
        alert('项目已归档，无法再次操作');
        return;
      }
      
      // 第一次确认
      const firstConfirm = confirm('确定要将项目归档吗？\n\n归档后所有成员（包括创建者）将无法编辑该项目。');
      if (!firstConfirm) return;
      
      // 第二次确认
      const secondConfirm = confirm('再次确认：您确定要归档该项目吗？\n\n此操作不可撤销！');
      if (!secondConfirm) return;
      
      // 执行归档
      archiveProject();
    }
    
    // 归档项目
    async function archiveProject() {
      try {
        // 显示加载提示
        const loadingMsg = document.createElement('div');
        loadingMsg.id = 'archiveLoading';
        loadingMsg.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        loadingMsg.innerHTML = `
          <div class="bg-white rounded-lg p-6 shadow-xl max-w-sm mx-4">
            <div class="flex items-center gap-3 mb-3">
              <iconify-icon icon="mdi:loading" class="text-blue-500 animate-spin" width="24"></iconify-icon>
              <span class="font-medium text-gray-800">正在生成酒店交通信息...</span>
            </div>
            <div class="text-sm text-gray-600">请稍候，即将归档项目</div>
          </div>
        `;
        document.body.appendChild(loadingMsg);
        
        // 生成酒店交通卡片
        if (projectHotels.length > 0) {
          console.log('[Archive] 归档前生成酒店交通卡片');
          await generateHotelTransportCards();
          
          // 等待界面刷新完成
          console.log('[Archive] 等待界面刷新...');
          await loadDayAttractions();
          
          // 再等待500ms确保DOM渲染完成
          await new Promise(resolve => setTimeout(resolve, 500));
          console.log('[Archive] 界面刷新完成，开始归档');
        }
        
        // 更新提示为正在归档
        loadingMsg.querySelector('.font-medium').textContent = '正在归档项目...';
        loadingMsg.querySelector('.text-sm').textContent = '请稍候';
        
        const response = await fetch(`/api/travel-projects/${projectId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            status: '已归档'
          })
        });
        
        if (response.ok) {
          projectStatus = '已归档';
          updateStatusBadge();
          
          // 移除加载提示
          const loadingMsg = document.getElementById('archiveLoading');
          if (loadingMsg) loadingMsg.remove();
          
          alert('✅ 项目已成功归档');
          
          // 刷新页面并等待界面完全加载
          location.reload();
          
          // 注意：reload后代码不会继续执行，stopAutoRefresh会在页面重新加载时自动生效（因为projectStatus已是'已归档'）
        } else {
          const errorData = await response.json().catch(() => ({}));
          
          // 移除加载提示
          const loadingMsg = document.getElementById('archiveLoading');
          if (loadingMsg) loadingMsg.remove();
          
          alert('归档失败：' + (errorData.message || '请重试'));
        }
      } catch (error) {
        console.error('Error archiving project:', error);
        
        // 移除加载提示
        const loadingMsg = document.getElementById('archiveLoading');
        if (loadingMsg) loadingMsg.remove();
        
        alert('归档失败：' + error.message);
      }
    }
    
    // 复制邀请链接
    function copyInviteLink() {
      const token = Math.random().toString(36).substring(2, 15);
      const shareUrl = `${window.location.origin}/collaboration.html?id=${projectId}&invite=${token}`;
      
      const tempInput = document.createElement('input');
      tempInput.value = shareUrl;
      document.body.appendChild(tempInput);
      tempInput.select();
      document.execCommand('copy');
      document.body.removeChild(tempInput);
      
      alert('协作链接已复制到剪贴板！其他用户可直接加入协作。');
    }

    // 加载聊天消息
    async function loadChatMessages() {
      if (!projectId) return;
      try {
        const response = await fetch(`/api/chat-messages/project/${projectId}`);
        if (response.ok) {
          const messages = await response.json();
          renderChat(messages);
          if (messages.length > 0) {
            lastMessageId = messages[messages.length - 1].id;
          }
        }
      } catch (error) {
        console.error('Error loading chat messages:', error);
      }
    }
    
    // 轮询新消息
    async function pollNewMessages() {
      if (!projectId || lastMessageId === 0) return;
      try {
        const response = await fetch(`/api/chat-messages/project/${projectId}/new?lastMessageId=${lastMessageId}`);
        if (response.ok) {
          const newMessages = await response.json();
          if (newMessages.length > 0) {
            appendNewMessages(newMessages);
            lastMessageId = newMessages[newMessages.length - 1].id;
          }
        }
      } catch (error) {
        console.error('Error polling new messages:', error);
      }
    }
    
    // 检查用户是否被踢出项目
    async function checkKickedStatus() {
      if (!projectId || !currentUser) return;
      try {
        const response = await fetch(`/api/project-participants/project/${projectId}`);
        if (response.ok) {
          const participants = await response.json();
          const isStillParticipant = participants.some(p => p.userId === currentUser.id);
          
          const projectRes = await fetch(`/api/travel-projects/${projectId}`);
          if (projectRes.ok) {
            const projectData = await projectRes.json();
            const project = projectData.data || projectData;
            isCreator = project.creatorId === currentUser.id;
            
            if (!isCreator && !isStillParticipant) {
              alert('🚫 您已被项目创建者移出该项目\n\n点击确定返回主页');
              window.location.href = '/index.html';
            }
          }
        }
      } catch (error) {
        console.error('Error checking kicked status:', error);
      }
    }

    function renderChat(messages) {
      const container = document.getElementById('chatMessages');
      // 缓存消息用于引用查找
      window.chatMessagesCache = messages;
      
      container.innerHTML = messages.map(msg => {
        const isCurrentUser = msg.userId === currentUser.id;
        const timeAgo = formatTimeAgo(msg.createdTime);
        
        // 检查是否是投票消息
        if (msg.message.startsWith('[VOTE]')) {
          return renderVoteMessage(msg, timeAgo);
        }
        
        // 解析引用消息
        let replyHtml = '';
        let displayMessage = msg.message;
        if (msg.message.startsWith('[REPLY:')) {
          const endIdx = msg.message.indexOf(']');
          if (endIdx > 0) {
            const replyId = parseInt(msg.message.substring(7, endIdx));
            displayMessage = msg.message.substring(endIdx + 1);
            const replyMsg = messages.find(m => m.id === replyId);
            if (replyMsg) {
              const replyContent = replyMsg.message.startsWith('[REPLY:') 
                ? replyMsg.message.substring(replyMsg.message.indexOf(']') + 1)
                : replyMsg.message;
              // 只显示前6个字
              const previewText = replyContent.substring(0, 6) + (replyContent.length > 6 ? '...' : '');
              replyHtml = `
                <div class="text-xs px-2 py-1 mb-2 rounded bg-black bg-opacity-10 border-l-2 ${isCurrentUser ? 'border-blue-300' : 'border-gray-400'}">
                  <div class="flex items-center gap-1">
                    <iconify-icon icon="mdi:reply" width="12" class="opacity-60"></iconify-icon>
                    <span class="opacity-80">${previewText}</span>
                  </div>
                </div>
              `;
            }
          }
        }
        
        // 检查是否被@（别人的消息且@了当前用户）
        const isMentioned = !isCurrentUser && checkMention(displayMessage);
        let bgClass = isCurrentUser ? 'bg-blue-500 text-white' : 'bg-white border';
        if (isMentioned) {
          bgClass = 'bg-blue-100 border-2 border-blue-400';
        }
        
        return `
          <div class="${isCurrentUser ? 'flex justify-end' : ''} group">
            <div class="${bgClass} p-3 rounded-lg max-w-[80%] shadow-sm ${isMentioned ? 'ring-2 ring-blue-300' : ''} relative">
              ${replyHtml}
              <div class="text-xs font-bold ${isCurrentUser ? 'text-blue-100' : 'text-blue-600'} mb-1">${msg.username}</div>
              <div class="text-sm break-words">${displayMessage}</div>
              <div class="flex justify-between items-center mt-1">
                <span class="text-xs ${isCurrentUser ? 'text-blue-100' : 'text-gray-400'}">${timeAgo}</span>
                <button onclick="setReply(${msg.id}, '${msg.username.replace(/'/g, "\\'")}', '${displayMessage.replace(/'/g, "\\'")}')" 
                        class="opacity-0 group-hover:opacity-100 text-xs ${isCurrentUser ? 'text-blue-200 hover:text-white' : 'text-gray-400 hover:text-blue-500'} transition-opacity ml-2"
                        title="回复">
                  <iconify-icon icon="mdi:reply" width="14"></iconify-icon>
                </button>
              </div>
            </div>
          </div>
        `;
      }).join('');
      container.scrollTop = container.scrollHeight;
    }
    
    // 渲染投票消息
    function renderVoteMessage(msg, timeAgo) {
      try {
        const voteData = JSON.parse(msg.message.substring(6));
        const totalVotes = voteData.options.reduce((sum, opt) => sum + opt.votes.length, 0);
        
        const optionsHtml = voteData.options.map(opt => {
          const voteCount = opt.votes.length;
          const percentage = totalVotes > 0 ? Math.round((voteCount / totalVotes) * 100) : 0;
          const hasVoted = opt.votes.includes(currentUser.id);
          
          return `
            <div class="mb-2">
              <button onclick="castVote(${msg.id}, ${voteData.id}, ${opt.id})" 
                      class="w-full text-left px-3 py-2 rounded-lg border ${hasVoted ? 'bg-orange-100 border-orange-400' : 'bg-gray-50 hover:bg-gray-100'} transition-colors">
                <div class="flex justify-between items-center">
                  <span class="text-sm ${hasVoted ? 'font-bold text-orange-600' : ''}">${opt.text}</span>
                  <span class="text-xs text-gray-500">${voteCount}票 (${percentage}%)</span>
                </div>
                <div class="mt-1 h-1.5 bg-gray-200 rounded-full overflow-hidden">
                  <div class="h-full ${hasVoted ? 'bg-orange-500' : 'bg-blue-400'}" style="width: ${percentage}%"></div>
                </div>
              </button>
            </div>
          `;
        }).join('');
        
        return `
          <div class="w-full">
            <div class="bg-gradient-to-r from-orange-50 to-yellow-50 border-2 border-orange-200 p-4 rounded-lg shadow-sm">
              <div class="flex items-center gap-2 mb-3">
                <iconify-icon icon="mdi:poll" class="text-orange-500" width="20"></iconify-icon>
                <span class="font-bold text-orange-600">投票</span>
                <span class="text-xs text-gray-500">by ${voteData.createdByName}</span>
              </div>
              <div class="font-semibold text-gray-800 mb-3">${voteData.title}</div>
              ${optionsHtml}
              <div class="text-xs text-gray-400 mt-2 flex justify-between">
                <span>共${totalVotes}人参与投票</span>
                <span>${timeAgo}</span>
              </div>
            </div>
          </div>
        `;
      } catch (e) {
        console.error('Error rendering vote:', e);
        return '';
      }
    }
    
    // @提醒声音
    function playMentionSound() {
      try {
        const audio = new Audio('/sounds/mention.mp3');
        audio.volume = 0.5;
        audio.play().catch(e => console.log('播放提示音失败:', e));
      } catch (e) {
        console.log('播放提示音失败:', e);
      }
    }
    
    // 检查消息是否@了当前用户
    function checkMention(message) {
      if (!currentUser || !currentUser.username) return false;
      const mentionPattern = new RegExp(`@${currentUser.username}\\b`, 'i');
      return mentionPattern.test(message);
    }
    
    function appendNewMessages(messages) {
      const container = document.getElementById('chatMessages');
      let hasMention = false;
      
      // 更新缓存
      if (!window.chatMessagesCache) window.chatMessagesCache = [];
      window.chatMessagesCache = [...window.chatMessagesCache, ...messages];
      
      messages.forEach(msg => {
        const isCurrentUser = msg.userId === currentUser.id;
        const timeAgo = formatTimeAgo(msg.createdTime);
        
        // 解析引用消息
        let replyHtml = '';
        let displayMessage = msg.message;
        if (msg.message.startsWith('[REPLY:')) {
          const endIdx = msg.message.indexOf(']');
          if (endIdx > 0) {
            const replyId = parseInt(msg.message.substring(7, endIdx));
            displayMessage = msg.message.substring(endIdx + 1);
            const replyMsg = window.chatMessagesCache.find(m => m.id === replyId);
            if (replyMsg) {
              const replyContent = replyMsg.message.startsWith('[REPLY:') 
                ? replyMsg.message.substring(replyMsg.message.indexOf(']') + 1)
                : replyMsg.message;
              const previewText = replyContent.substring(0, 6) + (replyContent.length > 6 ? '...' : '');
              replyHtml = `
                <div class="text-xs px-2 py-1 mb-2 rounded bg-black bg-opacity-10 border-l-2 ${isCurrentUser ? 'border-blue-300' : 'border-gray-400'}">
                  <div class="flex items-center gap-1">
                    <iconify-icon icon="mdi:reply" width="12" class="opacity-60"></iconify-icon>
                    <span class="opacity-80">${previewText}</span>
                  </div>
                </div>
              `;
            }
          }
        }
        
        const isMentioned = !isCurrentUser && checkMention(displayMessage);
        let bgClass = isCurrentUser ? 'bg-blue-500 text-white' : 'bg-white border';
        if (isMentioned) {
          bgClass = 'bg-blue-100 border-2 border-blue-400';
          hasMention = true;
        }
        
        const messageEl = document.createElement('div');
        messageEl.className = `${isCurrentUser ? 'flex justify-end' : ''} group`;
        messageEl.innerHTML = `
          <div class="${bgClass} p-3 rounded-lg max-w-[80%] shadow-sm ${isMentioned ? 'ring-2 ring-blue-300' : ''} relative">
            ${replyHtml}
            <div class="text-xs font-bold ${isCurrentUser ? 'text-blue-100' : 'text-blue-600'} mb-1">${msg.username}</div>
            <div class="text-sm break-words">${displayMessage}</div>
            <div class="flex justify-between items-center mt-1">
              <span class="text-xs ${isCurrentUser ? 'text-blue-100' : 'text-gray-400'}">${timeAgo}</span>
              <button onclick="setReply(${msg.id}, '${msg.username.replace(/'/g, "\\'")}', '${displayMessage.replace(/'/g, "\\'")}')" 
                      class="opacity-0 group-hover:opacity-100 text-xs ${isCurrentUser ? 'text-blue-200 hover:text-white' : 'text-gray-400 hover:text-blue-500'} transition-opacity ml-2"
                      title="回复">
                <iconify-icon icon="mdi:reply" width="14"></iconify-icon>
              </button>
            </div>
          </div>
        `;
        container.appendChild(messageEl);
      });
      
      // 如果被@，播放提示音
      if (hasMention) {
        playMentionSound();
      }
      
      container.scrollTop = container.scrollHeight;
    }
    
    function formatTimeAgo(timestamp) {
      const now = new Date();
      const time = new Date(timestamp);
      const diff = Math.floor((now - time) / 1000); // seconds
      
      if (diff < 60) return '刚刚';
      if (diff < 3600) return `${Math.floor(diff / 60)}分钟前`;
      if (diff < 86400) return `${Math.floor(diff / 3600)}小时前`;
      return time.toLocaleDateString();
    }

    // @mention 功能
    let mentionMode = false;
    let mentionSearchText = '';
    let selectedMentionIndex = 0;
    let mentionStartPos = 0;

    function showMentionDropdown(searchText = '') {
      const dropdown = document.getElementById('mentionDropdown');
      // 过滤参与者，排除当前用户（不能@自己）
      const filtered = projectParticipants.filter(p => {
        // 排除当前用户
        if (p.userId === currentUser.id) return false;
        const username = p.userInfo?.username || `用户${p.userId}`;
        return username.toLowerCase().includes(searchText.toLowerCase());
      });

      if (filtered.length === 0) {
        dropdown.classList.remove('active');
        return;
      }

      dropdown.innerHTML = filtered.map((p, idx) => {
        const username = p.userInfo?.username || `用户${p.userId}`;
        const email = p.userInfo?.email || '';
        return `
          <div class="mention-item ${idx === selectedMentionIndex ? 'selected' : ''}" data-index="${idx}" data-username="${username}">
            <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center text-white text-xs font-bold">
              ${username.charAt(0).toUpperCase()}
            </div>
            <div>
              <div class="text-sm font-medium">${username}</div>
              ${email ? `<div class="text-xs text-gray-500">${email}</div>` : ''}
            </div>
          </div>
        `;
      }).join('');

      dropdown.classList.add('active');

      // 绑定点击事件
      dropdown.querySelectorAll('.mention-item').forEach(item => {
        item.addEventListener('click', () => {
          selectMention(item.getAttribute('data-username'));
        });
      });
    }

    function hideMentionDropdown() {
      document.getElementById('mentionDropdown').classList.remove('active');
      mentionMode = false;
      mentionSearchText = '';
      selectedMentionIndex = 0;
    }

    function selectMention(username) {
      const input = document.getElementById('chatInput');
      const beforeMention = input.value.substring(0, mentionStartPos);
      const afterMention = input.value.substring(input.selectionStart);
      input.value = beforeMention + '@' + username + ' ' + afterMention;
      hideMentionDropdown();
      input.focus();
    }
    
    // 引用回复功能
    window.replyToMessageId = null;
    
    window.setReply = function(msgId, username, content) {
      window.replyToMessageId = msgId;
      document.getElementById('replyPreview').classList.remove('hidden');
      document.getElementById('replyToUser').textContent = username;
      document.getElementById('replyToContent').textContent = content.substring(0, 100) + (content.length > 100 ? '...' : '');
      document.getElementById('chatInput').focus();
    }
    
    window.cancelReply = function() {
      window.replyToMessageId = null;
      document.getElementById('replyPreview').classList.add('hidden');
    }

    async function sendMessage() {
      // 归档后不允许发送消息
      if (projectStatus === '已归档') {
        alert('项目已归档，聊天功能已关闭');
        return;
      }
      const input = document.getElementById('chatInput');
      const text = input.value.trim();
      if (text) {
        try {
          // 检查是否有引用
          let finalMessage = text;
          if (window.replyToMessageId) {
            finalMessage = `[REPLY:${window.replyToMessageId}]${text}`;
          }
          
          // 保存消息到数据库
          const response = await fetch('/api/chat-messages', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              projectId: projectId,
              userId: currentUser.id,
              username: currentUser.username,
              message: finalMessage,
              createdTime: new Date().toISOString()
            })
          });
          
          if (response.ok) {
            const savedMessage = await response.json();
            // 立即显示自己的消息
            appendNewMessages([savedMessage]);
            lastMessageId = savedMessage.id;
            input.value = '';
            hideMentionDropdown();
            cancelReply(); // 清除引用
          }
        } catch (error) {
          console.error('Error sending message:', error);
          alert('发送消息失败');
        }
      }
    }

    // 投票功能
    let projectVotes = []; // 存储投票数据
    
    window.openVoteModal = function() {
      document.getElementById('voteModal').classList.remove('hidden');
      document.getElementById('voteTitle').value = '';
      document.getElementById('voteOptions').innerHTML = `
        <input type="text" class="vote-option w-full border rounded-lg px-3 py-2" placeholder="选项1">
        <input type="text" class="vote-option w-full border rounded-lg px-3 py-2" placeholder="选项2">
      `;
    }
    
    window.closeVoteModal = function() {
      document.getElementById('voteModal').classList.add('hidden');
    }
    
    window.addVoteOption = function() {
      const container = document.getElementById('voteOptions');
      const count = container.querySelectorAll('.vote-option').length + 1;
      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'vote-option w-full border rounded-lg px-3 py-2';
      input.placeholder = `选项${count}`;
      container.appendChild(input);
    }
    
    window.createVote = async function() {
      const title = document.getElementById('voteTitle').value.trim();
      const optionInputs = document.querySelectorAll('.vote-option');
      const options = Array.from(optionInputs).map(i => i.value.trim()).filter(v => v);
      
      if (!title) { alert('请输入投票标题'); return; }
      if (options.length < 2) { alert('至少需要2个选项'); return; }
      
      // 通过聊天消息发送投票（使用特殊格式）
      const voteData = {
        type: 'vote',
        id: Date.now(),
        title: title,
        options: options.map((opt, idx) => ({ id: idx, text: opt, votes: [] })),
        createdBy: currentUser.id,
        createdByName: currentUser.username
      };
      
      try {
        const response = await fetch('/api/chat-messages', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            projectId: projectId,
            userId: currentUser.id,
            username: currentUser.username,
            message: `[VOTE]${JSON.stringify(voteData)}`,
            createdTime: new Date().toISOString()
          })
        });
        
        if (response.ok) {
          closeVoteModal();
          await loadChatMessages();
        }
      } catch (error) {
        console.error('Error creating vote:', error);
        alert('发起投票失败');
      }
    }
    
    window.castVote = async function(messageId, voteId, optionId) {
      try {
        // 获取原消息
        const response = await fetch(`/api/chat-messages/${messageId}`);
        if (!response.ok) return;
        
        const msg = await response.json();
        if (!msg.message.startsWith('[VOTE]')) return;
        
        const voteData = JSON.parse(msg.message.substring(6));
        
        // 检查是否已投票，如果已投则取消
        let hasVoted = false;
        voteData.options.forEach(opt => {
          const voteIdx = opt.votes.indexOf(currentUser.id);
          if (voteIdx > -1) {
            opt.votes.splice(voteIdx, 1);
            hasVoted = (opt.id === optionId);
          }
        });
        
        // 如果不是取消同一选项，则添加新投票
        if (!hasVoted) {
          const option = voteData.options.find(o => o.id === optionId);
          if (option) option.votes.push(currentUser.id);
        }
        
        // 更新消息
        await fetch(`/api/chat-messages/${messageId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            ...msg,
            message: `[VOTE]${JSON.stringify(voteData)}`
          })
        });
        
        await loadChatMessages();
      } catch (error) {
        console.error('Error casting vote:', error);
      }
    }

    // 聊天输入框事件监听
    const chatInput = document.getElementById('chatInput');
    
    chatInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !mentionMode) {
        e.preventDefault();
        sendMessage();
      } else if (mentionMode) {
        const dropdown = document.getElementById('mentionDropdown');
        const items = dropdown.querySelectorAll('.mention-item');
        
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          selectedMentionIndex = Math.min(selectedMentionIndex + 1, items.length - 1);
          showMentionDropdown(mentionSearchText);
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          selectedMentionIndex = Math.max(selectedMentionIndex - 1, 0);
          showMentionDropdown(mentionSearchText);
        } else if (e.key === 'Enter') {
          e.preventDefault();
          const selectedItem = items[selectedMentionIndex];
          if (selectedItem) {
            selectMention(selectedItem.getAttribute('data-username'));
          }
        } else if (e.key === 'Escape') {
          e.preventDefault();
          hideMentionDropdown();
        }
      }
    });

    chatInput.addEventListener('input', (e) => {
      const value = e.target.value;
      const cursorPos = e.target.selectionStart;
      
      // 检测 @ 符号
      const textBeforeCursor = value.substring(0, cursorPos);
      const lastAtIndex = textBeforeCursor.lastIndexOf('@');
      
      if (lastAtIndex !== -1) {
        const textAfterAt = textBeforeCursor.substring(lastAtIndex + 1);
        // 如果 @ 后面没有空格，进入 mention 模式
        if (!textAfterAt.includes(' ')) {
          mentionMode = true;
          mentionStartPos = lastAtIndex;
          mentionSearchText = textAfterAt;
          selectedMentionIndex = 0;
          showMentionDropdown(mentionSearchText);
        } else {
          hideMentionDropdown();
        }
      } else {
        hideMentionDropdown();
      }
    });

    // 点击外部关闭下拉框
    document.addEventListener('click', (e) => {
      if (!e.target.closest('#chatInput') && !e.target.closest('#mentionDropdown')) {
        hideMentionDropdown();
      }
    });

    // 分享文档功能
    function shareDocument() {
      if (projectId) {
        window.location.href = `/share.html?id=${projectId}`;
      } else {
        alert('项目 ID不存在，无法分享');
      }
    }
        
    // 导出PDF功能
    async function exportPdf(event) {
      if (!projectId) {
        alert('项目 ID 不存在');
        return;
      }
          
      // 获取按钮元素
      const btn = event && event.target ? event.target.closest('button') : document.querySelector('[onclick*="exportPdf"]');
          
      try {
        console.log('[PDF Export] 开始下载PDF...');
            
        // 显示加载状态
        let originalText = '';
        if (btn) {
          originalText = btn.innerHTML;
          btn.innerHTML = '<iconify-icon icon="mdi:loading" class="animate-spin" width="24"></iconify-icon><span class="font-medium">生成中...</span>';
          btn.disabled = true;
        }
            
        // 调用后端API
        const response = await fetch(`/api/pdf/itinerary/${projectId}`);
            
        if (!response.ok) {
          throw new Error('PDF生成失败');
        }
            
        // 获取PDF数据
        const blob = await response.blob();
            
        // 创建下载链接
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `旅行行程-${projectId}.pdf`;
        document.body.appendChild(a);
        a.click();
            
        // 清理
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
            
        console.log('[PDF Export] PDF下载成功');
            
        // 恢复按钮状态
        if (btn) {
          btn.innerHTML = originalText;
          btn.disabled = false;
        }
            
      } catch (error) {
        console.error('[PDF Export] 导出PDF失败:', error);
        alert('PDF导出失败，请稍后重试');
            
        // 恢复按钮状态
        if (btn) {
          btn.innerHTML = '<iconify-icon icon="mdi:file-pdf-box" width="24"></iconify-icon><span class="font-medium">导出PDF</span>';
          btn.disabled = false;
        }
      }
    }

    // ========== 活动管理功能 ==========
    
    // 打开添加活动弹窗
    function openAddActivityModal() {
      document.getElementById('activityModal').classList.remove('hidden');
      // 清空表单
      document.getElementById('activityName').value = '';
      document.getElementById('activityType').value = 'attraction';
      document.getElementById('activityDescription').value = '';
      document.getElementById('activitySuggestions').classList.add('hidden');
      document.getElementById('selectedPoiLocation').value = '';
      document.getElementById('selectedPoiId').value = '';
      activitySuggestionsData = [];
      // 清理预存的位置信息
      window.pendingPoiLocation = null;
    }
    
    // 活动类型变化时的处理
    function handleActivityTypeChange() {
      // 简化后不需要处理，保留空函数兼容
    }
    
    // 活动名称输入时的处理
    let activityInputTimeout = null;
    async function handleActivityNameInput() {
      const keyword = document.getElementById('activityName').value.trim();
      
      // 清空之前选中的位置信息
      document.getElementById('selectedPoiLocation').value = '';
      document.getElementById('selectedPoiId').value = '';
      
      if (!keyword) {
        document.getElementById('activitySuggestions').classList.add('hidden');
        activitySuggestionsData = [];
        return;
      }
      
      // 防抖处理
      if (activityInputTimeout) {
        clearTimeout(activityInputTimeout);
      }
      
      activityInputTimeout = setTimeout(async () => {
        await fetchActivitySuggestions(keyword);
      }, 300);
    }
    
   // 获取景点建议
    async function fetchActivitySuggestions(keyword) {
      if (!destinationCity) {
        console.warn('Destination city not set');
        return;
      }
      
      // 在每次搜索前尝试解析城市名称（防止缓存问题）
      let searchCity = destinationCity;
      
      // 如果城市名称包含"站"、"镇"等，尝试通过地理编码获取真实城市
      if (searchCity.includes('站') || searchCity.includes('镇') || searchCity.includes('村')) {
        console.log('[fetchActivitySuggestions] Destination looks like a location, not a city:', searchCity);
        try {
          const url = `https://restapi.amap.com/v3/geocode/geo?address=${encodeURIComponent(searchCity)}&key=bf0e97cd7a4c3c6aaa8ecf3dd7485381`;
          const geoResponse = await fetch(url);
          if (geoResponse.ok) {
            const geoData = await geoResponse.json();
            if (geoData.status === '1' && geoData.geocodes && geoData.geocodes.length > 0) {
              const geocode = geoData.geocodes[0];
              let city = geocode.city;
              if (!city || (Array.isArray(city) && city.length === 0) || city === '') {
                city = geocode.province || geocode.district;
              }
              if (city && city !== searchCity) {
                console.log('[fetchActivitySuggestions] Resolved city:', city, 'from:', searchCity);
                searchCity = city;
                destinationCity = city; // 更新全局变量
              }
            }
          }
        } catch (error) {
          console.warn('[fetchActivitySuggestions] Failed to resolve city, using original:', error);
        }
      }
      
      console.log('Fetching POI suggestions for:', keyword, 'in city:', searchCity);
      
      try {
        const types = encodeURIComponent('110000|120000|130000|140000');
        const response = await fetch(
          `/api/amap-test/poi-search?keyword=${encodeURIComponent(keyword)}&city=${encodeURIComponent(searchCity)}&types=${types}`
        );
        
        if (response.ok) {
          const data = await response.json();
          console.log('POI search result:', data);
          activitySuggestionsData = data.pois || [];
          renderActivitySuggestions();
        } else {
          console.error('POI search failed with status:', response.status);
          const errorData = await response.json().catch(() => ({}));
          console.error('Error details:', errorData);
        }
      } catch (error) {
        console.error('Error fetching activity suggestions:', error);
      }
    }
    
    // 渲染景点建议列表（保存完整POI信息）
    function renderActivitySuggestions() {
      const suggestionsDiv = document.getElementById('activitySuggestions');
      
      if (activitySuggestionsData.length === 0) {
        suggestionsDiv.classList.add('hidden');
        return;
      }
      
      suggestionsDiv.innerHTML = activitySuggestionsData.slice(0, 10).map((poi, index) => `
        <div class="px-4 py-2 hover:bg-blue-50 cursor-pointer border-b last:border-b-0" 
             onclick="selectActivitySuggestion(${index})"
             title="${poi.address || ''}">
          <div class="font-medium text-gray-800">${poi.name}</div>
          <div class="text-xs text-gray-500">${poi.type || ''} ${poi.address ? '| ' + poi.address.substring(0, 30) : ''}</div>
          <div class="text-xs text-green-600"><iconify-icon icon="mdi:map-marker-check" width="12" class="inline-block mr-1"></iconify-icon>已确认位置信息</div>
        </div>
      `).join('');
      
      suggestionsDiv.classList.remove('hidden');
    }
    
    // 选择景点建议（保存完整POI信息）
    function selectActivitySuggestion(index) {
      const poi = activitySuggestionsData[index];
      if (!poi) return;
      
      // 保存景点名称
      document.getElementById('activityName').value = poi.name;
      // 保存位置信息
      document.getElementById('selectedPoiLocation').value = poi.location || '';
      document.getElementById('selectedPoiId').value = poi.id || '';
      
      console.log('[selectActivitySuggestion] 选中景点:', poi.name, '位置:', poi.location);
      
      document.getElementById('activitySuggestions').classList.add('hidden');
      activitySuggestionsData = [];
    }
    
    // 显示景点建议（输入框获取焦点时）
    function showActivitySuggestions() {
      const keyword = document.getElementById('activityName').value.trim();
      if (keyword && activitySuggestionsData.length > 0) {
        document.getElementById('activitySuggestions').classList.remove('hidden');
      }
    }
    
    // 关闭活动弹窗
    function closeActivityModal() {
      document.getElementById('activityModal').classList.add('hidden');
    }
    
    // 为新增景点生成交通信息
    async function generateTransportForNewActivity(selectedDay, newActivityName) {
      console.log('[自动生成交通] ========== 函数被调用 ==========');
      console.log('[自动生成交通] selectedDay:', selectedDay, 'newActivityName:', newActivityName);
      
      try {
        
        // 获取项目信息
        const projectResponse = await fetch(`/api/travel-projects/${projectId}`);
        const projectResult = await projectResponse.json();
        const project = projectResult.success && projectResult.data ? projectResult.data : projectResult;
        const city = project.destination;
        
        // 重新获取最新的路线数据
        const routeResponse = await fetch(`/api/ai-generated-routes/${currentRouteData.id}`);
        const route = await routeResponse.json();
        const localItinerary = JSON.parse(route.dailyItinerary);
        
        // 找到当前天数的数据
        const dayData = localItinerary.find(d => (d.day || localItinerary.indexOf(d) + 1) === selectedDay);
        if (!dayData || !dayData.activities) {
          console.log('[自动生成交通] 找不到当前天数据');
          return;
        }
        
        // 提取所有景点（过滤餐饮）
        const attractions = [];
        console.log('[自动生成交通] dayData.activities 数量:', dayData.activities.length);
        
        dayData.activities.forEach((activity, index) => {
          const parsed = parseActivity(activity);
          const content = parsed.content;
          
          console.log(`  活动[${index}]:`, content);
          
          // 使用适配器的判断函数
          if (isAttractionActivity(content)) {
            // 优先使用poiInfo中的名称，其次提取文本
            const attractionName = (parsed.poiInfo && parsed.poiInfo.name) ? 
                                   parsed.poiInfo.name : 
                                   extractAttractionName(content);
            if (attractionName) {
              console.log(`    ✅ 是景点! 名称: ${attractionName}`);
              attractions.push({
                index: index,
                name: attractionName,
                location: parsed.poiInfo ? parsed.poiInfo.location : null
              });
            } else {
              console.log(`    ⚠️ 无法提取景点名称`);
            }
          } else {
            console.log(`    ❌ 不是景点 (可能是餐饮或其他)`);
          }
        });
        
        console.log('[自动生成交通] 当前天所有景点:', attractions.map(a => a.name));
        
        // 找到新增景点的位置（改进：使用更宽松的匹配）
        let newAttractionIndex = -1;
        console.log('[自动生成交通] 开始匹配新景点:', newActivityName);
        
        for (let i = 0; i < attractions.length; i++) {
          const aName = attractions[i].name.replace(/[\s\-]/g, '');  // 去除空格和连字符
          const newName = newActivityName.replace(/[\s\-]/g, '');   // 去除空格和连字符
          
          console.log(`  比较: "${attractions[i].name}" (${aName}) vs "${newActivityName}" (${newName})`);
          
          if (aName === newName || aName.includes(newName) || newName.includes(aName)) {
            newAttractionIndex = i;
            console.log(`  ✅ 匹配成功! 索引: ${i}`);
            break;
          }
        }
        
        console.log('[自动生成交通] 新景点索引:', newAttractionIndex, '新景点名称:', newActivityName);
        
        if (newAttractionIndex === -1) {
          console.error('[自动生成交通] 找不到新增景点，当前景点列表:', attractions.map(a => a.name));
          return;
        }
        
        // 初始化transports数组（如果不存在）
        if (!dayData.transports) {
          dayData.transports = [];
        }
        
        // 生成交通信息：上一个景点 -> 新景点
        if (newAttractionIndex > 0) {
          const prevAttraction = attractions[newAttractionIndex - 1];
          const newAttraction = attractions[newAttractionIndex];
          
          console.log('[自动生成交通] 生成交通:', prevAttraction.name, '->', newAttraction.name);
          
          await generateTransportBetween(dayData, prevAttraction, newAttraction, city);
        }
        
        // 生成交通信息：新景点 -> 下一个景点
        if (newAttractionIndex < attractions.length - 1) {
          const newAttraction = attractions[newAttractionIndex];
          const nextAttraction = attractions[newAttractionIndex + 1];
          
          console.log('[自动生成交通] 生成交通:', newAttraction.name, '->', nextAttraction.name);
          
          await generateTransportBetween(dayData, newAttraction, nextAttraction, city);
        }
        
        // 保存更新后的路线数据
        route.dailyItinerary = JSON.stringify(localItinerary);
        const saveResponse = await fetch(`/api/ai-generated-routes/${route.id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(route)
        });
        
        if (saveResponse.ok) {
          console.log('[自动生成交通] 交通信息生成成功');
          currentRouteData = route;
        }
        
      } catch (error) {
        console.error('[自动生成交通] 错误:', error);
      }
    }
    
    // 生成两个景点间的交通信息
    async function generateTransportBetween(dayData, fromAttraction, toAttraction, city) {
      try {
        // 如果已经存在交通信息，先删除
        const existingIndex = dayData.transports.findIndex(t => 
          t.fromIndex === fromAttraction.index && t.toIndex === toAttraction.index
        );
        if (existingIndex !== -1) {
          dayData.transports.splice(existingIndex, 1);
        }
        
        // 如果没有位置信息，先查询
        let fromLocation = fromAttraction.location;
        let toLocation = toAttraction.location;
        
        if (!fromLocation) {
          console.log(`[生成交通] 开始查询起点位置: ${fromAttraction.name}`);
          const fromPoi = await searchPOI(fromAttraction.name, city);
          if (fromPoi) {
            fromLocation = fromPoi.location;
            console.log(`[生成交通] 起点位置查询成功: ${fromLocation}`);
          } else {
            console.error(`[生成交通] ❌ 起点位置查询失败: ${fromAttraction.name}`);
          }
        }
        
        if (!toLocation) {
          console.log(`[生成交通] 开始查询终点位置: ${toAttraction.name}`);
          const toPoi = await searchPOI(toAttraction.name, city);
          if (toPoi) {
            toLocation = toPoi.location;
            console.log(`[生成交通] 终点位置查询成功: ${toLocation}`);
          } else {
            console.error(`[生成交通] ❌ 终点位置查询失败: ${toAttraction.name}`);
          }
        }
        
        if (!fromLocation || !toLocation) {
          console.error(`[生成交通] ❌ 无法获取位置信息 - 起点: ${fromLocation || '未获取'}, 终点: ${toLocation || '未获取'}`);
          // 显示用户友好的错误提示
          const missingInfo = [];
          if (!fromLocation) missingInfo.push(`起点"${fromAttraction.name}"位置未知`);
          if (!toLocation) missingInfo.push(`终点"${toAttraction.name}"位置未知`);
          console.warn(`[生成交通] 无法自动生成交通: ${missingInfo.join(', ')}`);
          return;
        }
        
        // 调用高德API获取交通路线（传递目的地名称）
        console.log(`[生成交通] 调用direction API - origin: ${fromLocation}, destination: ${toLocation}, destName: ${toAttraction.name}`);
        const response = await fetch(
          `/api/amap-test/direction?origin=${fromLocation}&destination=${toLocation}&city=${encodeURIComponent(city)}&destName=${encodeURIComponent(toAttraction.name)}`
        );
        
        console.log(`[生成交通] direction API响应状态: ${response.status}`);
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error(`[生成交通] ❌ API调用失败 - 状态: ${response.status}, 错误: ${errorText}`);
          return;
        }
        
        const transportData = await response.json();
        console.log('[生成交通] direction API返回数据:', transportData);
        
        // 添加到transports数组
        dayData.transports.push({
          fromIndex: fromAttraction.index,
          toIndex: toAttraction.index,
          fromName: fromAttraction.name,
          toName: toAttraction.name,
          fromLocation: fromLocation,  // 保存位置信息
          toLocation: toLocation,      // 保存位置信息
          method: transportData.method || '公交/地铁',
          distance: transportData.distance,
          distanceText: transportData.distanceText,
          duration: transportData.duration,
          durationText: transportData.durationText,
          cost: transportData.cost,
          costText: transportData.costText,
          steps: transportData.steps || [],
          details: transportData.details
        });
        
        console.log('[生成交通] 成功生成交通信息:', fromAttraction.name, '->', toAttraction.name);
        
      } catch (error) {
        console.error('[生成交通] 错误:', error);
      }
    }
    
    // 搜索POI获取位置信息（多策略查询）
    async function searchPOI(name, city) {
      try {
        // 策略1：使用输入提示API
        console.log(`[searchPOI] 尝试input-tips查询: ${name}`);
        const response1 = await fetch(
          `/api/amap-test/input-tips?keywords=${encodeURIComponent(name)}&city=${encodeURIComponent(city)}`
        );
        if (response1.ok) {
          const data = await response1.json();
          if (data && data.length > 0 && data[0].location) {
            console.log(`[searchPOI] input-tips成功: ${data[0].name}, 位置: ${data[0].location}`);
            return {
              name: data[0].name,
              location: data[0].location
            };
          }
        }
        
        // 策略2：使用POI搜索API
        console.log(`[searchPOI] input-tips无结果，尝试poi-search: ${name}`);
        const response2 = await fetch(
          `/api/amap-test/poi-search?keywords=${encodeURIComponent(name)}&city=${encodeURIComponent(city)}`
        );
        if (response2.ok) {
          const data = await response2.json();
          if (data && data.length > 0 && data[0].location) {
            console.log(`[searchPOI] poi-search成功: ${data[0].name}, 位置: ${data[0].location}`);
            return {
              name: data[0].name,
              location: data[0].location
            };
          }
        }
        
        console.error(`[searchPOI] 所有查询均失败: ${name}`);
        return null;
      } catch (error) {
        console.error('[searchPOI] 错误:', error);
        return null;
      }
    }
    
    // 保存活动
    async function saveActivity() {
      const name = document.getElementById('activityName').value.trim();
      const type = document.getElementById('activityType').value;
      const description = document.getElementById('activityDescription').value.trim();
      
      if (!name) {
        alert('请输入景点名称');
        return;
      }
      
      // 验证是否有位置信息（优先使用附近景点推荐的位置，其次使用下拉列表选择的位置）
      let poiLocation = window.pendingPoiLocation || document.getElementById('selectedPoiLocation').value;
      
      // 清理预存的位置
      window.pendingPoiLocation = null;
      
      if (!poiLocation) {
        alert('请从下拉列表中选择景点，确保高德能识别位置');
        return;
      }
      
      try {
        // 获取当前选中的天数
        const selectedDay = parseInt(document.getElementById('daySelector').value);
        
        // 获取当前路线数据
        const routeResponse = await fetch(`/api/ai-generated-routes/${currentRouteData.id}`);
        const route = await routeResponse.json();
        const localItinerary = JSON.parse(route.dailyItinerary); // 使用局部变量名
        
        // 找到当前天数的数据
        const dayIndex = localItinerary.findIndex(d => (d.day || localItinerary.indexOf(d) + 1) === selectedDay);
        if (dayIndex === -1) {
          alert('找不到当前天数的数据');
          return;
        }
        
        // 构造新活动（全部都是景点，不包含时间）
        let activityStr = `景点：${name}`;
        if (description) {
          activityStr += ` (备注：${description})`;
        }
        
        // 创建带有poiInfo的活动对象（text包含时间和格式信息）
        const newActivity = {
          text: activityStr,
          poiInfo: {
            name: name,
            location: poiLocation || null
          }
        };
        
        // 添加到当前天数的activities（添加到末尾）
        if (!localItinerary[dayIndex].activities) {
          localItinerary[dayIndex].activities = [];
        }
        localItinerary[dayIndex].activities.push(newActivity);
        
        // 更新路线数据
        route.dailyItinerary = JSON.stringify(localItinerary);
        
        // 保存到后端
        const saveResponse = await fetch(`/api/ai-generated-routes/${route.id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(route)
        });
        
        console.log('[saveActivity] 保存响应:', saveResponse.ok, saveResponse.status);
        
        if (saveResponse.ok) {
          console.log('[saveActivity] 进入ok分支');
          closeActivityModal();
          // 更新本地数据
          currentRouteData = route;
          dailyItinerary = JSON.parse(route.dailyItinerary); // 更新全局变量
          
          console.log('[saveActivity] 开始检查活动类型...');
          console.log('[saveActivity] type变量值:', type);
          console.log('[saveActivity] name变量值:', name);
          
          // 如果是景点类型，尝试生成交通信息
          if (type === 'attraction') {
            console.log('[saveActivity] 是景点！准备调用generateTransportForNewActivity...');
            await generateTransportForNewActivity(selectedDay, name);
            console.log('[saveActivity] generateTransportForNewActivity 执行完成');
          } else {
            console.log('[saveActivity] 不是景点 (type=' + type + ')，跳过交通生成');
          }
          
          console.log('[saveActivity] 即将刷新页面...');
          await loadDayAttractions();
          console.log('[saveActivity] 页面刷新完成');
        } else {
          console.error('[saveActivity] 保存失败:', saveResponse.status);
        }
      } catch (error) {
        console.error('Error saving activity:', error);
        alert('保存失败：' + error.message);
      }
    }
    
    // ============ 拖拽排序功能 ============
    let draggedActivityIndex = null;
    let isDragging = false;
    
    // 拖拽开始
    function handleDragStart(event, activityIndex) {
      console.log('[Drag] 开始拖拽，索引:', activityIndex);
      draggedActivityIndex = activityIndex;
      isDragging = true;
      event.target.classList.add('dragging');
      event.dataTransfer.effectAllowed = 'move';
      event.dataTransfer.setData('text/plain', activityIndex);
    }
    
    // 拖拽结束
    function handleDragEnd(event) {
      console.log('[Drag] 拖拽结束');
      event.target.classList.remove('dragging');
      isDragging = false;
      draggedActivityIndex = null;
      // 移除所有高亮
      document.querySelectorAll('.attraction-card').forEach(card => {
        card.classList.remove('drag-over');
      });
    }
    
    // 拖拽经过
    function handleDragOver(event) {
      event.preventDefault();
      event.dataTransfer.dropEffect = 'move';
      const card = event.target.closest('.attraction-card');
      if (card && !card.classList.contains('dragging')) {
        card.classList.add('drag-over');
      }
    }
    
    // 拖拽离开
    function handleDragLeave(event) {
      const card = event.target.closest('.attraction-card');
      if (card) {
        card.classList.remove('drag-over');
      }
    }
    
    // 放下
    async function handleDrop(event, targetActivityIndex) {
      event.preventDefault();
      const card = event.target.closest('.attraction-card');
      if (card) {
        card.classList.remove('drag-over');
      }
      
      const sourceIndex = draggedActivityIndex;
      
      console.log('[Drag] Drop - 从索引', sourceIndex, '到索引', targetActivityIndex);
      
      if (sourceIndex === null || sourceIndex === targetActivityIndex) {
        console.log('[Drag] 同位置，不处理');
        return;
      }
      
      // 执行重新排序
      await reorderActivities(sourceIndex, targetActivityIndex);
    }
    
    // 重新排序景点并重新生成交通
    async function reorderActivities(fromIndex, toIndex) {
      console.log('[Reorder] ========== 开始重新排序 ==========');
      console.log('[Reorder] 从', fromIndex, '移动到', toIndex);
      
      // 获取当前选中的天数
      const selectedDay = parseInt(document.getElementById('daySelector').value);
      
      try {
        // 使用缓存的路线数据
        if (!currentRouteData) {
          console.error('[Reorder] 没有路线数据');
          return;
        }
        
        const route = currentRouteData;
        const city = destinationCity || '北京';
        
        // 解析行程数据
        const localItinerary = JSON.parse(route.dailyItinerary || '[]');
        const dayData = localItinerary.find(d => (d.day || localItinerary.indexOf(d) + 1) === selectedDay);
        
        if (!dayData || !dayData.activities) {
          console.error('[Reorder] 找不到当天数据');
          return;
        }
        
        // 显示加载状态
        const overviewContainer = document.getElementById('dayOverviewGrid');
        const originalContent = overviewContainer.innerHTML;
        overviewContainer.innerHTML = '<div class="flex items-center justify-center py-8"><iconify-icon icon="mdi:loading" class="text-blue-500 animate-spin" width="32"></iconify-icon><span class="ml-2">正在调整景点顺序并重新生成交通...</span></div>';
        
        // 重新排序 activities 数组
        const activities = dayData.activities;
        console.log('[Reorder] 排序前:', activities.map((a, i) => `${i}: ${a.poiInfo?.name || a.text?.substring(0,10)}`));
        
        const [movedActivity] = activities.splice(fromIndex, 1);
        // 从前往后移动时，插入到目标位置；从后往前移动时，插入位置不变
        const insertIndex = toIndex;
        activities.splice(insertIndex, 0, movedActivity);
        
        console.log('[Reorder] 排序后:', activities.map((a, i) => `${i}: ${a.poiInfo?.name || a.text?.substring(0,10)}`));
        console.log('[Reorder] 排序后第一个元素完整结构:', JSON.stringify(activities[0]?.poiInfo));
        
        // 先筛选有位置信息的景点
        const attractionsWithLocation = activities.filter(a => a.poiInfo?.location);
        console.log('[Reorder] 有位置信息的景点:');
        attractionsWithLocation.forEach((a, i) => {
          console.log(`  [${i}] ${a.poiInfo?.name}, location: ${a.poiInfo?.location}`);
        });
        
        // 保留出发地交通信息和酒店交通信息，清除其他交通卡片
        const departureTransport = dayData.transports ? dayData.transports.find(t => t.fromIndex === -1 || t.isDeparture) : null;
        const hotelTransports = dayData.transports ? dayData.transports.filter(t => t.isHotelTransport || (t.toName && t.toName.includes('(酒店)'))) : [];
        console.log('[Reorder] 找到的出发地交通:', departureTransport);
        console.log('[Reorder] 找到的酒店交通:', hotelTransports.length, '个');
        dayData.transports = [];
        
        // 处理第一个景点的交通：第1天从出发地，第2天及以后从前一天酒店
        if (attractionsWithLocation.length > 0) {
          const firstAttraction = attractionsWithLocation[0];
          const firstAttrName = firstAttraction.poiInfo?.name || '第一个景点';
          const firstAttrLocation = firstAttraction.poiInfo?.location;
          
          // 判断是第几天
          const currentDay = selectedDay || (dailyItinerary.indexOf(dayData) + 1);
          
          if (currentDay === 1) {
            // 第1天：从出发地开始
            if (departureTransport) {
              let departureLocation = departureTransport.fromLocation;
              if (!departureLocation && currentProjectInfo && currentProjectInfo.departureLocationCoord) {
                departureLocation = currentProjectInfo.departureLocationCoord;
                console.log('[Reorder] 从项目信息中获取出发地坐标:', departureLocation);
              }
              
              console.log('[Reorder] 第1天，重新生成出发地交通:', departureTransport.fromName, '->', firstAttrName);
              
              if (departureLocation && firstAttrLocation) {
                try {
                  const depResponse = await fetch(
                    `/api/amap-test/direction?origin=${departureLocation}&destination=${firstAttrLocation}&city=${encodeURIComponent(city)}&destName=${encodeURIComponent(firstAttrName)}`
                  );
                  
                  if (depResponse.ok) {
                    const depData = await depResponse.json();
                    if (depData && !depData.error) {
                      dayData.transports.push({
                        ...depData,
                        fromIndex: -1,
                        toIndex: 0,
                        fromName: departureTransport.fromName,
                        toName: firstAttrName,
                        fromLocation: departureLocation,
                        toLocation: firstAttrLocation,
                        isDeparture: true
                      });
                      console.log('[Reorder] ✅ 出发地交通重新生成成功');
                    }
                  }
                } catch (e) {
                  console.error('[Reorder] 出发地交通生成失败:', e);
                }
              }
            }
          } else {
            // 第2天及以后：从前一天酒店开始
            const prevDayData = dailyItinerary[currentDay - 2];
            if (prevDayData) {
              // 查找前一天的酒店
              const prevDayHotel = projectHotels.find(h => h.dayIndex === currentDay - 1);
              
              if (prevDayHotel) {
                const hotelLocation = `${prevDayHotel.longitude},${prevDayHotel.latitude}`;
                const hotelName = prevDayHotel.hotelName;
                
                console.log(`[Reorder] 第${currentDay}天，从前一天酒店开始:`, hotelName, '->', firstAttrName);
                
                try {
                  const hotelToFirstResponse = await fetch(
                    `/api/amap-test/direction?origin=${hotelLocation}&destination=${firstAttrLocation}&city=${encodeURIComponent(city)}&destName=${encodeURIComponent(firstAttrName)}`
                  );
                  
                  if (hotelToFirstResponse.ok) {
                    const hotelToFirstData = await hotelToFirstResponse.json();
                    if (hotelToFirstData && !hotelToFirstData.error) {
                      dayData.transports.push({
                        ...hotelToFirstData,
                        fromIndex: -1,
                        toIndex: 0,
                        fromName: hotelName + '(酒店)',
                        toName: firstAttrName,
                        fromLocation: hotelLocation,
                        toLocation: firstAttrLocation,
                        isDeparture: true,
                        isFromPrevHotel: true  // 标记为从前一天酒店出发
                      });
                      console.log('[Reorder] ✅ 从前一天酒店出发的交通生成成功');
                    }
                  }
                } catch (e) {
                  console.error('[Reorder] 酒店到第一景点交通生成失败:', e);
                }
              } else if (departureTransport) {
                // 前一天没酒店，仍然从出发地开始
                console.log(`[Reorder] 第${currentDay}天，前一天无酒店，从出发地开始`);
                departureTransport.toIndex = 0;
                departureTransport.toName = firstAttrName;
                departureTransport.toLocation = firstAttrLocation;
                dayData.transports.push(departureTransport);
              }
            }
          }
        } else if (departureTransport) {
          // 没有有位置信息的景点，但有出发地交通，保留它
          console.log('[Reorder] 没有有位置信息的景点，保留出发地交通');
          dayData.transports.push(departureTransport);
        }
        
        // 对所有有位置信息的相邻景点生成交通
        for (let i = 0; i < attractionsWithLocation.length - 1; i++) {
          const fromAttraction = attractionsWithLocation[i];
          const toAttraction = attractionsWithLocation[i + 1];
          
          const fromName = fromAttraction.poiInfo?.name || '起点';
          const toName = toAttraction.poiInfo?.name || '终点';
          const fromLocation = fromAttraction.poiInfo?.location;
          const toLocation = toAttraction.poiInfo?.location;
          
          console.log(`[Reorder] 生成交通: ${fromName} -> ${toName}`);
          
          try {
            const dirResponse = await fetch(
              `/api/amap-test/direction?origin=${fromLocation}&destination=${toLocation}&city=${encodeURIComponent(city)}&destName=${encodeURIComponent(toName)}`
            );
            
            if (dirResponse.ok) {
              const transportData = await dirResponse.json();
              if (transportData && !transportData.error) {
                const fromIdx = activities.indexOf(fromAttraction);
                const toIdx = activities.indexOf(toAttraction);
                
                dayData.transports.push({
                  fromIndex: fromIdx,
                  toIndex: toIdx,
                  fromName: fromName,
                  toName: toName,
                  fromLocation: fromLocation,
                  toLocation: toLocation,
                  ...transportData
                });
                console.log(`[Reorder] ✅ 交通生成成功: ${fromName} -> ${toName}`);
              }
            }
          } catch (err) {
            console.error(`[Reorder] 交通生成失败: ${fromName} -> ${toName}`, err);
          }
        }
        
        console.log('[Reorder] 共生成交通卡片数:', dayData.transports.length);
        
        // 在保存前重新生成酒店交通（使用最新的景点信息）
        if (hotelTransports.length > 0 && attractionsWithLocation.length > 0) {
          console.log('[Reorder] 重新生成酒店交通');
          const lastAttr = attractionsWithLocation[attractionsWithLocation.length - 1];
          const lastAttrName = lastAttr.poiInfo?.name || '最后景点';
          const lastAttrLocation = lastAttr.poiInfo?.location;
          const lastAttractionIdx = activities.indexOf(lastAttr);
          
          // 从旧的酒店交通中获取酒店信息
          const oldHotelTransport = hotelTransports[0];
          const hotelLocation = oldHotelTransport.toLocation;
          const hotelName = oldHotelTransport.toName;
          
          if (lastAttrLocation && hotelLocation) {
            try {
              const hotelResponse = await fetch(
                `/api/amap-test/direction?origin=${lastAttrLocation}&destination=${hotelLocation}&destName=${encodeURIComponent(hotelName)}`
              );
              
              if (hotelResponse.ok) {
                const hotelData = await hotelResponse.json();
                if (hotelData && !hotelData.error) {
                  dayData.transports.push({
                    ...hotelData,
                    fromIndex: lastAttractionIdx,
                    toIndex: -2,
                    fromName: lastAttrName,
                    toName: hotelName,
                    fromLocation: lastAttrLocation,
                    toLocation: hotelLocation,
                    isHotelTransport: true
                  });
                  console.log('[Reorder] ✅ 酒店交通重新生成成功:', lastAttrName, '->', hotelName);
                }
              }
            } catch (e) {
              console.error('[Reorder] 酒店交通生成失败:', e);
            }
          }
        }
        
        // 更新路线数据
        route.dailyItinerary = JSON.stringify(localItinerary);
        
        // 打印保存前的数据检查
        const parsedBeforeSave = JSON.parse(route.dailyItinerary);
        console.log('[Reorder] 保存前 localItinerary 第1天activities:', localItinerary[0]?.activities?.map(a => a.poiInfo?.name || a.text?.substring(0, 10)));
        console.log('[Reorder] 保存前 route.dailyItinerary解析后 第1天activities:', parsedBeforeSave[0]?.activities?.map(a => a.poiInfo?.name || a.text?.substring(0, 10)));
        
        // 保存到后端
        const saveResponse = await fetch(`/api/ai-generated-routes/${route.id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(route)
        });
        
        if (saveResponse.ok) {
          console.log('[Reorder] 保存成功');
          console.log('[Reorder] 保存的transports:', JSON.stringify(dayData.transports.map(t => ({from: t.fromName, to: t.toName, isDep: t.isDeparture}))));
          currentRouteData = route;
          dailyItinerary = JSON.parse(route.dailyItinerary);
          console.log('[Reorder] 刷新后dailyItinerary中的transports:', JSON.stringify(dailyItinerary.find(d => d.day === selectedDay || dailyItinerary.indexOf(d) + 1 === selectedDay)?.transports?.map(t => ({from: t.fromName, to: t.toName}))));
          
          // 强制等待确保数据更新
          await new Promise(resolve => setTimeout(resolve, 100));
          
          // 重新生成酒店交通卡片
          if (projectHotels.length > 0) {
            await generateHotelTransportCards();
          }
          
          // 直接用刚保存的新数据渲染，不依赖loadDayAttractions重新解析
          const updatedDayData = dailyItinerary[selectedDay - 1];
          console.log('[Reorder] 直接渲染新数据, activities:', updatedDayData.activities);
          renderDayOverview(updatedDayData.activities, selectedDay);
          
          // 刷新左侧景点列表
          await loadDayAttractions();
        } else {
          console.error('[Reorder] 保存失败');
          overviewContainer.innerHTML = originalContent;
          alert('保存失败，请重试');
        }
        
      } catch (error) {
        console.error('[Reorder] 错误:', error);
        alert('调整顺序失败: ' + error.message);
      }
    }
    
    // 删除活动
    async function deleteAttraction(activityIndex) {
      if (!confirm('确定要删除这个活动吗？')) {
        return;
      }
      
      try {
        const selectedDay = parseInt(document.getElementById('daySelector').value);
        
        // 获取项目信息（用于生成交通）
        const projectResponse = await fetch(`/api/travel-projects/${projectId}`);
        const projectResult = await projectResponse.json();
        const project = projectResult.success && projectResult.data ? projectResult.data : projectResult;
        const city = project.destination;
        
        // 获取当前路线数据
        const routeResponse = await fetch(`/api/ai-generated-routes/${currentRouteData.id}`);
        const route = await routeResponse.json();
        const localItinerary = JSON.parse(route.dailyItinerary);
        
        // 找到当前天数的数据
        const dayIndex = localItinerary.findIndex(d => (d.day || localItinerary.indexOf(d) + 1) === selectedDay);
        if (dayIndex === -1 || !localItinerary[dayIndex].activities) {
          alert('找不到活动数据');
          return;
        }
        
        const dayData = localItinerary[dayIndex];
        
        // 获取要删除的景点名称
        const deletedActivity = dayData.activities[activityIndex];
        const parsed = parseActivity(deletedActivity);
        const deletedName = (parsed.poiInfo && parsed.poiInfo.name) ? parsed.poiInfo.name : extractAttractionName(parsed.content);
        
        console.log('[DELETE] 删除景点:', deletedName, '索引:', activityIndex);
        
        // 提取删除前的所有景点信息
        const attractionsBefore = [];
        dayData.activities.forEach((activity, idx) => {
          const p = parseActivity(activity);
          if (isAttractionActivity(p.content)) {
            const name = (p.poiInfo && p.poiInfo.name) ? p.poiInfo.name : extractAttractionName(p.content);
            if (name) {
              attractionsBefore.push({
                index: idx,
                name: name,
                location: p.poiInfo ? p.poiInfo.location : null
              });
            }
          }
        });
        
        // 找到删除景点在景点列表中的位置
        const deletedAttractionIdx = attractionsBefore.findIndex(a => a.index === activityIndex);
        const prevAttraction = deletedAttractionIdx > 0 ? attractionsBefore[deletedAttractionIdx - 1] : null;
        const nextAttraction = deletedAttractionIdx < attractionsBefore.length - 1 ? attractionsBefore[deletedAttractionIdx + 1] : null;
        
        console.log('[DELETE] 前一个景点:', prevAttraction ? prevAttraction.name : '无');
        console.log('[DELETE] 后一个景点:', nextAttraction ? nextAttraction.name : '无');
        
        // 删除指定的活动
        dayData.activities.splice(activityIndex, 1);
        
        // 删除相关的交通卡片（以该景点为起点或终点的）
        if (dayData.transports) {
          dayData.transports = dayData.transports.filter(t => {
            const isFromDeleted = t.fromIndex === activityIndex || t.fromName === deletedName;
            const isToDeleted = t.toIndex === activityIndex || t.toName === deletedName;
            if (isFromDeleted || isToDeleted) {
              console.log('[DELETE] 删除交通卡片:', t.fromName, '->', t.toName);
              return false;
            }
            return true;
          });
          
          // 更新剩余交通卡片的索引（删除后索引会变化）
          dayData.transports.forEach(t => {
            if (t.fromIndex > activityIndex) t.fromIndex--;
            if (t.toIndex > activityIndex) t.toIndex--;
          });
        }
        
        // 如果删除的是中间的景点，需要重新生成前后景点之间的交通
        if (prevAttraction && nextAttraction) {
          console.log('[DELETE] 需要重新生成交通:', prevAttraction.name, '->', nextAttraction.name);
          
          // 更新索引（因为删除后索引变了）
          const newPrevIdx = prevAttraction.index > activityIndex ? prevAttraction.index - 1 : prevAttraction.index;
          const newNextIdx = nextAttraction.index > activityIndex ? nextAttraction.index - 1 : nextAttraction.index;
          
          const updatedPrev = { ...prevAttraction, index: newPrevIdx };
          const updatedNext = { ...nextAttraction, index: newNextIdx };
          
          if (!dayData.transports) dayData.transports = [];
          
          await generateTransportBetween(dayData, updatedPrev, updatedNext, city);
        }
        
        // 更新路线数据
        route.dailyItinerary = JSON.stringify(localItinerary);
        
        // 保存到后端
        const saveResponse = await fetch(`/api/ai-generated-routes/${route.id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(route)
        });
        
        if (saveResponse.ok) {
          console.log('[DELETE] 删除成功');
          alert('删除成功！');
          currentRouteData = route;
          dailyItinerary = JSON.parse(route.dailyItinerary);
          await loadDayAttractions();
        } else {
          console.error('[DELETE] 后端响应错误:', saveResponse.status);
          alert('删除失败，请重试');
        }
      } catch (error) {
        console.error('Error deleting activity:', error);
        alert('删除失败：' + error.message);
      }
    }

    // 初始化
    async function init() {
      console.log('=== Initializing collaboration page ===');
      // 已移除：renderDailyTimeline(); renderFlowChart();
      
      // 初始化聊天窗口
      initChatWindow();
      
      try {
        // 加载项目信息
        console.log('Step 1: Loading project info...');
        await loadProjectInfo();
        console.log('Step 1: Project info loaded');
        
        // 初始化路线地图
        initRouteMap();
      } catch (error) {
        console.error('Step 1 failed:', error);
      }
      
      try {
        // 加载天数选项和景点列表
        console.log('Step 2: Loading day options and attractions...');
        await loadDayOptions();
        console.log('Step 2: Day options loaded');
      } catch (error) {
        console.error('Step 2 failed:', error);
        showNoRouteMessage();
      }
      
      try {
        // 先处理邀请链接，添加用户到项目
        console.log('Step 3: Handling invite link...');
        await handleInviteLink();
        console.log('Step 3: Invite link handled');
      } catch (error) {
        console.error('Step 3 failed:', error);
      }
      
      try {
        // 然后加载参与者和聊天消息
        console.log('Step 4: Loading participants...');
        await loadProjectParticipants();
        console.log('Step 4: Participants loaded');
      } catch (error) {
        console.error('Step 4 failed:', error);
      }
      
      try {
        console.log('Step 5: Loading chat messages...');
        await loadChatMessages();
        console.log('Step 5: Chat messages loaded');
      } catch (error) {
        console.error('Step 5 failed:', error);
      }
      
      try {
        // 加载项目需求参数（用于显示“xxx想去”）
        console.log('Step 6: Loading project requirements...');
        await loadProjectRequirements();
        console.log('Step 6: Requirements loaded');
        // 注意：不在这里调用loadDayAttractions，等酒店加载完后统一刷新
      } catch (error) {
        console.error('Step 6 failed:', error);
      }
            
      try {
        // 加载预算数据
        console.log('Step 7: Loading budget data...');
        await loadBudgets();
        console.log('Step 7: Budget data loaded');
        // 获取每日预算
        const projectResponse = await fetch(`/api/travel-projects/${projectId}`);
        if (projectResponse.ok) {
          const projectResult = await projectResponse.json();
          const project = projectResult.success && projectResult.data ? projectResult.data : projectResult;
          // 计算每日平均预算
          if (project.totalBudget && project.days) {
            dailyBudgetPlan = project.totalBudget / project.days;
          }
          console.log('Daily budget plan:', dailyBudgetPlan);
        }
      } catch (error) {
        console.error('Step 7 failed:', error);
      }
      
      try {
        // 加载任务分工数据
        console.log('Step 8: Loading project tasks...');
        await loadProjectTasks();
        console.log('Step 8: Project tasks loaded');
      } catch (error) {
        console.error('Step 8 failed:', error);
      }
      
      try {
        // 加载酒店数据
        console.log('Step 9: Loading project hotels...');
        await loadProjectHotels();
        console.log('Step 9: Project hotels loaded');
      } catch (error) {
        console.error('Step 9 failed:', error);
      }
      
      // 每3秒轮询一次新消息
      console.log('Setting up message polling...');
      setInterval(pollNewMessages, 3000);
      setInterval(checkKickedStatus, 5000); // 每5秒检查是否被踢出
      setInterval(pollNewTasks, 5000); // 每5秒检查新任务
      
      // 添加点击外部隐藏景点建议的事件监听
      document.addEventListener('click', function(e) {
        const suggestionsDiv = document.getElementById('activitySuggestions');
        const nameInput = document.getElementById('activityName');
        
        if (suggestionsDiv && nameInput && 
            !suggestionsDiv.contains(e.target) && 
            e.target !== nameInput) {
          suggestionsDiv.classList.add('hidden');
        }
      });
      
      console.log('=== Initialization complete ===');
      
      // 启动自动刷新（仅在项目未归档时）
      if (projectStatus !== '已归档') {
        startAutoRefresh();
      } else {
        console.log('[AutoRefresh] 项目已归档，不启动自动刷新');
      }
    }
    
    // 手动刷新
    async function manualRefresh() {
      const refreshBtn = document.getElementById('refreshBtn');
      const icon = refreshBtn.querySelector('iconify-icon');
      
      // 添加旋转动画
      icon.style.animation = 'spin 1s linear infinite';
      
      try {
        await refreshData();
        // 显示成功提示
        const originalBg = refreshBtn.className;
        refreshBtn.className = refreshBtn.className.replace('bg-green-500', 'bg-blue-500');
        setTimeout(() => {
          refreshBtn.className = originalBg;
        }, 500);
      } catch (error) {
        console.error('Manual refresh failed:', error);
        alert('刷新失败，请重试');
      } finally {
        // 停止旋转动画
        icon.style.animation = '';
      }
    }
    
    // 刷新数据
    async function refreshData() {
      console.log('[Refresh] 刷新数据...');
      
      // 重新加载路线数据
      if (currentRouteData && currentRouteData.id) {
        const routeResponse = await fetch(`/api/ai-generated-routes/${currentRouteData.id}`);
        if (routeResponse.ok) {
          const route = await routeResponse.json();
          console.log('[Refresh] Got route from backend, dailyItinerary length:', route.dailyItinerary?.length || 0);
          currentRouteData = route;
          dailyItinerary = JSON.parse(route.dailyItinerary);
          
          // 重新加载预算数据
          await loadBudgets();
          console.log('[Refresh] Budget data reloaded');
          
          // 显示当前天数的活动数量
          const selectedDay = parseInt(document.getElementById('daySelector').value);
          const dayData = dailyItinerary.find(d => (d.day || dailyItinerary.indexOf(d) + 1) === selectedDay);
          if (dayData && dayData.activities) {
            console.log('[Refresh] Day', selectedDay, 'activities count:', dayData.activities.length);
          }
          
          // 重新渲染当前天数的数据
          await loadDayAttractions();
          
          console.log('[Refresh] 数据刷新成功');
        }
      }
    }
    
    // 启动自动刷新
    function startAutoRefresh() {
      // 每10秒刷新一次
      autoRefreshInterval = setInterval(async () => {
        try {
          // 先检查项目状态是否变更
          await checkProjectStatus();
          // 再刷新数据
          await refreshData();
        } catch (error) {
          console.error('[AutoRefresh] Error:', error);
        }
      }, 10000); // 10秒
      
      console.log('[AutoRefresh] 自动刷新已启动，间隔：10秒');
    }
    
    // 停止自动刷新
    function stopAutoRefresh() {
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
        console.log('[AutoRefresh] 自动刷新已停止');
      }
    }
    
    // 检查项目状态是否变更为已归档
    async function checkProjectStatus() {
      try {
        const response = await fetch(`/api/travel-projects/${projectId}`);
        if (response.ok) {
          const project = await response.json();
          // 如果项目状态变为已归档，且当前用户不是刚才执行归档的人
          if (project.status === '已归档' && projectStatus !== '已归档') {
            console.log('[Status] 检测到项目已被归档');
            // 停止自动刷新
            stopAutoRefresh();
            // 弹窗通知用户
            alert('📢 项目已被创建者归档！\n\n系统将刷新页面获取最终版本...');
            // 刷新页面
            location.reload();
          }
        }
      } catch (error) {
        console.error('[Status] 检查项目状态失败:', error);
      }
    }
    
    // =========================
    // 交通卡片相关函数
    // =========================
    
    /**
     * 一键生成交通路线
     */
    async function generateTransport(fromActivityId, toActivityId, fromName, toName, fromLocation, toLocation, dayNumber) {
      try {
        const response = await fetch('/api/transport-cards/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            projectId: projectId,
            dayNumber: dayNumber,
            fromActivityId: fromActivityId,
            toActivityId: toActivityId,
            fromName: fromName,
            toName: toName,
            fromLocation: fromLocation,
            toLocation: toLocation
          })
        });
        
        if (!response.ok) {
          throw new Error('生成失败');
        }
        
        const card = await response.json();
        
        // 自动展开显示详情
        showTransportDetail(card);
        
        // 刷新页面
        await refreshData();
        
        return card;
      } catch (error) {
        console.error('生成交通路线失败:', error);
        alert('生成失败，请重试');
      }
    }
    
    /**
     * 显示交通详情弹窗
     */
    function showTransportDetail(card) {
      const modal = document.getElementById('transportDetailModal');
      const content = document.getElementById('transportDetailContent');
      
      // 解析steps
      let steps = [];
      try {
        steps = JSON.parse(card.stepsJson || '[]');
      } catch (e) {
        console.error('解析steps失败:', e);
      }
      
      // 解析备选方案
      let alternativePlans = [];
      try {
        alternativePlans = JSON.parse(card.alternativePlans || '[]');
      } catch (e) {
        console.error('解析备选方案失败:', e);
      }
      
      // 渲染步骤
      const stepsHtml = steps.map(step => {
        let icon, color;
        if (step.type === 'walk') {
          icon = 'mdi:walk';
          color = 'text-emerald-600';
        } else if (step.type === 'subway') {
          icon = 'mdi:subway-variant';
          color = 'text-blue-600';
        } else {
          icon = 'mdi:bus';
          color = 'text-green-600';
        }
        return `
          <div class="flex items-start gap-3 py-2 border-b border-gray-100 last:border-0">
            <iconify-icon icon="${icon}" class="${color}" width="20"></iconify-icon>
            <div class="flex-1">
              <p class="text-sm font-medium text-gray-800">${step.description}</p>
            </div>
          </div>
        `;
      }).join('');
      
      // 渲染备选方案切换按钮
      const plansHtml = alternativePlans.length > 1 ? `
        <div class="mt-4 p-3 bg-blue-50 rounded-lg">
          <p class="text-sm font-medium text-blue-800 mb-2">备选方案：</p>
          <div class="flex gap-2">
            ${alternativePlans.map((plan, index) => `
              <button onclick="switchTransportPlan(${card.id}, ${index})" 
                      class="px-3 py-1 text-sm rounded ${index === card.selectedPlanIndex ? 'bg-blue-600 text-white' : 'bg-white text-blue-600 border border-blue-300'} hover:bg-blue-700 hover:text-white transition-colors">
                方案${index + 1}
              </button>
            `).join('')}
          </div>
        </div>
      ` : '';
      
      content.innerHTML = `
        <div class="space-y-4">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="text-lg font-bold text-gray-800">${card.method || '交通方式'}</h3>
              <p class="text-sm text-gray-500">${card.fromName} → ${card.toName}</p>
            </div>
            <button onclick="closeTransportDetail()" class="text-gray-400 hover:text-gray-600">
              <iconify-icon icon="mdi:close" width="24"></iconify-icon>
            </button>
          </div>
          
          <div class="grid grid-cols-3 gap-3 p-3 bg-gray-50 rounded-lg">
            <div class="text-center">
              <iconify-icon icon="mdi:map-marker-distance" class="text-blue-600" width="20"></iconify-icon>
              <p class="text-xs text-gray-500 mt-1">距离</p>
              <p class="text-sm font-semibold">${card.distanceText || '-'}</p>
            </div>
            <div class="text-center">
              <iconify-icon icon="mdi:clock-outline" class="text-green-600" width="20"></iconify-icon>
              <p class="text-xs text-gray-500 mt-1">时长</p>
              <p class="text-sm font-semibold">${card.durationText || '-'}</p>
            </div>
            <div class="text-center">
              <iconify-icon icon="mdi:cash" class="text-orange-600" width="20"></iconify-icon>
              <p class="text-xs text-gray-500 mt-1">费用</p>
              <p class="text-sm font-semibold">${card.costText || '-'}</p>
            </div>
          </div>
          
          ${steps.length > 0 ? `
            <div>
              <h4 class="font-semibold text-gray-700 mb-2">详细路线：</h4>
              <div class="space-y-1">
                ${stepsHtml}
              </div>
            </div>
          ` : ''}
          
          ${plansHtml}
          
          <div class="flex gap-2 pt-3 border-t">
            <button onclick="openManualEditModal(${card.id})" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
              <iconify-icon icon="mdi:pencil" class="mr-1"></iconify-icon>手动编辑
            </button>
            <button onclick="regenerateTransport(${card.id})" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
              <iconify-icon icon="mdi:refresh" class="mr-1"></iconify-icon>重新生成
            </button>
          </div>
        </div>
      `;
      
      modal.classList.remove('hidden');
    }
    
    function closeTransportDetail() {
      document.getElementById('transportDetailModal').classList.add('hidden');
    }
    
    /**
     * 切换交通方案
     */
    async function switchTransportPlan(cardId, planIndex) {
      try {
        const response = await fetch(`/api/transport-cards/${cardId}/switch-plan`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ planIndex: planIndex })
        });
        
        if (!response.ok) {
          throw new Error('切换失败');
        }
        
        const card = await response.json();
        
        // 更新弹窗显示
        showTransportDetail(card);
        
        // 刷新页面
        await refreshData();
      } catch (error) {
        console.error('切换方案失败:', error);
        alert('切换失败，请重试');
      }
    }
    
    /**
     * 打开手动编辑弹窗
     */
    function openManualEditModal(cardId) {
      closeTransportDetail();
      const modal = document.getElementById('manualEditModal');
      const form = document.getElementById('manualEditForm');
      
      // 设置卡片ID
      form.dataset.cardId = cardId;
      
      // 清空表单
      document.getElementById('transportMethod').value = '';
      document.getElementById('customDuration').value = '';
      document.getElementById('customCost').value = '';
      
      modal.classList.remove('hidden');
    }
    
    function closeManualEditModal() {
      document.getElementById('manualEditModal').classList.add('hidden');
    }
    
    /**
     * 保存手动编辑
     */
    async function saveManualEdit() {
      const form = document.getElementById('manualEditForm');
      const cardId = form.dataset.cardId;
      const method = document.getElementById('transportMethod').value;
      const duration = parseInt(document.getElementById('customDuration').value) * 60; // 转为秒
      const cost = parseFloat(document.getElementById('customCost').value);
      
      if (!method) {
        alert('请选择交通方式');
        return;
      }
      
      try {
        const response = await fetch(`/api/transport-cards/${cardId}/manual-edit`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            method: method,
            duration: duration || null,
            cost: cost || null
          })
        });
        
        if (!response.ok) {
          throw new Error('保存失败');
        }
        
        closeManualEditModal();
        await refreshData();
        alert('保存成功');
      } catch (error) {
        console.error('保存失败:', error);
        alert('保存失败，请重试');
      }
    }
    
    /**
     * 重新生成交通路线
     */
    async function regenerateTransport(cardId) {
      // TODO: 实现重新生成逻辑
      alert('功能开发中...');
    }
    
    // ========== 任务分工功能 ==========
    let projectTasks = [];
    let lastTaskCount = 0; // 记录上次任务数量
    let myLastTaskIds = []; // 记录上次我的任务ID
    let taskPollInitialized = false; // 是否已初始化
    
    // 轮询新任务
    async function pollNewTasks() {
      if (!projectId || !currentUser) return;
      try {
        const response = await fetch(`/api/project-tasks/project/${projectId}`);
        if (response.ok) {
          const tasks = await response.json();
          // 检查是否有新分配给我的任务
          const myTasks = tasks.filter(t => t.assigneeId === currentUser.id);
          const myTaskIds = myTasks.map(t => t.id);
          const newTasksForMe = myTasks.filter(t => !myLastTaskIds.includes(t.id));
          
          if (newTasksForMe.length > 0 && taskPollInitialized) {
            // 有新任务分配给我
            const taskNames = newTasksForMe.map(t => t.taskName).join('、');
            showTaskNotification(taskNames);
          }
          
          myLastTaskIds = myTaskIds;
          taskPollInitialized = true;
          
          // 更新任务列表
          if (JSON.stringify(projectTasks) !== JSON.stringify(tasks)) {
            projectTasks = tasks;
            renderTaskList();
          }
        }
      } catch (error) {
        console.error('Error polling tasks:', error);
      }
    }
    
    // 显示任务通知
    function showTaskNotification(taskNames) {
      alert(`📝 新任务通知\n\n您有新的任务分配：\n${taskNames}`);
    }
    
    async function loadProjectTasks() {
      try {
        const response = await fetch(`/api/project-tasks/project/${projectId}`);
        if (response.ok) {
          projectTasks = await response.json();
          // 初始化我的任务ID列表
          myLastTaskIds = projectTasks.filter(t => t.assigneeId === currentUser.id).map(t => t.id);
          taskPollInitialized = true;
          renderTaskList();
        }
      } catch (error) {
        console.error('Error loading tasks:', error);
      }
    }
    
    function renderTaskList() {
      const container = document.getElementById('taskList');
      const addBtn = document.getElementById('addTaskBtn');
      
      // 只有创建者可以新建任务
      if (isCreator) {
        addBtn.classList.remove('hidden');
      }
      
      if (projectTasks.length === 0) {
        container.innerHTML = `
          <div class="text-center text-gray-400 text-sm py-4">
            <iconify-icon icon="mdi:clipboard-text-outline" width="32" class="mb-2"></iconify-icon>
            <p>暂无任务</p>
          </div>`;
        return;
      }
      
      container.innerHTML = projectTasks.map(task => {
        const assigneeName = task.assigneeInfo?.username || `用户${task.assigneeId}`;
        const isMyTask = task.assigneeId === currentUser.id;
        const imageCount = task.imageUrls ? task.imageUrls.split(',').length : 0;
        const statusIcon = task.status === 'COMPLETED' ? 'mdi:checkbox-marked-circle' : 'mdi:checkbox-blank-circle-outline';
        const statusColor = task.status === 'COMPLETED' ? 'text-green-500' : 'text-gray-400';
        
        return `
          <div class="p-3 border rounded-lg hover:bg-gray-50 transition cursor-pointer" onclick="openTaskDetail(${task.id})">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <iconify-icon icon="${statusIcon}" class="${statusColor}" width="20"></iconify-icon>
                <span class="font-medium text-sm ${task.status === 'COMPLETED' ? 'line-through text-gray-400' : ''}">${task.taskName}</span>
              </div>
              <div class="flex items-center gap-2">
                ${isMyTask ? '<span class="text-xs bg-purple-100 text-purple-600 px-2 py-0.5 rounded">我负责</span>' : ''}
                <span class="text-xs text-gray-500">👤 ${assigneeName}</span>
                ${imageCount > 0 ? `<span class="text-xs text-gray-400">📷 ${imageCount}</span>` : ''}
              </div>
            </div>
          </div>`;
      }).join('');
    }
    
    function openAddTaskModal() {
      // 归档后不允许添加任务
      if (projectStatus === '已归档') {
        alert('项目已归档，无法添加任务');
        return;
      }
      const select = document.getElementById('taskAssignee');
      select.innerHTML = '<option value="">选择成员</option>' + 
        projectParticipants.map(p => {
          const name = p.userInfo?.username || `用户${p.userId}`;
          return `<option value="${p.userId}">${name}</option>`;
        }).join('');
      document.getElementById('newTaskName').value = '';
      document.getElementById('addTaskModal').classList.remove('hidden');
    }
    
    function closeAddTaskModal() {
      document.getElementById('addTaskModal').classList.add('hidden');
    }
    
    async function createTask() {
      const taskName = document.getElementById('newTaskName').value.trim();
      const assigneeId = document.getElementById('taskAssignee').value;
      if (!taskName) { alert('请输入任务名称'); return; }
      if (!assigneeId) { alert('请选择负责人'); return; }
      
      try {
        const response = await fetch('/api/project-tasks', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            projectId: projectId,
            taskName: taskName,
            assigneeId: parseInt(assigneeId),
            createdBy: currentUser.id
          })
        });
        if (response.ok) {
          closeAddTaskModal();
          await loadProjectTasks();
        }
      } catch (error) {
        console.error('Error creating task:', error);
        alert('创建任务失败');
      }
    }
    
    function openEditTaskModal(taskId) {
      // 归档后不允许编辑任务
      if (projectStatus === '已归档') {
        alert('项目已归档，无法编辑任务');
        return;
      }
      const task = projectTasks.find(t => t.id === taskId);
      if (!task) return;
      document.getElementById('editTaskId').value = taskId;
      document.getElementById('editTaskName').value = task.taskName;
      document.getElementById('editTaskModal').classList.remove('hidden');
    }
    
    function closeEditTaskModal() {
      document.getElementById('editTaskModal').classList.add('hidden');
    }
    
    async function saveTaskEdit() {
      const taskId = document.getElementById('editTaskId').value;
      const taskName = document.getElementById('editTaskName').value.trim();
      if (!taskName) { alert('请输入任务名称'); return; }
      
      try {
        const response = await fetch(`/api/project-tasks/${taskId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ taskName: taskName })
        });
        if (response.ok) {
          closeEditTaskModal();
          await loadProjectTasks();
        }
      } catch (error) {
        console.error('Error updating task:', error);
        alert('保存失败');
      }
    }
    
    async function deleteTask(taskId) {
      if (!confirm('确定删除这个任务吗？')) return;
      try {
        await fetch(`/api/project-tasks/${taskId}`, { method: 'DELETE' });
        closeTaskDetailModal();
        await loadProjectTasks();
      } catch (error) {
        console.error('Error deleting task:', error);
      }
    }
    
    async function openTaskDetail(taskId) {
      const task = projectTasks.find(t => t.id === taskId);
      if (!task) return;
      
      document.getElementById('detailTaskId').value = taskId;
      document.getElementById('taskDetailTitle').textContent = task.taskName;
      
      const isMyTask = task.assigneeId === currentUser.id;
      const images = task.imageUrls ? task.imageUrls.split(',') : [];
      const assigneeName = task.assigneeInfo?.username || `用户${task.assigneeId}`;
      
      let html = `
        <div class="mb-4">
          <div class="flex items-center justify-between">
            <div>
              <span class="text-sm text-gray-500">负责人：</span>
              <span class="font-medium">${assigneeName}</span>
            </div>
            <div class="flex gap-2">`;
      
      if (isCreator) {
        html += `<button onclick="event.stopPropagation(); openEditTaskModal(${taskId})" class="text-blue-500 text-sm">编辑</button>`;
        html += `<button onclick="event.stopPropagation(); deleteTask(${taskId})" class="text-red-500 text-sm">删除</button>`;
      }
      
      html += `</div></div></div>`;
      
      // 图片展示
      html += `<div class="mb-4"><h4 class="text-sm font-medium text-gray-700 mb-2">完成截图</h4>`;
      if (images.length > 0) {
        html += `<div class="grid grid-cols-3 gap-2">`;
        images.forEach((url, idx) => {
          html += `
            <div class="relative group">
              <img src="${url}" class="w-full h-24 object-cover rounded cursor-pointer" onclick="event.stopPropagation(); previewImage('${url}')" />
              ${isMyTask ? `<button onclick="event.stopPropagation(); deleteTaskImage(${taskId}, ${idx})" class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 text-xs opacity-0 group-hover:opacity-100">×</button>` : ''}
            </div>`;
        });
        html += `</div>`;
      } else {
        html += `<p class="text-gray-400 text-sm">暂无图片</p>`;
      }
      html += `</div>`;
      
      // 被指派者可以上传图片和标记完成
      if (isMyTask) {
        html += `
          <div class="border-t pt-4 mt-4">
            <div class="flex gap-2">
              <label class="flex-1 flex items-center justify-center gap-2 px-4 py-2 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-purple-500 hover:bg-purple-50">
                <iconify-icon icon="mdi:camera-plus" width="20" class="text-gray-400"></iconify-icon>
                <span class="text-sm text-gray-500">上传图片</span>
                <input type="file" accept="image/*" class="hidden" onchange="uploadTaskImage(${taskId}, this)" />
              </label>
              <button onclick="toggleTaskStatus(${taskId})" class="px-4 py-2 ${task.status === 'COMPLETED' ? 'bg-gray-500' : 'bg-green-500'} text-white rounded-lg">
                ${task.status === 'COMPLETED' ? '标记未完成' : '标记完成'}
              </button>
            </div>
          </div>`;
      }
      
      document.getElementById('taskDetailContent').innerHTML = html;
      document.getElementById('taskDetailModal').classList.remove('hidden');
    }
    
    function closeTaskDetailModal() {
      document.getElementById('taskDetailModal').classList.add('hidden');
    }
    
    async function uploadTaskImage(taskId, input) {
      // 归档后不允许上传图片
      if (projectStatus === '已归档') {
        alert('项目已归档，无法上传图片');
        input.value = ''; // 清空文件选择
        return;
      }
      const file = input.files[0];
      if (!file) return;
      
      const formData = new FormData();
      formData.append('file', file);
      
      try {
        const response = await fetch(`/api/project-tasks/${taskId}/images`, {
          method: 'POST',
          body: formData
        });
        if (response.ok) {
          await loadProjectTasks();
          openTaskDetail(taskId);
        }
      } catch (error) {
        console.error('Error uploading image:', error);
        alert('上传失败');
      }
    }
    
    async function deleteTaskImage(taskId, index) {
      if (!confirm('删除这张图片？')) return;
      try {
        await fetch(`/api/project-tasks/${taskId}/images/${index}`, { method: 'DELETE' });
        await loadProjectTasks();
        openTaskDetail(taskId);
      } catch (error) {
        console.error('Error deleting image:', error);
      }
    }
    
    async function toggleTaskStatus(taskId) {
      // 归档后不允许更改任务状态
      if (projectStatus === '已归档') {
        alert('项目已归档，无法更改任务状态');
        return;
      }
      const task = projectTasks.find(t => t.id === taskId);
      const newStatus = task.status === 'COMPLETED' ? 'PENDING' : 'COMPLETED';
      try {
        await fetch(`/api/project-tasks/${taskId}/status`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: newStatus })
        });
        await loadProjectTasks();
        openTaskDetail(taskId);
      } catch (error) {
        console.error('Error updating status:', error);
      }
    }
    
    function previewImage(url) {
      document.getElementById('previewImage').src = url;
      document.getElementById('imagePreviewModal').classList.remove('hidden');
    }
    
    function closeImagePreview() {
      document.getElementById('imagePreviewModal').classList.add('hidden');
    }
    
    // 生成最后景点到酒店的交通路线
    async function generateToHotelTransport(dayIndex) {
      const dayHotel = projectHotels.find(h => h.dayIndex === dayIndex);
      if (!dayHotel) {
        alert('未找到当天酒店信息');
        return;
      }
      
      // 获取当天最后一个景点
      const itineraryData = JSON.parse(currentRouteData.dailyItinerary);
      const dayData = itineraryData[dayIndex - 1];
      if (!dayData || !dayData.activities || dayData.activities.length === 0) {
        alert('当天没有景点');
        return;
      }
      
      const lastActivity = dayData.activities[dayData.activities.length - 1];
      if (!lastActivity.location) {
        alert('景点缺少位置信息');
        return;
      }
      
      const hotelLocation = `${dayHotel.longitude},${dayHotel.latitude}`;
      
      try {
        const response = await fetch('/api/transport-cards/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            projectId: projectId,
            dayNumber: dayIndex,
            fromActivityId: 'hotel_from_' + dayIndex,
            toActivityId: 'hotel_to_' + dayIndex,
            fromName: lastActivity.name,
            toName: dayHotel.hotelName + '(酒店)',
            fromLocation: lastActivity.location,
            toLocation: hotelLocation
          })
        });
        
        if (response.ok) {
          alert('✅ 交通路线已生成');
          await refreshData();
        } else {
          const errorText = await response.text();
          console.error('[Hotel] API返回错误:', errorText);
          alert('生成失败: ' + errorText);
        }
      } catch (error) {
        console.error('[Hotel] 生成交通失败:', error);
        alert('生成失败: ' + error.message);
      }
    }
    
    // ========== 酒店功能 ==========
    
    // 加载项目酒店数据
    async function loadProjectHotels() {
      try {
        const response = await fetch(`/api/project-hotels/project/${projectId}`);
        if (response.ok) {
          projectHotels = await response.json();
          renderHotelList();
          
          // 加载完酒店后同步生成交通卡片（等待完成）
          if (projectHotels.length > 0 && currentRouteData) {
            console.log('[Hotel] 开始生成交通卡片...');
            await generateHotelTransportCards();
            console.log('[Hotel] 交通卡片生成完成');
          }
          
          // 统一刷新当前天数的显示（无论有没有酒店）
          const selectedDay = parseInt(document.getElementById('daySelector')?.value);
          if (selectedDay) {
            console.log('[Hotel] 统一刷新界面...');
            await loadDayAttractions();
          }
        }
      } catch (error) {
        console.error('Error loading hotels:', error);
      }
    }
    
    // 渲染酒店列表
    function renderHotelList() {
      const container = document.getElementById('hotelList');
      const setBtn = document.getElementById('setHotelBtn');
      
      // 只有创建者和编辑者可以设置酒店
      if (canEdit && projectStatus !== '已归档') {
        setBtn.classList.remove('hidden');
      }
      
      if (projectHotels.length === 0) {
        container.innerHTML = `
          <div class="text-center text-gray-400 text-sm py-4">
            <iconify-icon icon="mdi:hotel" width="32" class="mb-2"></iconify-icon>
            <p>暂未设置酒店</p>
          </div>`;
        return;
      }
      
      container.innerHTML = projectHotels.map(hotel => {
        return `
          <div class="p-3 border rounded-lg hover:bg-gray-50 transition">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <iconify-icon icon="mdi:bed" class="text-purple-500" width="18"></iconify-icon>
                <span class="font-medium text-sm">第${hotel.dayIndex}天</span>
              </div>
              ${canEdit && projectStatus !== '已归档' ? `
                <div class="flex gap-2">
                  <button onclick="openSetHotelModal(${hotel.dayIndex})" class="text-blue-500 text-xs hover:underline">修改</button>
                  <button onclick="deleteHotelFromList(${hotel.dayIndex}, ${hotel.id})" class="text-red-500 text-xs hover:underline">删除</button>
                </div>
              ` : ''}
            </div>
            <div class="mt-2 text-sm">
              <div class="font-medium text-gray-800">${hotel.hotelName}</div>
              <div class="text-gray-500 text-xs mt-1">${hotel.hotelAddress || ''}</div>
              <div class="text-purple-600 font-medium mt-1">¥${hotel.pricePerNight}/晚</div>
            </div>
          </div>
        `;
      }).join('');
    }
    
    // 打开设置酒店弹窗
    function openSetHotelModal(dayIndex) {
      // 归档后不允许设置
      if (projectStatus === '已归档') {
        alert('项目已归档，无法修改酒店');
        return;
      }
      
      document.getElementById('hotelDayIndex').value = dayIndex;
      document.getElementById('hotelDayDisplay').textContent = `第 ${dayIndex} 天`;
      document.getElementById('hotelNameInput').value = '';
      document.getElementById('hotelPrice').value = '';
      document.getElementById('hotelLongitude').value = '';
      document.getElementById('hotelLatitude').value = '';
      document.getElementById('hotelAddress').value = '';
      document.getElementById('editHotelId').value = '';
      document.getElementById('selectedHotelInfo').classList.add('hidden');
      document.getElementById('hotelSuggestions').classList.add('hidden');
      
      // 如果已有该天的酒店，填充信息
      const existingHotel = projectHotels.find(h => h.dayIndex === dayIndex);
      if (existingHotel) {
        document.getElementById('hotelNameInput').value = existingHotel.hotelName;
        document.getElementById('hotelPrice').value = existingHotel.pricePerNight;
        document.getElementById('hotelLongitude').value = existingHotel.longitude;
        document.getElementById('hotelLatitude').value = existingHotel.latitude;
        document.getElementById('hotelAddress').value = existingHotel.hotelAddress || '';
        document.getElementById('editHotelId').value = existingHotel.id;
        
        document.getElementById('selectedHotelName').textContent = existingHotel.hotelName;
        document.getElementById('selectedHotelAddress').textContent = existingHotel.hotelAddress || '';
        document.getElementById('selectedHotelInfo').classList.remove('hidden');
      }
      
      document.getElementById('setHotelModal').classList.remove('hidden');
    }
    
    // 关闭设置酒店弹窗
    function closeSetHotelModal() {
      document.getElementById('setHotelModal').classList.add('hidden');
      document.getElementById('hotelSuggestions').classList.add('hidden');
    }
    
    // 搜索酒店（调用高德POI）
    function searchHotels(keyword) {
      if (hotelSearchTimeout) {
        clearTimeout(hotelSearchTimeout);
      }
      
      if (!keyword || keyword.length < 2) {
        document.getElementById('hotelSuggestions').classList.add('hidden');
        return;
      }
      
      hotelSearchTimeout = setTimeout(async () => {
        try {
          // 优先使用destinationCity，如果为空则使用项目目的地
          let searchCity = destinationCity;
          if (!searchCity && currentProjectInfo) {
            searchCity = currentProjectInfo.destination || '';
          }
          // 简化城市名称：提取“XX市”或去掉省份前缀
          if (searchCity.includes('省')) {
            const match = searchCity.match(/([^省]+市)/);
            if (match) searchCity = match[1];
          }
          console.log('[searchHotels] Using city:', searchCity, 'keyword:', keyword);
          
          // 调用高德POI搜索，限制在目的城市，指定types为100000（住宿服务）
          const response = await fetch(`/api/amap-test/poi-search?keyword=${encodeURIComponent(keyword)}&city=${encodeURIComponent(searchCity)}&types=100000`);
          console.log('[searchHotels] Response status:', response.status);
          if (response.ok) {
            const data = await response.json();
            console.log('[searchHotels] API response:', data);
            if (data.pois && data.pois.length > 0) {
              console.log('[searchHotels] Found', data.pois.length, 'hotels');
              renderHotelSuggestions(data.pois);
            } else {
              console.log('[searchHotels] No hotels found');
              document.getElementById('hotelSuggestions').innerHTML = '<div class="p-3 text-gray-500 text-sm">未找到酒店，请尝试其他关键词</div>';
              document.getElementById('hotelSuggestions').classList.remove('hidden');
            }
          } else {
            console.error('[searchHotels] API failed with status:', response.status);
          }
        } catch (error) {
          console.error('Error searching hotels:', error);
        }
      }, 300);
    }
    
    // 渲染酒店搜索建议
    function renderHotelSuggestions(pois) {
      const container = document.getElementById('hotelSuggestions');
      // 渲染酒店搜索建议（已通过API参数types限制，无需前端过滤）
      const hotelPois = pois;
      
      console.log('[renderHotelSuggestions] Filtered', hotelPois.length, 'hotels from', pois.length, 'total POIs');
      
      if (hotelPois.length === 0) {
        container.innerHTML = '<div class="p-3 text-gray-500 text-sm">未找到酒店，请尝试其他关键词</div>';
      } else {
        container.innerHTML = hotelPois.slice(0, 10).map(poi => {
          const location = poi.location ? poi.location.split(',') : ['', ''];
          return `
            <div class="p-3 hover:bg-purple-50 cursor-pointer border-b last:border-b-0" 
                 onclick="selectHotel('${poi.name.replace(/'/g, "\\'").replace(/"/g, '&quot;')}', '${poi.address || ''}', '${location[0]}', '${location[1]}')">
              <div class="font-medium text-sm">${poi.name}</div>
              <div class="text-xs text-gray-500 mt-1">${poi.address || poi.pname + poi.cityname + poi.adname}</div>
            </div>
          `;
        }).join('');
      }
      container.classList.remove('hidden');
    }
    
    // 选择酒店
    function selectHotel(name, address, lng, lat) {
      document.getElementById('hotelNameInput').value = name;
      document.getElementById('hotelAddress').value = address;
      document.getElementById('hotelLongitude').value = lng;
      document.getElementById('hotelLatitude').value = lat;
      
      document.getElementById('selectedHotelName').textContent = name;
      document.getElementById('selectedHotelAddress').textContent = address;
      document.getElementById('selectedHotelInfo').classList.remove('hidden');
      
      document.getElementById('hotelSuggestions').classList.add('hidden');
    }
    
    // 保存酒店
    async function saveHotel() {
      const dayIndex = parseInt(document.getElementById('hotelDayIndex').value);
      const hotelName = document.getElementById('hotelNameInput').value.trim();
      const hotelAddress = document.getElementById('hotelAddress').value;
      const longitude = document.getElementById('hotelLongitude').value;
      const latitude = document.getElementById('hotelLatitude').value;
      const pricePerNight = document.getElementById('hotelPrice').value;
      
      if (!hotelName) {
        alert('请搜索并选择酒店');
        return;
      }
      
      if (!longitude || !latitude) {
        alert('请从搜索结果中选择酒店，以便获取坐标信息');
        return;
      }
      
      if (!pricePerNight || pricePerNight <= 0) {
        alert('请输入每晚价格');
        return;
      }
      
      try {
        const response = await fetch('/api/project-hotels', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            projectId: projectId,
            dayIndex: dayIndex,
            hotelName: hotelName,
            hotelAddress: hotelAddress,
            longitude: parseFloat(longitude),
            latitude: parseFloat(latitude),
            pricePerNight: parseFloat(pricePerNight)
          })
        });
        
        if (response.ok) {
          const result = await response.json();
          closeSetHotelModal();
          await loadProjectHotels();
          
          // 如果是第一天且之前没有酒店，提示用户已自动复制到后续天
          if (dayIndex === 1 && projectHotels.length > 1) {
            alert('✅ 第一天酒店已设置，并已自动复制到后续所有天\n\n您可以单独修改每天的酒店');
          } else {
            alert('✅ 酒店设置成功');
          }
          
          // 先立即渲染酒店卡片（无需等待交通信息）
          renderDayOverview();
          
          // 后台异步生成交通卡片（不阻塞用户操作）
          generateHotelTransportCards().then(() => {
            console.log('[Hotel] 交通卡片生成完成，刷新显示');
            renderDayOverview();
          });
        } else {
          const error = await response.json();
          alert('设置失败: ' + (error.message || '请重试'));
        }
      } catch (error) {
        console.error('Error saving hotel:', error);
        alert('保存失败，请重试');
      }
    }
    
    // 保存路线变更到服务器
    async function saveRouteChanges() {
      if (!currentRouteData || !currentRouteData.id) {
        console.error('[saveRouteChanges] 无路线数据');
        return false;
      }
      
      try {
        const response = await fetch(`/api/ai-generated-routes/${currentRouteData.id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(currentRouteData)
        });
        
        if (response.ok) {
          console.log('[saveRouteChanges] 路线保存成功');
          return true;
        } else {
          console.error('[saveRouteChanges] 保存失败:', response.status);
          return false;
        }
      } catch (error) {
        console.error('[saveRouteChanges] 保存异常:', error);
        return false;
      }
    }
    
    // 从酒店列表删除
    async function deleteHotelFromList(dayIndex, hotelId) {
      if (!confirm('确定要删除这个酒店吗？')) return;
      
      try {
        const response = await fetch(`/api/project-hotels/${hotelId}`, {
          method: 'DELETE'
        });
        
        if (response.ok) {
          // 从本地数据中删除
          const idx = projectHotels.findIndex(h => h.id === hotelId);
          if (idx !== -1) {
            projectHotels.splice(idx, 1);
          }
          
          // 删除相关的交通卡片
          const dailyItinerary = JSON.parse(currentRouteData.dailyItinerary);
          const dayData = dailyItinerary[dayIndex - 1];
          if (dayData && dayData.transports) {
            dayData.transports = dayData.transports.filter(t => 
              !(t.toName && t.toName.includes('(酒店)'))
            );
          }
          
          // 删除第二天从酒店出发的交通
          if (dayIndex < dailyItinerary.length) {
            const nextDayData = dailyItinerary[dayIndex];
            if (nextDayData && nextDayData.transports) {
              nextDayData.transports = nextDayData.transports.filter(t => !t.isFromPrevHotel);
            }
          }
          
          currentRouteData.dailyItinerary = JSON.stringify(dailyItinerary);
          await saveRouteChanges();
          
          // 刷新显示
          renderHotelList();
          if (selectedDay === dayIndex) {
            renderDayOverview(dayData ? dayData.activities : [], dayIndex);
          }
          
          alert('酒店已删除');
        } else {
          alert('删除失败');
        }
      } catch (error) {
        console.error('[deleteHotelFromList] 删除失败:', error);
        alert('删除异常');
      }
    }
    
    // 显示酒店详情
    function showHotelInfo(dayIndex, hotelId) {
      const hotel = projectHotels.find(h => h.id === hotelId);
      if (!hotel) return;
      
      const canDelete = currentUserRole !== 'viewer';
      
      const html = `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="this.remove()">
          <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-xl font-bold text-gray-800">酒店信息</h3>
              <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                <iconify-icon icon="mdi:close" width="24"></iconify-icon>
              </button>
            </div>
            <div class="space-y-3">
              <div>
                <div class="text-sm text-gray-500">酒店名称</div>
                <div class="text-base font-medium">${hotel.hotelName}</div>
              </div>
              <div>
                <div class="text-sm text-gray-500">地址</div>
                <div class="text-base">${hotel.hotelAddress || '无'}</div>
              </div>
              <div>
                <div class="text-sm text-gray-500">价格</div>
                <div class="text-lg font-bold text-purple-600">¥${hotel.pricePerNight}/晚</div>
              </div>
              <div>
                <div class="text-sm text-gray-500">入住日期</div>
                <div class="text-base">第${dayIndex}天</div>
              </div>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', html);
    }
    
    // 从madal中删除酒店
    async function deleteHotelFromModal(dayIndex, hotelId) {
      if (!confirm('确定要删除这个酒店吗？')) return;
      
      try {
        const response = await fetch(`/api/project-hotels/${hotelId}`, {
          method: 'DELETE'
        });
        
        if (response.ok) {
          // 从本地数据中删除
          const idx = projectHotels.findIndex(h => h.id === hotelId);
          if (idx !== -1) {
            projectHotels.splice(idx, 1);
          }
          
          // 删除相关的交通卡片
          const dailyItinerary = JSON.parse(currentRouteData.dailyItinerary);
          const dayData = dailyItinerary[dayIndex - 1];
          if (dayData && dayData.transports) {
            // 删除到酒店的交通
            dayData.transports = dayData.transports.filter(t => 
              !(t.toName && t.toName.includes('(酒店)'))
            );
          }
          
          // 删除第二天从酒店出发的交通
          if (dayIndex < dailyItinerary.length) {
            const nextDayData = dailyItinerary[dayIndex];
            if (nextDayData && nextDayData.transports) {
              nextDayData.transports = nextDayData.transports.filter(t => !t.isFromPrevHotel);
            }
          }
          
          currentRouteData.dailyItinerary = JSON.stringify(dailyItinerary);
          await saveRouteChanges();
          
          // 刷新显示
          renderDayOverview(dayData ? dayData.activities : [], dayIndex);
          
          // 关闭模态框
          document.querySelector('.fixed.inset-0')?.remove();
          
          alert('酒店已删除');
        } else {
          alert('删除失败');
        }
      } catch (error) {
        console.error('[deleteHotel] 删除失败:', error);
        alert('删除异常');
      }
    }
    
    // 生成酒店相关的交通卡片（并行请求优化）
    async function generateHotelTransportCards() {
      if (projectHotels.length === 0) {
        console.log('[Hotel] 无酒店数据，跳过交通卡片生成');
        return;
      }
      
      if (!currentRouteData || !currentRouteData.dailyItinerary) {
        console.log('[Hotel] 无行程数据，跳过交通卡片生成');
        return;
      }
      
      let itineraryData;
      try {
        itineraryData = JSON.parse(currentRouteData.dailyItinerary);
      } catch (e) {
        console.error('[Hotel] 解析行程数据失败:', e);
        return;
      }
      
      if (!itineraryData || itineraryData.length === 0) {
        console.log('[Hotel] 行程数据为空，跳过交通卡片生成');
        return;
      }
      
      console.log('[Hotel] 开始并行生成酒店交通卡片...');
      
      const totalDays = itineraryData.length;
      const transportPromises = [];
      const dayInfos = []; // 保存每个请求对应的天数信息
      
      // 收集所有需要生成交通的天数
      for (let day = 1; day <= totalDays; day++) {
        const dayHotel = projectHotels.find(h => h.dayIndex === day);
        console.log(`[Hotel] Day${day}: 查找酒店, dayHotel=`, dayHotel);
        if (!dayHotel) {
          console.log(`[Hotel] Day${day}: 无酒店数据，跳过`);
          continue;
        }
        
        const dayData = itineraryData[day - 1];
        if (!dayData || !dayData.activities || dayData.activities.length === 0) {
          console.log(`[Hotel] Day${day}: 无景点数据，跳过`);
          continue;
        }
        
        if (!dayData.transports) {
          dayData.transports = [];
        }
        
        const activities = dayData.activities;
        const hotelLocation = `${dayHotel.longitude},${dayHotel.latitude}`;
        
        const lastActivity = activities[activities.length - 1];
        const lastActivityName = lastActivity.name || lastActivity.attraction || '景点';
        const lastActivityLocation = lastActivity.poiInfo?.location || lastActivity.location;
        
        console.log(`[Hotel] Day${day}: 最后景点=${lastActivityName}, location=${lastActivityLocation}`);
        
        if (lastActivityLocation) {
          // 先删除旧的酒店交通
          const existingIdx = dayData.transports.findIndex(t => t.toName && t.toName.includes('(酒店)'));
          if (existingIdx !== -1) {
            dayData.transports.splice(existingIdx, 1);
          }
          
          // 创建并行请求
          const hotelName = dayHotel.hotelName || '酒店';
          const promise = fetch('/api/amap-test/direction?origin=' + 
            encodeURIComponent(lastActivityLocation) + '&destination=' + encodeURIComponent(hotelLocation) +
            '&destName=' + encodeURIComponent(hotelName))
            .then(res => res.ok ? res.json() : null)
            .catch(e => {
              console.error(`[Hotel] Day${day} 请求失败:`, e);
              return null;
            });
          
          transportPromises.push(promise);
          dayInfos.push({
            day,
            dayData,
            activities,
            lastActivityName,
            lastActivityLocation,
            hotelLocation,
            hotelName: dayHotel.hotelName
          });
        }
      }
      
      // 并行执行所有请求
      const results = await Promise.all(transportPromises);
      let hasChanges = false;
      
      // 处理结果：最后景点 → 当天酒店
      results.forEach((transportData, idx) => {
        if (!transportData) return;
        
        const info = dayInfos[idx];
        console.log(`[Hotel] Day${info.day}: ${info.lastActivityName} → ${info.hotelName}`);
        
        info.dayData.transports.push({
          fromIndex: info.activities.length - 1,
          toIndex: -2,
          fromName: info.lastActivityName,
          toName: info.hotelName + '(酒店)',
          fromLocation: info.lastActivityLocation,
          toLocation: info.hotelLocation,
          method: transportData.method || '公交/地铁',
          distance: transportData.distance,
          distanceText: transportData.distanceText,
          duration: transportData.duration,
          durationText: transportData.durationText,
          cost: transportData.cost,
          costText: transportData.costText,
          steps: transportData.steps,
          details: transportData.details,
          distanceTooFar: transportData.distanceTooFar,
          warning: transportData.warning,
          isHotelTransport: true
        });
        hasChanges = true;
      });
      
      // 生成第2天及以后：前一天酒店 → 第一个景点
      for (let day = 2; day <= totalDays; day++) {
        const prevDayHotel = projectHotels.find(h => h.dayIndex === day - 1);
        if (!prevDayHotel) continue;
        
        const dayData = itineraryData[day - 1];
        if (!dayData || !dayData.activities || dayData.activities.length === 0) continue;
        
        if (!dayData.transports) {
          dayData.transports = [];
        }
        
        const firstActivity = dayData.activities[0];
        const firstActivityName = firstActivity.name || firstActivity.attraction || '景点';
        const firstActivityLocation = firstActivity.poiInfo?.location || firstActivity.location;
        
        if (firstActivityLocation) {
          // 删除旧的出发地交通
          const existingDepIdx = dayData.transports.findIndex(t => t.fromIndex === -1 || t.isDeparture);
          if (existingDepIdx !== -1) {
            dayData.transports.splice(existingDepIdx, 1);
          }
          
          const hotelLocation = `${prevDayHotel.longitude},${prevDayHotel.latitude}`;
          
          try {
            const response = await fetch('/api/amap-test/direction?origin=' + 
              encodeURIComponent(hotelLocation) + '&destination=' + encodeURIComponent(firstActivityLocation) +
              '&destName=' + encodeURIComponent(firstActivityName));
            
            if (response.ok) {
              const transportData = await response.json();
              if (transportData) {
                dayData.transports.unshift({
                  ...transportData,
                  fromIndex: -1,
                  toIndex: 0,
                  fromName: prevDayHotel.hotelName + '(酒店)',
                  toName: firstActivityName,
                  fromLocation: hotelLocation,
                  toLocation: firstActivityLocation,
                  isDeparture: true,
                  isFromPrevHotel: true
                });
                console.log(`[Hotel] Day${day}: ${prevDayHotel.hotelName}(酒店) → ${firstActivityName}`);
                hasChanges = true;
              }
            }
          } catch (e) {
            console.error(`[Hotel] Day${day} 从前一天酒店出发交通生成失败:`, e);
          }
        }
      }
      
      // 保存更新
      if (hasChanges) {
        currentRouteData.dailyItinerary = JSON.stringify(itineraryData);
        await saveRouteChanges();
      }
      
      console.log('[Hotel] 酒店交通卡片生成完成');
    }
    
    init();
  </script>
  
  <!-- 交通详情弹窗 -->
  <div id="transportDetailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="if(event.target === this) closeTransportDetail()">
    <div class="bg-white rounded-lg p-6 max-w-lg w-full mx-4 max-h-[80vh] overflow-y-auto">
      <div id="transportDetailContent">
        <!-- 动态内容 -->
      </div>
    </div>
  </div>
  
  <!-- 设置酒店弹窗 -->
  <div id="setHotelModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="if(event.target === this) closeSetHotelModal()">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4">
      <div class="bg-gradient-to-r from-purple-500 to-indigo-500 px-6 py-4 flex justify-between items-center">
        <h3 class="text-white font-bold text-lg">设置酒店</h3>
        <button onclick="closeSetHotelModal()" class="text-white hover:text-gray-200">
          <iconify-icon icon="mdi:close" width="24"></iconify-icon>
        </button>
      </div>
      <div class="p-6">
        <input type="hidden" id="hotelDayIndex" value="1" />
        <input type="hidden" id="hotelLongitude" value="" />
        <input type="hidden" id="hotelLatitude" value="" />
        <input type="hidden" id="hotelAddress" value="" />
        <input type="hidden" id="editHotelId" value="" />
        
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">设置第几天的酒店</label>
          <div id="hotelDayDisplay" class="text-purple-600 font-bold">第 1 天</div>
        </div>
        
        <div class="mb-4 relative">
          <label class="block text-sm font-medium text-gray-700 mb-1">酒店名称</label>
          <input type="text" id="hotelNameInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="搜索酒店名称..." oninput="searchHotels(this.value)" />
          <div id="hotelSuggestions" class="hidden absolute z-10 w-full bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto mt-1"></div>
        </div>
        
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">每晚价格 (元)</label>
          <input type="number" id="hotelPrice" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="例如：300" min="0" step="1" />
        </div>
        
        <div id="selectedHotelInfo" class="hidden mb-4 p-3 bg-purple-50 rounded-lg">
          <div class="flex items-center gap-2 text-purple-700">
            <iconify-icon icon="mdi:check-circle" width="20"></iconify-icon>
            <span id="selectedHotelName" class="font-medium"></span>
          </div>
          <div id="selectedHotelAddress" class="text-sm text-gray-500 mt-1"></div>
        </div>
        
        <div class="flex gap-3">
          <button onclick="closeSetHotelModal()" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">取消</button>
          <button onclick="saveHotel()" class="flex-1 px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600">确定</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- 新建任务弹窗 -->
  <div id="addTaskModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="if(event.target === this) closeAddTaskModal()">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4">
      <div class="bg-gradient-to-r from-purple-500 to-indigo-500 px-6 py-4 flex justify-between items-center">
        <h3 class="text-white font-bold text-lg">新建任务</h3>
        <button onclick="closeAddTaskModal()" class="text-white hover:text-gray-200">
          <iconify-icon icon="mdi:close" width="24"></iconify-icon>
        </button>
      </div>
      <div class="p-6">
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">任务名称</label>
          <input type="text" id="newTaskName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="例如：订酒店、买火车票" />
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">指派给</label>
          <select id="taskAssignee" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
            <option value="">选择成员</option>
          </select>
        </div>
        <div class="flex gap-2">
          <button onclick="closeAddTaskModal()" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">取消</button>
          <button onclick="createTask()" class="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">创建</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- 编辑任务弹窗 -->
  <div id="editTaskModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[70]" onclick="if(event.target === this) closeEditTaskModal()">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4">
      <div class="bg-gradient-to-r from-purple-500 to-indigo-500 px-6 py-4 flex justify-between items-center">
        <h3 class="text-white font-bold text-lg">编辑任务</h3>
        <button onclick="closeEditTaskModal()" class="text-white hover:text-gray-200">
          <iconify-icon icon="mdi:close" width="24"></iconify-icon>
        </button>
      </div>
      <div class="p-6">
        <input type="hidden" id="editTaskId" />
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">任务名称</label>
          <input type="text" id="editTaskName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" />
        </div>
        <div class="flex gap-2">
          <button onclick="closeEditTaskModal()" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">取消</button>
          <button onclick="saveTaskEdit()" class="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">保存</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- 任务详情/图片弹窗 -->
  <div id="taskDetailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60]" onclick="if(event.target === this) closeTaskDetailModal()">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl mx-4 max-h-[80vh] overflow-y-auto">
      <div class="bg-gradient-to-r from-purple-500 to-indigo-500 px-6 py-4 flex justify-between items-center sticky top-0">
        <h3 class="text-white font-bold text-lg" id="taskDetailTitle">任务详情</h3>
        <button onclick="closeTaskDetailModal()" class="text-white hover:text-gray-200">
          <iconify-icon icon="mdi:close" width="24"></iconify-icon>
        </button>
      </div>
      <div class="p-6">
        <input type="hidden" id="detailTaskId" />
        <div id="taskDetailContent"></div>
      </div>
    </div>
  </div>
  
  <!-- 图片大图预览弹窗 -->
  <div id="imagePreviewModal" class="hidden fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-[60]" onclick="closeImagePreview()">
    <img id="previewImage" src="" class="max-w-[90vw] max-h-[90vh] object-contain" />
  </div>
  
  <!-- 新建任务弹窗 -->
  <div id="addTaskModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="if(event.target === this) closeAddTaskModal()">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4">
      <div class="bg-gradient-to-r from-purple-500 to-indigo-500 px-6 py-4 flex justify-between items-center">
        <h3 class="text-white font-bold text-lg">新建任务</h3>
        <button onclick="closeAddTaskModal()" class="text-white hover:text-gray-200"><iconify-icon icon="mdi:close" width="24"></iconify-icon></button>
      </div>
      <div class="p-6">
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">任务名称</label>
          <input type="text" id="newTaskName" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="例如：订酒店、买火车票" />
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">指派给</label>
          <select id="taskAssignee" class="w-full px-3 py-2 border border-gray-300 rounded-lg"><option value="">选择成员</option></select>
        </div>
        <div class="flex gap-2">
          <button onclick="closeAddTaskModal()" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">取消</button>
          <button onclick="createTask()" class="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">创建</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- 编辑任务弹窗 -->
  <div id="editTaskModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[70]" onclick="if(event.target === this) closeEditTaskModal()">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4">
      <div class="bg-gradient-to-r from-purple-500 to-indigo-500 px-6 py-4 flex justify-between items-center">
        <h3 class="text-white font-bold text-lg">编辑任务</h3>
        <button onclick="closeEditTaskModal()" class="text-white hover:text-gray-200"><iconify-icon icon="mdi:close" width="24"></iconify-icon></button>
      </div>
      <div class="p-6">
        <input type="hidden" id="editTaskId" />
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">任务名称</label>
          <input type="text" id="editTaskName" class="w-full px-3 py-2 border border-gray-300 rounded-lg" />
        </div>
        <div class="flex gap-2">
          <button onclick="closeEditTaskModal()" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">取消</button>
          <button onclick="saveTaskEdit()" class="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">保存</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- 任务详情弹窗 -->
  <div id="taskDetailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60]" onclick="if(event.target === this) closeTaskDetailModal()">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl mx-4 max-h-[80vh] overflow-y-auto">
      <div class="bg-gradient-to-r from-purple-500 to-indigo-500 px-6 py-4 flex justify-between items-center sticky top-0">
        <h3 class="text-white font-bold text-lg" id="taskDetailTitle">任务详情</h3>
        <button onclick="closeTaskDetailModal()" class="text-white hover:text-gray-200"><iconify-icon icon="mdi:close" width="24"></iconify-icon></button>
      </div>
      <div class="p-6"><input type="hidden" id="detailTaskId" /><div id="taskDetailContent"></div></div>
    </div>
  </div>
  
  <!-- 图片预览弹窗 -->
  <div id="imagePreviewModal" class="hidden fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-[60]" onclick="closeImagePreview()">
    <img id="previewImage" src="" class="max-w-[90vw] max-h-[90vh] object-contain" />
  </div>
</body>
</html>
</html>
</html>
</html>
