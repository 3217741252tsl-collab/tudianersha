<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åä½œç¼–è¾‘ - é€”ç‚¹å„¿å•¥</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
  <style>
    .timeline-item { position: relative; padding-left: 30px; }
    .timeline-item::before { content: ''; position: absolute; left: 8px; top: 30px; width: 2px; height: calc(100% - 20px); background: #e5e7eb; }
    .timeline-dot { position: absolute; left: 0; top: 8px; width: 18px; height: 18px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .flow-node { width: 80px; height: 80px; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; font-weight: bold; position: relative; }
    .flow-line { height: 2px; flex: 1; margin: 0 -10px; background: linear-gradient(to right, transparent 0%, #3b82f6 20%, #3b82f6 80%, transparent 100%); background-size: 10px 2px; }
    .flow-line-dashed { background: repeating-linear-gradient(to right, #3b82f6 0px, #3b82f6 10px, transparent 10px, transparent 20px); }
    
    /* Chat Styles */
    .chat-messages {
      height: 300px;
      overflow-y: auto;
      scroll-behavior: smooth;
    }
    .chat-messages::-webkit-scrollbar {
      width: 6px;
    }
    .chat-messages::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 3px;
    }
    .chat-messages::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 3px;
    }
    .chat-messages::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }
    .mention {
      color: #3b82f6;
      background-color: #dbeafe;
      padding: 1px 4px;
      border-radius: 3px;
      font-weight: 600;
    }
    .mention-dropdown {
      position: absolute;
      bottom: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      max-height: 200px;
      overflow-y: auto;
      display: none;
      z-index: 1000;
    }
    .mention-dropdown.active {
      display: block;
    }
    .mention-item {
      padding: 8px 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .mention-item:hover {
      background-color: #f3f4f6;
    }
    .mention-item.selected {
      background-color: #dbeafe;
    }
  </style>
</head>
<body class="bg-gray-50">
  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <header class="bg-white shadow-sm">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex items-center gap-4">
        <button onclick="window.history.back()" class="text-gray-600 hover:text-gray-900">
          <iconify-icon icon="mdi:arrow-left" width="24"></iconify-icon>
        </button>
        <h1 class="text-xl font-bold" id="projectName">å›½åº†ä¸ƒæ—¥æ¸¸</h1>
        <span class="bg-blue-500 text-white text-xs px-3 py-1 rounded-full">åä½œä¸­</span>
      </div>
      <div class="flex items-center gap-3">
        <div class="flex -space-x-2" id="participantAvatars">
          <!-- åŠ¨æ€åŠ è½½å‚ä¸è€…å¤´åƒ -->
        </div>
        <button id="permissionManageBtn" class="bg-purple-500 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-purple-600" style="display: none;" onclick="openPermissionModal()">
          <iconify-icon icon="mdi:account-cog"></iconify-icon>
          <span>æƒé™ç®¡ç†</span>
        </button>
        <button class="bg-blue-500 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-blue-600" onclick="copyInviteLink()">
          <iconify-icon icon="mdi:share"></iconify-icon>
          <span>é‚€è¯·</span>
        </button>
        <button onclick="window.location.href='/index.html'" class="text-gray-600 hover:text-gray-900">
          <iconify-icon icon="mdi:close" width="24"></iconify-icon>
        </button>
      </div>
    </div>
  </header>

  <!-- ä¸»å†…å®¹åŒº -->
  <div class="container mx-auto px-4 py-6">
    <div class="grid grid-cols-12 gap-4">
      <!-- å·¦ä¾§ï¼šæ™¯ç‚¹åˆ—è¡¨ (3åˆ—) -->
      <div class="col-span-3 bg-white rounded-lg shadow p-4">
        <div class="flex items-center justify-between mb-4">
          <h3 class="font-bold text-lg flex items-center gap-2">
            <iconify-icon icon="mdi:map-marker-multiple" class="text-blue-500"></iconify-icon>
            æ™¯ç‚¹åˆ—è¡¨
          </h3>
        </div>
        
        <!-- æ—¥æœŸé€‰æ‹©å™¨ -->
        <div class="mb-4">
          <label class="text-sm text-gray-600 mb-2 block">é€‰æ‹©æ—¥æœŸ</label>
          <select id="daySelector" class="w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="loadDayAttractions()">
            <!-- åŠ¨æ€ç”Ÿæˆå¤©æ•°é€‰é¡¹ -->
          </select>
        </div>
        
        <!-- æ™¯ç‚¹åˆ—è¡¨ -->
        <div class="space-y-2 max-h-[calc(100vh-300px)] overflow-y-auto" id="attractionsList">
          <div class="text-center text-gray-400 py-8">
            <iconify-icon icon="mdi:map-search" width="48"></iconify-icon>
            <p class="mt-2 text-sm">åŠ è½½ä¸­...</p>
          </div>
        </div>
      </div>

      <!-- ä¸­é—´ï¼šè·¯çº¿æ€»è§ˆ (5åˆ—) -->
      <div class="col-span-5">
        <div class="bg-white rounded-lg shadow p-4 mb-4">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-bold text-lg flex items-center gap-2">
              <iconify-icon icon="mdi:timeline-text" class="text-purple-500"></iconify-icon>
              è·¯çº¿æ€»è§ˆ
            </h3>
            <div class="flex items-center gap-3">
              <span class="text-xs text-gray-500" id="currentDayLabel">ç¬¬1å¤©</span>
              <button id="addActivityBtn" onclick="openAddActivityModal()" 
                      class="hidden bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded-lg text-sm flex items-center gap-1">
                <iconify-icon icon="mdi:plus" width="16"></iconify-icon>
                æ–°å¢æ´»åŠ¨
              </button>
            </div>
          </div>
          
          <!-- å½“æ—¥è¡Œç¨‹å¡ç‰‡ (æ¨ªå‘4åˆ—ç½‘æ ¼) -->
          <div class="grid grid-cols-4 gap-3" id="dayOverviewGrid">
            <!-- åŠ¨æ€åŠ è½½è¡Œç¨‹å¡ç‰‡ -->
            <div class="text-center text-gray-400 col-span-4 py-8">
              <iconify-icon icon="mdi:calendar-blank" width="48"></iconify-icon>
              <p class="mt-2 text-sm">è¯·é€‰æ‹©æ—¥æœŸæŸ¥çœ‹è¡Œç¨‹</p>
            </div>
          </div>
        </div>
      </div>

      <!-- å³ä¾§ï¼šæ™¯ç‚¹ä»‹ç» (4åˆ—) -->
      <div class="col-span-4">
        <div class="bg-white rounded-lg shadow p-4" id="attractionDetailPanel">
          <!-- é»˜è®¤ç©ºçŠ¶æ€ -->
          <div class="h-[calc(100vh-200px)] flex flex-col items-center justify-center text-gray-400" id="emptyState">
            <iconify-icon icon="mdi:information-outline" width="64" class="mb-4"></iconify-icon>
            <p class="text-lg">ç‚¹å‡»æ™¯ç‚¹æŸ¥çœ‹ä»‹ç»</p>
          </div>
          
          <!-- æ™¯ç‚¹ä»‹ç»å†…å®¹ -->
          <div class="hidden" id="attractionDetail">
            <!-- æ™¯ç‚¹æ ‡é¢˜ -->
            <div class="mb-4 pb-4 border-b">
              <h2 class="text-xl font-bold text-gray-800 mb-2" id="attractionName">æ™¯ç‚¹åç§°</h2>
              <div class="flex items-center gap-4 text-sm text-gray-600">
                <div class="flex items-center gap-1">
                  <iconify-icon icon="mdi:clock-outline"></iconify-icon>
                  <span id="attractionTime">09:00-12:00</span>
                </div>
                <div class="flex items-center gap-1">
                  <iconify-icon icon="mdi:map-marker"></iconify-icon>
                  <span id="attractionAddress" class="text-xs">åœ°å€åŠ è½½ä¸­...</span>
                </div>
              </div>
            </div>
            
            <!-- åŸºæœ¬ä¿¡æ¯å¡ç‰‡ -->
            <div class="grid grid-cols-2 gap-3 mb-4">
              <div class="bg-blue-50 p-3 rounded-lg">
                <div class="flex items-center gap-2 text-blue-600 mb-1">
                  <iconify-icon icon="mdi:clock-outline" width="18"></iconify-icon>
                  <span class="font-semibold text-sm">å¼€æ”¾æ—¶é—´</span>
                </div>
                <p class="text-gray-700 text-xs" id="openingHours">åŠ è½½ä¸­...</p>
              </div>
              <div class="bg-green-50 p-3 rounded-lg">
                <div class="flex items-center gap-2 text-green-600 mb-1">
                  <iconify-icon icon="mdi:ticket-outline" width="18"></iconify-icon>
                  <span class="font-semibold text-sm">é—¨ç¥¨ä¿¡æ¯</span>
                </div>
                <p class="text-gray-700 text-xs" id="ticketInfo">åŠ è½½ä¸­...</p>
              </div>
            </div>
            
            <!-- AI ä»‹ç» -->
            <div class="border-t pt-4">
              <div class="flex items-center gap-2 mb-3">
                <div class="w-6 h-6 bg-purple-500 rounded-full flex items-center justify-center">
                  <iconify-icon icon="mdi:robot" class="text-white" width="14"></iconify-icon>
                </div>
                <h3 class="text-sm font-bold">AI æ™ºèƒ½ä»‹ç»</h3>
                <span class="text-xs text-gray-500">by Kimi</span>
              </div>
              <div class="prose prose-sm max-w-none">
                <div id="aiIntroduction" class="text-gray-700 text-sm leading-relaxed max-h-[calc(100vh-500px)] overflow-y-auto">
                  <div class="flex items-center justify-center py-8">
                    <iconify-icon icon="mdi:loading" class="text-blue-500 animate-spin" width="24"></iconify-icon>
                    <span class="ml-2 text-gray-500 text-xs">AI æ­£åœ¨ç”Ÿæˆä»‹ç»...</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- åº•éƒ¨èŠå¤© -->
    <div class="mt-8 border-t pt-4">
      <h4 class="font-bold mb-3 flex items-center gap-2">
        <iconify-icon icon="mdi:chat" width="20"></iconify-icon>
        å›¢é˜Ÿåä½œ
        <span class="text-xs text-gray-500 font-normal">(@æåŠæˆå‘˜)</span>
      </h4>
      <div class="chat-messages space-y-2 mb-3 p-3 bg-gray-50 rounded-lg" id="chatMessages">
        <!-- èŠå¤©æ¶ˆæ¯ -->
      </div>
      <div class="relative">
        <div class="mention-dropdown" id="mentionDropdown">
          <!-- @mention suggestions -->
        </div>
        <div class="flex gap-2">
          <input type="text" id="chatInput" placeholder="è¾“å…¥æ¶ˆæ¯... (è¾“å…¥@æåŠå…¶ä»–ç”¨æˆ·)" class="flex-1 border rounded-lg px-4 py-2 text-sm" />
          <button onclick="sendMessage()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
            <iconify-icon icon="mdi:send"></iconify-icon>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- å³ä¸‹è§’æ‚¬æµ®æŒ‰é’®ï¼šå¯¼å‡ºPDF -->
  <div class="fixed bottom-8 right-8 z-50">
    <button onclick="exportPdf()" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-full shadow-lg flex items-center gap-2 transition-all duration-300 hover:shadow-xl hover:scale-105">
      <iconify-icon icon="mdi:file-pdf-box" width="24"></iconify-icon>
      <span class="font-medium">å¯¼å‡ºPDF</span>
    </button>
  </div>

  <!-- æƒé™ç®¡ç†å¼¹çª— -->
  <div id="permissionModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl mx-4 max-h-[80vh] overflow-hidden">
      <div class="bg-gradient-to-r from-purple-500 to-blue-500 px-6 py-4 flex justify-between items-center">
        <h2 class="text-xl font-bold text-white flex items-center gap-2">
          <iconify-icon icon="mdi:account-cog" width="24"></iconify-icon>
          æƒé™ç®¡ç†
        </h2>
        <button onclick="closePermissionModal()" class="text-white hover:text-gray-200">
          <iconify-icon icon="mdi:close" width="24"></iconify-icon>
        </button>
      </div>
      <div class="p-6 overflow-y-auto" style="max-height: calc(80vh - 140px);">
        <div class="mb-4 text-sm text-gray-600">
          <p>âš ï¸ æƒé™è¯´æ˜ï¼š</p>
          <ul class="list-disc list-inside ml-2 mt-2 space-y-1">
            <li><strong>ç¼–è¾‘è€…</strong>ï¼šå¯ä»¥æŸ¥çœ‹å’Œç¼–è¾‘é¡¹ç›®å†…å®¹</li>
            <li><strong>æŸ¥çœ‹è€…</strong>ï¼šåªèƒ½æŸ¥çœ‹é¡¹ç›®å†…å®¹ï¼Œä¸èƒ½ç¼–è¾‘</li>
          </ul>
        </div>
        <div id="participantList" class="space-y-3">
          <!-- å‚ä¸è€…åˆ—è¡¨å°†åŠ¨æ€ç”Ÿæˆ -->
        </div>
      </div>
      <div class="bg-gray-50 px-6 py-4 flex justify-end gap-3">
        <button onclick="closePermissionModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">å–æ¶ˆ</button>
        <button onclick="savePermissions()" class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600">ä¿å­˜ä¿®æ”¹</button>
      </div>
    </div>
  </div>

  <!-- æ–°å¢/ç¼–è¾‘æ´»åŠ¨å¼¹çª— -->
  <div id="activityModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4">
      <div class="bg-gradient-to-r from-green-500 to-blue-500 px-6 py-4 flex justify-between items-center">
        <h2 class="text-xl font-bold text-white flex items-center gap-2">
          <iconify-icon icon="mdi:calendar-plus" width="24"></iconify-icon>
          æ–°å¢æ´»åŠ¨
        </h2>
        <button onclick="closeActivityModal()" class="text-white hover:text-gray-200">
          <iconify-icon icon="mdi:close" width="24"></iconify-icon>
        </button>
      </div>
      <div class="p-6">
        <div class="space-y-4">
          <!-- æ´»åŠ¨ç±»å‹ -->
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">æ´»åŠ¨ç±»å‹</label>
            <select id="activityType" onchange="handleActivityTypeChange()" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500">
              <option value="attraction">æ™¯ç‚¹æ¸¸è§ˆ</option>
              <option value="meal">é¤é¥®</option>
              <option value="other">å…¶ä»–</option>
            </select>
          </div>
          
          <!-- æ´»åŠ¨åç§° -->
          <div class="relative">
            <label class="block text-sm font-semibold text-gray-700 mb-2">æ´»åŠ¨åç§° <span class="text-red-500">*</span></label>
            <input type="text" id="activityName" placeholder="ä¾‹å¦‚ï¼šè¥¿æ¹–ã€åˆé¤ç­‰" 
                   oninput="handleActivityNameInput()"
                   onfocus="showActivitySuggestions()"
                   class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500">
            <!-- è‡ªåŠ¨è¡¥å…¨ä¸‹æ‹‰åˆ—è¡¨ -->
            <div id="activitySuggestions" class="hidden absolute z-10 w-full bg-white border border-gray-300 rounded-lg shadow-lg mt-1 max-h-60 overflow-y-auto">
              <!-- åŠ¨æ€ç”Ÿæˆå»ºè®®åˆ—è¡¨ -->
            </div>
          </div>
          
          <!-- æ—¶é—´æ®µ -->
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">å¼€å§‹æ—¶é—´</label>
              <input type="time" id="startTime" value="09:00" 
                     class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500">
            </div>
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">ç»“æŸæ—¶é—´</label>
              <input type="time" id="endTime" value="12:00" 
                     class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500">
            </div>
          </div>
          
          <!-- è¯¦ç»†æè¿° -->
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">è¯¦ç»†æè¿°</label>
            <textarea id="activityDescription" rows="3" placeholder="é€‰å¡«ï¼šå¼€æ”¾æ—¶é—´ã€é—¨ç¥¨ç­‰ä¿¡æ¯" 
                      class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500"></textarea>
          </div>
        </div>
      </div>
      <div class="bg-gray-50 px-6 py-4 flex justify-end gap-3">
        <button onclick="closeActivityModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">å–æ¶ˆ</button>
        <button onclick="saveActivity()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <script src="/js/common.js"></script>
  <script>
    // URLå‚æ•°è·å–å‡½æ•°
    function getQueryParam(param) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
    }
    
    if (!auth.isLoggedIn()) {
      window.location.href = '/login.html';
      throw new Error('Not logged in');
    }

    const currentUser = auth.getUser();
    const projectId = getQueryParam('id');
    const inviteToken = getQueryParam('invite');
    
    // å…¨å±€å˜é‡
    let canEdit = false; // å½“å‰ç”¨æˆ·æ˜¯å¦æœ‰ç¼–è¾‘æƒé™ï¼ˆåˆ›å»ºè€…æˆ–ç¼–è¾‘è€…ï¼‰
    let currentRouteData = null; // å½“å‰è·¯çº¿æ•°æ®
    let currentDayAttractions = []; // å½“å‰å¤©æ•°çš„æ™¯ç‚¹åˆ—è¡¨
    let destinationCity = ''; // é¡¹ç›®ç›®çš„åœ°åŸå¸‚
    let activitySuggestionsData = []; // æ´»åŠ¨åç§°è‡ªåŠ¨è¡¥å…¨æ•°æ®
    
    // æ£€æŸ¥projectIdæ˜¯å¦å­˜åœ¨
    if (!projectId) {
      console.error('No project ID found in URL');
      alert('é”™è¯¯ï¼šæœªæ‰¾åˆ°é¡¹ç›®ID');
      window.location.href = '/index.html';
    }
    
    console.log('Collaboration page initialized with projectId:', projectId);
    console.log('Current user:', currentUser);
    console.log('Invite token:', inviteToken);
    
    // åŠ è½½é¡¹ç›®ä¿¡æ¯
    async function loadProjectInfo() {
      if (!projectId) return;
      
      try {
        const response = await fetch(`/api/travel-projects/${projectId}`);
        if (response.ok) {
          const project = await response.json();
          // æ›´æ–°é¡¹ç›®åç§°
          document.getElementById('projectName').textContent = project.projectName;
          
          // ä¿å­˜ç›®çš„åœ°åŸå¸‚ï¼ˆç”¨äºæ™¯ç‚¹è‡ªåŠ¨è¡¥å…¨ï¼‰
          destinationCity = project.destination || '';
          console.log('[loadProjectInfo] Initial destination:', destinationCity);
          
          // å¦‚æœç›®çš„åœ°ä¸æ˜¯æ ‡å‡†åŸå¸‚åï¼Œå°è¯•è·å–çœŸå®åŸå¸‚å
          if (destinationCity) {
            console.log('[loadProjectInfo] Calling getCityNameFromDestination...');
            await getCityNameFromDestination(destinationCity);
            console.log('[loadProjectInfo] After getCityNameFromDestination, city is now:', destinationCity);
          }
          
          // æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦ä¸ºåˆ›å»ºè€…
          const isCreator = project.creatorId === currentUser.id;
          
          if (isCreator) {
            // åˆ›å»ºè€…æ˜¾ç¤ºæƒé™ç®¡ç†æŒ‰é’®
            document.getElementById('permissionManageBtn').style.display = 'flex';
            canEdit = true;
          } else {
            // éåˆ›å»ºè€…éœ€è¦æ£€æŸ¥æ˜¯å¦ä¸ºç¼–è¾‘è€…
            await checkEditPermission();
          }
          
          // æ ¹æ®æƒé™æ˜¾ç¤º/éšè—æ–°å¢æŒ‰é’®
          if (canEdit) {
            document.getElementById('addActivityBtn').classList.remove('hidden');
            document.getElementById('addActivityBtn').style.display = 'flex';
          }
        }
      } catch (error) {
        console.error('Error loading project info:', error);
      }
    }
    
    // æ£€æŸ¥ç¼–è¾‘æƒé™
    async function checkEditPermission() {
      try {
        const response = await fetch(`/api/project-participants/project/${projectId}`);
        if (response.ok) {
          const participants = await response.json();
          const currentParticipant = participants.find(p => p.userId === currentUser.id);
          if (currentParticipant && currentParticipant.permission === 'EDIT') {
            canEdit = true;
          }
        }
      } catch (error) {
        console.error('Error checking permission:', error);
      }
    }
    
    // ä»ç›®çš„åœ°è·å–åŸå¸‚åç§°ï¼ˆä½¿ç”¨åç«¯Geocoding APIï¼‰
    async function getCityNameFromDestination(destination) {
      console.log('[getCityName] Starting resolution for:', destination);
      
      // å¦‚æœå·²ç»æ˜¯åŸå¸‚æ ¼å¼ï¼ˆä»¥"å¸‚"ç»“å°¾ï¼‰ï¼Œç›´æ¥ä½¿ç”¨
      if (destination.endsWith('å¸‚')) {
        console.log('[getCityName] Destination is already a city:', destination);
        destinationCity = destination;
        return destination;
      }
      
      try {
        // ä½¿ç”¨åç«¯ä»£ç†æ¥å£
        const url = `/api/amap-test/geocode?address=${encodeURIComponent(destination)}`;
        console.log('[getCityName] Calling backend Geocoding API:', url);
        
        const response = await fetch(url);
        console.log('[getCityName] Response status:', response.status);
        
        if (response.ok) {
          const data = await response.json();
          console.log('[getCityName] API response:', data);
          
          if (data.success && data.city) {
            console.log('[getCityName] Resolved city name:', data.city, 'from destination:', destination);
            destinationCity = data.city;
            return data.city;
          } else {
            console.warn('[getCityName] Invalid response:', data);
          }
        } else {
          console.error('[getCityName] API call failed with status:', response.status);
        }
        
        console.warn('[getCityName] Failed to resolve city name, using original destination:', destination);
        // å¤‡ç”¨æ–¹æ¡ˆï¼šå°è¯•ä»åœ°å€ä¸­æå–åŸå¸‚å
        const cityMatch = destination.match(/([\u4e00-\u9fa5]+å¸‚)/); // åŒ¹é… "XXå¸‚"
        if (cityMatch) {
          const extractedCity = cityMatch[1];
          console.log('[getCityName] Extracted city from pattern:', extractedCity);
          destinationCity = extractedCity;
          return extractedCity;
        }
        destinationCity = destination;
        return destination;
      } catch (error) {
        console.error('Error resolving city name:', error);
        return destination;
      }
    }
    
    // å¦‚æœæ˜¯é€šè¿‡é‚€è¯·é“¾æ¥è¿›å…¥ï¼Œè‡ªåŠ¨æ·»åŠ ç”¨æˆ·åˆ°é¡¹ç›®
    async function handleInviteLink() {
      if (!inviteToken || !projectId) return;
      
      try {
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç»æ˜¯å‚ä¸è€…
        const checkResponse = await fetch(`/api/project-participants/project/${projectId}`);
        if (checkResponse.ok) {
          const participants = await checkResponse.json();
          const alreadyParticipant = participants.some(p => p.userId === currentUser.id);
          
          if (!alreadyParticipant) {
            // æ·»åŠ ç”¨æˆ·åˆ°é¡¹ç›®å‚ä¸è€…
            const addResponse = await fetch('/api/project-participants', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                projectId: parseInt(projectId),
                userId: currentUser.id,
                role: 'å‚ä¸è€…',
                joinTime: new Date().toISOString()
              })
            });
            
            if (addResponse.ok) {
              console.log('æˆåŠŸåŠ å…¥é¡¹ç›®');
              // é‡æ–°åŠ è½½å‚ä¸è€…åˆ—è¡¨
              await loadProjectParticipants();
            }
          }
        }
      } catch (error) {
        console.error('Error handling invite link:', error);
      }
    }
    
    // å…¨å±€å˜é‡å·²åœ¨ä¸Šæ–¹å£°æ˜
    
    // åŠ è½½é€‰ä¸­è·¯çº¿çš„å¤©æ•°é€‰é¡¹
    async function loadDayOptions() {
      console.log('Loading day options for project:', projectId);
      try {
        const projectResponse = await fetch(`/api/travel-projects/${projectId}`);
        if (!projectResponse.ok) {
          console.error('Failed to load project:', projectResponse.status);
          showNoRouteMessage();
          return;
        }
        
        const project = await projectResponse.json();
        console.log('Project loaded:', project);
        const currentRouteId = project.currentRouteId;
        
        if (!currentRouteId) {
          console.warn('No route selected for this project');
          showNoRouteMessage();
          return;
        }
        
        console.log('Loading route:', currentRouteId);
        const routeResponse = await fetch(`/api/ai-generated-routes/${currentRouteId}`);
        if (!routeResponse.ok) {
          console.error('Failed to load route:', routeResponse.status);
          showNoRouteMessage();
          return;
        }
        
        const route = await routeResponse.json();
        console.log('Route loaded:', route);
        currentRouteData = route;
        
        // è§£æè¡Œç¨‹æ•°æ®
        if (route.dailyItinerary) {
          const dailyItinerary = JSON.parse(route.dailyItinerary);
          console.log('Daily itinerary parsed:', dailyItinerary);
          const daySelector = document.getElementById('daySelector');
          
          // è·å–é¡¹ç›®å¼€å§‹æ—¥æœŸ
          const startDate = new Date(project.startDate);
          
          daySelector.innerHTML = dailyItinerary.map((day, index) => {
            const dayNumber = day.day || (index + 1);
            // è®¡ç®—å½“å‰å¤©çš„å…·ä½“æ—¥æœŸ
            const currentDate = new Date(startDate);
            currentDate.setDate(startDate.getDate() + index);
            
            // æ ¼å¼åŒ–æ—¥æœŸï¼šæœˆæœˆæ—¥æ—¥
            const month = currentDate.getMonth() + 1;
            const date = currentDate.getDate();
            const dateStr = `${month}æœˆ${date}æ—¥`;
            
            return `<option value="${dayNumber}">${dateStr}ï¼ˆç¬¬${dayNumber}å¤©ï¼‰</option>`;
          }).join('');
          
          // é»˜è®¤åŠ è½½ç¬¬ä¸€å¤©
          loadDayAttractions();
        } else {
          console.warn('Route has no daily itinerary');
          showNoRouteMessage();
        }
      } catch (error) {
        console.error('Error loading day options:', error);
        showNoRouteMessage();
      }
    }
    
    // æ˜¾ç¤ºæ— è·¯çº¿æç¤º
    function showNoRouteMessage() {
      console.log('Showing no route message...');
      const attractionsList = document.getElementById('attractionsList');
      if (!attractionsList) {
        console.error('attractionsList element not found!');
        return;
      }
      attractionsList.innerHTML = `
        <div class="text-center text-gray-500 py-8">
          <iconify-icon icon="mdi:map-marker-off-outline" width="64" class="text-gray-300 mb-4"></iconify-icon>
          <p class="text-lg font-semibold mb-2">æš‚æœªé€‰æ‹©è·¯çº¿æ–¹æ¡ˆ</p>
          <p class="text-sm mb-4">è¯·å…ˆå‰å¾€è·¯çº¿é€‰æ‹©é¡µé¢é€‰æ‹©ä¸€ä¸ªAIç”Ÿæˆçš„æ–¹æ¡ˆ</p>
          <a href="/route-selection.html?id=${projectId}" class="inline-block bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg transition-colors">
            <iconify-icon icon="mdi:map-search" class="mr-2"></iconify-icon>
            å‰å¾€é€‰æ‹©è·¯çº¿
          </a>
        </div>
      `;
      console.log('No route message displayed');
    }
    
    // åŠ è½½æŒ‡å®šå¤©æ•°çš„æ™¯ç‚¹
    async function loadDayAttractions() {
      const selectedDay = parseInt(document.getElementById('daySelector').value);
      
      if (!currentRouteData || !currentRouteData.dailyItinerary) {
        document.getElementById('attractionsList').innerHTML = `
          <div class="text-center text-gray-400 py-8">
            <iconify-icon icon="mdi:alert-circle" width="48"></iconify-icon>
            <p class="mt-2 text-sm">æš‚æ— è¡Œç¨‹æ•°æ®</p>
          </div>
        `;
        return;
      }
      
      try {
        // è·å–é¡¹ç›®ä¿¡æ¯ä»¥è®¡ç®—å…·ä½“æ—¥æœŸ
        const projectResponse = await fetch(`/api/travel-projects/${projectId}`);
        const project = await projectResponse.json();
        const startDate = new Date(project.startDate);
        
        const dailyItinerary = JSON.parse(currentRouteData.dailyItinerary);
        const dayData = dailyItinerary.find(d => (d.day || dailyItinerary.indexOf(d) + 1) === selectedDay);
        
        if (!dayData || !dayData.activities) {
          document.getElementById('attractionsList').innerHTML = `
            <div class="text-center text-gray-400 py-8">
              <p class="text-sm">å½“å¤©æš‚æ— æ™¯ç‚¹</p>
            </div>
          `;
          return;
        }
        
        // æå–æ™¯ç‚¹ï¼ˆè¿‡æ»¤æ‰é¤é¥®ï¼‰
        const attractions = [];
        dayData.activities.forEach((activity, index) => {
          // è§£ææ´»åŠ¨å­—ç¬¦ä¸²
          const timeMatch = activity.match(/^(\d{2}:\d{2}-\d{2}:\d{2})\s*(.*)/);
          let timeRange = '';
          let content = activity;
          
          if (timeMatch) {
            timeRange = timeMatch[1];
            content = timeMatch[2];
          }
          
          // åªä¿ç•™æ™¯ç‚¹ç›¸å…³çš„ï¼ˆåŒ…å«"æ™¯ç‚¹â€å…³é”®è¯æˆ–æ—¶é—´åœ¨éç”¨é¤æ—¶æ®µï¼‰
          if (content.includes('æ™¯ç‚¹ï¼š') || 
              content.includes('ä¸Šåˆï¼š') || 
              content.includes('ä¸‹åˆï¼š') || 
              content.includes('æ™šä¸Šï¼š') ||
              (!content.includes('æ—©é¤') && !content.includes('åˆé¤') && !content.includes('æ™šé¤'))) {
            
            // æå–æ™¯ç‚¹åç§°
            const attractionName = extractAttractionName(content);
            if (attractionName) {
              attractions.push({
                index: index,
                name: attractionName,
                time: timeRange,
                fullActivity: activity,
                rawContent: content
              });
            }
          }
        });
        
        currentDayAttractions = attractions;
        renderAttractionsList(attractions);
        
        // æ›´æ–°å½“å‰å¤©æ•°æ ‡ç­¾ï¼ˆæ˜¾ç¤ºå…·ä½“æ—¥æœŸï¼‰
        const currentDate = new Date(startDate);
        currentDate.setDate(startDate.getDate() + (selectedDay - 1));
        const month = currentDate.getMonth() + 1;
        const date = currentDate.getDate();
        const dateStr = `${month}æœˆ${date}æ—¥`;
        document.getElementById('currentDayLabel').textContent = `${dateStr}ï¼ˆç¬¬${selectedDay}å¤©ï¼‰`;
        
        // æ¸²æŸ“è·¯çº¿æ€»è§ˆï¼ˆæ˜¾ç¤ºæ‰€æœ‰æ´»åŠ¨ï¼‰
        renderDayOverview(dayData.activities, selectedDay);
        
      } catch (error) {
        console.error('Error loading day attractions:', error);
      }
    }
    
    // æå–æ™¯ç‚¹åç§°
    function extractAttractionName(content) {
      // ç§»é™¤æ—¶é—´æ®µ
      content = content.replace(/^\d{2}:\d{2}-\d{2}:\d{2}\s*/, '');
      
      // ç§»é™¤å‰ç¼€
      content = content.replace(/^[æ—©åˆæ™š]é¤[:ï¼š\s]*/, '');
      content = content.replace(/^[ä¸Šä¸‹]åˆ[:ï¼š\s]*/, '');
      content = content.replace(/^æ™šä¸Š[:ï¼š\s]*/, '');
      content = content.replace(/^æ™¯ç‚¹[:ï¼š\s]*/, '');
      
      // æå–ã€ã€‘ä¸­çš„å†…å®¹
      const bracketMatch = content.match(/ã€([^ã€‘]+)ã€‘/);
      if (bracketMatch) {
        return bracketMatch[1].trim();
      }
      
      // æå–ç¬¬ä¸€ä¸ªé€—å·æˆ–å¥å·ä¹‹å‰çš„å†…å®¹
      const parts = content.split(/[,ï¼Œã€‚ï¼š:]/);
      if (parts.length > 0) {
        const name = parts[0].trim();
        // ç§»é™¤â€œå‚è§‚â€ã€â€œæ¸¸è§ˆâ€ç­‰åŠ¨è¯
        return name.replace(/^(å‚è§‚|æ¸¸è§ˆ|å‰å¾€|æ‰“å¡)/, '').trim();
      }
      
      return content.substring(0, 20).trim();
    }
    
    // æ¸²æŸ“æ™¯ç‚¹åˆ—è¡¨
    function renderAttractionsList(attractions) {
      const listContainer = document.getElementById('attractionsList');
      
      if (attractions.length === 0) {
        listContainer.innerHTML = `
          <div class="text-center text-gray-400 py-8">
            <iconify-icon icon="mdi:map-marker-off" width="48"></iconify-icon>
            <p class="mt-2 text-sm">å½“å¤©æ²¡æœ‰æ™¯ç‚¹å®‰æ’</p>
          </div>
        `;
        return;
      }
      
      listContainer.innerHTML = attractions.map((attr, index) => `
        <div class="p-3 border rounded-lg hover:bg-blue-50 hover:border-blue-300 transition-all attraction-item cursor-pointer" 
             onclick="showAttractionDetail(${index})"
             data-index="${index}">
          <div class="flex items-start gap-3">
            <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0">
              <iconify-icon icon="mdi:map-marker" class="text-blue-600" width="20"></iconify-icon>
            </div>
            <div class="flex-1 min-w-0">
              <h4 class="font-semibold text-gray-800 truncate">${attr.name}</h4>
              <p class="text-xs text-gray-500 mt-1 flex items-center gap-1">
                <iconify-icon icon="mdi:clock-outline" width="12"></iconify-icon>
                ${attr.time || 'æ—¶é—´æœªè®¾ç½®'}
              </p>
            </div>
            <iconify-icon icon="mdi:chevron-right" class="text-gray-400" width="20"></iconify-icon>
          </div>
        </div>
      `).join('');
    }
    
    // æ¸²æŸ“è·¯çº¿æ€»è§ˆï¼ˆæ¨ªå‘4åˆ—ç½‘æ ¼ï¼‰
    function renderDayOverview(activities, selectedDay) {
      const gridContainer = document.getElementById('dayOverviewGrid');
      
      if (!activities || activities.length === 0) {
        gridContainer.innerHTML = `
          <div class="text-center text-gray-400 col-span-4 py-8">
            <iconify-icon icon="mdi:calendar-blank" width="48"></iconify-icon>
            <p class="mt-2 text-sm">å½“å¤©æš‚æ— è¡Œç¨‹</p>
          </div>
        `;
        return;
      }
      
      // è§£ææ¯ä¸ªæ´»åŠ¨
      const parsedActivities = activities.map((activity, index) => {
        const timeMatch = activity.match(/^(\d{2}:\d{2}-\d{2}:\d{2})\s*(.*)/);
        let timeRange = 'æœªè®¾ç½®';
        let content = activity;
        let activityType = 'other'; // attraction, meal, other
        let icon = 'mdi:map-marker';
        let bgColor = 'bg-gray-100';
        let textColor = 'text-gray-600';
        
        if (timeMatch) {
          timeRange = timeMatch[1];
          content = timeMatch[2];
        }
        
        // åˆ¤æ–­æ´»åŠ¨ç±»å‹
        if (content.includes('æ—©é¤') || content.includes('åˆé¤') || content.includes('æ™šé¤')) {
          activityType = 'meal';
          icon = 'mdi:silverware-fork-knife';
          bgColor = 'bg-orange-100';
          textColor = 'text-orange-600';
        } else if (content.includes('æ™¯ç‚¹') || content.includes('ä¸Šåˆ') || content.includes('ä¸‹åˆ') || content.includes('æ™šä¸Š')) {
          activityType = 'attraction';
          icon = 'mdi:map-marker';
          bgColor = 'bg-blue-100';
          textColor = 'text-blue-600';
        }
        
        // æå–åç§°ï¼ˆç®€åŒ–ç‰ˆï¼‰
        let displayName = content;
        displayName = displayName.replace(/^æ™¯ç‚¹[::ï¼š]/, '');
        displayName = displayName.replace(/^[ä¸Šä¸‹]åˆ[::ï¼š]/, '');
        displayName = displayName.replace(/^æ™šä¸Š[::ï¼š]/, '');
        displayName = displayName.replace(/^[æ—©åˆæ™š]é¤[::ï¼š]/, '');
        
        // æå–ã€ã€‘ä¸­çš„å†…å®¹
        const bracketMatch = displayName.match(/ã€([^ã€‘]+)ã€‘/);
        if (bracketMatch) {
          displayName = bracketMatch[1];
        } else {
          // åªå–ç¬¬ä¸€ä¸ªé€—å·å‰çš„å†…å®¹
          displayName = displayName.split(/[,ï¼Œã€‚]/)[ 0];
        }
        
        return {
          time: timeRange,
          name: displayName.substring(0, 12).trim(),
          fullContent: content,
          type: activityType,
          icon,
          bgColor,
          textColor,
          originalIndex: index // ä¿å­˜åŸå§‹ç´¢å¼•ç”¨äºåˆ é™¤
        };
      });
      
      // æ¸²æŸ“å¡ç‰‡ï¼ˆ4åˆ—ç½‘æ ¼ï¼‰
      gridContainer.innerHTML = parsedActivities.map((activity, index) => `
        <div class="bg-white border rounded-lg p-3 hover:shadow-md transition-shadow relative group">
          ${canEdit ? `
            <button onclick="event.stopPropagation(); deleteAttraction(${activity.originalIndex})" 
                    class="absolute -top-2 -right-2 bg-red-500 hover:bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity shadow-lg" 
                    title="åˆ é™¤æ´»åŠ¨">
              <iconify-icon icon="mdi:close" width="14"></iconify-icon>
            </button>
          ` : ''}
          <div class="flex flex-col h-full">
            <div class="flex items-center gap-2 mb-2">
              <div class="w-8 h-8 ${activity.bgColor} rounded-full flex items-center justify-center flex-shrink-0">
                <iconify-icon icon="${activity.icon}" class="${activity.textColor}" width="16"></iconify-icon>
              </div>
              <span class="text-xs font-semibold ${activity.textColor}">${activity.time}</span>
            </div>
            <h5 class="text-sm font-medium text-gray-800 line-clamp-2 flex-1">${activity.name}</h5>
          </div>
        </div>
      `).join('');
    }
    
    // æ˜¾ç¤ºæ™¯ç‚¹è¯¦æƒ…
    async function showAttractionDetail(index) {
      const attraction = currentDayAttractions[index];
      if (!attraction) return;
      
      // éšè—ç©ºçŠ¶æ€ï¼Œæ˜¾ç¤ºè¯¦æƒ…
      document.getElementById('emptyState').classList.add('hidden');
      document.getElementById('attractionDetail').classList.remove('hidden');
      
      // é«˜äº®å½“å‰é€‰ä¸­çš„æ™¯ç‚¹
      document.querySelectorAll('.attraction-item').forEach(item => {
        item.classList.remove('bg-blue-50', 'border-blue-300');
      });
      document.querySelector(`.attraction-item[data-index="${index}"]`)?.classList.add('bg-blue-50', 'border-blue-300');
      
      // è®¾ç½®åŸºæœ¬ä¿¡æ¯
      document.getElementById('attractionName').textContent = attraction.name;
      document.getElementById('attractionTime').textContent = attraction.time || 'æ—¶é—´æœªè®¾ç½®';
      
      // é‡ç½®åŠ è½½çŠ¶æ€
      document.getElementById('openingHours').textContent = 'åŠ è½½ä¸­...';
      document.getElementById('ticketInfo').textContent = 'åŠ è½½ä¸­...';
      document.getElementById('attractionAddress').textContent = 'åŠ è½½ä¸­...';
      document.getElementById('aiIntroduction').innerHTML = `
        <div class="flex items-center justify-center py-8">
          <iconify-icon icon="mdi:loading" class="text-blue-500 animate-spin" width="32"></iconify-icon>
          <span class="ml-2 text-gray-500">AI æ­£åœ¨ç”Ÿæˆä»‹ç»...</span>
        </div>
      `;
      
      // è·å–é«˜å¾·æ™¯ç‚¹ä¿¡æ¯ï¼ˆå›¾ç‰‡ + åŸºæœ¬ä¿¡æ¯ï¼‰
      await loadAmapInfo(attraction);
      
      // ç”ŸæˆAIä»‹ç»
      await generateAIIntroduction(attraction);
    }
    
    // åŠ è½½é«˜å¾·æ™¯ç‚¹ä¿¡æ¯ï¼ˆåªè·å–åœ°å€ï¼‰
    async function loadAmapInfo(attraction) {
      try {
        const projectResponse = await fetch(`/api/travel-projects/${projectId}`);
        const project = await projectResponse.json();
        const city = project.destination;
        
        console.log('Loading Amap info for:', attraction.name, 'in', city);
        
        const response = await fetch(`/api/amap-test/poi-detail?keyword=${encodeURIComponent(attraction.name)}&city=${encodeURIComponent(city)}`);
        if (!response.ok) {
          console.warn('Amap API response not OK:', response.status);
          throw new Error('Failed to fetch');
        }
        
        const data = await response.json();
        console.log('Amap API returned:', data);
        
        // ä¼˜å…ˆä½¿ç”¨é«˜å¾·è¿”å›çš„åœ°å€
        if (data && data.address) {
          // ç›´æ¥ä½¿ç”¨é«˜å¾·è¿”å›çš„åœ°å€
          console.log('Using Amap address:', data.address);
          document.getElementById('attractionAddress').textContent = data.address;
        } else if (data && data.name) {
          // æœ‰POIä¿¡æ¯ä½†æ²¡æœ‰åœ°å€
          console.log('POI found but no address available');
          document.getElementById('attractionAddress').textContent = 'åœ°å€ä¿¡æ¯æš‚æ— ';
        } else {
          // æ²¡æœ‰æ‰¾åˆ°æ™¯ç‚¹ä¿¡æ¯
          console.log('No POI found');
          document.getElementById('attractionAddress').textContent = 'æœªæ‰¾åˆ°æ™¯ç‚¹';
        }
        
        // è®¾ç½®å¼€æ”¾æ—¶é—´å’Œé—¨ç¥¨ï¼ˆä»è¡Œç¨‹ä¸­æå–ï¼‰
        extractOpeningHoursAndTicket(attraction.rawContent);
        
      } catch (error) {
        console.error('Error loading Amap info:', error);
        document.getElementById('attractionAddress').textContent = 'æš‚æ— å®šä½ä¿¡æ¯';
        extractOpeningHoursAndTicket(attraction.rawContent);
      }
    }
    
    // ä»æ–‡æœ¬ä¸­æå–å¼€æ”¾æ—¶é—´å’Œé—¨ç¥¨ä¿¡æ¯
    function extractOpeningHoursAndTicket(content) {
      // æå–å¼€æ”¾æ—¶é—´
      const openingMatch = content.match(/å¼€æ”¾æ—¶é—´[::ï¼š]([^ï¼Œ,ã€‚]+)/);
      if (openingMatch) {
        document.getElementById('openingHours').textContent = openingMatch[1].trim();
      } else {
        document.getElementById('openingHours').textContent = 'æœªæ ‡æ³¨';
      }
      
      // æå–é—¨ç¥¨ä¿¡æ¯
      const ticketMatch = content.match(/é—¨ç¥¨[::ï¼š]([^ï¼Œ,ã€‚]+)/);
      if (ticketMatch) {
        document.getElementById('ticketInfo').textContent = ticketMatch[1].trim();
      } else {
        document.getElementById('ticketInfo').textContent = 'æœªæ ‡æ³¨';
      }
    }
    
    // ç”ŸæˆAIä»‹ç»
    async function generateAIIntroduction(attraction) {
      try {
        const projectResponse = await fetch(`/api/travel-projects/${projectId}`);
        const project = await projectResponse.json();
        const city = project.destination;
        
        const response = await fetch(`/api/amap-test/attraction-intro?name=${encodeURIComponent(attraction.name)}&city=${encodeURIComponent(city)}`);
        if (!response.ok) throw new Error('Failed to fetch');
        
        const data = await response.json();
        
        if (data.success && data.introduction) {
          // æ ¼å¼åŒ–ä»‹ç»æ–‡æœ¬ä¸ºæ®µè½
          const paragraphs = data.introduction.split('\n').filter(p => p.trim().length > 0);
          const formattedIntro = paragraphs.map(p => `<p class="mb-3">${p.trim()}</p>`).join('');
          document.getElementById('aiIntroduction').innerHTML = formattedIntro;
        } else {
          // ä½¿ç”¨é»˜è®¤ä»‹ç»
          const introduction = `
            <p class="mb-3">${attraction.name}æ˜¯ä¸€å¤„å…·æœ‰é‡è¦å†å²å’Œæ–‡åŒ–æ„ä¹‰çš„æ™¯ç‚¹ã€‚è¿™é‡Œä¸ä»…é£æ™¯ä¼˜ç¾ï¼Œè€Œä¸”è•´å«ç€ä¸°å¯Œçš„å†å²æ•…äº‹å’Œæ–‡åŒ–åº•è•´ã€‚</p>
            <p class="mb-3">æ™¯ç‚¹å‘¨è¾¹é…å¥—è®¾æ–½å®Œå–„ï¼Œäº¤é€šä¾¿åˆ©ï¼Œæ˜¯æ¸¸å®¢å¿…æ‰“å¡çš„çƒ­é—¨åœ°ç‚¹ä¹‹ä¸€ã€‚å»ºè®®æ‚¨æå‰äº†è§£ç›¸å…³å†å²èƒŒæ™¯ï¼Œè¿™æ ·èƒ½æ›´å¥½åœ°æ¬£èµå’Œç†è§£æ™¯ç‚¹çš„å†…æ¶µã€‚</p>
            <p>æ¸¸è§ˆè¿‡ç¨‹ä¸­è¯·æ³¨æ„ä¿æŠ¤æ–‡ç‰©ï¼Œä¸è¦åœ¨æ–‡ç‰©å¤è¿¹ä¸Šåˆ»ç”»æˆ–æ¶‚å†™ã€‚åŒæ—¶å»ºè®®æºå¸¦ç›¸æœºï¼Œè®°å½•ä¸‹ç¾å¥½çš„æ—…è¡Œå›å¿†ã€‚</p>
          `;
          document.getElementById('aiIntroduction').innerHTML = introduction;
        }
      } catch (error) {
        console.error('Error generating AI introduction:', error);
        // ä½¿ç”¨é»˜è®¤ä»‹ç»
        const introduction = `
          <p class="mb-3">${attraction.name}æ˜¯ä¸€å¤„å…·æœ‰é‡è¦å†å²å’Œæ–‡åŒ–æ„ä¹‰çš„æ™¯ç‚¹ã€‚è¿™é‡Œä¸ä»…é£æ™¯ä¼˜ç¾ï¼Œè€Œä¸”è•´å«ç€ä¸°å¯Œçš„å†å²æ•…äº‹å’Œæ–‡åŒ–åº•è•´ã€‚</p>
          <p class="mb-3">æ™¯ç‚¹å‘¨è¾¹é…å¥—è®¾æ–½å®Œå–„ï¼Œäº¤é€šä¾¿åˆ©ï¼Œæ˜¯æ¸¸å®¢å¿…æ‰“å¡çš„çƒ­é—¨åœ°ç‚¹ä¹‹ä¸€ã€‚å»ºè®®æ‚¨æå‰äº†è§£ç›¸å…³å†å²èƒŒæ™¯ï¼Œè¿™æ ·èƒ½æ›´å¥½åœ°æ¬£èµå’Œç†è§£æ™¯ç‚¹çš„å†…æ¶µã€‚</p>
          <p>æ¸¸è§ˆè¿‡ç¨‹ä¸­è¯·æ³¨æ„ä¿æŠ¤æ–‡ç‰©ï¼Œä¸è¦åœ¨æ–‡ç‰©å¤è¿¹ä¸Šåˆ»ç”»æˆ–æ¶‚å†™ã€‚åŒæ—¶å»ºè®®æºå¸¦ç›¸æœºï¼Œè®°å½•ä¸‹ç¾å¥½çš„æ—…è¡Œå›å¿†ã€‚</p>
        `;
        document.getElementById('aiIntroduction').innerHTML = introduction;
      }
    }

    // é¡¹ç›®å‚ä¸è€…åˆ—è¡¨
    let projectParticipants = [];
    let lastMessageId = 0; // è®°å½•æœ€åä¸€æ¡æ¶ˆæ¯çš„ID
    
    // åŠ è½½é¡¹ç›®å‚ä¸è€…
    async function loadProjectParticipants() {
      if (!projectId) return;
      try {
        const response = await fetch(`/api/project-participants/project/${projectId}`);
        if (response.ok) {
          projectParticipants = await response.json();
          // è·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯
          for (let participant of projectParticipants) {
            try {
              const userResponse = await fetch(`/api/users/${participant.userId}`);
              if (userResponse.ok) {
                participant.userInfo = await userResponse.json();
              }
            } catch (err) {
              console.error('Error loading user info:', err);
            }
          }
          // æ¸²æŸ“å‚ä¸è€…å¤´åƒ
          renderParticipantAvatars();
        }
      } catch (error) {
        console.error('Error loading project participants:', error);
      }
    }
    
    // æ¸²æŸ“å‚ä¸è€…å¤´åƒ
    function renderParticipantAvatars() {
      const container = document.getElementById('participantAvatars');
      const colors = ['#667eea', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'];
      
      const maxDisplay = 5; // æœ€å¤šæ˜¾ç¤º5ä¸ªå¤´åƒ
      const displayParticipants = projectParticipants.slice(0, maxDisplay);
      const remaining = projectParticipants.length - maxDisplay;
      
      container.innerHTML = displayParticipants.map((p, idx) => {
        const username = p.userInfo?.username || `ç”¨æˆ·${p.userId}`;
        const initial = username.charAt(0).toUpperCase();
        const color = colors[idx % colors.length];
        const isCurrentUser = p.userId === currentUser.id;
        
        return `
          <div class="w-8 h-8 rounded-full border-2 border-white flex items-center justify-center text-white text-xs font-bold ${isCurrentUser ? 'ring-2 ring-blue-400' : ''}" 
               style="background: ${color};" 
               title="${username}${isCurrentUser ? ' (ä½ )' : ''}">
            ${initial}
          </div>
        `;
      }).join('');
      
      // å¦‚æœè¿˜æœ‰æ›´å¤šå‚ä¸è€…ï¼Œæ˜¾ç¤º+N
      if (remaining > 0) {
        container.innerHTML += `
          <div class="w-8 h-8 rounded-full bg-gray-400 border-2 border-white flex items-center justify-center text-white text-xs font-bold" 
               title="è¿˜æœ‰${remaining}ä½å‚ä¸è€…">
            +${remaining}
          </div>
        `;
      }
    }
    
    // æ‰“å¼€æƒé™ç®¡ç†å¼¹çª—
    function openPermissionModal() {
      const modal = document.getElementById('permissionModal');
      modal.classList.remove('hidden');
      renderParticipantList();
    }
    
    // å…³é—­æƒé™ç®¡ç†å¼¹çª—
    function closePermissionModal() {
      const modal = document.getElementById('permissionModal');
      modal.classList.add('hidden');
    }
    
    // æ¸²æŸ“å‚ä¸è€…åˆ—è¡¨ï¼ˆæƒé™ç®¡ç†ï¼‰
    function renderParticipantList() {
      const container = document.getElementById('participantList');
      const colors = ['#667eea', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'];
      
      // è¿‡æ»¤æ‰åˆ›å»ºè€…ï¼Œåªæ˜¾ç¤ºå…¶ä»–å‚ä¸è€…
      const editableParticipants = projectParticipants.filter(p => p.role !== 'åˆ›å»ºè€…');
      
      if (editableParticipants.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-8">æš‚æ— å…¶ä»–å‚ä¸è€…</p>';
        return;
      }
      
      container.innerHTML = editableParticipants.map((p, idx) => {
        const username = p.userInfo?.username || `ç”¨æˆ·${p.userId}`;
        const initial = username.charAt(0).toUpperCase();
        const color = colors[idx % colors.length];
        const currentRole = p.role || 'æŸ¥çœ‹è€…';
        
        return `
          <div class="bg-gray-50 rounded-lg p-4 flex items-center justify-between hover:bg-gray-100 transition-colors">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 rounded-full flex items-center justify-center text-white text-lg font-bold" 
                   style="background: ${color};">
                ${initial}
              </div>
              <div>
                <div class="font-semibold text-gray-800">${username}</div>
                <div class="text-sm text-gray-500">ID: ${p.userId}</div>
              </div>
            </div>
            <div class="flex items-center gap-3">
              <select class="permission-select px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" 
                      data-participant-id="${p.id}" data-user-id="${p.userId}">
                <option value="ç¼–è¾‘è€…" ${currentRole === 'ç¼–è¾‘è€…' ? 'selected' : ''}>ğŸ“ ç¼–è¾‘è€…</option>
                <option value="æŸ¥çœ‹è€…" ${currentRole === 'æŸ¥çœ‹è€…' || currentRole === 'å‚ä¸è€…' ? 'selected' : ''}>ğŸ‘ï¸ æŸ¥çœ‹è€…</option>
              </select>
            </div>
          </div>
        `;
      }).join('');
    }
    
    // ä¿å­˜æƒé™ä¿®æ”¹
    async function savePermissions() {
      const selects = document.querySelectorAll('.permission-select');
      const updates = [];
      
      for (let select of selects) {
        const participantId = select.getAttribute('data-participant-id');
        const newRole = select.value;
        
        updates.push({
          participantId: parseInt(participantId),
          role: newRole
        });
      }
      
      try {
        // é€ä¸ªæ›´æ–°æƒé™
        for (let update of updates) {
          const response = await fetch(`/api/project-participants/${update.participantId}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              role: update.role
            })
          });
          
          if (!response.ok) {
            throw new Error('æ›´æ–°æƒé™å¤±è´¥');
          }
        }
        
        alert('âœ… æƒé™ä¿®æ”¹æˆåŠŸï¼');
        closePermissionModal();
        
        // é‡æ–°åŠ è½½å‚ä¸è€…åˆ—è¡¨
        await loadProjectParticipants();
        
      } catch (error) {
        console.error('Error saving permissions:', error);
        alert('âŒ æƒé™ä¿®æ”¹å¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    }
    
    // å¤åˆ¶é‚€è¯·é“¾æ¥
    function copyInviteLink() {
      const token = Math.random().toString(36).substring(2, 15);
      const shareUrl = `${window.location.origin}/collaboration.html?id=${projectId}&invite=${token}`;
      
      const tempInput = document.createElement('input');
      tempInput.value = shareUrl;
      document.body.appendChild(tempInput);
      tempInput.select();
      document.execCommand('copy');
      document.body.removeChild(tempInput);
      
      alert('åä½œé“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼å…¶ä»–ç”¨æˆ·å¯ç›´æ¥åŠ å…¥åä½œã€‚');
    }

    // åŠ è½½èŠå¤©æ¶ˆæ¯
    async function loadChatMessages() {
      if (!projectId) return;
      try {
        const response = await fetch(`/api/chat-messages/project/${projectId}`);
        if (response.ok) {
          const messages = await response.json();
          renderChat(messages);
          if (messages.length > 0) {
            lastMessageId = messages[messages.length - 1].id;
          }
        }
      } catch (error) {
        console.error('Error loading chat messages:', error);
      }
    }
    
    // è½®è¯¢æ–°æ¶ˆæ¯
    async function pollNewMessages() {
      if (!projectId || lastMessageId === 0) return;
      try {
        const response = await fetch(`/api/chat-messages/project/${projectId}/new?lastMessageId=${lastMessageId}`);
        if (response.ok) {
          const newMessages = await response.json();
          if (newMessages.length > 0) {
            appendNewMessages(newMessages);
            lastMessageId = newMessages[newMessages.length - 1].id;
          }
        }
      } catch (error) {
        console.error('Error polling new messages:', error);
      }
    }

    function renderChat(messages) {
      const container = document.getElementById('chatMessages');
      container.innerHTML = messages.map(msg => {
        const isCurrentUser = msg.userId === currentUser.id;
        const timeAgo = formatTimeAgo(msg.createdTime);
        return `
          <div class="${isCurrentUser ? 'flex justify-end' : ''}">
            <div class="${isCurrentUser ? 'bg-blue-500 text-white' : 'bg-white border'} p-3 rounded-lg max-w-[80%] shadow-sm">
              <div class="text-xs font-bold ${isCurrentUser ? 'text-blue-100' : 'text-blue-600'} mb-1">${msg.username}</div>
              <div class="text-sm break-words">${msg.message}</div>
              <div class="text-xs ${isCurrentUser ? 'text-blue-100' : 'text-gray-400'} mt-1">${timeAgo}</div>
            </div>
          </div>
        `;
      }).join('');
      // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
      container.scrollTop = container.scrollHeight;
    }
    
    function appendNewMessages(messages) {
      const container = document.getElementById('chatMessages');
      messages.forEach(msg => {
        const isCurrentUser = msg.userId === currentUser.id;
        const timeAgo = formatTimeAgo(msg.createdTime);
        const messageEl = document.createElement('div');
        messageEl.className = isCurrentUser ? 'flex justify-end' : '';
        messageEl.innerHTML = `
          <div class="${isCurrentUser ? 'bg-blue-500 text-white' : 'bg-white border'} p-3 rounded-lg max-w-[80%] shadow-sm">
            <div class="text-xs font-bold ${isCurrentUser ? 'text-blue-100' : 'text-blue-600'} mb-1">${msg.username}</div>
            <div class="text-sm break-words">${msg.message}</div>
            <div class="text-xs ${isCurrentUser ? 'text-blue-100' : 'text-gray-400'} mt-1">${timeAgo}</div>
          </div>
        `;
        container.appendChild(messageEl);
      });
      container.scrollTop = container.scrollHeight;
    }
    
    function formatTimeAgo(timestamp) {
      const now = new Date();
      const time = new Date(timestamp);
      const diff = Math.floor((now - time) / 1000); // seconds
      
      if (diff < 60) return 'åˆšåˆš';
      if (diff < 3600) return `${Math.floor(diff / 60)}åˆ†é’Ÿå‰`;
      if (diff < 86400) return `${Math.floor(diff / 3600)}å°æ—¶å‰`;
      return time.toLocaleDateString();
    }

    // @mention åŠŸèƒ½
    let mentionMode = false;
    let mentionSearchText = '';
    let selectedMentionIndex = 0;
    let mentionStartPos = 0;

    function showMentionDropdown(searchText = '') {
      const dropdown = document.getElementById('mentionDropdown');
      const filtered = projectParticipants.filter(p => {
        const username = p.userInfo?.username || `ç”¨æˆ·${p.userId}`;
        return username.toLowerCase().includes(searchText.toLowerCase());
      });

      if (filtered.length === 0) {
        dropdown.classList.remove('active');
        return;
      }

      dropdown.innerHTML = filtered.map((p, idx) => {
        const username = p.userInfo?.username || `ç”¨æˆ·${p.userId}`;
        const email = p.userInfo?.email || '';
        return `
          <div class="mention-item ${idx === selectedMentionIndex ? 'selected' : ''}" data-index="${idx}" data-username="${username}">
            <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center text-white text-xs font-bold">
              ${username.charAt(0).toUpperCase()}
            </div>
            <div>
              <div class="text-sm font-medium">${username}</div>
              ${email ? `<div class="text-xs text-gray-500">${email}</div>` : ''}
            </div>
          </div>
        `;
      }).join('');

      dropdown.classList.add('active');

      // ç»‘å®šç‚¹å‡»äº‹ä»¶
      dropdown.querySelectorAll('.mention-item').forEach(item => {
        item.addEventListener('click', () => {
          selectMention(item.getAttribute('data-username'));
        });
      });
    }

    function hideMentionDropdown() {
      document.getElementById('mentionDropdown').classList.remove('active');
      mentionMode = false;
      mentionSearchText = '';
      selectedMentionIndex = 0;
    }

    function selectMention(username) {
      const input = document.getElementById('chatInput');
      const beforeMention = input.value.substring(0, mentionStartPos);
      const afterMention = input.value.substring(input.selectionStart);
      input.value = beforeMention + '@' + username + ' ' + afterMention;
      hideMentionDropdown();
      input.focus();
    }

    async function sendMessage() {
      const input = document.getElementById('chatInput');
      const text = input.value.trim();
      if (text) {
        try {
          // ä¿å­˜æ¶ˆæ¯åˆ°æ•°æ®åº“
          const response = await fetch('/api/chat-messages', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              projectId: projectId,
              userId: currentUser.id,
              username: currentUser.username,
              message: text,
              createdTime: new Date().toISOString()
            })
          });
          
          if (response.ok) {
            const savedMessage = await response.json();
            // ç«‹å³æ˜¾ç¤ºè‡ªå·±çš„æ¶ˆæ¯
            appendNewMessages([savedMessage]);
            lastMessageId = savedMessage.id;
            input.value = '';
            hideMentionDropdown();
          }
        } catch (error) {
          console.error('Error sending message:', error);
          alert('å‘é€æ¶ˆæ¯å¤±è´¥');
        }
      }
    }

    // èŠå¤©è¾“å…¥æ¡†äº‹ä»¶ç›‘å¬
    const chatInput = document.getElementById('chatInput');
    
    chatInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !mentionMode) {
        e.preventDefault();
        sendMessage();
      } else if (mentionMode) {
        const dropdown = document.getElementById('mentionDropdown');
        const items = dropdown.querySelectorAll('.mention-item');
        
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          selectedMentionIndex = Math.min(selectedMentionIndex + 1, items.length - 1);
          showMentionDropdown(mentionSearchText);
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          selectedMentionIndex = Math.max(selectedMentionIndex - 1, 0);
          showMentionDropdown(mentionSearchText);
        } else if (e.key === 'Enter') {
          e.preventDefault();
          const selectedItem = items[selectedMentionIndex];
          if (selectedItem) {
            selectMention(selectedItem.getAttribute('data-username'));
          }
        } else if (e.key === 'Escape') {
          e.preventDefault();
          hideMentionDropdown();
        }
      }
    });

    chatInput.addEventListener('input', (e) => {
      const value = e.target.value;
      const cursorPos = e.target.selectionStart;
      
      // æ£€æµ‹ @ ç¬¦å·
      const textBeforeCursor = value.substring(0, cursorPos);
      const lastAtIndex = textBeforeCursor.lastIndexOf('@');
      
      if (lastAtIndex !== -1) {
        const textAfterAt = textBeforeCursor.substring(lastAtIndex + 1);
        // å¦‚æœ @ åé¢æ²¡æœ‰ç©ºæ ¼ï¼Œè¿›å…¥ mention æ¨¡å¼
        if (!textAfterAt.includes(' ')) {
          mentionMode = true;
          mentionStartPos = lastAtIndex;
          mentionSearchText = textAfterAt;
          selectedMentionIndex = 0;
          showMentionDropdown(mentionSearchText);
        } else {
          hideMentionDropdown();
        }
      } else {
        hideMentionDropdown();
      }
    });

    // ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰æ¡†
    document.addEventListener('click', (e) => {
      if (!e.target.closest('#chatInput') && !e.target.closest('#mentionDropdown')) {
        hideMentionDropdown();
      }
    });

    // åˆ†äº«æ–‡æ¡£åŠŸèƒ½
    function shareDocument() {
      if (projectId) {
        window.location.href = `/share.html?id=${projectId}`;
      } else {
        alert('é¡¹ç›® IDä¸å­˜åœ¨ï¼Œæ— æ³•åˆ†äº«');
      }
    }
        
    // å¯¼å‡ºPDFåŠŸèƒ½
    async function exportPdf() {
      if (!projectId) {
        alert('é¡¹ç›® ID ä¸å­˜åœ¨');
        return;
      }
          
      try {
        console.log('[PDF Export] å¼€å§‹ä¸‹è½½PDF...');
            
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const btn = event.target.closest('button');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<iconify-icon icon="mdi:loading" class="animate-spin" width="24"></iconify-icon><span class="font-medium">ç”Ÿæˆä¸­...</span>';
        btn.disabled = true;
            
        // è°ƒç”¨åç«¯API
        const response = await fetch(`/api/pdf/itinerary/${projectId}`);
            
        if (!response.ok) {
          throw new Error('PDFç”Ÿæˆå¤±è´¥');
        }
            
        // è·å–PDFæ•°æ®
        const blob = await response.blob();
            
        // åˆ›å»ºä¸‹è½½é“¾æ¥
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `æ—…è¡Œè¡Œç¨‹-${projectId}.pdf`;
        document.body.appendChild(a);
        a.click();
            
        // æ¸…ç†
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
            
        console.log('[PDF Export] PDFä¸‹è½½æˆåŠŸ');
            
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        btn.innerHTML = originalText;
        btn.disabled = false;
            
      } catch (error) {
        console.error('[PDF Export] å¯¼å‡ºPDFå¤±è´¥:', error);
        alert('PDFå¯¼å‡ºå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        const btn = event.target.closest('button');
        btn.innerHTML = '<iconify-icon icon="mdi:file-pdf-box" width="24"></iconify-icon><span class="font-medium">å¯¼å‡ºPDF</span>';
        btn.disabled = false;
      }
    }

    // ========== æ´»åŠ¨ç®¡ç†åŠŸèƒ½ ==========
    
    // æ‰“å¼€æ·»åŠ æ´»åŠ¨å¼¹çª—
    function openAddActivityModal() {
      document.getElementById('activityModal').classList.remove('hidden');
      // æ¸…ç©ºè¡¨å•
      document.getElementById('activityName').value = '';
      document.getElementById('activityType').value = 'attraction';
      document.getElementById('startTime').value = '09:00';
      document.getElementById('endTime').value = '12:00';
      document.getElementById('activityDescription').value = '';
      document.getElementById('activitySuggestions').classList.add('hidden');
      activitySuggestionsData = [];
    }
    
    // æ´»åŠ¨ç±»å‹å˜åŒ–æ—¶çš„å¤„ç†
    function handleActivityTypeChange() {
      const type = document.getElementById('activityType').value;
      const nameInput = document.getElementById('activityName');
      
      // æ ¹æ®ç±»å‹è°ƒæ•´æç¤ºæ–‡æœ¬
      if (type === 'attraction') {
        nameInput.placeholder = 'è¾“å…¥æ™¯ç‚¹åç§°ï¼Œå¦‚ï¼šè¥¿æ¹–';
      } else if (type === 'meal') {
        nameInput.placeholder = 'è¾“å…¥é¤å…æˆ–é¤é£Ÿåç§°';
      } else {
        nameInput.placeholder = 'è¾“å…¥æ´»åŠ¨åç§°';
      }
      
      // æ¸…ç©ºè¾“å…¥å’Œå»ºè®®
      nameInput.value = '';
      document.getElementById('activitySuggestions').classList.add('hidden');
      activitySuggestionsData = [];
    }
    
    // æ´»åŠ¨åç§°è¾“å…¥æ—¶çš„å¤„ç†
    let activityInputTimeout = null;
    async function handleActivityNameInput() {
      const type = document.getElementById('activityType').value;
      const keyword = document.getElementById('activityName').value.trim();
      
      // åªæœ‰å½“ç±»å‹ä¸ºâ€œæ™¯ç‚¹æ¸¸è§ˆâ€æ—¶æ‰å¯ç”¨è‡ªåŠ¨è¡¥å…¨
      if (type !== 'attraction') {
        document.getElementById('activitySuggestions').classList.add('hidden');
        return;
      }
      
      if (!keyword) {
        document.getElementById('activitySuggestions').classList.add('hidden');
        activitySuggestionsData = [];
        return;
      }
      
      // é˜²æŠ–å¤„ç†
      if (activityInputTimeout) {
        clearTimeout(activityInputTimeout);
      }
      
      activityInputTimeout = setTimeout(async () => {
        await fetchActivitySuggestions(keyword);
      }, 300);
    }
    
   // è·å–æ™¯ç‚¹å»ºè®®
    async function fetchActivitySuggestions(keyword) {
      if (!destinationCity) {
        console.warn('Destination city not set');
        return;
      }
      
      // åœ¨æ¯æ¬¡æœç´¢å‰å°è¯•è§£æåŸå¸‚åç§°ï¼ˆé˜²æ­¢ç¼“å­˜é—®é¢˜ï¼‰
      let searchCity = destinationCity;
      
      // å¦‚æœåŸå¸‚åç§°åŒ…å«"ç«™"ã€"é•‡"ç­‰ï¼Œå°è¯•é€šè¿‡åœ°ç†ç¼–ç è·å–çœŸå®åŸå¸‚
      if (searchCity.includes('ç«™') || searchCity.includes('é•‡') || searchCity.includes('æ‘')) {
        console.log('[fetchActivitySuggestions] Destination looks like a location, not a city:', searchCity);
        try {
          const url = `https://restapi.amap.com/v3/geocode/geo?address=${encodeURIComponent(searchCity)}&key=bf0e97cd7a4c3c6aaa8ecf3dd7485381`;
          const geoResponse = await fetch(url);
          if (geoResponse.ok) {
            const geoData = await geoResponse.json();
            if (geoData.status === '1' && geoData.geocodes && geoData.geocodes.length > 0) {
              const geocode = geoData.geocodes[0];
              let city = geocode.city;
              if (!city || (Array.isArray(city) && city.length === 0) || city === '') {
                city = geocode.province || geocode.district;
              }
              if (city && city !== searchCity) {
                console.log('[fetchActivitySuggestions] Resolved city:', city, 'from:', searchCity);
                searchCity = city;
                destinationCity = city; // æ›´æ–°å…¨å±€å˜é‡
              }
            }
          }
        } catch (error) {
          console.warn('[fetchActivitySuggestions] Failed to resolve city, using original:', error);
        }
      }
      
      console.log('Fetching POI suggestions for:', keyword, 'in city:', searchCity);
      
      try {
        const types = encodeURIComponent('110000|120000|130000|140000');
        const response = await fetch(
          `/api/amap-test/poi-search?keyword=${encodeURIComponent(keyword)}&city=${encodeURIComponent(searchCity)}&types=${types}`
        );
        
        if (response.ok) {
          const data = await response.json();
          console.log('POI search result:', data);
          activitySuggestionsData = data.pois || [];
          renderActivitySuggestions();
        } else {
          console.error('POI search failed with status:', response.status);
          const errorData = await response.json().catch(() => ({}));
          console.error('Error details:', errorData);
        }
      } catch (error) {
        console.error('Error fetching activity suggestions:', error);
      }
    }
    
    // æ¸²æŸ“æ™¯ç‚¹å»ºè®®åˆ—è¡¨
    function renderActivitySuggestions() {
      const suggestionsDiv = document.getElementById('activitySuggestions');
      
      if (activitySuggestionsData.length === 0) {
        suggestionsDiv.classList.add('hidden');
        return;
      }
      
      suggestionsDiv.innerHTML = activitySuggestionsData.slice(0, 10).map(poi => `
        <div class="px-4 py-2 hover:bg-blue-50 cursor-pointer border-b last:border-b-0" 
             onclick="selectActivitySuggestion('${poi.name.replace(/'/g, "\\'")}')"
             title="${poi.address || ''}">
          <div class="font-medium text-gray-800">${poi.name}</div>
          <div class="text-xs text-gray-500">${poi.type || ''} ${poi.address ? '| ' + poi.address.substring(0, 30) : ''}</div>
        </div>
      `).join('');
      
      suggestionsDiv.classList.remove('hidden');
    }
    
    // é€‰æ‹©æ™¯ç‚¹å»ºè®®
    function selectActivitySuggestion(name) {
      document.getElementById('activityName').value = name;
      document.getElementById('activitySuggestions').classList.add('hidden');
      activitySuggestionsData = [];
    }
    
    // æ˜¾ç¤ºæ™¯ç‚¹å»ºè®®ï¼ˆè·å–ç„¦ç‚¹æ—¶ï¼‰
    function showActivitySuggestions() {
      const type = document.getElementById('activityType').value;
      const keyword = document.getElementById('activityName').value.trim();
      
      if (type === 'attraction' && keyword && activitySuggestionsData.length > 0) {
        document.getElementById('activitySuggestions').classList.remove('hidden');
      }
    }
    
    // å…³é—­æ´»åŠ¨å¼¹çª—
    function closeActivityModal() {
      document.getElementById('activityModal').classList.add('hidden');
    }
    
    // ä¿å­˜æ´»åŠ¨
    async function saveActivity() {
      const name = document.getElementById('activityName').value.trim();
      const type = document.getElementById('activityType').value;
      const startTime = document.getElementById('startTime').value;
      const endTime = document.getElementById('endTime').value;
      const description = document.getElementById('activityDescription').value.trim();
      
      if (!name) {
        alert('è¯·è¾“å…¥æ´»åŠ¨åç§°');
        return;
      }
      
      try {
        // è·å–å½“å‰é€‰ä¸­çš„å¤©æ•°
        const selectedDay = parseInt(document.getElementById('daySelector').value);
        
        // è·å–å½“å‰è·¯çº¿æ•°æ®
        const routeResponse = await fetch(`/api/ai-generated-routes/${currentRouteData.id}`);
        const route = await routeResponse.json();
        const dailyItinerary = JSON.parse(route.dailyItinerary);
        
        // æ‰¾åˆ°å½“å‰å¤©æ•°çš„æ•°æ®
        const dayIndex = dailyItinerary.findIndex(d => (d.day || dailyItinerary.indexOf(d) + 1) === selectedDay);
        if (dayIndex === -1) {
          alert('æ‰¾ä¸åˆ°å½“å‰å¤©æ•°çš„æ•°æ®');
          return;
        }
        
        // æ„é€ æ–°æ´»åŠ¨å­—ç¬¦ä¸²
        let activityStr = `${startTime}-${endTime} `;
        if (type === 'meal') {
          activityStr += `é¤é¥®ï¼š${name}`;
        } else if (type === 'attraction') {
          activityStr += `æ™¯ç‚¹ï¼š${name}`;
        } else {
          activityStr += name;
        }
        if (description) {
          activityStr += ` (å¤‡æ³¨ï¼š${description})`;
        }
        
        // æ·»åŠ åˆ°å½“å‰å¤©æ•°çš„activities
        if (!dailyItinerary[dayIndex].activities) {
          dailyItinerary[dayIndex].activities = [];
        }
        dailyItinerary[dayIndex].activities.push(activityStr);
        
        // æŒ‰æ—¶é—´æ’åº
        dailyItinerary[dayIndex].activities.sort((a, b) => {
          const timeA = a.match(/^(\d{2}:\d{2})/);
          const timeB = b.match(/^(\d{2}:\d{2})/);
          if (timeA && timeB) {
            return timeA[1].localeCompare(timeB[1]);
          }
          return 0;
        });
        
        // æ›´æ–°è·¯çº¿æ•°æ®
        route.dailyItinerary = JSON.stringify(dailyItinerary);
        
        // ä¿å­˜åˆ°åç«¯
        const saveResponse = await fetch(`/api/ai-generated-routes/${route.id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(route)
        });
        
        if (saveResponse.ok) {
          alert('æ´»åŠ¨æ·»åŠ æˆåŠŸï¼');
          closeActivityModal();
          // é‡æ–°åŠ è½½å½“å‰å¤©æ•°çš„æ•°æ®
          currentRouteData = route;
          await loadDayAttractions();
        } else {
          alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
        }
      } catch (error) {
        console.error('Error saving activity:', error);
        alert('ä¿å­˜å¤±è´¥ï¼š' + error.message);
      }
    }
    
    // åˆ é™¤æ´»åŠ¨
    async function deleteAttraction(activityIndex) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ´»åŠ¨å—ï¼Ÿ')) {
        return;
      }
      
      try {
        const selectedDay = parseInt(document.getElementById('daySelector').value);
        
        // è·å–å½“å‰è·¯çº¿æ•°æ®
        const routeResponse = await fetch(`/api/ai-generated-routes/${currentRouteData.id}`);
        const route = await routeResponse.json();
        const dailyItinerary = JSON.parse(route.dailyItinerary);
        
        // æ‰¾åˆ°å½“å‰å¤©æ•°çš„æ•°æ®
        const dayIndex = dailyItinerary.findIndex(d => (d.day || dailyItinerary.indexOf(d) + 1) === selectedDay);
        if (dayIndex === -1 || !dailyItinerary[dayIndex].activities) {
          alert('æ‰¾ä¸åˆ°æ´»åŠ¨æ•°æ®');
          return;
        }
        
        // åˆ é™¤æŒ‡å®šçš„æ´»åŠ¨
        dailyItinerary[dayIndex].activities.splice(activityIndex, 1);
        
        // æ›´æ–°è·¯çº¿æ•°æ®
        route.dailyItinerary = JSON.stringify(dailyItinerary);
        
        // ä¿å­˜åˆ°åç«¯
        const saveResponse = await fetch(`/api/ai-generated-routes/${route.id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(route)
        });
        
        if (saveResponse.ok) {
          alert('åˆ é™¤æˆåŠŸï¼');
          // é‡æ–°åŠ è½½å½“å‰å¤©æ•°çš„æ•°æ®
          currentRouteData = route;
          await loadDayAttractions();
        } else {
          alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
        }
      } catch (error) {
        console.error('Error deleting activity:', error);
        alert('åˆ é™¤å¤±è´¥ï¼š' + error.message);
      }
    }

    // åˆå§‹åŒ–
    async function init() {
      console.log('=== Initializing collaboration page ===');
      // å·²ç§»é™¤ï¼šrenderDailyTimeline(); renderFlowChart();
      
      try {
        // åŠ è½½é¡¹ç›®ä¿¡æ¯
        console.log('Step 1: Loading project info...');
        await loadProjectInfo();
        console.log('Step 1: Project info loaded');
      } catch (error) {
        console.error('Step 1 failed:', error);
      }
      
      try {
        // åŠ è½½å¤©æ•°é€‰é¡¹å’Œæ™¯ç‚¹åˆ—è¡¨
        console.log('Step 2: Loading day options and attractions...');
        await loadDayOptions();
        console.log('Step 2: Day options loaded');
      } catch (error) {
        console.error('Step 2 failed:', error);
        showNoRouteMessage();
      }
      
      try {
        // å…ˆå¤„ç†é‚€è¯·é“¾æ¥ï¼Œæ·»åŠ ç”¨æˆ·åˆ°é¡¹ç›®
        console.log('Step 3: Handling invite link...');
        await handleInviteLink();
        console.log('Step 3: Invite link handled');
      } catch (error) {
        console.error('Step 3 failed:', error);
      }
      
      try {
        // ç„¶ååŠ è½½å‚ä¸è€…å’ŒèŠå¤©æ¶ˆæ¯
        console.log('Step 4: Loading participants...');
        await loadProjectParticipants();
        console.log('Step 4: Participants loaded');
      } catch (error) {
        console.error('Step 4 failed:', error);
      }
      
      try {
        console.log('Step 5: Loading chat messages...');
        await loadChatMessages();
        console.log('Step 5: Chat messages loaded');
      } catch (error) {
        console.error('Step 5 failed:', error);
      }
      
      // æ¯3ç§’è½®è¯¢ä¸€æ¬¡æ–°æ¶ˆæ¯
      console.log('Setting up message polling...');
      setInterval(pollNewMessages, 3000);
      
      // æ·»åŠ ç‚¹å‡»å¤–éƒ¨éšè—æ™¯ç‚¹å»ºè®®çš„äº‹ä»¶ç›‘å¬
      document.addEventListener('click', function(e) {
        const suggestionsDiv = document.getElementById('activitySuggestions');
        const nameInput = document.getElementById('activityName');
        
        if (suggestionsDiv && nameInput && 
            !suggestionsDiv.contains(e.target) && 
            e.target !== nameInput) {
          suggestionsDiv.classList.add('hidden');
        }
      });
      
      console.log('=== Initialization complete ===');
    }
    
    init();
  </script>
</body>
</html>
